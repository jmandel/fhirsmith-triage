# FHIRsmith Triage Toolkit

Automated comparison and triage system for validating [FHIRsmith](https://github.com/nicktobey/FHIRsmith) (a Node.js FHIR terminology server) against the production Java implementation at tx.fhir.org.

**[Browse triage results](https://joshuamandel.com/fhirsmith-triage/)**

## What it does

1. **Compare** — Runs paired requests against prod (tx.fhir.org) and dev (FHIRsmith), capturing both responses
2. **Diff** — Applies a tolerance pipeline to filter known-acceptable differences, then categorizes remaining deltas by severity
3. **Triage** — An AI agent analyzes each delta, determines root cause, files bugs via `git-bug`, and writes tolerance rules to prevent re-analysis
4. **Report** — Generates HTML/Markdown bug reports published to GitHub Pages

## Quick start

```bash
# Start a new triage job from a comparison dataset
./prompts/start-triage.sh <job-name> path/to/comparison.ndjson

# Run the automated triage loop
./prompts/triage-loop.sh jobs/<job-name>
```

## Key concepts

**Tolerances** are judgment rules that classify differences between prod and dev responses:

- `equiv-autofix` — Semantically equivalent responses that differ only in form (key ordering, whitespace, server-generated IDs). Permanent.
- `temp-tolerance` — Real bugs that follow a recognizable pattern. Each is linked to a `git-bug` issue. Cleared between rounds as bugs are fixed.

**Comparison categories** (from most to least severe):

| Category | Meaning |
|---|---|
| `dev-crash-on-valid` | prod=200, dev=500 |
| `result-disagrees` | Both 200, `result` boolean differs |
| `missing-resource` | prod=200, dev=404 |
| `dev-crash-on-error` | prod=4xx, dev=500 |
| `status-mismatch` | Different HTTP status codes |
| `content-differs` | Same status, content differs |

**Records** are identified by stable UUIDs, so previously-analyzed records are recognized even when the delta file is regenerated.

## Directory structure

```
triage/
├── engine/
│   ├── compare.js            # Comparison engine + tolerance pipeline
│   ├── next-record.js        # Picks next unanalyzed record
│   ├── dump-bugs.sh          # Markdown bug report generator
│   └── dump-bugs-html.py     # HTML bug report generator
├── prompts/
│   ├── triage-loop.sh        # Main automation loop
│   ├── start-triage.sh       # Job initialization
│   ├── triage-prompt.md      # Agent instructions for triage
│   ├── orchestration.md      # Running triage + repro agents
│   └── repro-request.md      # Agent instructions for bug reproduction
├── baseline/
│   └── tolerances.js         # Minimal starter tolerance set
├── reference/                # FHIR specs, operation docs, code system guides
├── jobs/<job-name>/
│   ├── tolerances.js         # Working tolerances (evolves during triage)
│   ├── issues/<uuid>/        # Per-record analysis workspace
│   │   ├── analysis.md       # Agent's triage judgment
│   │   ├── record.json       # Full delta record
│   │   ├── {prod,dev}-{raw,normalized}.json
│   │   └── applied-tolerances.txt
│   └── bugs/
│       ├── bugs.html         # Interactive bug report
│       ├── bugs.md
│       └── bugs.json
└── .github/workflows/
    └── pages.yml             # Publishes bug reports to GitHub Pages
```

## Data files (not in git)

Large data files are gitignored. To run triage you need:

- `jobs/<job-name>/comparison.ndjson` — Paired prod/dev responses (generated externally)
- `jobs/<job-name>/results/deltas/deltas.ndjson` — Generated by `engine/compare.js`
