{"id":"b6d19d8","title":"b6d19d8 [open] Dev omits system/code/version/display params on CodeSystem/$validate-code with codeableConcept containing unknown system","body":"b6d19d8 [open] Dev omits system/code/version/display params on CodeSystem/$validate-code with codeableConcept containing unknown system\n\nClaude (AI Assistant) opened this issue 2026-02-07 16:12:17 -0600 CST\nThis was last edited at 2026-02-08 10:52:57 -0600 CST\n\nlabels: content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  bb66dd1 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 5\nTolerance-ID: cc-validate-code-missing-known-coding-params\nRecord-ID: 84b0cee7-5f7e-4fbc-af8a-aed5ad7a91d4\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r5/CodeSystem/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"https://fhir.smartypower.app/CodeSystem/smartypower-cognitive-tests\",\"code\":\"SP-QUICKSTOP\",\"display\":\"QuickStop Response Inhibition Test\"},{\"system\":\"http://loinc.org\",\"code\":\"72106-8\",\"display\":\"Cognitive functioning [Interpretation]\"}],\"text\":\"Go/No-Go task measuring response inhibition and impulse control\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r5/CodeSystem/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"https://fhir.smartypower.app/CodeSystem/smartypower-cognitive-tests\",\"code\":\"SP-QUICKSTOP\",\"display\":\"QuickStop Response Inhibition Test\"},{\"system\":\"http://loinc.org\",\"code\":\"72106-8\",\"display\":\"Cognitive functioning [Interpretation]\"}],\"text\":\"Go/No-Go task measuring response inhibition and impulse control\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n```\n\nProd returns `system=http://loinc.org`, `code=72106-8`, `display=Total score [MMSE]`, plus 2 OperationOutcome issues (UNKNOWN_CODESYSTEM + Display_Name_for__should_be_one_of__instead_of). Dev returns no system/code/display params and only 1 issue (UNKNOWN_CODESYSTEM).\n\n\nWhen CodeSystem/$validate-code is called with a codeableConcept containing multiple codings \u2014 one from an unknown CodeSystem and one from a known CodeSystem \u2014 and result=false:\n\n- **Prod** validates the known coding and returns `system`, `code`, `version`, `display` parameters for it. When the known coding also has issues (e.g. invalid-display), prod includes those as additional OperationOutcome issues.\n- **Dev** only reports the unknown system error and omits the `system`, `code`, `version`, `display` parameters entirely. Dev also omits any additional OperationOutcome issues related to the known coding.\n\nFor example, with a codeableConcept containing a LOINC coding (known) and a smartypower coding (unknown):\n- Prod returns: system=http://loinc.org, code=72106-8, version=2.81, display=\"Total score [MMSE]\", plus 2 issues (UNKNOWN_CODESYSTEM + invalid-display)\n- Dev returns: no system/code/version/display params, only 1 issue (UNKNOWN_CODESYSTEM)\n\n\n5 records in deltas. All are CodeSystem/$validate-code (both /r4 and /r5) with codeableConcept containing one unknown and one known coding. Both sides agree result=false.\n\nSearch: `grep '\"missing-in-dev\",\"param\":\"system\"' results/deltas/deltas.ndjson | wc -l` \u2192 5\n\nThe 5 records involve 2 unknown systems:\n- https://fhir.smartypower.app/CodeSystem/smartypower-cognitive-tests (2 records, LOINC known coding)\n- http://fhir.essilorluxottica.com/fhir/CodeSystem/el-observation-code-cs (3 records, SNOMED known coding)\n\n\nTolerance ID: cc-validate-code-missing-known-coding-params\nMatches: validate-code with codeableConcept, result=false on both sides, x-caused-by-unknown-system present, where prod has system/code params that dev lacks.\nNormalizes by adding prod's system/code/version/display params to dev and canonicalizing issues to prod's set.\nEliminates: 5 records.\n\n\n- 84b0cee7-5f7e-4fbc-af8a-aed5ad7a91d4 (LOINC + smartypower, /r5)\n- 6f70f14a-81e1-427e-9eed-1b2c53801296 (SNOMED + essilorluxottica, /r4)\n"}
{"id":"2ed80bd","title":"2ed80bd [open] Dev  omits expansion.total when prod includes it","body":"2ed80bd [open] Dev  omits expansion.total when prod includes it\n\nClaude (AI Assistant) opened this issue 2026-02-07 16:18:44 -0600 CST\nThis was last edited at 2026-02-08 10:52:56 -0600 CST\n\nlabels: content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  22eedd8 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 47\nTolerance-ID: expand-dev-missing-total\nRecord-ID: a1f653a2-a199-4228-a7f7-2522abde6953\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand' -H 'Accept: application/fhir+json' -H 'Content-Type: application/fhir+json' -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"system-version\",\"valueUri\":\"http://snomed.info/sct|http://snomed.info/sct/11000315107\"},{\"name\":\"displayLanguage\",\"valueCode\":\"fr\"},{\"name\":\"includeDefinition\",\"valueBoolean\":false},{\"name\":\"excludeNested\",\"valueBoolean\":true},{\"name\":\"cache-id\",\"valueId\":\"4d94febc-fb6a-407d-a69c-29b8de3c56c3\"},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"status\":\"active\",\"compose\":{\"inactive\":true,\"include\":[{\"system\":\"urn:iso:std:iso:3166:-2\"}]}}}]}' | jq '.expansion | {total, contains_count: (.contains | length)}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand' -H 'Accept: application/fhir+json' -H 'Content-Type: application/fhir+json' -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"system-version\",\"valueUri\":\"http://snomed.info/sct|http://snomed.info/sct/11000315107\"},{\"name\":\"displayLanguage\",\"valueCode\":\"fr\"},{\"name\":\"includeDefinition\",\"valueBoolean\":false},{\"name\":\"excludeNested\",\"valueBoolean\":true},{\"name\":\"cache-id\",\"valueId\":\"4d94febc-fb6a-407d-a69c-29b8de3c56c3\"},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"status\":\"active\",\"compose\":{\"inactive\":true,\"include\":[{\"system\":\"urn:iso:std:iso:3166:-2\"}]}}}]}' | jq '.expansion | {total, contains_count: (.contains | length)}'\n```\n\nProd returns `\"total\": 5099` with 1000 contains entries. Dev returns `\"total\": null` (field missing) with 1000 contains entries.\n\n## What differs\n\nIn $expand responses (POST /r4/ValueSet/$expand), prod returns `expansion.total` (the total count of matching concepts) while dev omits it entirely. The `total` field is a 0..1 optional integer in FHIR R4's ValueSet.expansion, documented as \"Total concept count; permits server pagination.\" Without it, clients cannot determine how many pages exist in a paged expansion.\n\nExamples:\n- Prod: `\"total\": 5099` with 1000 contains (paged)\n- Dev: no `total` field, same 1000 contains\n\nBoth servers return identical `contains` arrays and `offset` values in all sampled records.\n\n## How widespread\n\n47 records in deltas.ndjson show this pattern (prod has expansion.total, dev omits it). Breakdown:\n- 33 records with total=5099 (paged SNOMED expansions with count=1000)\n- 13 records with total=0 (empty expansions)\n- 1 record with total=249 (ISO 3166 codes, also has contains count mismatch)\n\nSearch: All 47 are expand operations, all POST /r4/ValueSet/$expand, all with both statuses 200.\n\nNote: There is a separate existing tolerance (expand-unclosed-extension-and-total, bug f2b2cef) for the reverse case where prod omits total on unclosed expansions but dev includes it. That bug is about the valueset-unclosed extension. This bug is different \u2014 neither side has the unclosed extension; dev simply fails to include `total` in complete expansions.\n\n## What the tolerance covers\n\nTolerance ID: expand-dev-missing-total\nMatches: $expand responses (POST /r4/ValueSet/$expand) where both sides return 200, prod has expansion.total, and dev doesn't.\nNormalizes by removing expansion.total from prod (since dev lacks it) to prevent re-triaging.\n"}
{"id":"c7004d3","title":"c7004d3 [open] Dev omits valueset-toocostly extension and adds spurious used-codesystem on  for grammar-based code systems","body":"c7004d3 [open] Dev omits valueset-toocostly extension and adds spurious used-codesystem on  for grammar-based code systems\n\nClaude (AI Assistant) opened this issue 2026-02-07 16:25:28 -0600 CST\nThis was last edited at 2026-02-08 10:52:57 -0600 CST\n\nlabels: content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  cc77000 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 13\nTolerance-ID: expand-toocostly-extension-and-used-codesystem\nRecord-ID: a272aa8c-96d7-4905-a75a-ea21d67b83fc\n\n\nProd:\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"_incomplete\",\"valueBoolean\":true},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"url\":\"http://hl7.org/fhir/ValueSet/mimetypes\",\"compose\":{\"include\":[{\"system\":\"urn:ietf:bcp:13\"}]}}}]}' \\\n  | jq '.expansion.extension, [.expansion.parameter[] | select(.name == \"used-codesystem\")]'\n```\n\nDev:\n```bash\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"_incomplete\",\"valueBoolean\":true},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"url\":\"http://hl7.org/fhir/ValueSet/mimetypes\",\"compose\":{\"include\":[{\"system\":\"urn:ietf:bcp:13\"}]}}}]}' \\\n  | jq '.expansion.extension, [.expansion.parameter[] | select(.name == \"used-codesystem\")]'\n```\n\nProd returns `expansion.extension` with `valueset-toocostly: true`, dev returns `null`. Dev includes `used-codesystem: urn:ietf:bcp:13` in parameters, prod does not.\n\n\nFor $expand on grammar-based code systems (primarily BCP-13 MIME types via `urn:ietf:bcp:13`, plus one Brazilian ICD-10 ValueSet), both prod and dev return 200 with an empty expansion (total=0, no `contains`). However:\n\n1. **Prod includes `expansion.extension` with `valueset-toocostly: true`; dev omits it.** This extension signals that the expansion could not be performed because the code system is grammar-based or too costly to enumerate. Prod correctly marks these expansions; dev does not.\n\n2. **Dev includes `expansion.parameter` with `used-codesystem` (e.g., `urn:ietf:bcp:13`); prod omits it.** Dev reports which code system it consulted, even though the expansion returned no results. Prod does not report a used-codesystem on these too-costly expansions.\n\nBoth differences always co-occur in the same records.\n\n\n13 records in the current comparison dataset show both patterns simultaneously. All are successful (200/200) $expand operations. 12 of 13 involve `http://hl7.org/fhir/ValueSet/mimetypes` (BCP-13 MIME types). One involves a Brazilian ValueSet that includes LOINC and a Brazilian ICD-10 code system.\n\nSearch: `grep 'valueset-toocostly' deltas.ndjson` found 25 records total; of those, 13 have both sides returning 200 (the rest have status mismatches handled by other tolerances).\n\n\nTolerance `expand-toocostly-extension-and-used-codesystem` matches $expand records where both return 200, prod has the `valueset-toocostly` extension but dev doesn't, and normalizes by:\n- Removing the `valueset-toocostly` extension from prod\n- Removing any dev-only `used-codesystem` parameters\n\nEliminates 13 records from the delta file.\n\n\na272aa8c-96d7-4905-a75a-ea21d67b83fc: POST /r4/ValueSet/$expand \u2014 BCP-13 MIME types (http://hl7.org/fhir/ValueSet/mimetypes). Prod returns empty expansion with `valueset-toocostly: true` extension and `limitedExpansion: true` parameter. Dev returns empty expansion with `limitedExpansion: true` and `used-codesystem: urn:ietf:bcp:13` but no toocostly extension.\n"}
{"id":"3103b01","title":"3103b01 [open] Dev returns extra informational HGVS syntax issue in $validate-code for varnomen.hgvs.org","body":"3103b01 [open] Dev returns extra informational HGVS syntax issue in $validate-code for varnomen.hgvs.org\n\nClaude (AI Assistant) opened this issue 2026-02-07 16:30:46 -0600 CST\nThis was last edited at 2026-02-08 10:52:56 -0600 CST\n\nlabels: content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  3311003 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 62\nTolerance-ID: hgvs-extra-syntax-issue\nRecord-ID: cdf72565-a646-4daa-86f9-ed5ead0058d6\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/CodeSystem/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://varnomen.hgvs.org\",\"code\":\"NC_000003.11\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r4/CodeSystem/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://varnomen.hgvs.org\",\"code\":\"NC_000003.11\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n```\n\nProd returns 1 OperationOutcome issue (error-level only), dev returns 2 issues (error-level plus an additional informational-level issue with text: \"Error while processing 'NC_000003.11': Missing one of 'c', 'g', 'm', 'n', 'p', 'r' followed by '.'.\")\n\n\nFor $validate-code operations against http://varnomen.hgvs.org, both prod and dev correctly return result=false for invalid HGVS codes. Both return the same error-level OperationOutcome issue (\"Unknown code 'X' in the CodeSystem 'http://varnomen.hgvs.org' version '2.0'\").\n\nHowever, dev returns an additional informational-level OperationOutcome issue that prod does not:\n\n- severity: \"information\"\n- code: \"code-invalid\"\n- text: \"Error while processing '<code>': Missing one of 'c', 'g', 'm', 'n', 'p', 'r' followed by '.'.\"\n\nThis appears to be HGVS-specific syntax validation feedback that dev performs but prod does not.\n\n\n62 records in content-differs category show this exact pattern. All involve $validate-code POST to /r4/CodeSystem/$validate-code? with system http://varnomen.hgvs.org. All have the same extra informational issue text pattern (\"Missing one of 'c', 'g', 'm', 'n', 'p', 'r' followed by '.'\").\n\nSearch: grep -c \"Missing one of\" results/deltas/deltas.ndjson => 62\n\n\nTolerance ID: hgvs-extra-syntax-issue. Matches $validate-code records for http://varnomen.hgvs.org where dev has more OperationOutcome issues than prod, and the extra issues are informational-level. Normalizes by trimming dev's issue list to match prod's length. Eliminates 62 records.\n\n\ncdf72565-a646-4daa-86f9-ed5ead0058d6\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Dev** adds an extra informational issue from the `locate()` message when a code is not found:\n[`tx/workers/validate.js#L1506-L1508`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L1506-L1508)\n\u2014 In `checkConceptSet`, after adding the `Unknown_Code_in_Version` error, dev checks `if (loc.message && op)` and adds an informational issue with the message returned by the HGVS provider's `locate()` method.\n\n**Dev HGVS provider** passes the NLM service error message through as `loc.message`:\n[`tx/cs/cs-hgvs.js#L111-L115`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/cs/cs-hgvs.js#L111-L115)\n\u2014 When the NLM `$validate-code` returns `result=false`, the HGVS syntax error message (e.g., \"Missing one of 'c', 'g', 'm', 'n', 'p', 'r' followed by '.'\") is returned as `{ context: null, message: result.message }`.\n\n**Prod** does not add informational issues from the `locate()` message:\n[`library/ftx/fhir_valuesets.pas#L2273-L2281`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_valuesets.pas#L2273-L2281)\n\u2014 In `checkConceptSet`, when `loc = nil`, prod only adds the `Unknown_Code_in_Version` error issue. There is no code to emit the `message` var as an additional informational issue. (Additionally, the prod HGVS `locate` at [`server/tx/tx_hgvs.pas#L252-L253`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx/tx_hgvs.pas#L252-L253) reads `o.str['message']` instead of `o.str['valueString']`, so the NLM error message is never captured regardless.)\n\n**Fix**: Remove the informational issue emission in `tx/workers/validate.js` lines 1506-1508, or gate it behind a condition that matches prod behavior. The `loc.message` from `locate()` should not be surfaced as a separate OperationOutcome issue since prod does not emit it.\n"}
{"id":"36da928","title":"36da928 [open] Dev returns 404 for SNOMED CT implicit ValueSet  (fhir_vs URLs)","body":"36da928 [open] Dev returns 404 for SNOMED CT implicit ValueSet  (fhir_vs URLs)\n\nClaude (AI Assistant) opened this issue 2026-02-07 16:37:24 -0600 CST\nThis was last edited at 2026-02-08 10:52:56 -0600 CST\n\nlabels: missing-resource, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  3366dda #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 36\nTolerance-ID: snomed-implicit-valueset-expand-404\nRecord-ID: 871b3f66-9e31-4b6c-9774-adb378e935df\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http%3A%2F%2Fsnomed.info%2Fsct%3Ffhir_vs&filter=diabetes&count=5' \\\n  -H 'Accept: application/fhir+json'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http%3A%2F%2Fsnomed.info%2Fsct%3Ffhir_vs&filter=diabetes&count=5' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 200 with a valid ValueSet expansion containing 5 SNOMED CT concepts matching \"diabetes\". Dev returns HTTP 404 with OperationOutcome: `\"ValueSet not found: http://snomed.info/sct?fhir_vs\"`.\n\n## What differs\n\nWhen expanding SNOMED CT implicit ValueSets using the standard `fhir_vs` URL pattern, prod returns 200 with a valid ValueSet expansion, while dev returns 404 with OperationOutcome \"ValueSet not found: http://snomed.info/sct?fhir_vs\".\n\nThis affects all SNOMED CT implicit ValueSet URLs:\n- `http://snomed.info/sct?fhir_vs` (all of SNOMED CT)\n- `http://snomed.info/sct?fhir_vs=isa/<sctid>` (descendants of a concept)\n\nThese are FHIR-standard implicit ValueSet URLs defined in the SNOMED CT FHIR usage guide. A terminology server must recognize these URL patterns and synthesize the corresponding ValueSet rather than looking for a stored resource.\n\n## How widespread\n\n36 records in the delta file show this pattern. All are `missing-resource` category, `expand` operation. All have prod=200, dev=404.\n\n```\ngrep -c 'fhir_vs' jobs/2026-02-round-2/results/deltas/deltas.ndjson\n# \u2192 36\n```\n\nThe pattern is predicted by the URL containing `fhir_vs` combined with the $expand operation. Both /r4/ and /r5/ FHIR version prefixes are affected. Various filter and count parameters are used across the records but all fail the same way.\n\n176 total records in comparison.ndjson contain `fhir_vs`; the other 140 are already handled (matched OK or skipped by existing tolerances).\n\n## What the tolerance covers\n\nTolerance `snomed-implicit-valueset-expand-404` matches records where:\n- The URL contains `fhir_vs`\n- Dev returns status 404\n- Prod returns status 200\n\nIt skips these records entirely since no meaningful comparison is possible (dev doesn't return FHIR content). Eliminates 36 delta records.\n\n## Representative record\n\n`871b3f66-9e31-4b6c-9774-adb378e935df` \u2014 GET /r4/ValueSet/$expand?url=http%3A%2F%2Fsnomed.info%2Fsct%3Ffhir_vs&filter=diabetes&count=5\n"}
{"id":"e02b03e","title":"e02b03e [open] Prod HGVS timeout: 62 records have prod=500 due to external service timeout, comparison invalid","body":"e02b03e [open] Prod HGVS timeout: 62 records have prod=500 due to external service timeout, comparison invalid\n\nClaude (AI Assistant) opened this issue 2026-02-07 16:49:48 -0600 CST\nThis was last edited at 2026-02-08 10:52:57 -0600 CST\n\nlabels: config-issue, reproduced, round:2026-02-round-2, status-mismatch, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  ee0022b #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 62\nTolerance-ID: skip-prod-hgvs-timeout\nRecord-ID: 286d30a9-e2b8-4967-8c56-265b3f6160a6\n\n\n```bash\ncurl -s https://tx.fhir.org/r4/CodeSystem/'$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://varnomen.hgvs.org\",\"code\":\"BRCA1:c.3143delG p.(Gly1048ValfsTer14)\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"cache-id\",\"valueId\":\"7743c2e6-5b90-4b62-bcd2-6695b993e76b\"},{\"name\":\"system-version\",\"valueUri\":\"http://snomed.info/sct|http://snomed.info/sct/83821000000107\"},{\"name\":\"diagnostics\",\"valueBoolean\":true}]}'\n\ncurl -s https://tx-dev.fhir.org/r4/CodeSystem/'$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://varnomen.hgvs.org\",\"code\":\"BRCA1:c.3143delG p.(Gly1048ValfsTer14)\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"cache-id\",\"valueId\":\"7743c2e6-5b90-4b62-bcd2-6695b993e76b\"},{\"name\":\"system-version\",\"valueUri\":\"http://snomed.info/sct|http://snomed.info/sct/83821000000107\"},{\"name\":\"diagnostics\",\"valueBoolean\":true}]}'\n```\n\nProd returns HTTP 500 with OperationOutcome: \"Error parsing HGVS response: Read timed out.\" Dev returns HTTP 200 with Parameters: result=false, indicating the HGVS code is unknown.\n\n\nProd returns HTTP 500 with an OperationOutcome error: \"Error parsing HGVS response: Read timed out.\" Dev returns HTTP 200 with a proper Parameters response (result=false, code not found in http://varnomen.hgvs.org version 2.0).\n\nProd's 500 is a transient failure \u2014 the prod server timed out calling an external HGVS validation service during data collection. Dev processes the same code locally and returns a valid terminology response.\n\n\n62 records in the comparison dataset. All share:\n- System: http://varnomen.hgvs.org\n- Operation: $validate-code (POST /r4/CodeSystem/$validate-code?)\n- Status: prod=500, dev=200\n- Category: status-mismatch\n- Prod body contains \"Error parsing HGVS response: Read timed out.\"\n\nSearch: `grep -c 'Read timed out' results/deltas/deltas.ndjson` \u2192 62\n\nThere are 124 total HGVS records in the dataset; the other 62 did not timeout and have prod=200, dev=200.\n\n\nTolerance `skip-prod-hgvs-timeout` skips any record where prod returned 500 and the prod body contains \"Read timed out\". These records have unreliable comparison data since prod failed to complete the operation. Eliminates 62 records.\n\n\n286d30a9-e2b8-4967-8c56-265b3f6160a6\n\nThis is a data collection artifact \u2014 the comparison data is tainted because prod experienced transient external service timeouts during the collection run. These records should be recollected in a future run.\n"}
{"id":"80ce6b2","title":"80ce6b2 [open] Dev message parameter omits issue texts when validating CodeableConcept with multiple coding errors","body":"80ce6b2 [open] Dev message parameter omits issue texts when validating CodeableConcept with multiple coding errors\n\nClaude (AI Assistant) opened this issue 2026-02-07 17:09:31 -0600 CST\nThis was last edited at 2026-02-08 10:52:56 -0600 CST\n\nlabels: content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  8800cce #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 10\nTolerance-ID: message-concat-selective-issues\nRecord-ID: c350392e-d535-45e3-83cf-924b05e26a14\n\n## Repro\n\n```bash\n# Prod\ncat > /tmp/repro-request.json << 'EOF'\n{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication\",\"code\":\"R210\",\"display\":\"Inherited MMR deficiency (Lynch syndrome)\"},{\"system\":\"http://snomed.info/sct\",\"code\":\"1365861003\",\"display\":\"Lynch syndrome gene mutation detected\"}],\"text\":\"Inherited MMR deficiency (Lynch syndrome)\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"tx-resource\",\"resource\":{\"resourceType\":\"CodeSystem\",\"id\":\"GenomicClinicalIndication\",\"url\":\"https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication\",\"version\":\"0.1.0\",\"name\":\"GenomicClinicalIndication\",\"title\":\"NHS England Genomic Clinical Indication Code\",\"status\":\"draft\",\"experimental\":false,\"date\":\"2025-05-08\",\"publisher\":\"NHS North West Genomics\",\"contact\":[{\"telecom\":[{\"system\":\"url\",\"value\":\"https://www.nwgenomics.nhs.uk/contact-us\"}]}],\"description\":\"1st level Genomic Test Directory Codes\",\"jurisdiction\":[{\"coding\":[{\"system\":\"urn:iso:std:iso:3166\",\"code\":\"GB\",\"display\":\"United Kingdom of Great Britain and Northern Ireland\"}]}],\"caseSensitive\":true,\"content\":\"fragment\",\"concept\":[{\"code\":\"R240\",\"display\":\"Diagnostic testing for known mutation(s)\"},{\"code\":\"R361\",\"display\":\"Childhood onset hereditary spastic paraplegia\"},{\"code\":\"R362\",\"display\":\"Not present in 8.0\"},{\"code\":\"R372\",\"display\":\"Newborn screening for sickle cell disease in a transfused baby\"},{\"code\":\"R93\",\"display\":\"Sickle cell, thalassaemia and other haemoglobinopathies\"},{\"code\":\"R94\",\"display\":\"Not present in 8.0\"},{\"code\":\"R413\",\"display\":\"Autoinflammatory Disorders\"},{\"code\":\"R67\",\"display\":\"Monogenic hearing loss\"},{\"code\":\"R141\",\"display\":\"Monogenic diabetes\"},{\"code\":\"R142\",\"display\":\"Glucokinase-related fasting hyperglycaemia\"},{\"code\":\"R201\",\"display\":\"Atypical haemolytic uraemic syndrome\"},{\"code\":\"M9\",\"display\":\"Thyroid Papillary Carcinoma - Adult\"},{\"code\":\"M215\",\"display\":\"Endometrial Cancer\"}]}},{\"name\":\"cache-id\",\"valueId\":\"7743c2e6-5b90-4b62-bcd2-6695b993e76b\"},{\"name\":\"system-version\",\"valueUri\":\"http://snomed.info/sct|http://snomed.info/sct/83821000000107\"},{\"name\":\"diagnostics\",\"valueBoolean\":true}]}\nEOF\n\ncat /tmp/repro-request.json | curl -s https://tx.fhir.org/r4/CodeSystem/\\$validate-code \\\n  -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' \\\n  --data-binary @- | jq -r '.parameter[] | select(.name == \"message\") | .valueString'\n\n# Dev\ncat /tmp/repro-request.json | curl -s https://tx-dev.fhir.org/r4/CodeSystem/\\$validate-code \\\n  -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' \\\n  --data-binary @- | jq -r '.parameter[] | select(.name == \"message\") | .valueString'\n```\n\nProd returns: `Unknown code '1365861003' in the CodeSystem 'http://snomed.info/sct' version 'http://snomed.info/sct/83821000000107/version/20230412' (UK Edition); Unknown Code 'R210' in the CodeSystem 'https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication' version '0.1.0' - note that the code system is labeled as a fragment, so the code may be valid in some other fragment`\n\nDev returns: `Unknown code '1365861003' in the CodeSystem 'http://snomed.info/sct' version 'http://snomed.info/sct/83821000000107/version/20230412' (UK Edition)`\n\nDev omits the second error message about the GenomicClinicalIndication code R210.\n\n## What differs\n\nWhen $validate-code is called on a CodeableConcept containing multiple codings that each fail validation, the `message` output parameter should concatenate all error/warning issue texts with \"; \". Prod does this correctly. Dev only includes one of the error texts in the message, omitting the others.\n\nFor example, with a CodeableConcept containing two codings (GenomicClinicalIndication#R210 and SNOMED#1365861003), both invalid:\n- **Prod message**: \"Unknown code '1365861003' in the CodeSystem 'http://snomed.info/sct'...; Unknown Code 'R210' in the CodeSystem 'https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication'...\"\n- **Dev message**: \"Unknown code '1365861003' in the CodeSystem 'http://snomed.info/sct'...\"\n\nDev omits the second error about the GenomicClinicalIndication code. The structured OperationOutcome `issues` resource is identical between prod and dev (both have all 3 issues). Only the `message` parameter text is incomplete.\n\n## How widespread\n\n10 delta records, all POST /r4/CodeSystem/$validate-code, all validating the same GenomicClinicalIndication CodeableConcept with SNOMED coding. Identified by searching for records where the only diff is `message` value-differs and prod's message contains more semicolon-separated segments than dev's.\n\nThis is a variant of the same underlying bug as tolerance `message-concat-missing-issues` (which handles a different set of 8 records where prod message = all issue texts joined, dev message = first issue text only). The root cause is the same: dev doesn't properly concatenate all relevant issue texts into the message parameter.\n\n## What the tolerance covers\n\nTolerance `message-concat-selective-issues` matches validate-code records where:\n- Both sides have identical OperationOutcome issues\n- Messages differ\n- Dev's message is a proper substring of prod's message (prod includes more issue texts)\n\nCanonicalizes dev's message to prod's value. Eliminates 10 records.\n"}
{"id":"9fd2328","title":"9fd2328 [open] Dev loads older SNOMED CT edition (20240201) than prod (20250201), causing  to return different code sets","body":"9fd2328 [open] Dev loads older SNOMED CT edition (20240201) than prod (20250201), causing  to return different code sets\n\nClaude (AI Assistant) opened this issue 2026-02-07 17:22:35 -0600 CST\nThis was last edited at 2026-02-08 11:49:47 -0600 CST\n\nlabels: config-issue, content-differs, reproduced, round:2026-02-round-2, to-discuss, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  99ffdd2 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 82\nTolerance-ID: expand-snomed-version-skew-content, expand-snomed-version-skew-content-no-used-cs, snomed-version-skew-message-text\nRecord-ID: 2c7143df-3316-422a-b284-237f16fbcd6e, accdb602-a8bc-4e9c-a8fb-22a12b740f0e, 3534e5f0-39e3-4375-9b37-4dc59848cb70\n\n## What differs\n\nProd and dev load different SNOMED CT editions, causing multiple types of differences across $expand and $validate-code operations. Three variants observed:\n\n1. **$expand with `used-codesystem` parameter** (POST requests with inline ValueSets): Prod uses SNOMED International edition 20250201, dev uses 20240201. The `used-codesystem` expansion parameter confirms the version difference. Example: expanding descendants of 365636006 \"Finding of blood group\" \u2014 prod returns 208 codes, dev returns 207 (code 1351894008 \"Mixed field RhD\" only in prod).\n\n2. **$expand without `used-codesystem` parameter** (GET requests for VSAC ValueSets): Prod uses SNOMED US edition 20250901, dev uses 20250301. Version difference is only visible in `contains[].version` strings. Example: ValueSet 2.16.840.1.113762.1.4.1240.3 (\"Sex\") \u2014 dev returns 5 codes including 184115007 \"Patient sex unknown (finding)\" which is absent from prod's 4-code expansion.\n\n3. **$validate-code message/issues text version skew**: Both sides agree on result=false, but the error message text and OperationOutcome issue text contain different SNOMED edition version strings (e.g., \"version 'http://snomed.info/sct/900000000000207008/version/20250201'\" in prod vs \"version/20240201\" in dev). The message structure and content are otherwise identical \u2014 only the embedded version URI differs. All are POST /r4/ValueSet/$validate-code with SNOMED codes that are not found in the specified ValueSet.\n\n## How widespread\n\n82 records total:\n- 40 expand records with `used-codesystem` parameter (POST /r4/ValueSet/$expand with SNOMED filters)\n- 7 expand records without `used-codesystem` parameter (GET /r4/ValueSet/$expand for VSAC ValueSet 2.16.840.1.113762.1.4.1240.3)\n- 35 validate-code content-differs records where message/issues text contain SNOMED version strings that differ only due to edition version skew\n\n## What the tolerances cover\n\n- **`expand-snomed-version-skew-content`** (40 records): Matches expand records where both sides return 200, SNOMED `used-codesystem` versions differ, and code membership differs. Normalizes both sides to the intersection of codes and adjusts total.\n\n- **`expand-snomed-version-skew-content-no-used-cs`** (7 records): Matches expand records where SNOMED version skew is detectable only from `contains[].version` strings (no `used-codesystem` expansion parameter). Same normalization approach \u2014 intersects code membership, adjusts total, and normalizes version strings to prod's values.\n\n- **`snomed-version-skew-message-text`** (35 records): Matches validate-code Parameters responses where SNOMED version strings in the `message` valueString and `issues` OperationOutcome issue text differ, but the text is otherwise identical after version normalization. Replaces dev's SNOMED version URIs with prod's values in both the message parameter and issue detail text fields.\n"}
