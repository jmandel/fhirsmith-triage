{"id":"f33161f","title":"f33161f [open] Dev returns 400 error instead of 200 toocostly expansion for grammar-based code systems","body":"f33161f [open] Dev returns 400 error instead of 200 toocostly expansion for grammar-based code systems\n\nClaude (AI Assistant) opened this issue 2026-02-07 17:28:46 -0600 CST\nThis was last edited at 2026-02-08 10:52:57 -0600 CST\n\nlabels: reproduced, round:2026-02-round-2, status-mismatch, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  ff33331 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 12\nTolerance-ID: expand-toocostly-grammar-400\nRecord-ID: 4a993d89-3f8b-444d-9a63-e95c6944c4a7\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"x-system-cache-id\",\"valueString\":\"dc8fd4bc-091a-424a-8a3b-6198ef146891\"},{\"name\":\"defaultDisplayLanguage\",\"valueCode\":\"en-US\"},{\"name\":\"_limit\",\"valueInteger\":10000},{\"name\":\"_incomplete\",\"valueBoolean\":true},{\"name\":\"displayLanguage\",\"valueCode\":\"en\"},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"excludeNested\",\"valueBoolean\":false},{\"name\":\"cache-id\",\"valueId\":\"26888bd4-58f1-4cae-b379-f6f52937a918\"},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"all-languages\",\"status\":\"active\",\"compose\":{\"include\":[{\"system\":\"urn:ietf:bcp:47\"}]}}}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"x-system-cache-id\",\"valueString\":\"dc8fd4bc-091a-424a-8a3b-6198ef146891\"},{\"name\":\"defaultDisplayLanguage\",\"valueCode\":\"en-US\"},{\"name\":\"_limit\",\"valueInteger\":10000},{\"name\":\"_incomplete\",\"valueBoolean\":true},{\"name\":\"displayLanguage\",\"valueCode\":\"en\"},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"excludeNested\",\"valueBoolean\":false},{\"name\":\"cache-id\",\"valueId\":\"26888bd4-58f1-4cae-b379-f6f52937a918\"},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"all-languages\",\"status\":\"active\",\"compose\":{\"include\":[{\"system\":\"urn:ietf:bcp:47\"}]}}}]}'\n```\n\nProd returns HTTP 200 with a ValueSet containing the `valueset-toocostly` extension (`valueBoolean: true`) and `limitedExpansion` parameter. Dev returns HTTP 400 with an OperationOutcome: `code: \"too-costly\"`, message: `\"The code System \\\"urn:ietf:bcp:47\\\" has a grammar, and cannot be enumerated directly\"`.\n\n\nWhen expanding a ValueSet that includes a grammar-based code system (BCP-47 `urn:ietf:bcp:47` or SNOMED CT `http://snomed.info/sct`) without any filter constraints, prod returns HTTP 200 with a ValueSet containing the `valueset-toocostly` extension and `limitedExpansion` parameter (indicating the expansion is too large to enumerate). Dev instead returns HTTP 400 with an OperationOutcome error (`code: \"too-costly\"`, message: \"The code System ... has a grammar, and cannot be enumerated directly\").\n\nProd's approach (returning a ValueSet with the toocostly extension) is the expected FHIR behavior for expansions that are too costly to compute \u2014 it signals the condition without failing the request.\n\n\n12 records in the comparison dataset show this pattern:\n- 8 records involve BCP-47 (`urn:ietf:bcp:47`), including the `all-languages` ValueSet\n- 4 records involve SNOMED CT (`http://snomed.info/sct`)\n- Affects both /r4/ and /r5/ endpoints\n- All are POST /r{4,5}/ValueSet/$expand requests\n\nSearch: `grep 'has a grammar' deltas.ndjson` finds 223 matches across all records (most already handled by existing tolerances), but filtering to status-mismatch expand records with prod=200/dev=400 and dev issue code \"too-costly\" yields exactly 12.\n\n\nTolerance ID: `expand-toocostly-grammar-400`. Matches $expand requests where prod returns 200 with the `valueset-toocostly` extension and dev returns 400 with an OperationOutcome containing issue code \"too-costly\". Skips these records entirely since the status codes and response formats are incomparable.\n\n\n- `4a993d89-3f8b-444d-9a63-e95c6944c4a7` (BCP-47, /r4/)\n- `b96706f9-c555-40e7-bdd2-f682fe2d5d88` (SNOMED, /r4/)\n- `d61127b2-3ed1-4deb-b11b-b8ccc77185ed` (BCP-47, /r5/)\n"}
{"id":"44d1916","title":"44d1916 [open] Dev returns 200 expansion instead of 422 too-costly for large code systems (LOINC, MIME types)","body":"44d1916 [open] Dev returns 200 expansion instead of 422 too-costly for large code systems (LOINC, MIME types)\n\nClaude (AI Assistant) opened this issue 2026-02-07 17:34:53 -0600 CST\nThis was last edited at 2026-02-08 10:52:56 -0600 CST\n\nlabels: reproduced, round:2026-02-round-2, status-mismatch, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  4444dd1 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 17\nTolerance-ID: expand-too-costly-succeeds\nRecord-ID: d9734f68-d8b4-475d-9204-632c9b4ccbf0\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r5/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"status\":\"active\",\"compose\":{\"inactive\":true,\"include\":[{\"system\":\"http://loinc.org\"}]}}}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r5/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"status\":\"active\",\"compose\":{\"inactive\":true,\"include\":[{\"system\":\"http://loinc.org\"}]}}}]}'\n```\n\nProd returns HTTP 422 with OperationOutcome: `{\"resourceType\":\"OperationOutcome\", \"issue\":[{\"severity\":\"error\",\"code\":\"too-costly\",\"details\":{\"text\":\"The value set '' expansion has too many codes to display (>10000)\"}}]}`.\n\nDev returns HTTP 200 with a ValueSet containing 1000 LOINC codes in the expansion (respecting the `count` parameter for pagination).\n\n\nWhen expanding ValueSets that include very large code systems (all of LOINC via `http://loinc.org`, or MIME types via `http://hl7.org/fhir/ValueSet/mimetypes`), prod returns HTTP 422 with an OperationOutcome containing `issue.code: \"too-costly\"` and message \"The value set '' expansion has too many codes to display (>10000)\". Dev returns HTTP 200 with a ValueSet containing up to 1000 codes (honoring the count parameter for pagination).\n\nProd correctly enforces an expansion size guard \u2014 refusing to expand code systems with >10000 codes even when pagination parameters are present. Dev does not enforce this guard and instead returns a paginated result.\n\n\n17 records in the comparison dataset show this pattern:\n- 6 records: POST `/r5/ValueSet/$expand` expanding all of LOINC (`http://loinc.org`, with `inactive: true`)\n- 11 records: GET `/r4/ValueSet/$expand?url=http%3A%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fmimetypes` expanding MIME types\n\nSearch method: `grep 'too-costly' deltas.ndjson` finds 273 records total; filtering to `status-mismatch` category (prod=422, dev=200) yields 17. The remaining 256 are `dev-crash-on-error` (prod=422, dev=500) \u2014 same root cause but different symptom (dev crashes rather than succeeding).\n\nAdditionally, there are likely records already eliminated by the prior `expand-too-costly-succeeds` tolerance (bug e3fb3f6, which appears to have been removed from git-bug). The current tolerance was scoped too narrowly (exact URL match on `/r4/ValueSet/$expand` only, missing GET requests with query params and /r5/ requests).\n\n\nTolerance ID: `expand-too-costly-succeeds`. Matches any $expand request (any FHIR version, GET or POST) where prod returns 422 with an OperationOutcome containing `issue.code: \"too-costly\"` and dev returns 200. Skips these records entirely since the responses are fundamentally incomparable (error vs success).\n\n\n- `d9734f68-d8b4-475d-9204-632c9b4ccbf0` (LOINC, POST /r5/ValueSet/$expand)\n- `3a2672db-cb0d-4312-87f1-5d6b685fbfe0` (MIME types, GET /r4/ValueSet/$expand?url=...mimetypes)\n"}
{"id":"4aebc14","title":"4aebc14 [open] Dev -code result=false for SNOMED codes valid in prod due to older SNOMED edition","body":"4aebc14 [open] Dev -code result=false for SNOMED codes valid in prod due to older SNOMED edition\n\nClaude (AI Assistant) opened this issue 2026-02-07 17:57:18 -0600 CST\nThis was last edited at 2026-02-08 11:49:47 -0600 CST\n\nlabels: config-issue, reproduced, result-disagrees, round:2026-02-round-2, to-discuss, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  44aaeeb #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 57\nTolerance-ID: snomed-version-skew-validate-code-result-disagrees\nRecord-ID: a74520f2-677a-41d4-a489-57b323c8dfb9\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code?' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://snomed.info/sct\",\"code\":\"39154008\",\"display\":\"Clinical diagnosis\"}},{\"name\":\"valueSetMode\",\"valueString\":\"NO_MEMBERSHIP_CHECK\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"ndhm-diagnosis-use\",\"url\":\"https://nrces.in/ndhm/fhir/r4/ValueSet/ndhm-diagnosis-use\",\"version\":\"6.5.0\",\"compose\":{\"include\":[{\"system\":\"http://snomed.info/sct\",\"filter\":[{\"property\":\"concept\",\"op\":\"is-a\",\"value\":\"106229004\"}]}],\"exclude\":[{\"system\":\"http://snomed.info/sct\",\"concept\":[{\"code\":\"106229004\",\"display\":\"Qualifier for type of diagnosis\"}]}]}}},{\"name\":\"system-version\",\"valueString\":\"http://snomed.info/sct|http://snomed.info/sct/900000000000207008\"}]}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://snomed.info/sct\",\"code\":\"39154008\",\"display\":\"Clinical diagnosis\"}},{\"name\":\"valueSetMode\",\"valueString\":\"NO_MEMBERSHIP_CHECK\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"ndhm-diagnosis-use\",\"url\":\"https://nrces.in/ndhm/fhir/r4/ValueSet/ndhm-diagnosis-use\",\"version\":\"6.5.0\",\"compose\":{\"include\":[{\"system\":\"http://snomed.info/sct\",\"filter\":[{\"property\":\"concept\",\"op\":\"is-a\",\"value\":\"106229004\"}]}],\"exclude\":[{\"system\":\"http://snomed.info/sct\",\"concept\":[{\"code\":\"106229004\",\"display\":\"Qualifier for type of diagnosis\"}]}]}}},{\"name\":\"system-version\",\"valueString\":\"http://snomed.info/sct|http://snomed.info/sct/900000000000207008\"}]}'\n```\n\nProd returns `result: true` with SNOMED version 20250201. Dev returns `result: false` with SNOMED version 20240201 and an error message that code 39154008 was not found in the ValueSet.\n\n## What differs\n\nOn ValueSet $validate-code operations with SNOMED CT codes, prod returns result=true while dev returns result=false. The root cause is that dev loads older SNOMED CT editions than prod (e.g., International 20240201 vs 20250201, US 20240201 vs 20250901). When a ValueSet uses hierarchy-based filters (e.g., is-a or descendent-of), the code membership can differ between SNOMED versions because the hierarchical relationships change between editions.\n\nFor example, in the representative record, SNOMED code 39154008 (\"Clinical diagnosis\") is validated against ValueSet ndhm-diagnosis-use (which filters for descendants of 106229004 \"Qualifier for type of diagnosis\"). Prod (version 20250201) says the code is in the ValueSet; dev (version 20240201) says it is not.\n\n## How widespread\n\n57 records in the full comparison.ndjson have SNOMED version-skewed validate-code result disagreements. Of those, 12 still appear in deltas.ndjson (the remaining 45 are already handled by other tolerances, likely because they also have status mismatches). Found via:\n\n```python\n# Check all validate-code records for SNOMED version skew + result disagreement\n# across comparison.ndjson\n```\n\nAffected SNOMED modules: International (20240201 vs 20250201) and US (20240201/20230301 vs 20250901). Multiple codes affected: 39154008, 116154003, 309343006, 1287116005, 428041000124106, and others.\n\n## What the tolerance covers\n\nTolerance `snomed-version-skew-validate-code-result-disagrees` skips validate-code records where both prod and dev return 200, both have SNOMED version parameters that differ, and the result boolean disagrees. This is the validate-code counterpart of the existing expand-snomed-version-skew-content tolerance (bug 9fd2328). Eliminates 1 delta record (the others are already handled by existing status-mismatch tolerances).\n\n## Related\n\nSame root cause as bug 9fd2328 (Dev loads older SNOMED CT edition), which covers $expand operations.\n"}
{"id":"1433eb6","title":"1433eb6 [open] Dev returns 400 ValueSet-not-found for validate-code requests that prod handles successfully (10 records)","body":"1433eb6 [open] Dev returns 400 ValueSet-not-found for validate-code requests that prod handles successfully (10 records)\n\nClaude (AI Assistant) opened this issue 2026-02-07 18:02:54 -0600 CST\nThis was last edited at 2026-02-08 10:52:55 -0600 CST\n\nlabels: reproduced, round:2026-02-round-2, status-mismatch, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  1144333 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 10\nTolerance-ID: validate-code-valueset-not-found-dev-400\nRecord-ID: 064711fa-e287-430e-a6f4-7ff723952ff1\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"url\",\"valueUri\":\"http://hl7.org/fhir/ValueSet/@all\"},{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"http://snomed.info/sct\",\"code\":\"48546005\",\"display\":\"Diazepam-containing product\"}]}},{\"name\":\"displayLanguage\",\"valueCode\":\"en-US\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"url\",\"valueUri\":\"http://hl7.org/fhir/ValueSet/@all\"},{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"http://snomed.info/sct\",\"code\":\"48546005\",\"display\":\"Diazepam-containing product\"}]}},{\"name\":\"displayLanguage\",\"valueCode\":\"en-US\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n```\n\nProd returns HTTP 200 with `{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"result\",\"valueBoolean\":true},...]}` indicating successful validation. Dev returns HTTP 400 with `{\"resourceType\":\"OperationOutcome\",\"issue\":[{\"severity\":\"error\",\"code\":\"not-found\",\"details\":{\"text\":\"A definition for the value Set 'http://hl7.org/fhir/ValueSet/@all' could not be found\"}}]}`.\n\nFor $validate-code requests against certain ValueSets, prod returns HTTP 200 with a valid Parameters response (result=true or result=false), while dev returns HTTP 400 with an OperationOutcome saying \"A definition for the value Set '...' could not be found.\"\n\nProd successfully resolves these ValueSets and performs code validation. Dev fails at the ValueSet resolution step and returns an error instead of a validation result.\n\n\n10 records show this pattern (prod=200, dev=400 with \"could not be found\"):\n\n- 3 records: `nrces.in/ndhm/fhir/r4/ValueSet/ndhm-diagnosis-use*` (Indian NDHM ValueSets)\n- 5 records: `ontariohealth.ca/fhir/ValueSet/*` (Ontario Health ValueSets)\n- 2 records: `hl7.org/fhir/ValueSet/@all` (special @all ValueSet)\n\nSearch: `grep 'could not be found' results/deltas/deltas.ndjson` filtered to prod=200 dev=400\n\nAll are POST /r4/ValueSet/$validate-code requests. The ValueSets come from different IG packages (NDHM India, Ontario Health, and core FHIR @all), so the root cause may be that dev is missing certain IG-provided ValueSet definitions or doesn't support the @all pseudo-ValueSet.\n\n\nTolerance `validate-code-valueset-not-found-dev-400` matches: POST validate-code, prod=200, dev=400, where dev body contains OperationOutcome with \"could not be found\" text. Eliminates all 10 records.\n\n\n- 064711fa-e287-430e-a6f4-7ff723952ff1 (nrces.in ndhm-diagnosis-use--0)\n- 5beceead-a754-4f88-8dec-1a7a931166b9 (ontariohealth.ca symptoms-of-clinical-concern)\n- 38f6e665-4c34-4589-8d29-77c522b97845 (hl7.org/fhir/ValueSet/@all)\n"}
{"id":"1932f81","title":"1932f81 [open] Dev returns SQLITE_MISUSE error on RxNorm-related $expand requests","body":"1932f81 [open] Dev returns SQLITE_MISUSE error on RxNorm-related $expand requests\n\nClaude (AI Assistant) opened this issue 2026-02-07 18:11:11 -0600 CST\nThis was last edited at 2026-02-08 10:52:55 -0600 CST\n\nlabels: content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  1199332 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 16\nTolerance-ID: dev-sqlite-misuse-expand-rxnorm\nRecord-ID: e108a92a-a962-45b4-ad35-e0aa4fe4cf32\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?_limit=1000&_incomplete=true' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"x-system-cache-id\",\n      \"valueString\": \"dc8fd4bc-091a-424a-8a3b-6198ef146891\"\n    },\n    {\n      \"name\": \"includeDefinition\",\n      \"valueBoolean\": false\n    },\n    {\n      \"name\": \"excludeNested\",\n      \"valueBoolean\": false\n    },\n    {\n      \"name\": \"valueSet\",\n      \"resource\": {\n        \"resourceType\": \"ValueSet\",\n        \"status\": \"active\",\n        \"compose\": {\n          \"inactive\": true,\n          \"include\": [\n            {\n              \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\"\n            }\n          ]\n        }\n      }\n    },\n    {\n      \"name\": \"_limit\",\n      \"valueString\": \"1000\"\n    },\n    {\n      \"name\": \"_incomplete\",\n      \"valueString\": \"true\"\n    }\n  ]\n}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?_limit=1000&_incomplete=true' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"x-system-cache-id\",\n      \"valueString\": \"dc8fd4bc-091a-424a-8a3b-6198ef146891\"\n    },\n    {\n      \"name\": \"includeDefinition\",\n      \"valueBoolean\": false\n    },\n    {\n      \"name\": \"excludeNested\",\n      \"valueBoolean\": false\n    },\n    {\n      \"name\": \"valueSet\",\n      \"resource\": {\n        \"resourceType\": \"ValueSet\",\n        \"status\": \"active\",\n        \"compose\": {\n          \"inactive\": true,\n          \"include\": [\n            {\n              \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\"\n            }\n          ]\n        }\n      }\n    },\n    {\n      \"name\": \"_limit\",\n      \"valueString\": \"1000\"\n    },\n    {\n      \"name\": \"_incomplete\",\n      \"valueString\": \"true\"\n    }\n  ]\n}'\n```\n\nProd returns 500 with `\"fdb_sqlite3_objects error: no such column: cui1\"` (specific database schema error). Dev returns 500 with `\"SQLITE_MISUSE: not an error\"` (generic SQLite misuse error).\n\n## What differs\n\nDev returns 500 with error message \"SQLITE_MISUSE: not an error\" on POST /r4/ValueSet/$expand requests involving RxNorm-related code systems. This affects two sub-patterns:\n\n1. **8 records (both 500)**: Prod also returns 500 but with a different, more descriptive SQLite error: \"fdb_sqlite3_objects error: no such column: cui1\". Both servers crash, but dev's error is generic/unhelpful while prod's points to a specific database schema issue.\n\n2. **8 records (prod 422, dev 500)**: Prod returns 422 with a proper error message like \"A definition for CodeSystem 'https://hl7.org/fhir/sid/ndc' could not be found, so the value set cannot be expanded\". Dev crashes with 500 SQLITE_MISUSE instead of returning a proper error response.\n\nAll 16 records are POST requests to /r4/ValueSet/$expand?_limit=1000&_incomplete=true with request bodies that include RxNorm (http://www.nlm.nih.gov/research/umls/rxnorm) in the ValueSet compose.\n\n## How widespread\n\n16 records total in the dataset. All are expand operations on the same URL pattern. Searched with:\n  grep -c 'SQLITE_MISUSE' results/deltas/deltas.ndjson  \u2192 16\n\nAll have the same dev error text \"SQLITE_MISUSE: not an error\". The prod responses vary between internal SQLite errors (500) and proper FHIR error responses (422).\n\n## What the tolerance covers\n\nTolerance ID: dev-sqlite-misuse-expand-rxnorm\nMatches records where the dev response is an OperationOutcome containing \"SQLITE_MISUSE\" in the error details, on $expand operations. Skips the entire record since dev's crash prevents meaningful content comparison.\nEliminates 16 records.\n"}
{"id":"4f12dda","title":"4f12dda [open] Dev loads older SNOMED CT and CPT editions, causing expand contains[].version to differ","body":"4f12dda [open] Dev loads older SNOMED CT and CPT editions, causing expand contains[].version to differ\n\nClaude (AI Assistant) opened this issue 2026-02-07 18:18:00 -0600 CST\nThis was last edited at 2026-02-08 11:49:47 -0600 CST\n\nlabels: config-issue, content-differs, reproduced, round:2026-02-round-2, to-discuss, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  44ff112 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 198\nTolerance-ID: expand-contains-version-skew\nRecord-ID: 6f9cf4c7-e6f4-445c-bc86-323b2b6d7165\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fcts.nlm.nih.gov%2Ffhir%2FValueSet%2F2.16.840.1.113762.1.4.1267.23&_format=json' \\\n  -H 'Accept: application/fhir+json' | jq '.expansion.contains[:3] | map({system, code, version})'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fcts.nlm.nih.gov%2Ffhir%2FValueSet%2F2.16.840.1.113762.1.4.1267.23&_format=json' \\\n  -H 'Accept: application/fhir+json' | jq '.expansion.contains[:3] | map({system, code, version})'\n```\n\nProd returns SNOMED version `http://snomed.info/sct/731000124108/version/20250901` and CPT version `2026`, dev returns SNOMED version `http://snomed.info/sct/731000124108/version/20250301` and CPT version `2025`.\n\n## What differs\n\nIn $expand responses, prod and dev return the same set of codes (same system + code pairs) but with different `version` strings on `expansion.contains[]` entries:\n\n- **SNOMED CT US edition**: prod returns `http://snomed.info/sct/731000124108/version/20250901`, dev returns `http://snomed.info/sct/731000124108/version/20250301`\n- **CPT (AMA)**: prod returns `2026`, dev returns `2025`\n\nBoth sides return 200 with identical code membership (280 codes in the representative record), but each code's version field reflects the loaded edition.\n\nThis differs from bug 9fd2328, which covers the case where SNOMED version skew causes *different* code sets to appear. Here, the codes are the same \u2014 only the version annotations differ.\n\n## How widespread\n\n198 expand delta records exhibit this pattern. All are the same ValueSet URL (`http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1267.23`) requested with different parameters. Each contains 280 codes with both SNOMED and CPT codes, where all codes match but version strings differ.\n\nFound via:\n```python\n# For each expand delta with same code membership,\n# check if contains[].version differs for common codes\n```\n\n## What the tolerance covers\n\nTolerance `expand-contains-version-skew` matches expand records where both sides return 200, the code membership is identical, but `contains[].version` strings differ for common codes. It normalizes all `contains[].version` values to prod's values. This only triggers when code sets are the same (no extra/missing codes) \u2014 the existing `expand-snomed-version-skew-content` tolerance handles cases with code membership differences.\n"}
{"id":"af1ce69","title":"af1ce69 [open] validate-code: dev renders null status as literal 'null' in inactive concept message","body":"af1ce69 [open] validate-code: dev renders null status as literal 'null' in inactive concept message\n\nClaude (AI Assistant) opened this issue 2026-02-07 18:53:06 -0600 CST\nThis was last edited at 2026-02-08 10:52:57 -0600 CST\n\nlabels: content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  aaff11c #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 24\nTolerance-ID: validate-code-null-status-in-message\nRecord-ID: 20db1af0-c1c6-4f83-9019-2aaeff9ef549\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/CodeSystem/$validate-code?url=http:%2F%2Fwww.nlm.nih.gov%2Fresearch%2Fumls%2Frxnorm&code=70618&_format=json' \\\n  -H 'Accept: application/fhir+json' | jq -r '.parameter[] | select(.name == \"message\") | .valueString'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/CodeSystem/$validate-code?url=http:%2F%2Fwww.nlm.nih.gov%2Fresearch%2Fumls%2Frxnorm&code=70618&_format=json' \\\n  -H 'Accept: application/fhir+json' | jq -r '.parameter[] | select(.name == \"message\") | .valueString'\n```\n\nProd returns `\"The concept '70618' has a status of  and its use should be reviewed\"` (empty string for status), dev returns `\"The concept '70618' has a status of null and its use should be reviewed\"` (literal word \"null\").\n\n## What differs\n\nIn $validate-code responses for inactive concepts, the message and issues text differ in how a missing status value is rendered:\n\n- Prod: `\"The concept '70618' has a status of  and its use should be reviewed\"` (empty string for status)\n- Dev: `\"The concept '70618' has a status of null and its use should be reviewed\"` (literal word \"null\")\n\nBoth servers agree on result=true, inactive=true, display, system, and version. The only difference is this string interpolation of a null/missing status value in the INACTIVE_CONCEPT_FOUND message.\n\n## How widespread\n\n24 records in the current delta file, all identical: GET /r4/CodeSystem/$validate-code for RxNorm code 70618. The same underlying pattern (empty vs \"null\" in status message) also affects 20 NDC records already covered by a separate tolerance (ndc-validate-code-extra-inactive-params, bug 7258b41).\n\nSearch: `grep 'has a status of  and' results/deltas/deltas.ndjson | wc -l` \u2192 24\nAll 24 are validate-code operations on http://www.nlm.nih.gov/research/umls/rxnorm, code 70618.\n\n## What the tolerance covers\n\nTolerance ID: validate-code-null-status-in-message\nMatches: validate-code Parameters responses where prod message contains \"status of \" (empty) and dev message contains \"status of null\" at the same position. Normalizes both message and issues text by replacing \"status of null\" with \"status of \" (prod's rendering) in dev. Eliminates 24 delta records.\n"}
{"id":"e4e45bc","title":"e4e45bc [open] Dev returns 200 instead of 422 for validate-code with code but no system parameter","body":"e4e45bc [open] Dev returns 200 instead of 422 for validate-code with code but no system parameter\n\nClaude (AI Assistant) opened this issue 2026-02-07 18:56:50 -0600 CST\nThis was last edited at 2026-02-08 10:52:57 -0600 CST\n\nlabels: reproduced, round:2026-02-round-2, status-mismatch, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  ee44ee4 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 133\nTolerance-ID: validate-code-no-system-422\nRecord-ID: 5ea323a9-073d-4ebf-b1ae-0a374b35c26d\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code?url=http%3A%2F%2Fterminology.hl7.org%2FValueSet%2FUSPS-State&code=TX&_format=json' \\\n  -H 'Accept: application/fhir+json'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http%3A%2F%2Fterminology.hl7.org%2FValueSet%2FUSPS-State&code=TX&_format=json' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 422 with OperationOutcome: \"Unable to find code to validate (looked for coding | codeableConcept | code+system | code+inferSystem in parameters ...)\". Dev returns HTTP 200 with Parameters containing `result=true`, `system=https://www.usps.com/`, `code=TX`, `display=Texas`.\n\n\nWhen $validate-code is called with `code` but no `system` parameter (and no `context`), prod returns HTTP 422 with an OperationOutcome error: \"Unable to find code to validate (looked for coding | codeableConcept | code+system | code+inferSystem in parameters ...)\". Dev returns HTTP 200 with a successful Parameters response, inferring the system from the ValueSet.\n\nPer the FHIR spec for ValueSet/$validate-code: \"If a code is provided, a system or a context must be provided.\" Prod correctly rejects these requests; dev incorrectly accepts them by inferring the system.\n\n\n133 records across 14 distinct request URLs, all sharing the same pattern:\n- GET /r4/ValueSet/$validate-code with `url=...&code=...` but no `system` parameter\n- One POST /r4/CodeSystem/$validate-code with only `code` in the Parameters body (no system)\n\nExamples include ValueSets for USPS-State, defined-types, iso3166-1-2, mimetypes, languages, administrative-gender, encounter-status, event-status, patient-contactrelationship, and a CTS ValueSet.\n\nFound via: `grep '\"status-mismatch\"' deltas.ndjson > /tmp/sm.ndjson` then filtering for prod.status=422, dev.status=200, op=validate-code.\n\n\nTolerance ID: `validate-code-no-system-422`. Matches validate-code records where prod returns 422 and dev returns 200, and the request has `code` but no `system` parameter (checked in both URL query params and POST request body). Eliminates 133 records.\n\n\n5ea323a9-073d-4ebf-b1ae-0a374b35c26d \u2014 GET /r4/ValueSet/$validate-code?url=http:%2F%2Fterminology.hl7.org%2FValueSet%2FUSPS-State&code=TX&_format=json\n"}
