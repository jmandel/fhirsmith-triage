{"id":"2337986","title":"2337986 [open] Dev returns 404 instead of 422 when ValueSet not found for $expand","body":"2337986 [open] Dev returns 404 instead of 422 when ValueSet not found for $expand\n\nClaude (AI Assistant) opened this issue 2026-02-07 15:17:11 -0600 CST\nThis was last edited at 2026-02-08 10:52:56 -0600 CST\n\nlabels: code-defect, reproduced, round:2026-02-round-2, status-mismatch, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  2233337 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 756\nTolerance-ID: expand-valueset-not-found-status-mismatch\nRecord-ID: 8b7a9262-90d3-4753-a197-9a631ffdcf2f\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fdavinci-pdex-plan-net%2FValueSet%2FPractitionerRoleVS&_format=json' \\\n  -H 'Accept: application/fhir+json'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fdavinci-pdex-plan-net%2FValueSet%2FPractitionerRoleVS&_format=json' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 422 with `issue.code: \"unknown\"` and `issue.details.text`, dev returns HTTP 404 with `issue.code: \"not-found\"` and `issue.diagnostics`.\n\n\nWhen a ValueSet cannot be found for a $expand operation, prod returns HTTP 422 (Unprocessable Entity) with an OperationOutcome using issue code `unknown` and `details.text`, while dev returns HTTP 404 (Not Found) with issue code `not-found` and `diagnostics`. Both communicate the same semantic meaning (\"this ValueSet doesn't exist\"), but the HTTP status code and OperationOutcome structure differ.\n\nProd response (status 422):\n- issue.code: \"unknown\"\n- issue.details.text: \"Unable to find value set for URL \\\"...\\\"\"\n\nDev response (status 404):\n- issue.code: \"not-found\"\n- issue.diagnostics: \"ValueSet not found: ...\"\n\n\n756 records in the comparison dataset show this exact pattern (prod=422, dev=404). All are $expand operations (722 GET, 34 POST) across many different ValueSet URLs. The pattern is universal \u2014 every prod=422/dev=404 status mismatch is an $expand of an unknown ValueSet.\n\nSearch used: `grep -c '\"prodStatus\":422,\"devStatus\":404' results/deltas/deltas.ndjson`\n\n\nTolerance ID: `expand-valueset-not-found-status-mismatch`\nMatches: $expand operations where prod=422 and dev=404, and both responses are OperationOutcomes indicating a ValueSet was not found.\nRecords eliminated: 756\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** returns HTTP 422 with issue code `unknown` for unfound ValueSets:\n[`server/tx_operations.pas#L335-L336`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx_operations.pas#L335-L336)\n\u2014 Raises `ETerminologyError` with `itUnknown` when ValueSet URL lookup fails during $expand.\n\n[`server/endpoint_storage.pas#L1553-L1561`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/endpoint_storage.pas#L1553-L1561)\n\u2014 All `ETerminologyError` exceptions are caught and returned with `HTTP_ERR_BUSINESS_RULES_FAILED` (422), preserving the exception's `issueType` (`itUnknown` -> `\"unknown\"`) in the OperationOutcome.\n\n**Dev** returns HTTP 404 with issue code `not-found`:\n[`tx/workers/expand.js#L1669-L1672`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/expand.js#L1669-L1672)\n\u2014 When `findValueSet` returns null, the expand handler returns `res.status(404)` with issue code `not-found` and puts the error message only in `diagnostics`.\n\nThere are two divergences:\n1. **HTTP status**: Dev uses 404 instead of 422. Prod treats all terminology errors as \"business rules failed\" (422), regardless of whether the issue is \"not found\" or something else.\n2. **Issue code**: Dev uses `not-found` instead of `unknown`. Prod uses `itUnknown` because the error semantics are \"the system doesn't know this ValueSet\", not a pure resource-not-found.\n\n**Fix**: In `tx/workers/expand.js` line 1670, change `res.status(404)` to `res.status(422)` and change the issue code from `'not-found'` to `'unknown'` to match prod's behavior. The same fix should be applied to `tx/workers/related.js` line 1670 which has identical code.\n"}
{"id":"cd4b7d1","title":"cd4b7d1 [open] Dev returns 400 instead of 422 for error responses across validate-code and expand operations","body":"cd4b7d1 [open] Dev returns 400 instead of 422 for error responses across validate-code and expand operations\n\nClaude (AI Assistant) opened this issue 2026-02-07 15:22:58 -0600 CST\nThis was last edited at 2026-02-08 10:52:57 -0600 CST\n\nlabels: code-defect, reproduced, round:2026-02-round-2, status-mismatch, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  ccdd44b #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 1897\nTolerance-ID: error-status-422-vs-400\nRecord-ID: e5639442-a91b-4de0-b1d9-9b901023b6c1\n\n## Repro\n\n```bash\n# Prod\ncurl -s -w \"\\nHTTP Status: %{http_code}\\n\" \\\n  'https://tx.fhir.org/r4/ValueSet/$validate-code?url=http://hl7.org/fhir/us/davinci-pdex-plan-net/ValueSet/PractitionerRoleVS&code=ho&_format=json&system=http://hl7.org/fhir/us/davinci-pdex-plan-net/CodeSystem/ProviderRoleCS' \\\n  -H 'Accept: application/fhir+json'\n\n# Dev\ncurl -s -w \"\\nHTTP Status: %{http_code}\\n\" \\\n  'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http://hl7.org/fhir/us/davinci-pdex-plan-net/ValueSet/PractitionerRoleVS&code=ho&_format=json&system=http://hl7.org/fhir/us/davinci-pdex-plan-net/CodeSystem/ProviderRoleCS' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 422 with OperationOutcome (issue code \"not-found\"). Dev returns HTTP 400 with the same OperationOutcome content. Both agree on the error semantics (same error code, same error message), differing only in HTTP status.\n\n## What differs\n\nProd returns HTTP 422 (Unprocessable Entity) while dev returns HTTP 400 (Bad Request) for error responses. Both servers return OperationOutcome resources with error-level issues and agree on the error semantics (same error codes, same error messages). The only difference is the HTTP status code.\n\nExample: a $validate-code request for a ValueSet that doesn't exist. Both return OperationOutcome with issue code \"not-found\" and text \"A definition for the value Set '...' could not be found\", but prod uses 422 and dev uses 400.\n\n## How widespread\n\n1897 records in the comparison dataset show this pattern (prod=422, dev=400). All 1897 have OperationOutcome on both sides.\n\nBreakdown by operation type:\n- validate-code: 1331 records\n- expand: 566 records\n\nBoth GET and POST requests are affected. The pattern spans all FHIR versions (/r4/, etc.) and all code systems/ValueSets.\n\nFound via: grep -c '\"prodStatus\":422,\"devStatus\":400' results/deltas/deltas.ndjson\n\n## What the tolerance covers\n\nTolerance ID: error-status-422-vs-400\nMatches: any record where prod.status=422, dev.status=400, and both response bodies are OperationOutcome resources (resourceType check).\nAction: skip (since the status code difference IS the categorization trigger \u2014 normalizing bodies doesn't change the status-mismatch category).\nEliminates: 1897 records.\n\n## Representative record\n\ne5639442-a91b-4de0-b1d9-9b901023b6c1 \u2014 GET /r4/ValueSet/$validate-code for PractitionerRoleVS (davinci-pdex-plan-net). Prod=422, dev=400, both return \"not-found\" OperationOutcome.\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** returns HTTP 422 for all terminology operation errors via two mechanisms:\n\n1. For `$validate-code`, when the ValueSet is not found, it creates an OperationOutcome directly and sets `response.HTTPCode := 422`:\n[`server/tx_operations.pas#L611-L616`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx_operations.pas#L611-L616)\n\u2014 When `oOut` (OperationOutcome) is non-nil, the response code is hardcoded to 422. Same pattern at [line 882-887](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx_operations.pas#L882-L887) for the POST path.\n\n2. For `$expand` and other operations, `ETerminologyError` exceptions propagate to the general handler in `endpoint_storage.pas` which sends `HTTP_ERR_BUSINESS_RULES_FAILED`:\n[`server/endpoint_storage.pas#L1553-L1561`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/endpoint_storage.pas#L1553-L1561)\n\u2014 `HTTP_ERR_BUSINESS_RULES_FAILED` is defined as `422` in [`library/fhir/fhir_objects.pas#L900`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/fhir/fhir_objects.pas#L900).\n\n**Dev** returns HTTP 400 because error `Issue` objects are created with `statusCode = 400`:\n[`tx/workers/validate.js#L2212`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L2212)\n\u2014 \"ValueSet not found\" Issue is constructed with `400` as the last parameter. The catch block at [`tx/workers/validate.js#L2034-L2037`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L2034-L2037) uses `error.statusCode || 500`, so it sends 400. The same pattern appears throughout expand.js (e.g., [lines 515-533](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/expand.js#L515-L533)).\n\n**Fix**: Change the `statusCode` from `400` to `422` in all Issue constructors and `.handleAsOO()` calls across `validate.js` and `expand.js` where the error represents a terminology operation failure (not-found, invalid filter, missing supplement, etc.). The `Issue` constructor default at `operation-outcome.js:14` is already `500`, so each call site needs updating. Alternatively, change the error handler catch blocks (e.g., `validate.js:2037`, `expand.js:1555`) to always use `422` when the error is a terminology-level Issue, matching prod's convention that all terminology OperationOutcome responses use HTTP 422.\n"}
{"id":"167be81","title":"167be81 [open] Dev returns result=false for valid v3 terminology codes in ValueSet $validate-code","body":"167be81 [open] Dev returns result=false for valid v3 terminology codes in ValueSet $validate-code\n\nClaude (AI Assistant) opened this issue 2026-02-07 15:28:00 -0600 CST\nThis was last edited at 2026-02-08 10:52:55 -0600 CST\n\nlabels: code-defect, reproduced, result-disagrees, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  116677b #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 187\nTolerance-ID: v3-valueset-validate-code-result-disagrees\nRecord-ID: 92d4fd1a-70fc-4497-adb5-309a3f564716\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fconsent-category&code=INFA&_format=json&system=http:%2F%2Fterminology.hl7.org%2FCodeSystem%2Fv3-ActCode' \\\n  -H 'Accept: application/fhir+json'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fconsent-category&code=INFA&_format=json&system=http:%2F%2Fterminology.hl7.org%2FCodeSystem%2Fv3-ActCode' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns `result: true` (code is valid in the ValueSet), dev returns `result: false` with error message \"The provided code 'http://terminology.hl7.org/CodeSystem/v3-ActCode#INFA' was not found in the value set 'http://hl7.org/fhir/ValueSet/consent-category|4.0.1'\".\n\nThe bug reproduces across multiple ValueSets:\n- encounter-participant-type with code CON from v3-ParticipationType\n- v3-ActEncounterCode with code AMB from v3-ActCode\n\n## Root Cause\n\n**Classification**: code-level defect\n\nHL7 v3 CodeSystems (e.g., v3-ActCode, v3-ParticipationType, v3-RoleCode) use a **flat concept list** with a property named `subsumedBy` to define hierarchy. This property is declared with `uri: \"http://hl7.org/fhir/concept-properties#parent\"` \u2014 the standard FHIR URI for parent relationships \u2014 but with the non-standard property code `subsumedBy` instead of `parent`.\n\n**Prod** resolves hierarchy by matching on the property URI, not just the code:\n[`fhir_codesystem_service.pas#L438-L458`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_codesystem_service.pas#L438-L458)\n\u2014 In `loadCodeSystem`, iterates the CodeSystem's `property` declarations and matches any property where `prop.code = 'parent'` **or** `prop.uri = 'http://hl7.org/fhir/concept-properties#parent'`. This finds the `subsumedBy` property via its URI. Then uses `prop.code` (= `subsumedBy`) to look up concept-level properties and build parent-child relationships.\n\n**Dev** only matches on hardcoded property code names `parent` and `child`:\n[`tx/library/codesystem.js#L507-L523`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/codesystem.js#L507-L523)\n\u2014 In `_buildHierarchyMaps`, checks `property.code === 'parent'` and `property.code === 'child'` only. Never consults the CodeSystem's property declarations or their URIs. Since v3 CodeSystems use `subsumedBy` (not `parent`), no hierarchy relationships are built. `getDescendants('_ActConsentType')` returns empty, so `is-a` filter matching in `checkConceptSet` finds no descendants, and validation returns false.\n\n**Fix**: In `_buildHierarchyMaps`, look up the CodeSystem's `property` declarations to find which property code maps to `http://hl7.org/fhir/concept-properties#parent` (and `#child`), then use those codes when scanning concept properties \u2014 matching the prod server's approach.\n\n## What differs\n\nProd returns `result: true` for $validate-code of HL7 v3 terminology codes against their corresponding ValueSets. Dev returns `result: false` with message \"The provided code was not found in the value set.\"\n\nBoth servers agree on the CodeSystem version, code, and display text \u2014 dev can look up the code successfully in the CodeSystem. But dev fails to determine that the code is a member of the ValueSet.\n\nExample (this record): GET /r4/ValueSet/$validate-code with system=v3-ActCode, code=INFA, url=consent-category.\n- Prod: result=true, version=9.0.0, display=\"information access\"\n- Dev: result=false, version=9.0.0, display=\"information access\", message=\"code not found in value set consent-category|4.0.1\"\n\n## How widespread\n\n187 records across 5 ValueSets, all GET requests, all r4, all using terminology.hl7.org/CodeSystem/v3-* systems:\n\n- 103 records: v3-ActEncounterCode ValueSet (codes AMB, IMP, HH, EMER from v3-ActCode)\n- 69 records: encounter-participant-type ValueSet (codes CON, ADM, ATND from v3-ParticipationType)\n- 9 records: consent-category ValueSet (code INFA from v3-ActCode)\n- 4 records: v3-ServiceDeliveryLocationRoleType ValueSet (codes ER, CARD, SLEEP from v3-RoleCode)\n- 2 records: v3-PurposeOfUse ValueSet (code HMARKT from v3-ActReason)\n\nSearch used: grep 'result-disagrees' deltas.ndjson, filtered to terminology.hl7.org/CodeSystem/v3-* systems.\n\n## What the tolerance covers\n\nTolerance `v3-valueset-validate-code-result-disagrees` skips records where:\n- Operation is ValueSet/$validate-code\n- System is terminology.hl7.org/CodeSystem/v3-*\n- prodResult=true, devResult=false\n- Both sides report the same CodeSystem version\n\nEliminates 187 records.\n"}
{"id":"6edc96c","title":"6edc96c [open] Dev loads different versions of HL7 terminology CodeSystems (terminology.hl7.org) than prod","body":"6edc96c [open] Dev loads different versions of HL7 terminology CodeSystems (terminology.hl7.org) than prod\n\nClaude (AI Assistant) opened this issue 2026-02-07 15:33:34 -0600 CST\nThis was last edited at 2026-02-08 10:52:56 -0600 CST\n\nlabels: config-issue, content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  66eeddc #0 Claude (AI Assistant) <>\n\n  Records-Impacted: ~465\nRecord-ID: 04364a8a-acce-491a-8018-9ac010d47d21, ef77e7ca-9afa-4325-a1f3-a939a62a490f, 7813f9ee-79ee-445b-8064-603a98e876bf, 83509e51-1a8b-4d77-8f4e-7b0037009c4a, 2d18564d-4e72-425d-aca0-358240df2c57, 118efc0f-ad5c-4db9-b9e6-2120a5824b92\nTolerance-ID: hl7-terminology-cs-version-skew, expand-hl7-terminology-version-skew-params, expand-hl7-terminology-version-skew-content, validate-code-hl7-terminology-vs-version-skew, expand-hl7-terminology-version-skew-vs-metadata, hl7-terminology-lookup-definition-designation-skew\n\n## Summary\n\nDev loads older/different versions of HL7 terminology CodeSystems and ValueSets (`http://terminology.hl7.org/CodeSystem/*`, `http://terminology.hl7.org/ValueSet/*`) than prod. For example, prod loads `consentcategorycodes` at version `4.0.1` while dev loads `1.0.1`; prod loads `observation-category` at `4.0.1` while dev loads `2.0.0`. Dev also loads different ValueSet versions (e.g., `v3-TribalEntityUS|4.0.0` vs dev's `|2018-08-12`, `v3-ActEncounterCode|3.0.0` vs dev's `|2014-03-26`). This version skew is the single root cause behind six distinct manifestations affecting `$validate-code`, `$expand`, and `$lookup` operations.\n\nKnown affected CodeSystems and their version mismatches:\n- `consentcategorycodes`: prod=4.0.1, dev=1.0.1\n- `goal-achievement`: prod=4.0.1, dev=1.0.1\n- `observation-category`: prod=4.0.1, dev=2.0.0\n- `consentpolicycodes`: prod=4.0.1, dev=3.0.1\n- `condition-category`: prod=4.0.1, dev=2.0.0\n- `condition-clinical`: prod=4.0.1, dev=3.0.0\n- `v2-0116`: prod=2.9, dev=3.0.0\n\nKnown affected ValueSets:\n- `v3-ActEncounterCode`: prod=3.0.0, dev=2014-03-26\n- `v3-TribalEntityUS`: prod=4.0.0, dev=2018-08-12\n\n## Tolerances\n\n### 1. `hl7-terminology-cs-version-skew` (~58 records)\n\n**What it handles**: `$validate-code` responses where the only differences are CodeSystem version strings in the `version` parameter, `message` text, and `issues` OperationOutcome `details.text`. Also strips draft `status-check` informational issues that prod includes but dev omits (because dev loads a version that lacks the draft status metadata). Both servers agree on validation results for all affected codes.\n\n**Normalizes**: Dev's version parameter and version strings in message/issues text to prod's values; strips prod's draft status-check issues.\n\n**Representative record**: `04364a8a-acce-491a-8018-9ac010d47d21` \u2014 validate-code for `consentcategorycodes` where prod says \"version '4.0.1'\", dev says \"version '1.0.1'\".\n\n### 2. `expand-hl7-terminology-version-skew-params` (~236 records)\n\n**What it handles**: `$expand` responses where the `expansion.parameter` entries differ due to version skew. The `used-codesystem` version strings differ (e.g., `observation-category|4.0.1` vs `|2.0.0`) and prod includes `warning-draft` parameters that dev omits.\n\n**Normalizes**: `used-codesystem` versions for `terminology.hl7.org` systems to prod's values; strips `warning-draft` parameters from both sides.\n\n**Representative record**: `ef77e7ca-9afa-4325-a1f3-a939a62a490f` \u2014 expand of `us-core-simple-observation-category` where used-codesystem version and warning-draft differ.\n\n### 3. `expand-hl7-terminology-version-skew-content` (~163 records)\n\n**What it handles**: `$expand` responses where prod and dev return slightly different sets of codes (1-5 extra/missing) because different CodeSystem versions include different codes. For example, dev's older `consentpolicycodes` includes `ch-epr` (removed in 4.0.1), and dev's older `observation-category` includes an extra `symptom` code. The common codes between prod and dev are identical.\n\n**Normalizes**: Both sides to the intersection of codes present in both responses; adjusts the total count accordingly.\n\n**Representative record**: `7813f9ee-79ee-445b-8064-603a98e876bf` \u2014 expand of `consent-policy` where dev returns 27 codes vs prod's 26 (extra `ch-epr`).\n\n### 4. `validate-code-hl7-terminology-vs-version-skew` (4 records)\n\n**What it handles**: `$validate-code` responses where the only difference is the ValueSet version string in message text and issues details text. Both servers agree on `result=false` and all other parameters. The difference appears in \"not found in the value set 'url|version'\" messages where prod references the newer ValueSet version (e.g., `v3-ActEncounterCode|3.0.0`) and dev references the older version (e.g., `|2014-03-26`).\n\n**Normalizes**: ValueSet pipe-delimited version strings in message and issues text to prod's values.\n\n**Representative record**: `83509e51-1a8b-4d77-8f4e-7b0037009c4a` \u2014 validate-code for PLB in v3-ActEncounterCode where prod says `|3.0.0`, dev says `|2014-03-26`.\n\n### 5. `expand-hl7-terminology-version-skew-vs-metadata` (3 records)\n\n**What it handles**: `$expand` responses where the ValueSet-level metadata fields (date, name, title, version, identifier, language, immutable, meta) differ because prod and dev loaded different editions of the same HL7 terminology ValueSet. The expansion contents are handled by other tolerances (e.g., code intersection), but the wrapper metadata still reflects the different loaded ValueSet versions. For example, TribalEntityUS: prod returns version=4.0.0/name=TribalEntityUS/date=2014-03-26, dev returns version=2018-08-12/name=v3.TribalEntityUS/date=2018-08-12.\n\n**Normalizes**: Dev's metadata fields (date, name, title, version, identifier, language, immutable, meta) to prod's values.\n\n**Representative record**: `2d18564d-4e72-425d-aca0-358240df2c57` \u2014 expand of v3-TribalEntityUS where all ValueSet metadata differs between versions.\n\n### 6. `hl7-terminology-lookup-definition-designation-skew` (1 record)\n\n**What it handles**: `$lookup` responses for HL7 terminology CodeSystems where dev returns extra top-level `definition` and `designation` parameters that prod doesn't return. Dev has `definition` as a top-level parameter (with version-dependent text), while prod returns `definition` only as a property entry. Dev also includes a `designation` parameter with `preferredForLanguage` use that prod omits entirely. Both are consequences of dev loading a newer CodeSystem version with richer content.\n\n**Normalizes**: Strips `definition` and `designation` top-level parameters and `definition` property entries from both sides.\n\n**Representative record**: `118efc0f-ad5c-4db9-b9e6-2120a5824b92` \u2014 lookup of `active` in `condition-clinical` where dev (version 3.0.0) returns extra definition and designation, prod (version 4.0.1) returns definition only as a property.\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fterminology.hl7.org%2FValueSet%2Fv3-TribalEntityUS&incomplete-ok=true&_format=json' -H 'Accept: application/fhir+json' | jq '{version, name, title, date}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fterminology.hl7.org%2FValueSet%2Fv3-TribalEntityUS&incomplete-ok=true&_format=json' -H 'Accept: application/fhir+json' | jq '{version, name, title, date}'\n```\n\nProd returns `version=4.0.0, name=TribalEntityUS`, dev returns `version=2018-08-12, name=v3.TribalEntityUS`.\n\n\n  61e2d5c #1 Claude (AI Assistant) <>\n\n  The HL7 terminology CodeSystem version skew also affects $expand operations. Dev returns different expansion content (extra or missing codes) compared to prod for ValueSets using terminology.hl7.org CodeSystems.\n\n163 expand records have minor code differences (1-5 extra/missing codes, e.g., consent-policy 26 vs 27, observation-category 17 vs 18). The common codes between prod and dev are identical \u2014 only the set of included codes differs.\n\nAdditionally, 246 expand records show dev returning total=1 where prod returns many codes for v3 ValueSets. These may be a separate root cause (dev failing to expand v3 included ValueSets) but also involve terminology.hl7.org CodeSystems.\n\nAdding tolerance `expand-hl7-terminology-version-skew-content` for the 163 minor-diff records.\n\n\n  66ecd7c #2 Claude (AI Assistant) <>\n\n  ## Updated scope (as of round 71)\n\nThis bug now covers 3 tolerances handling different manifestations of the same root cause: dev loads older versions of HL7 terminology CodeSystems (terminology.hl7.org) than prod.\n\n### Tolerances\n\n1. **`hl7-terminology-cs-version-skew`** (original) \u2014 Normalizes version strings in $validate-code message text and OperationOutcome issue details. Covers ~58 validate-code records where the only difference is the version string in error messages (e.g., prod says \"version '4.0.1'\", dev says \"version '1.0.1'\").\n\n2. **`expand-hl7-terminology-version-skew-content`** \u2014 Intersects code membership in $expand results where prod and dev return slightly different code sets (1-5 extra/missing codes) due to the version skew. Covers ~163 expand records.\n\n3. **`expand-hl7-terminology-version-skew-params`** \u2014 Normalizes `used-codesystem` version strings in expansion parameters (e.g., `observation-category|4.0.1` vs `|2.0.0`) and strips `warning-draft` parameters that only prod includes. Covers ~236 expand records.\n\n### Total impact: ~457 records across validate-code and expand operations.\n\n55 records referencing terminology.hl7.org remain in the delta file, likely involving additional patterns not yet covered by these tolerances.\n\n\n  6be2dac #3 Claude (AI Assistant) <>\n\n  Adding tolerance `expand-hl7-terminology-used-valueset-version-skew` to cover used-valueset version differences.\n\nThe existing `expand-hl7-terminology-version-skew-params` tolerance handles used-codesystem and warning-draft parameter differences, but not used-valueset version strings. Prod reports newer HL7 terminology ValueSet versions (e.g., `|3.0.0`, `|3.1.0`) while dev reports older versions (e.g., `|2014-03-26`, `|2018-08-12`) for the same ValueSets. Same root cause \u2014 different loaded HL7 terminology editions.\n\nAlso adding `expand-hl7-terminology-extra-params` to handle prod including `displayLanguage` and `warning-retired` parameters that dev omits.\n\nThese tolerances affect the same 18 security-labels expand records. Updated total records impacted under this bug: ~255 (237 original + 18 new).\n"}
{"id":"4336772","title":"4336772 [open] Dev  returns only root concept for v3 hierarchical ValueSets (missing child codes)","body":"4336772 [open] Dev  returns only root concept for v3 hierarchical ValueSets (missing child codes)\n\nClaude (AI Assistant) opened this issue 2026-02-07 15:45:40 -0600 CST\nThis was last edited at 2026-02-08 10:52:56 -0600 CST\n\nlabels: code-defect, content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  4433336 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 246\nTolerance-ID: expand-v3-hierarchical-incomplete\nRecord-ID: 18d8209b-15f4-486d-8009-25ed8cb2cbcb\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http://terminology.hl7.org/ValueSet/v3-PurposeOfUse&_format=json' \\\n  -H 'Accept: application/fhir+json'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http://terminology.hl7.org/ValueSet/v3-PurposeOfUse&_format=json' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns `expansion.total=63` with 63 codes (PurposeOfUse root + 62 child codes like HMARKT, HOPERAT, TREAT, etc.). Dev returns `expansion.total=1` with only the root abstract concept `PurposeOfUse`.\n\n\nWhen expanding v3 ValueSets that include hierarchical concepts from `terminology.hl7.org/CodeSystem/v3-ActReason`, dev returns only the root abstract concept while prod returns the full hierarchy of child codes.\n\nFor example, expanding `http://terminology.hl7.org/ValueSet/v3-PurposeOfUse`:\n- Prod: `expansion.total=63`, contains 63 codes (PurposeOfUse root + 62 child codes like HMARKT, HOPERAT, TREAT, etc.)\n- Dev: `expansion.total=1`, contains only the root abstract concept `PurposeOfUse`\n\nThe same pattern affects 4 distinct v3 ValueSets:\n- `v3-ActEncounterCode`: prod=12 codes, dev=1 (209 records)\n- `v3-ServiceDeliveryLocationRoleType`: prod=139 codes, dev=1 (24 records)\n- `v3-PurposeOfUse`: prod=63 codes, dev=1 (6 records)\n- `v3-ActPharmacySupplyType`: prod=35 codes, dev=1 (7 records)\n\nIn all cases, dev returns only the root concept and completely omits the descendant codes that should be included in the expansion.\n\n\n246 records across the 4 ValueSets listed above. Found via:\n```bash\ngrep '\"op\":\"expand\"' jobs/2026-02-round-2/results/deltas/deltas.ndjson | python3 -c '...' # script checking prod_total>1 and dev_total==1\n```\n\nAll are GET requests to `/r4/ValueSet/$expand` with `url=http://terminology.hl7.org/ValueSet/v3-*`.\n\n\nTolerance ID: `expand-v3-hierarchical-incomplete`. Matches expand operations where both prod and dev return 200, the ValueSet URL matches `terminology.hl7.org/ValueSet/v3-`, and dev expansion total is 1 while prod expansion total is greater than 1. Skips these records. Eliminates 246 records.\n\n\nBug 6edc96c mentions these 246 records in a comment as potentially a separate root cause from the version skew issue. This bug tracks the specific failure to expand hierarchical v3 ValueSets.\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** resolves parent-child hierarchy from CodeSystem property definitions by matching on URI:\n[`library/ftx/fhir_codesystem_service.pas#L438-L458`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_codesystem_service.pas#L438-L458)\n\u2014 Iterates CodeSystem property definitions and matches any property where `code = 'parent'` OR `uri = 'http://hl7.org/fhir/concept-properties#parent'`. Then uses the matched property's actual `code` (e.g. `subsumedBy`) to find concept-level property entries and build parent-child relationships.\n\n**Dev** only matches hardcoded property code names `parent` and `child`:\n[`tx/library/codesystem.js#L507-L523`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/codesystem.js#L507-L523)\n\u2014 The `_buildHierarchyMaps` method checks `property.code === 'parent'` and `property.code === 'child'` but never consults the CodeSystem's property definitions to discover that `subsumedBy` maps to the standard parent URI `http://hl7.org/fhir/concept-properties#parent`.\n\nThe v3 CodeSystems (e.g. `v3-ActReason`) define their parent property as `{code: \"subsumedBy\", uri: \"http://hl7.org/fhir/concept-properties#parent\"}`. Since the dev server only checks for the literal string `\"parent\"`, it never builds the hierarchy for these code systems. When ValueSets like `v3-PurposeOfUse` use a `filter: [{property: \"concept\", op: \"is-a\", value: \"PurposeOfUse\"}]`, the `_addDescendants` call in `cs-cs.js` finds zero descendants because the `parentToChildrenMap` was never populated.\n\n**Fix**: In `_buildHierarchyMaps` (or `buildMaps`), consult the CodeSystem's top-level `property` definitions to identify which property codes map to `http://hl7.org/fhir/concept-properties#parent` (or `#child`), then use those codes when scanning concept properties \u2014 matching the prod server's approach.\n"}
{"id":"f2b2cef","title":"f2b2cef [open] Dev : missing valueset-unclosed extension and spurious expansion.total on incomplete expansions","body":"f2b2cef [open] Dev : missing valueset-unclosed extension and spurious expansion.total on incomplete expansions\n\nClaude (AI Assistant) opened this issue 2026-02-07 15:52:32 -0600 CST\nThis was last edited at 2026-02-08 10:52:57 -0600 CST\n\nlabels: code-defect, content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  ff22bb2 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 292\nTolerance-ID: expand-unclosed-extension-and-total\nRecord-ID: b6156665-797d-4483-971c-62c00a0816b8\n\n\n```bash\ncurl -s https://tx.fhir.org/r4/ValueSet/\\$expand \\\n  -H \"Accept: application/fhir+json\" \\\n  -H \"Content-Type: application/fhir+json\" \\\n  --data-binary @- << 'REQUEST'\n{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"count\",\n      \"valueInteger\": 1000\n    },\n    {\n      \"name\": \"offset\",\n      \"valueInteger\": 0\n    },\n    {\n      \"name\": \"valueSet\",\n      \"resource\": {\n        \"resourceType\": \"ValueSet\",\n        \"status\": \"active\",\n        \"compose\": {\n          \"inactive\": true,\n          \"include\": [\n            {\n              \"system\": \"http://snomed.info/sct\",\n              \"filter\": [\n                {\n                  \"property\": \"concept\",\n                  \"op\": \"is-a\",\n                  \"value\": \"404684003\"\n                }\n              ]\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nREQUEST\n\ncurl -s https://tx-dev.fhir.org/r4/ValueSet/\\$expand \\\n  -H \"Accept: application/fhir+json\" \\\n  -H \"Content-Type: application/fhir+json\" \\\n  --data-binary @- << 'REQUEST'\n{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"count\",\n      \"valueInteger\": 1000\n    },\n    {\n      \"name\": \"offset\",\n      \"valueInteger\": 0\n    },\n    {\n      \"name\": \"valueSet\",\n      \"resource\": {\n        \"resourceType\": \"ValueSet\",\n        \"status\": \"active\",\n        \"compose\": {\n          \"inactive\": true,\n          \"include\": [\n            {\n              \"system\": \"http://snomed.info/sct\",\n              \"filter\": [\n                {\n                  \"property\": \"concept\",\n                  \"op\": \"is-a\",\n                  \"value\": \"404684003\"\n                }\n              ]\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nREQUEST\n```\n\nProd returns `expansion.extension` with `valueset-unclosed: true` and no `expansion.total`. Dev returns `expansion.total: 124412` with no unclosed extension.\n\n\nFor $expand operations that return incomplete/truncated expansions (e.g., SNOMED CT is-a queries requesting count=1000 from a set with 124,412 total codes):\n\n1. **Prod includes `expansion.extension` with `valueset-unclosed: true`; dev omits it.** Per the FHIR R4 spec, this extension signals that an expansion is incomplete due to inclusion of post-coordinated or unbounded value sets. Prod correctly marks these expansions as unclosed; dev does not.\n\n2. **Dev includes `expansion.total` (e.g., 124412); prod omits it.** The `total` field is optional (0..1) per spec. Prod omits it on these incomplete expansions; dev includes it. Since these expansions are truncated to the `count` parameter (e.g., 1000 codes returned), the behavioral difference is: dev tells the client the full count but doesn't signal incompleteness, while prod signals incompleteness but doesn't provide the full count.\n\nThese two differences always co-occur in the same records \u2014 every record where prod has `valueset-unclosed` but dev doesn't also has dev providing `total` while prod doesn't.\n\n\n292 records in the comparison dataset show both patterns simultaneously. All are successful (200/200) $expand operations. The pattern is predicted by: prod expansion has `valueset-unclosed` extension present AND dev expansion has `total` present but prod expansion does not.\n\nSearch: analyzed all 810 successful expand deltas; 292 match the combined pattern `unclosed=prod-only AND total=dev-only`. No records show unclosed prod-only without total dev-only or vice versa.\n\n\nTolerance `expand-unclosed-extension-and-total` matches $expand records where:\n- Both return 200 with expansion data\n- Prod has the `valueset-unclosed` extension but dev doesn't\n- Dev has `expansion.total` but prod doesn't\n\nIt normalizes by removing the `valueset-unclosed` extension from prod's expansion.extension array and removing `total` from dev's expansion object.\n\n\nb6156665-797d-4483-971c-62c00a0816b8: POST /r4/ValueSet/$expand \u2014 SNOMED CT is-a 404684003 (Clinical finding), count=1000. Prod returns 1000 codes with `valueset-unclosed: true` and no total. Dev returns 1000 codes with `total: 124412` and no unclosed extension.\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** calls `cs.isNotClosed()` per-filter to check if the code system's expansion is unclosed:\n[`library/ftx/fhir_valuesets.pas#L4028-L4029`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_valuesets.pas#L4028-L4029)\n\u2014 After each filter is applied, calls `cs.isNotClosed(opContext, filter, f)`. For SNOMED CT, this unconditionally returns `true`:\n[`library/ftx/ftx_sct_services.pas#L5354-L5357`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/ftx_sct_services.pas#L5354-L5357)\n\n**Dev** uses a separate `filtersNotClosed()` method that SNOMED doesn't override:\n[`tx/workers/expand.js#L816-L818`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/expand.js#L816-L818)\n\u2014 Calls `cs.filtersNotClosed(prep)` after executing filters. The SNOMED provider (`tx/cs/cs-snomed.js`) does not override this method, so it inherits the base class default which returns `false`:\n[`tx/cs/cs-api.js#L557`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/cs/cs-api.js#L557)\n\nThe consequence is that `notClosed` stays `false` for SNOMED filter expansions. This causes both symptoms: (1) the `valueset-unclosed` extension is not added (expand.js L1296-1297), and (2) `expansion.total` is set (expand.js L1308-1311) because the code falls into the else branch that only runs when `notClosed` is `false`.\n\n**Fix**: Add `async filtersNotClosed() { return true; }` to the SNOMED provider class in `tx/cs/cs-snomed.js`, matching the existing `isNotClosed() { return true; }` at line 950.\n"}
{"id":"801aef1","title":"801aef1 [open] Dev adds expression field on informational OperationOutcome issues where prod omits it","body":"801aef1 [open] Dev adds expression field on informational OperationOutcome issues where prod omits it\n\nClaude (AI Assistant) opened this issue 2026-02-07 15:59:16 -0600 CST\nThis was last edited at 2026-02-08 10:52:56 -0600 CST\n\nlabels: content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  880011a #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 6\nTolerance-ID: oo-extra-expression-on-info-issues\nRecord-ID: 9160e659-1af6-4bc6-9c89-e0a8b4df55cf\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/CodeSystem/$validate-code?system=http%3A%2F%2Funitsofmeasure.org&code=TEST' \\\n  -H 'Accept: application/fhir+json' | \\\n  jq '.parameter[] | select(.name == \"issues\") | .resource.issue[] | select(.severity == \"information\") | {severity, code, expression}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/CodeSystem/$validate-code?system=http%3A%2F%2Funitsofmeasure.org&code=TEST' \\\n  -H 'Accept: application/fhir+json' | \\\n  jq '.parameter[] | select(.name == \"issues\") | .resource.issue[] | select(.severity == \"information\") | {severity, code, expression}'\n```\n\nProd returns `\"expression\": null` (field absent) on the informational issue, dev returns `\"expression\": [\"code\"]`.\n\n## What differs\n\nIn $validate-code responses, both prod and dev return OperationOutcome issues. On error-severity issues, both include `expression: [\"code\"]`. On information-severity issues, prod omits the `expression` field entirely while dev includes `expression: [\"code\"]`.\n\nFor example, on `GET /r4/CodeSystem/$validate-code?system=http%3A%2F%2Funitsofmeasure.org&code=TEST`:\n- Prod: informational issue has no `expression` field\n- Dev: informational issue has `\"expression\": [\"code\"]`\n\nThe `expression` value is semantically correct (the issue relates to the `code` parameter), so dev is providing more complete information, but the difference in field presence is a real behavioral divergence.\n\n## How widespread\n\n6 records across the dataset exhibit this pattern:\n- 4 SNOMED CT records (all `code=K29` variants on different FHIR version paths)\n- 1 UCUM record (`code=TEST`)\n- 1 SNOMED CT POST record (`code=freetext`)\n\nAll are `$validate-code` or `$batch-validate-code` operations where the code is invalid and the informational issue provides supplementary error context (e.g., UCUM parse error, SNOMED expression parse error).\n\nSearch: node script checking all 3948 delta records for issues where dev has `expression` and prod lacks it on the same positional issue.\n\n## What the tolerance covers\n\nTolerance `oo-extra-expression-on-info-issues` matches validate-code Parameters responses where any OperationOutcome information-severity issue in dev has `expression` that prod lacks. Normalizes by removing the extra `expression` from dev to match prod. Eliminates 6 records.\n"}
{"id":"bd89513","title":"bd89513 [open] Dev returns extra message/issues for display language resolution on validate-code result=true","body":"bd89513 [open] Dev returns extra message/issues for display language resolution on validate-code result=true\n\nClaude (AI Assistant) opened this issue 2026-02-07 16:05:31 -0600 CST\nThis was last edited at 2026-02-08 10:52:57 -0600 CST\n\nlabels: code-defect, content-differs, reproduced, round:2026-02-round-2, tx-compare\nactors: Claude (AI Assistant)\nparticipants: Claude (AI Assistant)\n\n  bbdd889 #0 Claude (AI Assistant) <>\n\n  Records-Impacted: 21\nTolerance-ID: dev-extra-display-lang-not-found-message\nRecord-ID: 299d1b7f-b8f7-4cee-95ab-fa83da75ea80, c9f3b468-dc3d-47f5-a305-0346bf5b4cab\n\n## What differs\n\nWhen $validate-code returns result=true and a displayLanguage parameter was specified in the request, prod and dev disagree on how to communicate \"no display found in the requested language\":\n\n**Variant 1 (19 records):** Prod omits message/issues entirely. Dev returns extra `message` (\"There are no valid display names found for the code ...\") and `issues` (OperationOutcome with informational severity, tx-issue-type=`invalid-display`).\n\n**Variant 2 (2 records):** Prod returns `issues` with tx-issue-type=`display-comment` (\"'Laboratory procedure' is the default display; the code system http://snomed.info/sct has no Display Names for the language es-AR\"). Dev returns `message` and `issues` with tx-issue-type=`invalid-display` with differently-worded text. Both are saying the same thing but using different issue type codes and message wording.\n\nIn all cases, both servers agree on result=true, and system/code/version/display parameters match.\n\n## How widespread\n\n21 records total. Variant 1 affects 19 records (mostly urn:iso:std:iso:3166 codes with displayLanguage=fr/fr-FR, POST /r4/ValueSet/$validate-code). Variant 2 affects 2 records (SNOMED code 108252007 with displayLanguage=es-AR, POST /r5/CodeSystem/$validate-code).\n\nSearch: `grep 'There are no valid display names found' jobs/2026-02-round-2/comparison.ndjson | wc -l` \u2192 21\n\n## Tolerance\n\nTolerance `dev-extra-display-lang-not-found-message` handles both variants. It matches validate-code Parameters where result=true, prod has no message parameter, and dev has a message containing \"There are no valid display names found\". It normalizes by stripping dev's extra message/issues, and also stripping prod's display-comment issues when all issues are about display language defaults. Eliminates 21 records.\n\n## Repro\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code?' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"urn:iso:std:iso:3166\",\"code\":\"FR\",\"display\":\"France\"}]}},{\"name\":\"displayLanguage\",\"valueCode\":\"fr\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"jurisdiction\",\"url\":\"http://hl7.org/fhir/ValueSet/jurisdiction\",\"version\":\"4.0.1\",\"compose\":{\"include\":[{\"system\":\"urn:iso:std:iso:3166\"},{\"system\":\"urn:iso:std:iso:3166:-2\"},{\"system\":\"http://unstats.un.org/unsd/methods/m49/m49.htm\",\"filter\":[{\"property\":\"class\",\"op\":\"=\",\"value\":\"region\"}]}]}}}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"urn:iso:std:iso:3166\",\"code\":\"FR\",\"display\":\"France\"}]}},{\"name\":\"displayLanguage\",\"valueCode\":\"fr\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"jurisdiction\",\"url\":\"http://hl7.org/fhir/ValueSet/jurisdiction\",\"version\":\"4.0.1\",\"compose\":{\"include\":[{\"system\":\"urn:iso:std:iso:3166\"},{\"system\":\"urn:iso:std:iso:3166:-2\"},{\"system\":\"http://unstats.un.org/unsd/methods/m49/m49.htm\",\"filter\":[{\"property\":\"class\",\"op\":\"=\",\"value\":\"region\"}]}]}}}]}'\n```\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** passes `defLang` to `hasDisplay` when checking whether the provided display matches known designations, so default-language displays count as a match and the display warning block is skipped entirely:\n[`library/ftx/fhir_valuesets.pas#L1768`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_valuesets.pas#L1768)\n\u2014 `list.hasDisplay(FParams.workingLanguages, defLang, c.display, ...)` finds \"France\" via the default language fallback, so no display error is generated.\n\n**Dev** passes `null` instead of `defLang` to `hasDisplay` in the `checkDisplays` method, so default-language displays are not considered a match. This causes the code to enter the display-not-found path and emit the `NO_VALID_DISPLAY_FOUND_NONE_FOR_LANG_OK` informational message:\n[`tx/workers/validate.js#L1343`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L1343)\n\u2014 `list.hasDisplay(this.params.workingLanguages(), null, c.display, ...)` does not find \"France\" because `_langsMatch` skips the default-language shortcut when `defLang` is `null`:\n[`tx/library/designations.js#L778-L781`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/designations.js#L778-L781)\n\n**Fix**: In `checkDisplays` at `tx/workers/validate.js` line 1343, change the second argument of `list.hasDisplay(...)` from `null` to `defLang` (which is already passed as a parameter to `checkDisplays`), matching what prod does at `fhir_valuesets.pas` line 1768.\n"}
