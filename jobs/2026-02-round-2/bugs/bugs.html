<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FHIRsmith tx-compare Bug Report</title>
<style>
:root {
  --bg: #ffffff;
  --bg-surface: #f6f8fa;
  --bg-card: #ffffff;
  --border: #d1d9e0;
  --border-light: #e8ecf0;
  --text: #1f2328;
  --text-secondary: #59636e;
  --text-muted: #818b98;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-hover: 0 4px 12px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
  --radius: 8px;
  --radius-sm: 6px;
  --font: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
  --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;

  --pill-tx-bg: #ccfbf1; --pill-tx-fg: #115e59; --pill-tx-border: #5eead4;
  --pill-default-bg: #f3f4f6; --pill-default-fg: #4b5563; --pill-default-border: #d1d5db;

  --status-open-bg: #dcfce7; --status-open-fg: #166534; --status-open-border: #86efac;
  --status-closed-bg: #f3f4f6; --status-closed-fg: #6b7280; --status-closed-border: #d1d5db;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0d1117;
    --bg-surface: #161b22;
    --bg-card: #1c2128;
    --border: #30363d;
    --border-light: #21262d;
    --text: #e6edf3;
    --text-secondary: #8b949e;
    --text-muted: #6e7681;
    --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
    --shadow-hover: 0 4px 12px rgba(0,0,0,0.4), 0 2px 4px rgba(0,0,0,0.3);

    --pill-tx-bg: #042f2e; --pill-tx-fg: #5eead4; --pill-tx-border: #134e4a;
    --pill-default-bg: #1f2937; --pill-default-fg: #9ca3af; --pill-default-border: #374151;

    --status-open-bg: #052e16; --status-open-fg: #86efac; --status-open-border: #14532d;
    --status-closed-bg: #1f2937; --status-closed-fg: #9ca3af; --status-closed-border: #374151;
  }
}

*, *::before, *::after { box-sizing: border-box; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 0;
  line-height: 1.6;
}

.container {
  max-width: 960px;
  margin: 0 auto;
  padding: 24px 16px;
}

h1 {
  font-size: 24px;
  font-weight: 700;
  margin: 0 0 4px 0;
}

.subtitle {
  color: var(--text-muted);
  font-size: 14px;
  margin: 0 0 24px 0;
}

.stats-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
  padding: 16px;
  background: var(--bg-surface);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
}

.stat {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-secondary);
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  border: 1px solid var(--border-light);
}

.stat-value {
  font-weight: 700;
  color: var(--text);
  font-size: 15px;
}

.stat-divider {
  width: 1px;
  height: 24px;
  background: var(--border);
  margin: 0 4px;
}

.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
  align-items: center;
}

.search-box {
  flex: 1;
  min-width: 200px;
  padding: 8px 12px;
  font-size: 14px;
  font-family: var(--font);
  background: var(--bg-card);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
}

.search-box:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
}

.search-box::placeholder {
  color: var(--text-muted);
}

.filter-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.filter-pill {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 999px;
  cursor: pointer;
  user-select: none;
  transition: opacity 0.15s, transform 0.1s;
  border: 1px solid var(--pill-default-border);
  background: var(--pill-default-bg);
  color: var(--pill-default-fg);
}

.filter-pill[data-label="tx-compare"] {
  background: var(--pill-tx-bg);
  color: var(--pill-tx-fg);
  border-color: var(--pill-tx-border);
}

.filter-pill:hover {
  transform: translateY(-1px);
}

.filter-pill.active {
  box-shadow: 0 0 0 2px var(--text);
}

.filter-pill.dimmed {
  opacity: 0.35;
}

.filter-pill .count {
  font-weight: 400;
  opacity: 0.8;
}

.controls {
  display: flex;
  gap: 4px;
  margin-left: auto;
  flex-wrap: wrap;
}

.ctrl-btn {
  padding: 4px 10px;
  font-size: 12px;
  font-weight: 600;
  border-radius: var(--radius-sm);
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-secondary);
  font-family: var(--font);
  transition: background 0.15s, color 0.15s;
}

.ctrl-btn:hover {
  background: var(--bg-surface);
}

.ctrl-btn.active {
  background: var(--text);
  color: var(--bg);
  border-color: var(--text);
}

.bug-card {
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  margin-bottom: 8px;
  box-shadow: var(--shadow);
  transition: box-shadow 0.15s, border-color 0.15s;
  overflow: hidden;
}

.bug-card:hover {
  box-shadow: var(--shadow-hover);
  border-color: var(--border);
}

.bug-card.hidden {
  display: none;
}

.bug-header {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 12px 16px;
  cursor: pointer;
  user-select: none;
}

.bug-header:hover {
  background: var(--bg-surface);
}

.bug-expand-icon {
  flex-shrink: 0;
  width: 18px;
  height: 18px;
  margin-top: 2px;
  color: var(--text-muted);
  transition: transform 0.2s;
}

.bug-card.expanded .bug-expand-icon {
  transform: rotate(90deg);
}

.bug-info {
  flex: 1;
  min-width: 0;
}

.bug-title {
  font-size: 14px;
  font-weight: 600;
  line-height: 1.4;
  word-break: break-word;
}

.bug-meta {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 6px;
  margin-top: 6px;
}

.pill {
  display: inline-flex;
  align-items: center;
  padding: 1px 8px;
  font-size: 11px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid;
  white-space: nowrap;
}

.pill-status-open {
  background: var(--status-open-bg);
  color: var(--status-open-fg);
  border-color: var(--status-open-border);
}

.pill-status-closed {
  background: var(--status-closed-bg);
  color: var(--status-closed-fg);
  border-color: var(--status-closed-border);
}

.pill-label {
  background: var(--pill-default-bg);
  color: var(--pill-default-fg);
  border-color: var(--pill-default-border);
}

.pill-label[data-label="tx-compare"] {
  background: var(--pill-tx-bg);
  color: var(--pill-tx-fg);
  border-color: var(--pill-tx-border);
}

.pill-impact {
  background: #fef3c7;
  color: #92400e;
  border-color: #fcd34d;
  font-family: var(--font-mono);
  font-size: 10px;
}

@media (prefers-color-scheme: dark) {
  .pill-impact {
    background: #3b2f0b;
    color: #fcd34d;
    border-color: #78350f;
  }
}

.bug-id {
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}

.bug-date {
  font-size: 11px;
  color: var(--text-muted);
}

.bug-body {
  display: none;
  padding: 0 16px 16px 44px;
  border-top: 1px solid var(--border-light);
}

.bug-card.expanded .bug-body {
  display: block;
}

.bug-body h1, .bug-body h2, .bug-body h3,
.bug-body h4, .bug-body h5, .bug-body h6 {
  margin: 16px 0 8px 0;
  font-weight: 700;
  line-height: 1.3;
}

.bug-body h1 { font-size: 18px; }
.bug-body h2 { font-size: 16px; }
.bug-body h3 { font-size: 14px; }
.bug-body h4, .bug-body h5, .bug-body h6 { font-size: 13px; }

.bug-body p {
  margin: 8px 0;
  font-size: 13px;
  line-height: 1.65;
}

.bug-body ul, .bug-body ol {
  margin: 8px 0;
  padding-left: 24px;
  font-size: 13px;
}

.bug-body li {
  margin: 4px 0;
  line-height: 1.55;
}

.bug-body code {
  font-family: var(--font-mono);
  font-size: 12px;
  background: var(--bg-surface);
  padding: 2px 6px;
  border-radius: 4px;
  border: 1px solid var(--border-light);
}

.bug-body pre {
  background: var(--bg-surface);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  padding: 12px 16px;
  overflow-x: auto;
  margin: 12px 0;
}

.bug-body pre code {
  background: none;
  border: none;
  padding: 0;
  font-size: 12px;
  line-height: 1.5;
}

.bug-body hr {
  border: none;
  border-top: 1px solid var(--border-light);
  margin: 16px 0;
}

.bug-body strong { font-weight: 700; }
.bug-body em { font-style: italic; }
.bug-body a { color: #3b82f6; text-decoration: none; }
.bug-body a:hover { text-decoration: underline; }

.no-results {
  text-align: center;
  padding: 48px 16px;
  color: var(--text-muted);
  font-size: 14px;
}

.no-results.hidden {
  display: none;
}

.pipeline-bar {
  display: flex;
  gap: 0;
  margin-bottom: 12px;
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid var(--border-light);
  font-size: 12px;
  line-height: 1.3;
}

.pipeline-bar:empty {
  display: none;
}

.pipeline-seg {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10px 8px;
  min-width: 0;
  text-align: center;
}

.pipeline-seg .seg-value {
  font-weight: 700;
  font-size: 16px;
  font-family: var(--font-mono);
}

.pipeline-seg .seg-label {
  font-size: 10px;
  opacity: 0.8;
  margin-top: 2px;
}

.seg-perfect { background: #dcfce7; color: #166534; }
.seg-equiv { background: #dbeafe; color: #1e40af; }
.seg-known { background: #fef3c7; color: #92400e; }
.seg-untriaged { background: #fee2e2; color: #991b1b; }

@media (prefers-color-scheme: dark) {
  .seg-perfect { background: #052e16; color: #86efac; }
  .seg-equiv { background: #172554; color: #93c5fd; }
  .seg-known { background: #3b2f0b; color: #fcd34d; }
  .seg-untriaged { background: #450a0a; color: #fca5a5; }
}

@media (max-width: 640px) {
  .container { padding: 16px 12px; }
  .stats-bar { padding: 12px; gap: 6px; }
  .stat-divider { display: none; }
  .filter-bar { flex-direction: column; }
  .search-box { min-width: 100%; }
  .bug-body { padding: 0 12px 12px 12px; }
  .bug-header { padding: 10px 12px; }
  .controls { margin-left: 0; }
  .pipeline-bar { font-size: 10px; }
  .pipeline-seg .seg-value { font-size: 13px; }
}
</style>
</head>
<body>
<div class="container">
  <h1>FHIRsmith tx-compare Bugs</h1>
  <p class="subtitle">Generated from git-bug &middot; <span id="gen-time"></span></p>

  <div class="pipeline-bar" id="pipeline-bar"></div>
  <div class="stats-bar" id="stats-bar"></div>

  <div class="filter-bar">
    <input type="text" class="search-box" id="search" placeholder="Search bugs by title or body..." autocomplete="off">
    <div class="filter-pills" id="label-filters"></div>
    <div class="controls">
      <button class="ctrl-btn" id="expand-all-btn" onclick="toggleExpandAll()">Expand all</button>
      <span class="stat-divider"></span>
      <button class="ctrl-btn active" data-status="all">All</button>
      <button class="ctrl-btn" data-status="open">Open</button>
      <button class="ctrl-btn" data-status="closed">Closed</button>
      <span class="stat-divider"></span>
      <button class="ctrl-btn sort-btn active" data-sort="impact">Impact</button>
      <button class="ctrl-btn sort-btn" data-sort="date">Date</button>
      <button class="ctrl-btn sort-btn" data-sort="title">Title</button>
    </div>
  </div>

  <div id="bug-list"></div>
  <div class="no-results hidden" id="no-results">No bugs match your filters.</div>
</div>

<script>
const BUGS = [{"id": "dc0132b", "title": "Dev SNOMED  returns URI-based name and omits most properties", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 19:38", "date_iso": "2026-02-07T19:38:03-06:00", "body_md": "Records-Impacted: 2170\nTolerance-ID: snomed-lookup-name-and-properties\nRecord-ID: 1a78565a-0d41-448b-b6cc-ae96754dd093\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/CodeSystem/$lookup?system=http://snomed.info/sct&code=446050000' -H 'Accept: application/fhir+json'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/CodeSystem/$lookup?system=http://snomed.info/sct&code=446050000' -H 'Accept: application/fhir+json'\n```\n\nProd returns `name: \"SNOMED CT\"` with properties `copyright`, `moduleId`, `normalForm`, `normalFormTerse`, `parent`. Dev returns `name: \"http://snomed.info/sct|http://snomed.info/sct/900000000000207008/version/20250201\"` with only the `inactive` property.\n\n## What differs\n\nFor SNOMED CT CodeSystem/$lookup requests, dev differs from prod in three ways:\n\n1. **`name` parameter**: Prod returns the human-readable code system name `\"SNOMED CT\"`. Dev returns a system|version URI like `\"http://snomed.info/sct|http://snomed.info/sct/900000000000207008/version/20250201\"`. Per the FHIR R4 $lookup spec, the `name` output parameter (1..1 string) is defined as \"A display name for the code system\", so prod's value is correct.\n\n2. **Missing properties**: Prod returns properties `copyright`, `moduleId`, `normalForm`, `normalFormTerse`, `parent` (and `child` when applicable). Dev returns only `inactive`. Per the FHIR spec, \"If no properties are specified, the server chooses what to return\", but dev returns significantly fewer SNOMED-specific properties than prod.\n\n3. **Missing `abstract` parameter on R5**: For R5 SNOMED lookups (2170 of 2176 R5 records), prod returns `abstract: false` but dev omits the parameter entirely.\n\n## How widespread\n\n2186 SNOMED $lookup delta records match the name + properties pattern. The tolerance eliminates 2170 of them. The remaining 16 have additional differences beyond what this tolerance covers (e.g., designation content differences).\n\nSearch: `grep '$lookup.*snomed' jobs/2026-02-round-2/results/deltas/deltas.ndjson | wc -l` → 2187 (before tolerance)\n\nAll three issues co-occur on every affected record.\n\n## What the tolerance covers\n\nTolerance `snomed-lookup-name-and-properties` normalizes by:\n- Setting dev's `name` to prod's value (`\"SNOMED CT\"`)\n- Removing properties from prod that dev doesn't have (copyright, moduleId, normalForm, normalFormTerse, parent, child)\n- Removing `abstract` from prod when dev doesn't have it (R5 lookups)\n\n## Representative record\n\n1a78565a-0d41-448b-b6cc-ae96754dd093 — `GET /r4/CodeSystem/$lookup?system=http://snomed.info/sct&code=446050000`", "body_html": "<p>Records-Impacted: 2170<br>\nTolerance-ID: snomed-lookup-name-and-properties<br>\nRecord-ID: 1a78565a-0d41-448b-b6cc-ae96754dd093</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/CodeSystem/$lookup?system=http://snomed.info/sct&amp;code=446050000&#x27; -H &#x27;Accept: application/fhir+json&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/CodeSystem/$lookup?system=http://snomed.info/sct&amp;code=446050000&#x27; -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns <code>name: &quot;SNOMED CT&quot;</code> with properties <code>copyright</code>, <code>moduleId</code>, <code>normalForm</code>, <code>normalFormTerse</code>, <code>parent</code>. Dev returns <code>name: &quot;http://snomed.info/sct|http://snomed.info/sct/900000000000207008/version/20250201&quot;</code> with only the <code>inactive</code> property.</p>\n<h2>What differs</h2>\n<p>For SNOMED CT CodeSystem/$lookup requests, dev differs from prod in three ways:</p>\n<ol><li>**<code>name</code> parameter**: Prod returns the human-readable code system name <code>&quot;SNOMED CT&quot;</code>. Dev returns a system|version URI like <code>&quot;http://snomed.info/sct|http://snomed.info/sct/900000000000207008/version/20250201&quot;</code>. Per the FHIR R4 $lookup spec, the <code>name</code> output parameter (1..1 string) is defined as &quot;A display name for the code system&quot;, so prod&#x27;s value is correct.</li></ol>\n<ol><li><strong>Missing properties</strong>: Prod returns properties <code>copyright</code>, <code>moduleId</code>, <code>normalForm</code>, <code>normalFormTerse</code>, <code>parent</code> (and <code>child</code> when applicable). Dev returns only <code>inactive</code>. Per the FHIR spec, &quot;If no properties are specified, the server chooses what to return&quot;, but dev returns significantly fewer SNOMED-specific properties than prod.</li></ol>\n<ol><li>**Missing <code>abstract</code> parameter on R5**: For R5 SNOMED lookups (2170 of 2176 R5 records), prod returns <code>abstract: false</code> but dev omits the parameter entirely.</li></ol>\n<h2>How widespread</h2>\n<p>2186 SNOMED $lookup delta records match the name + properties pattern. The tolerance eliminates 2170 of them. The remaining 16 have additional differences beyond what this tolerance covers (e.g., designation content differences).</p>\n<p>Search: <code>grep &#x27;$lookup.*snomed&#x27; jobs/2026-02-round-2/results/deltas/deltas.ndjson | wc -l</code> → 2187 (before tolerance)</p>\n<p>All three issues co-occur on every affected record.</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>snomed-lookup-name-and-properties</code> normalizes by:</p>\n<ul><li>Setting dev&#x27;s <code>name</code> to prod&#x27;s value (<code>&quot;SNOMED CT&quot;</code>)</li><li>Removing properties from prod that dev doesn&#x27;t have (copyright, moduleId, normalForm, normalFormTerse, parent, child)</li><li>Removing <code>abstract</code> from prod when dev doesn&#x27;t have it (R5 lookups)</li></ul>\n<h2>Representative record</h2>\n<p>1a78565a-0d41-448b-b6cc-ae96754dd093 — <code>GET /r4/CodeSystem/$lookup?system=http://snomed.info/sct&amp;code=446050000</code></p>", "impact": 2170}, {"id": "cd4b7d1", "title": "Dev returns 400 instead of 422 for error responses across validate-code and expand operations", "status": "open", "labels": ["code-defect", "reproduced", "status-mismatch", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:33", "date_iso": "2026-02-07T20:33:25-06:00", "body_md": "Records-Impacted: 1897\nTolerance-ID: error-status-422-vs-400\nRecord-ID: e5639442-a91b-4de0-b1d9-9b901023b6c1\n\n## Repro\n\n```bash\n# Prod\ncurl -s -w \"\\nHTTP Status: %{http_code}\\n\" \\\n  'https://tx.fhir.org/r4/ValueSet/$validate-code?url=http://hl7.org/fhir/us/davinci-pdex-plan-net/ValueSet/PractitionerRoleVS&code=ho&_format=json&system=http://hl7.org/fhir/us/davinci-pdex-plan-net/CodeSystem/ProviderRoleCS' \\\n  -H 'Accept: application/fhir+json'\n\n# Dev\ncurl -s -w \"\\nHTTP Status: %{http_code}\\n\" \\\n  'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http://hl7.org/fhir/us/davinci-pdex-plan-net/ValueSet/PractitionerRoleVS&code=ho&_format=json&system=http://hl7.org/fhir/us/davinci-pdex-plan-net/CodeSystem/ProviderRoleCS' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 422 with OperationOutcome (issue code \"not-found\"). Dev returns HTTP 400 with the same OperationOutcome content. Both agree on the error semantics (same error code, same error message), differing only in HTTP status.\n\n## What differs\n\nProd returns HTTP 422 (Unprocessable Entity) while dev returns HTTP 400 (Bad Request) for error responses. Both servers return OperationOutcome resources with error-level issues and agree on the error semantics (same error codes, same error messages). The only difference is the HTTP status code.\n\nExample: a $validate-code request for a ValueSet that doesn't exist. Both return OperationOutcome with issue code \"not-found\" and text \"A definition for the value Set '...' could not be found\", but prod uses 422 and dev uses 400.\n\n## How widespread\n\n1897 records in the comparison dataset show this pattern (prod=422, dev=400). All 1897 have OperationOutcome on both sides.\n\nBreakdown by operation type:\n- validate-code: 1331 records\n- expand: 566 records\n\nBoth GET and POST requests are affected. The pattern spans all FHIR versions (/r4/, etc.) and all code systems/ValueSets.\n\nFound via: grep -c '\"prodStatus\":422,\"devStatus\":400' results/deltas/deltas.ndjson\n\n## What the tolerance covers\n\nTolerance ID: error-status-422-vs-400\nMatches: any record where prod.status=422, dev.status=400, and both response bodies are OperationOutcome resources (resourceType check).\nAction: skip (since the status code difference IS the categorization trigger — normalizing bodies doesn't change the status-mismatch category).\nEliminates: 1897 records.\n\n## Representative record\n\ne5639442-a91b-4de0-b1d9-9b901023b6c1 — GET /r4/ValueSet/$validate-code for PractitionerRoleVS (davinci-pdex-plan-net). Prod=422, dev=400, both return \"not-found\" OperationOutcome.\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** returns HTTP 422 for all terminology operation errors via two mechanisms:\n\n1. For `$validate-code`, when the ValueSet is not found, it creates an OperationOutcome directly and sets `response.HTTPCode := 422`:\n[`server/tx_operations.pas#L611-L616`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx_operations.pas#L611-L616)\n— When `oOut` (OperationOutcome) is non-nil, the response code is hardcoded to 422. Same pattern at [line 882-887](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx_operations.pas#L882-L887) for the POST path.\n\n2. For `$expand` and other operations, `ETerminologyError` exceptions propagate to the general handler in `endpoint_storage.pas` which sends `HTTP_ERR_BUSINESS_RULES_FAILED`:\n[`server/endpoint_storage.pas#L1553-L1561`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/endpoint_storage.pas#L1553-L1561)\n— `HTTP_ERR_BUSINESS_RULES_FAILED` is defined as `422` in [`library/fhir/fhir_objects.pas#L900`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/fhir/fhir_objects.pas#L900).\n\n**Dev** returns HTTP 400 because error `Issue` objects are created with `statusCode = 400`:\n[`tx/workers/validate.js#L2212`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L2212)\n— \"ValueSet not found\" Issue is constructed with `400` as the last parameter. The catch block at [`tx/workers/validate.js#L2034-L2037`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L2034-L2037) uses `error.statusCode || 500`, so it sends 400. The same pattern appears throughout expand.js (e.g., [lines 515-533](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/expand.js#L515-L533)).\n\n**Fix**: Change the `statusCode` from `400` to `422` in all Issue constructors and `.handleAsOO()` calls across `validate.js` and `expand.js` where the error represents a terminology operation failure (not-found, invalid filter, missing supplement, etc.). The `Issue` constructor default at `operation-outcome.js:14` is already `500`, so each call site needs updating. Alternatively, change the error handler catch blocks (e.g., `validate.js:2037`, `expand.js:1555`) to always use `422` when the error is a terminology-level Issue, matching prod's convention that all terminology OperationOutcome responses use HTTP 422.", "body_html": "<p>Records-Impacted: 1897<br>\nTolerance-ID: error-status-422-vs-400<br>\nRecord-ID: e5639442-a91b-4de0-b1d9-9b901023b6c1</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s -w &quot;\\nHTTP Status: %{http_code}\\n&quot; \\\n  &#x27;https://tx.fhir.org/r4/ValueSet/$validate-code?url=http://hl7.org/fhir/us/davinci-pdex-plan-net/ValueSet/PractitionerRoleVS&amp;code=ho&amp;_format=json&amp;system=http://hl7.org/fhir/us/davinci-pdex-plan-net/CodeSystem/ProviderRoleCS&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\n# Dev\ncurl -s -w &quot;\\nHTTP Status: %{http_code}\\n&quot; \\\n  &#x27;https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http://hl7.org/fhir/us/davinci-pdex-plan-net/ValueSet/PractitionerRoleVS&amp;code=ho&amp;_format=json&amp;system=http://hl7.org/fhir/us/davinci-pdex-plan-net/CodeSystem/ProviderRoleCS&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns HTTP 422 with OperationOutcome (issue code &quot;not-found&quot;). Dev returns HTTP 400 with the same OperationOutcome content. Both agree on the error semantics (same error code, same error message), differing only in HTTP status.</p>\n<h2>What differs</h2>\n<p>Prod returns HTTP 422 (Unprocessable Entity) while dev returns HTTP 400 (Bad Request) for error responses. Both servers return OperationOutcome resources with error-level issues and agree on the error semantics (same error codes, same error messages). The only difference is the HTTP status code.</p>\n<p>Example: a $validate-code request for a ValueSet that doesn&#x27;t exist. Both return OperationOutcome with issue code &quot;not-found&quot; and text &quot;A definition for the value Set &#x27;...&#x27; could not be found&quot;, but prod uses 422 and dev uses 400.</p>\n<h2>How widespread</h2>\n<p>1897 records in the comparison dataset show this pattern (prod=422, dev=400). All 1897 have OperationOutcome on both sides.</p>\n<p>Breakdown by operation type:</p>\n<ul><li>validate-code: 1331 records</li><li>expand: 566 records</li></ul>\n<p>Both GET and POST requests are affected. The pattern spans all FHIR versions (/r4/, etc.) and all code systems/ValueSets.</p>\n<p>Found via: grep -c &#x27;&quot;prodStatus&quot;:422,&quot;devStatus&quot;:400&#x27; results/deltas/deltas.ndjson</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance ID: error-status-422-vs-400<br>\nMatches: any record where prod.status=422, dev.status=400, and both response bodies are OperationOutcome resources (resourceType check).<br>\nAction: skip (since the status code difference IS the categorization trigger — normalizing bodies doesn&#x27;t change the status-mismatch category).<br>\nEliminates: 1897 records.</p>\n<h2>Representative record</h2>\n<p>e5639442-a91b-4de0-b1d9-9b901023b6c1 — GET /r4/ValueSet/$validate-code for PractitionerRoleVS (davinci-pdex-plan-net). Prod=422, dev=400, both return &quot;not-found&quot; OperationOutcome.</p>\n<h2>Root Cause</h2>\n<p><strong>Classification</strong>: code-level defect</p>\n<p><strong>Prod</strong> returns HTTP 422 for all terminology operation errors via two mechanisms:</p>\n<ol><li>For <code>$validate-code</code>, when the ValueSet is not found, it creates an OperationOutcome directly and sets <code>response.HTTPCode := 422</code>:</li></ol>\n<p><a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx_operations.pas#L611-L616\" target=\"_blank\"><code>server/tx_operations.pas#L611-L616</code></a><br>\n— When <code>oOut</code> (OperationOutcome) is non-nil, the response code is hardcoded to 422. Same pattern at <a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx_operations.pas#L882-L887\" target=\"_blank\">line 882-887</a> for the POST path.</p>\n<ol><li>For <code>$expand</code> and other operations, <code>ETerminologyError</code> exceptions propagate to the general handler in <code>endpoint_storage.pas</code> which sends <code>HTTP_ERR_BUSINESS_RULES_FAILED</code>:</li></ol>\n<p><a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/endpoint_storage.pas#L1553-L1561\" target=\"_blank\"><code>server/endpoint_storage.pas#L1553-L1561</code></a><br>\n— <code>HTTP_ERR_BUSINESS_RULES_FAILED</code> is defined as <code>422</code> in <a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/fhir/fhir_objects.pas#L900\" target=\"_blank\"><code>library/fhir/fhir_objects.pas#L900</code></a>.</p>\n<p><strong>Dev</strong> returns HTTP 400 because error <code>Issue</code> objects are created with <code>statusCode = 400</code>:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L2212\" target=\"_blank\"><code>tx/workers/validate.js#L2212</code></a><br>\n— &quot;ValueSet not found&quot; Issue is constructed with <code>400</code> as the last parameter. The catch block at <a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L2034-L2037\" target=\"_blank\"><code>tx/workers/validate.js#L2034-L2037</code></a> uses <code>error.statusCode || 500</code>, so it sends 400. The same pattern appears throughout expand.js (e.g., <a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/expand.js#L515-L533\" target=\"_blank\">lines 515-533</a>).</p>\n<p><strong>Fix</strong>: Change the <code>statusCode</code> from <code>400</code> to <code>422</code> in all Issue constructors and <code>.handleAsOO()</code> calls across <code>validate.js</code> and <code>expand.js</code> where the error represents a terminology operation failure (not-found, invalid filter, missing supplement, etc.). The <code>Issue</code> constructor default at <code>operation-outcome.js:14</code> is already <code>500</code>, so each call site needs updating. Alternatively, change the error handler catch blocks (e.g., <code>validate.js:2037</code>, <code>expand.js:1555</code>) to always use <code>422</code> when the error is a terminology-level Issue, matching prod&#x27;s convention that all terminology OperationOutcome responses use HTTP 422.</p>", "impact": 1897}, {"id": "2337986", "title": "Dev returns 404 instead of 422 when ValueSet not found for $expand", "status": "open", "labels": ["code-defect", "reproduced", "status-mismatch", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:24", "date_iso": "2026-02-07T20:24:52-06:00", "body_md": "Records-Impacted: 756\nTolerance-ID: expand-valueset-not-found-status-mismatch\nRecord-ID: 8b7a9262-90d3-4753-a197-9a631ffdcf2f\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fdavinci-pdex-plan-net%2FValueSet%2FPractitionerRoleVS&_format=json' \\\n  -H 'Accept: application/fhir+json'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fdavinci-pdex-plan-net%2FValueSet%2FPractitionerRoleVS&_format=json' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 422 with `issue.code: \"unknown\"` and `issue.details.text`, dev returns HTTP 404 with `issue.code: \"not-found\"` and `issue.diagnostics`.\n\n\nWhen a ValueSet cannot be found for a $expand operation, prod returns HTTP 422 (Unprocessable Entity) with an OperationOutcome using issue code `unknown` and `details.text`, while dev returns HTTP 404 (Not Found) with issue code `not-found` and `diagnostics`. Both communicate the same semantic meaning (\"this ValueSet doesn't exist\"), but the HTTP status code and OperationOutcome structure differ.\n\nProd response (status 422):\n- issue.code: \"unknown\"\n- issue.details.text: \"Unable to find value set for URL \\\"...\\\"\"\n\nDev response (status 404):\n- issue.code: \"not-found\"\n- issue.diagnostics: \"ValueSet not found: ...\"\n\n\n756 records in the comparison dataset show this exact pattern (prod=422, dev=404). All are $expand operations (722 GET, 34 POST) across many different ValueSet URLs. The pattern is universal — every prod=422/dev=404 status mismatch is an $expand of an unknown ValueSet.\n\nSearch used: `grep -c '\"prodStatus\":422,\"devStatus\":404' results/deltas/deltas.ndjson`\n\n\nTolerance ID: `expand-valueset-not-found-status-mismatch`\nMatches: $expand operations where prod=422 and dev=404, and both responses are OperationOutcomes indicating a ValueSet was not found.\nRecords eliminated: 756\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** returns HTTP 422 with issue code `unknown` for unfound ValueSets:\n[`server/tx_operations.pas#L335-L336`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx_operations.pas#L335-L336)\n— Raises `ETerminologyError` with `itUnknown` when ValueSet URL lookup fails during $expand.\n\n[`server/endpoint_storage.pas#L1553-L1561`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/endpoint_storage.pas#L1553-L1561)\n— All `ETerminologyError` exceptions are caught and returned with `HTTP_ERR_BUSINESS_RULES_FAILED` (422), preserving the exception's `issueType` (`itUnknown` -> `\"unknown\"`) in the OperationOutcome.\n\n**Dev** returns HTTP 404 with issue code `not-found`:\n[`tx/workers/expand.js#L1669-L1672`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/expand.js#L1669-L1672)\n— When `findValueSet` returns null, the expand handler returns `res.status(404)` with issue code `not-found` and puts the error message only in `diagnostics`.\n\nThere are two divergences:\n1. **HTTP status**: Dev uses 404 instead of 422. Prod treats all terminology errors as \"business rules failed\" (422), regardless of whether the issue is \"not found\" or something else.\n2. **Issue code**: Dev uses `not-found` instead of `unknown`. Prod uses `itUnknown` because the error semantics are \"the system doesn't know this ValueSet\", not a pure resource-not-found.\n\n**Fix**: In `tx/workers/expand.js` line 1670, change `res.status(404)` to `res.status(422)` and change the issue code from `'not-found'` to `'unknown'` to match prod's behavior. The same fix should be applied to `tx/workers/related.js` line 1670 which has identical code.", "body_html": "<p>Records-Impacted: 756<br>\nTolerance-ID: expand-valueset-not-found-status-mismatch<br>\nRecord-ID: 8b7a9262-90d3-4753-a197-9a631ffdcf2f</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fdavinci-pdex-plan-net%2FValueSet%2FPractitionerRoleVS&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fdavinci-pdex-plan-net%2FValueSet%2FPractitionerRoleVS&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns HTTP 422 with <code>issue.code: &quot;unknown&quot;</code> and <code>issue.details.text</code>, dev returns HTTP 404 with <code>issue.code: &quot;not-found&quot;</code> and <code>issue.diagnostics</code>.</p>\n<p>When a ValueSet cannot be found for a $expand operation, prod returns HTTP 422 (Unprocessable Entity) with an OperationOutcome using issue code <code>unknown</code> and <code>details.text</code>, while dev returns HTTP 404 (Not Found) with issue code <code>not-found</code> and <code>diagnostics</code>. Both communicate the same semantic meaning (&quot;this ValueSet doesn&#x27;t exist&quot;), but the HTTP status code and OperationOutcome structure differ.</p>\n<p>Prod response (status 422):</p>\n<ul><li>issue.code: &quot;unknown&quot;</li><li>issue.details.text: &quot;Unable to find value set for URL \\&quot;...\\&quot;&quot;</li></ul>\n<p>Dev response (status 404):</p>\n<ul><li>issue.code: &quot;not-found&quot;</li><li>issue.diagnostics: &quot;ValueSet not found: ...&quot;</li></ul>\n<p>756 records in the comparison dataset show this exact pattern (prod=422, dev=404). All are $expand operations (722 GET, 34 POST) across many different ValueSet URLs. The pattern is universal — every prod=422/dev=404 status mismatch is an $expand of an unknown ValueSet.</p>\n<p>Search used: <code>grep -c &#x27;&quot;prodStatus&quot;:422,&quot;devStatus&quot;:404&#x27; results/deltas/deltas.ndjson</code></p>\n<p>Tolerance ID: <code>expand-valueset-not-found-status-mismatch</code><br>\nMatches: $expand operations where prod=422 and dev=404, and both responses are OperationOutcomes indicating a ValueSet was not found.<br>\nRecords eliminated: 756</p>\n<h2>Root Cause</h2>\n<p><strong>Classification</strong>: code-level defect</p>\n<p><strong>Prod</strong> returns HTTP 422 with issue code <code>unknown</code> for unfound ValueSets:<br>\n<a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx_operations.pas#L335-L336\" target=\"_blank\"><code>server/tx_operations.pas#L335-L336</code></a><br>\n— Raises <code>ETerminologyError</code> with <code>itUnknown</code> when ValueSet URL lookup fails during $expand.</p>\n<p><a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/endpoint_storage.pas#L1553-L1561\" target=\"_blank\"><code>server/endpoint_storage.pas#L1553-L1561</code></a><br>\n— All <code>ETerminologyError</code> exceptions are caught and returned with <code>HTTP_ERR_BUSINESS_RULES_FAILED</code> (422), preserving the exception&#x27;s <code>issueType</code> (<code>itUnknown</code> -&gt; <code>&quot;unknown&quot;</code>) in the OperationOutcome.</p>\n<p><strong>Dev</strong> returns HTTP 404 with issue code <code>not-found</code>:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/expand.js#L1669-L1672\" target=\"_blank\"><code>tx/workers/expand.js#L1669-L1672</code></a><br>\n— When <code>findValueSet</code> returns null, the expand handler returns <code>res.status(404)</code> with issue code <code>not-found</code> and puts the error message only in <code>diagnostics</code>.</p>\n<p>There are two divergences:</p>\n<ol><li><strong>HTTP status</strong>: Dev uses 404 instead of 422. Prod treats all terminology errors as &quot;business rules failed&quot; (422), regardless of whether the issue is &quot;not found&quot; or something else.</li><li><strong>Issue code</strong>: Dev uses <code>not-found</code> instead of <code>unknown</code>. Prod uses <code>itUnknown</code> because the error semantics are &quot;the system doesn&#x27;t know this ValueSet&quot;, not a pure resource-not-found.</li></ol>\n<p><strong>Fix</strong>: In <code>tx/workers/expand.js</code> line 1670, change <code>res.status(404)</code> to <code>res.status(422)</code> and change the issue code from <code>&#x27;not-found&#x27;</code> to <code>&#x27;unknown&#x27;</code> to match prod&#x27;s behavior. The same fix should be applied to <code>tx/workers/related.js</code> line 1670 which has identical code.</p>", "impact": 756}, {"id": "f2b2cef", "title": "Dev : missing valueset-unclosed extension and spurious expansion.total on incomplete expansions", "status": "open", "labels": ["code-defect", "content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:32", "date_iso": "2026-02-07T20:32:48-06:00", "body_md": "Records-Impacted: 292\nTolerance-ID: expand-unclosed-extension-and-total\nRecord-ID: b6156665-797d-4483-971c-62c00a0816b8\n\n\n```bash\ncurl -s https://tx.fhir.org/r4/ValueSet/\\$expand \\\n  -H \"Accept: application/fhir+json\" \\\n  -H \"Content-Type: application/fhir+json\" \\\n  --data-binary @- << 'REQUEST'\n{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"count\",\n      \"valueInteger\": 1000\n    },\n    {\n      \"name\": \"offset\",\n      \"valueInteger\": 0\n    },\n    {\n      \"name\": \"valueSet\",\n      \"resource\": {\n        \"resourceType\": \"ValueSet\",\n        \"status\": \"active\",\n        \"compose\": {\n          \"inactive\": true,\n          \"include\": [\n            {\n              \"system\": \"http://snomed.info/sct\",\n              \"filter\": [\n                {\n                  \"property\": \"concept\",\n                  \"op\": \"is-a\",\n                  \"value\": \"404684003\"\n                }\n              ]\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nREQUEST\n\ncurl -s https://tx-dev.fhir.org/r4/ValueSet/\\$expand \\\n  -H \"Accept: application/fhir+json\" \\\n  -H \"Content-Type: application/fhir+json\" \\\n  --data-binary @- << 'REQUEST'\n{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"count\",\n      \"valueInteger\": 1000\n    },\n    {\n      \"name\": \"offset\",\n      \"valueInteger\": 0\n    },\n    {\n      \"name\": \"valueSet\",\n      \"resource\": {\n        \"resourceType\": \"ValueSet\",\n        \"status\": \"active\",\n        \"compose\": {\n          \"inactive\": true,\n          \"include\": [\n            {\n              \"system\": \"http://snomed.info/sct\",\n              \"filter\": [\n                {\n                  \"property\": \"concept\",\n                  \"op\": \"is-a\",\n                  \"value\": \"404684003\"\n                }\n              ]\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nREQUEST\n```\n\nProd returns `expansion.extension` with `valueset-unclosed: true` and no `expansion.total`. Dev returns `expansion.total: 124412` with no unclosed extension.\n\n\nFor $expand operations that return incomplete/truncated expansions (e.g., SNOMED CT is-a queries requesting count=1000 from a set with 124,412 total codes):\n\n1. **Prod includes `expansion.extension` with `valueset-unclosed: true`; dev omits it.** Per the FHIR R4 spec, this extension signals that an expansion is incomplete due to inclusion of post-coordinated or unbounded value sets. Prod correctly marks these expansions as unclosed; dev does not.\n\n2. **Dev includes `expansion.total` (e.g., 124412); prod omits it.** The `total` field is optional (0..1) per spec. Prod omits it on these incomplete expansions; dev includes it. Since these expansions are truncated to the `count` parameter (e.g., 1000 codes returned), the behavioral difference is: dev tells the client the full count but doesn't signal incompleteness, while prod signals incompleteness but doesn't provide the full count.\n\nThese two differences always co-occur in the same records — every record where prod has `valueset-unclosed` but dev doesn't also has dev providing `total` while prod doesn't.\n\n\n292 records in the comparison dataset show both patterns simultaneously. All are successful (200/200) $expand operations. The pattern is predicted by: prod expansion has `valueset-unclosed` extension present AND dev expansion has `total` present but prod expansion does not.\n\nSearch: analyzed all 810 successful expand deltas; 292 match the combined pattern `unclosed=prod-only AND total=dev-only`. No records show unclosed prod-only without total dev-only or vice versa.\n\n\nTolerance `expand-unclosed-extension-and-total` matches $expand records where:\n- Both return 200 with expansion data\n- Prod has the `valueset-unclosed` extension but dev doesn't\n- Dev has `expansion.total` but prod doesn't\n\nIt normalizes by removing the `valueset-unclosed` extension from prod's expansion.extension array and removing `total` from dev's expansion object.\n\n\nb6156665-797d-4483-971c-62c00a0816b8: POST /r4/ValueSet/$expand — SNOMED CT is-a 404684003 (Clinical finding), count=1000. Prod returns 1000 codes with `valueset-unclosed: true` and no total. Dev returns 1000 codes with `total: 124412` and no unclosed extension.\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** calls `cs.isNotClosed()` per-filter to check if the code system's expansion is unclosed:\n[`library/ftx/fhir_valuesets.pas#L4028-L4029`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_valuesets.pas#L4028-L4029)\n— After each filter is applied, calls `cs.isNotClosed(opContext, filter, f)`. For SNOMED CT, this unconditionally returns `true`:\n[`library/ftx/ftx_sct_services.pas#L5354-L5357`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/ftx_sct_services.pas#L5354-L5357)\n\n**Dev** uses a separate `filtersNotClosed()` method that SNOMED doesn't override:\n[`tx/workers/expand.js#L816-L818`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/expand.js#L816-L818)\n— Calls `cs.filtersNotClosed(prep)` after executing filters. The SNOMED provider (`tx/cs/cs-snomed.js`) does not override this method, so it inherits the base class default which returns `false`:\n[`tx/cs/cs-api.js#L557`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/cs/cs-api.js#L557)\n\nThe consequence is that `notClosed` stays `false` for SNOMED filter expansions. This causes both symptoms: (1) the `valueset-unclosed` extension is not added (expand.js L1296-1297), and (2) `expansion.total` is set (expand.js L1308-1311) because the code falls into the else branch that only runs when `notClosed` is `false`.\n\n**Fix**: Add `async filtersNotClosed() { return true; }` to the SNOMED provider class in `tx/cs/cs-snomed.js`, matching the existing `isNotClosed() { return true; }` at line 950.", "body_html": "<p>Records-Impacted: 292<br>\nTolerance-ID: expand-unclosed-extension-and-total<br>\nRecord-ID: b6156665-797d-4483-971c-62c00a0816b8</p>\n<pre><code class=\"lang-bash\">curl -s https://tx.fhir.org/r4/ValueSet/\\$expand \\\n  -H &quot;Accept: application/fhir+json&quot; \\\n  -H &quot;Content-Type: application/fhir+json&quot; \\\n  --data-binary @- &lt;&lt; &#x27;REQUEST&#x27;\n{\n  &quot;resourceType&quot;: &quot;Parameters&quot;,\n  &quot;parameter&quot;: [\n    {\n      &quot;name&quot;: &quot;count&quot;,\n      &quot;valueInteger&quot;: 1000\n    },\n    {\n      &quot;name&quot;: &quot;offset&quot;,\n      &quot;valueInteger&quot;: 0\n    },\n    {\n      &quot;name&quot;: &quot;valueSet&quot;,\n      &quot;resource&quot;: {\n        &quot;resourceType&quot;: &quot;ValueSet&quot;,\n        &quot;status&quot;: &quot;active&quot;,\n        &quot;compose&quot;: {\n          &quot;inactive&quot;: true,\n          &quot;include&quot;: [\n            {\n              &quot;system&quot;: &quot;http://snomed.info/sct&quot;,\n              &quot;filter&quot;: [\n                {\n                  &quot;property&quot;: &quot;concept&quot;,\n                  &quot;op&quot;: &quot;is-a&quot;,\n                  &quot;value&quot;: &quot;404684003&quot;\n                }\n              ]\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nREQUEST\n\ncurl -s https://tx-dev.fhir.org/r4/ValueSet/\\$expand \\\n  -H &quot;Accept: application/fhir+json&quot; \\\n  -H &quot;Content-Type: application/fhir+json&quot; \\\n  --data-binary @- &lt;&lt; &#x27;REQUEST&#x27;\n{\n  &quot;resourceType&quot;: &quot;Parameters&quot;,\n  &quot;parameter&quot;: [\n    {\n      &quot;name&quot;: &quot;count&quot;,\n      &quot;valueInteger&quot;: 1000\n    },\n    {\n      &quot;name&quot;: &quot;offset&quot;,\n      &quot;valueInteger&quot;: 0\n    },\n    {\n      &quot;name&quot;: &quot;valueSet&quot;,\n      &quot;resource&quot;: {\n        &quot;resourceType&quot;: &quot;ValueSet&quot;,\n        &quot;status&quot;: &quot;active&quot;,\n        &quot;compose&quot;: {\n          &quot;inactive&quot;: true,\n          &quot;include&quot;: [\n            {\n              &quot;system&quot;: &quot;http://snomed.info/sct&quot;,\n              &quot;filter&quot;: [\n                {\n                  &quot;property&quot;: &quot;concept&quot;,\n                  &quot;op&quot;: &quot;is-a&quot;,\n                  &quot;value&quot;: &quot;404684003&quot;\n                }\n              ]\n            }\n          ]\n        }\n      }\n    }\n  ]\n}\nREQUEST</code></pre>\n<p>Prod returns <code>expansion.extension</code> with <code>valueset-unclosed: true</code> and no <code>expansion.total</code>. Dev returns <code>expansion.total: 124412</code> with no unclosed extension.</p>\n<p>For $expand operations that return incomplete/truncated expansions (e.g., SNOMED CT is-a queries requesting count=1000 from a set with 124,412 total codes):</p>\n<ol><li>**Prod includes <code>expansion.extension</code> with <code>valueset-unclosed: true</code>; dev omits it.** Per the FHIR R4 spec, this extension signals that an expansion is incomplete due to inclusion of post-coordinated or unbounded value sets. Prod correctly marks these expansions as unclosed; dev does not.</li></ol>\n<ol><li>**Dev includes <code>expansion.total</code> (e.g., 124412); prod omits it.** The <code>total</code> field is optional (0..1) per spec. Prod omits it on these incomplete expansions; dev includes it. Since these expansions are truncated to the <code>count</code> parameter (e.g., 1000 codes returned), the behavioral difference is: dev tells the client the full count but doesn&#x27;t signal incompleteness, while prod signals incompleteness but doesn&#x27;t provide the full count.</li></ol>\n<p>These two differences always co-occur in the same records — every record where prod has <code>valueset-unclosed</code> but dev doesn&#x27;t also has dev providing <code>total</code> while prod doesn&#x27;t.</p>\n<p>292 records in the comparison dataset show both patterns simultaneously. All are successful (200/200) $expand operations. The pattern is predicted by: prod expansion has <code>valueset-unclosed</code> extension present AND dev expansion has <code>total</code> present but prod expansion does not.</p>\n<p>Search: analyzed all 810 successful expand deltas; 292 match the combined pattern <code>unclosed=prod-only AND total=dev-only</code>. No records show unclosed prod-only without total dev-only or vice versa.</p>\n<p>Tolerance <code>expand-unclosed-extension-and-total</code> matches $expand records where:</p>\n<ul><li>Both return 200 with expansion data</li><li>Prod has the <code>valueset-unclosed</code> extension but dev doesn&#x27;t</li><li>Dev has <code>expansion.total</code> but prod doesn&#x27;t</li></ul>\n<p>It normalizes by removing the <code>valueset-unclosed</code> extension from prod&#x27;s expansion.extension array and removing <code>total</code> from dev&#x27;s expansion object.</p>\n<p>b6156665-797d-4483-971c-62c00a0816b8: POST /r4/ValueSet/$expand — SNOMED CT is-a 404684003 (Clinical finding), count=1000. Prod returns 1000 codes with <code>valueset-unclosed: true</code> and no total. Dev returns 1000 codes with <code>total: 124412</code> and no unclosed extension.</p>\n<h2>Root Cause</h2>\n<p><strong>Classification</strong>: code-level defect</p>\n<p><strong>Prod</strong> calls <code>cs.isNotClosed()</code> per-filter to check if the code system&#x27;s expansion is unclosed:<br>\n<a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_valuesets.pas#L4028-L4029\" target=\"_blank\"><code>library/ftx/fhir_valuesets.pas#L4028-L4029</code></a><br>\n— After each filter is applied, calls <code>cs.isNotClosed(opContext, filter, f)</code>. For SNOMED CT, this unconditionally returns <code>true</code>:<br>\n<a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/ftx_sct_services.pas#L5354-L5357\" target=\"_blank\"><code>library/ftx/ftx_sct_services.pas#L5354-L5357</code></a></p>\n<p><strong>Dev</strong> uses a separate <code>filtersNotClosed()</code> method that SNOMED doesn&#x27;t override:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/expand.js#L816-L818\" target=\"_blank\"><code>tx/workers/expand.js#L816-L818</code></a><br>\n— Calls <code>cs.filtersNotClosed(prep)</code> after executing filters. The SNOMED provider (<code>tx/cs/cs-snomed.js</code>) does not override this method, so it inherits the base class default which returns <code>false</code>:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/cs/cs-api.js#L557\" target=\"_blank\"><code>tx/cs/cs-api.js#L557</code></a></p>\n<p>The consequence is that <code>notClosed</code> stays <code>false</code> for SNOMED filter expansions. This causes both symptoms: (1) the <code>valueset-unclosed</code> extension is not added (expand.js L1296-1297), and (2) <code>expansion.total</code> is set (expand.js L1308-1311) because the code falls into the else branch that only runs when <code>notClosed</code> is <code>false</code>.</p>\n<p><strong>Fix</strong>: Add <code>async filtersNotClosed() { return true; }</code> to the SNOMED provider class in <code>tx/cs/cs-snomed.js</code>, matching the existing <code>isNotClosed() { return true; }</code> at line 950.</p>", "impact": 292}, {"id": "f73e488", "title": "Dev crashes (500) on GET  when CodeSystem content mode prevents expansion", "status": "open", "labels": ["dev-crash-on-error", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 18:28", "date_iso": "2026-02-07T18:28:50-06:00", "body_md": "Records-Impacted: 258\nTolerance-ID: expand-dev-crash-on-error\nRecord-ID: 6b9d3a10-654f-4823-aadb-0fabc0d915bb\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fcore%2FValueSet%2Fus-core-procedure-code&_format=json' \\\n  -H 'Accept: application/fhir+json'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fcore%2FValueSet%2Fus-core-procedure-code&_format=json' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 422 with issue code \"too-costly\" and clean error message: \"The code System 'http://www.ama-assn.org/go/cpt' has a grammar, and cannot be enumerated directly\". Dev returns HTTP 500 with issue code \"business-rule\" and a JavaScript source code leak in the error message: `contentMode() {\\r\\n    return this.codeSystem.content;\\r\\n  }` instead of the actual content mode value.\n\n## What differs\n\nWhen expanding ValueSets that include code systems with restrictive content modes (e.g., HCPCS, ICD-9-CM), prod returns HTTP 422 with a clear OperationOutcome (issue code \"too-costly\", message like \"The code System X has a grammar, and cannot be enumerated directly\"). Dev returns HTTP 500 with multiple issues:\n\n1. **JS source code leak in error message**: Dev's error text contains interpolated JavaScript function body: `contentMode() {\\r\\n    return this.codeSystem.content;\\r\\n  }` instead of the actual content mode value. The message reads: \"The code system definition for <URL> is a contentMode() { return this.codeSystem.content; }, so this expansion is not permitted...\"\n\n2. **Different issue code**: Dev uses \"business-rule\" instead of prod's \"too-costly\"\n\n3. **Different HTTP status**: Dev returns 500 (server error) instead of 422 (semantic error)\n\n4. **Different code system referenced**: For us-core-procedure-code, prod references CPT (http://www.ama-assn.org/go/cpt) while dev references HCPCS (http://www.cms.gov/Medicare/Coding/HCPCSReleaseCodeSets). Both are included in the ValueSet but the servers stop at different code systems.\n\nAdditionally, 4 records within this category show different dev crashes:\n- 2 records: \"searchText.toLowerCase is not a function\" (medication-codes expand with filter)\n- 1 record: \"Unable to understand default system version\" (iso3166 expand)\n- 1 record: \"Cannot read properties of null (reading 'coding')\" (CodeSystem validate-code)\n\n## How widespread\n\n258 total dev-crash-on-error records in the delta file:\n- 257 are GET /r4/ValueSet/$expand (query params in URL)\n- 1 is POST /r4/CodeSystem/$validate-code\n- All share prod=422, dev=500\n\nThe contentMode JS leak specifically affects 254 records across 2 ValueSets:\n- us-core-procedure-code (200 records, code system: HCPCS)\n- us-core-condition-code (54 records, code system: ICD-9-CM)\n\n## What the tolerance covers\n\nThe existing tolerance `expand-dev-crash-on-error` only matched POST requests (exact URL match `/r4/ValueSet/$expand`). Updated to match URL starting with `/r4/ValueSet/$expand` (covering GET requests with query params) and also the CodeSystem/$validate-code crash. This brings coverage from ~0 to 258 records eliminated.\n\n## Representative record\n\n6b9d3a10-654f-4823-aadb-0fabc0d915bb — GET /r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fcore%2FValueSet%2Fus-core-procedure-code", "body_html": "<p>Records-Impacted: 258<br>\nTolerance-ID: expand-dev-crash-on-error<br>\nRecord-ID: 6b9d3a10-654f-4823-aadb-0fabc0d915bb</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fcore%2FValueSet%2Fus-core-procedure-code&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fcore%2FValueSet%2Fus-core-procedure-code&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns HTTP 422 with issue code &quot;too-costly&quot; and clean error message: &quot;The code System &#x27;<a href=\"http://www.ama-assn.org/go/cpt&#x27;\" target=\"_blank\">http://www.ama-assn.org/go/cpt&#x27;</a> has a grammar, and cannot be enumerated directly&quot;. Dev returns HTTP 500 with issue code &quot;business-rule&quot; and a JavaScript source code leak in the error message: <code>contentMode() {\\r\\n    return this.codeSystem.content;\\r\\n  }</code> instead of the actual content mode value.</p>\n<h2>What differs</h2>\n<p>When expanding ValueSets that include code systems with restrictive content modes (e.g., HCPCS, ICD-9-CM), prod returns HTTP 422 with a clear OperationOutcome (issue code &quot;too-costly&quot;, message like &quot;The code System X has a grammar, and cannot be enumerated directly&quot;). Dev returns HTTP 500 with multiple issues:</p>\n<ol><li><strong>JS source code leak in error message</strong>: Dev&#x27;s error text contains interpolated JavaScript function body: <code>contentMode() {\\r\\n    return this.codeSystem.content;\\r\\n  }</code> instead of the actual content mode value. The message reads: &quot;The code system definition for &lt;URL&gt; is a contentMode() { return this.codeSystem.content; }, so this expansion is not permitted...&quot;</li></ol>\n<ol><li><strong>Different issue code</strong>: Dev uses &quot;business-rule&quot; instead of prod&#x27;s &quot;too-costly&quot;</li></ol>\n<ol><li><strong>Different HTTP status</strong>: Dev returns 500 (server error) instead of 422 (semantic error)</li></ol>\n<ol><li><strong>Different code system referenced</strong>: For us-core-procedure-code, prod references CPT (<a href=\"http://www.ama-assn.org/go/cpt\" target=\"_blank\">http://www.ama-assn.org/go/cpt</a>) while dev references HCPCS (<a href=\"http://www.cms.gov/Medicare/Coding/HCPCSReleaseCodeSets\" target=\"_blank\">http://www.cms.gov/Medicare/Coding/HCPCSReleaseCodeSets</a>). Both are included in the ValueSet but the servers stop at different code systems.</li></ol>\n<p>Additionally, 4 records within this category show different dev crashes:</p>\n<ul><li>2 records: &quot;searchText.toLowerCase is not a function&quot; (medication-codes expand with filter)</li><li>1 record: &quot;Unable to understand default system version&quot; (iso3166 expand)</li><li>1 record: &quot;Cannot read properties of null (reading &#x27;coding&#x27;)&quot; (CodeSystem validate-code)</li></ul>\n<h2>How widespread</h2>\n<p>258 total dev-crash-on-error records in the delta file:</p>\n<ul><li>257 are GET /r4/ValueSet/$expand (query params in URL)</li><li>1 is POST /r4/CodeSystem/$validate-code</li><li>All share prod=422, dev=500</li></ul>\n<p>The contentMode JS leak specifically affects 254 records across 2 ValueSets:</p>\n<ul><li>us-core-procedure-code (200 records, code system: HCPCS)</li><li>us-core-condition-code (54 records, code system: ICD-9-CM)</li></ul>\n<h2>What the tolerance covers</h2>\n<p>The existing tolerance <code>expand-dev-crash-on-error</code> only matched POST requests (exact URL match <code>/r4/ValueSet/$expand</code>). Updated to match URL starting with <code>/r4/ValueSet/$expand</code> (covering GET requests with query params) and also the CodeSystem/$validate-code crash. This brings coverage from ~0 to 258 records eliminated.</p>\n<h2>Representative record</h2>\n<p>6b9d3a10-654f-4823-aadb-0fabc0d915bb — GET /r4/ValueSet/$expand?url=http:%2F%2Fhl7.org%2Ffhir%2Fus%2Fcore%2FValueSet%2Fus-core-procedure-code</p>", "impact": 258}, {"id": "4336772", "title": "Dev  returns only root concept for v3 hierarchical ValueSets (missing child codes)", "status": "open", "labels": ["code-defect", "content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:37", "date_iso": "2026-02-07T20:37:32-06:00", "body_md": "Records-Impacted: 246\nTolerance-ID: expand-v3-hierarchical-incomplete\nRecord-ID: 18d8209b-15f4-486d-8009-25ed8cb2cbcb\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http://terminology.hl7.org/ValueSet/v3-PurposeOfUse&_format=json' \\\n  -H 'Accept: application/fhir+json'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http://terminology.hl7.org/ValueSet/v3-PurposeOfUse&_format=json' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns `expansion.total=63` with 63 codes (PurposeOfUse root + 62 child codes like HMARKT, HOPERAT, TREAT, etc.). Dev returns `expansion.total=1` with only the root abstract concept `PurposeOfUse`.\n\n\nWhen expanding v3 ValueSets that include hierarchical concepts from `terminology.hl7.org/CodeSystem/v3-ActReason`, dev returns only the root abstract concept while prod returns the full hierarchy of child codes.\n\nFor example, expanding `http://terminology.hl7.org/ValueSet/v3-PurposeOfUse`:\n- Prod: `expansion.total=63`, contains 63 codes (PurposeOfUse root + 62 child codes like HMARKT, HOPERAT, TREAT, etc.)\n- Dev: `expansion.total=1`, contains only the root abstract concept `PurposeOfUse`\n\nThe same pattern affects 4 distinct v3 ValueSets:\n- `v3-ActEncounterCode`: prod=12 codes, dev=1 (209 records)\n- `v3-ServiceDeliveryLocationRoleType`: prod=139 codes, dev=1 (24 records)\n- `v3-PurposeOfUse`: prod=63 codes, dev=1 (6 records)\n- `v3-ActPharmacySupplyType`: prod=35 codes, dev=1 (7 records)\n\nIn all cases, dev returns only the root concept and completely omits the descendant codes that should be included in the expansion.\n\n\n246 records across the 4 ValueSets listed above. Found via:\n```bash\ngrep '\"op\":\"expand\"' jobs/2026-02-round-2/results/deltas/deltas.ndjson | python3 -c '...' # script checking prod_total>1 and dev_total==1\n```\n\nAll are GET requests to `/r4/ValueSet/$expand` with `url=http://terminology.hl7.org/ValueSet/v3-*`.\n\n\nTolerance ID: `expand-v3-hierarchical-incomplete`. Matches expand operations where both prod and dev return 200, the ValueSet URL matches `terminology.hl7.org/ValueSet/v3-`, and dev expansion total is 1 while prod expansion total is greater than 1. Skips these records. Eliminates 246 records.\n\n\nBug 6edc96c mentions these 246 records in a comment as potentially a separate root cause from the version skew issue. This bug tracks the specific failure to expand hierarchical v3 ValueSets.\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** resolves parent-child hierarchy from CodeSystem property definitions by matching on URI:\n[`library/ftx/fhir_codesystem_service.pas#L438-L458`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_codesystem_service.pas#L438-L458)\n— Iterates CodeSystem property definitions and matches any property where `code = 'parent'` OR `uri = 'http://hl7.org/fhir/concept-properties#parent'`. Then uses the matched property's actual `code` (e.g. `subsumedBy`) to find concept-level property entries and build parent-child relationships.\n\n**Dev** only matches hardcoded property code names `parent` and `child`:\n[`tx/library/codesystem.js#L507-L523`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/codesystem.js#L507-L523)\n— The `_buildHierarchyMaps` method checks `property.code === 'parent'` and `property.code === 'child'` but never consults the CodeSystem's property definitions to discover that `subsumedBy` maps to the standard parent URI `http://hl7.org/fhir/concept-properties#parent`.\n\nThe v3 CodeSystems (e.g. `v3-ActReason`) define their parent property as `{code: \"subsumedBy\", uri: \"http://hl7.org/fhir/concept-properties#parent\"}`. Since the dev server only checks for the literal string `\"parent\"`, it never builds the hierarchy for these code systems. When ValueSets like `v3-PurposeOfUse` use a `filter: [{property: \"concept\", op: \"is-a\", value: \"PurposeOfUse\"}]`, the `_addDescendants` call in `cs-cs.js` finds zero descendants because the `parentToChildrenMap` was never populated.\n\n**Fix**: In `_buildHierarchyMaps` (or `buildMaps`), consult the CodeSystem's top-level `property` definitions to identify which property codes map to `http://hl7.org/fhir/concept-properties#parent` (or `#child`), then use those codes when scanning concept properties — matching the prod server's approach.", "body_html": "<p>Records-Impacted: 246<br>\nTolerance-ID: expand-v3-hierarchical-incomplete<br>\nRecord-ID: 18d8209b-15f4-486d-8009-25ed8cb2cbcb</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand?url=http://terminology.hl7.org/ValueSet/v3-PurposeOfUse&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http://terminology.hl7.org/ValueSet/v3-PurposeOfUse&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns <code>expansion.total=63</code> with 63 codes (PurposeOfUse root + 62 child codes like HMARKT, HOPERAT, TREAT, etc.). Dev returns <code>expansion.total=1</code> with only the root abstract concept <code>PurposeOfUse</code>.</p>\n<p>When expanding v3 ValueSets that include hierarchical concepts from <code>terminology.hl7.org/CodeSystem/v3-ActReason</code>, dev returns only the root abstract concept while prod returns the full hierarchy of child codes.</p>\n<p>For example, expanding <code>http://terminology.hl7.org/ValueSet/v3-PurposeOfUse</code>:</p>\n<ul><li>Prod: <code>expansion.total=63</code>, contains 63 codes (PurposeOfUse root + 62 child codes like HMARKT, HOPERAT, TREAT, etc.)</li><li>Dev: <code>expansion.total=1</code>, contains only the root abstract concept <code>PurposeOfUse</code></li></ul>\n<p>The same pattern affects 4 distinct v3 ValueSets:</p>\n<ul><li><code>v3-ActEncounterCode</code>: prod=12 codes, dev=1 (209 records)</li><li><code>v3-ServiceDeliveryLocationRoleType</code>: prod=139 codes, dev=1 (24 records)</li><li><code>v3-PurposeOfUse</code>: prod=63 codes, dev=1 (6 records)</li><li><code>v3-ActPharmacySupplyType</code>: prod=35 codes, dev=1 (7 records)</li></ul>\n<p>In all cases, dev returns only the root concept and completely omits the descendant codes that should be included in the expansion.</p>\n<p>246 records across the 4 ValueSets listed above. Found via:</p>\n<pre><code class=\"lang-bash\">grep &#x27;&quot;op&quot;:&quot;expand&quot;&#x27; jobs/2026-02-round-2/results/deltas/deltas.ndjson | python3 -c &#x27;...&#x27; # script checking prod_total&gt;1 and dev_total==1</code></pre>\n<p>All are GET requests to <code>/r4/ValueSet/$expand</code> with <code>url=http://terminology.hl7.org/ValueSet/v3-*</code>.</p>\n<p>Tolerance ID: <code>expand-v3-hierarchical-incomplete</code>. Matches expand operations where both prod and dev return 200, the ValueSet URL matches <code>terminology.hl7.org/ValueSet/v3-</code>, and dev expansion total is 1 while prod expansion total is greater than 1. Skips these records. Eliminates 246 records.</p>\n<p>Bug 6edc96c mentions these 246 records in a comment as potentially a separate root cause from the version skew issue. This bug tracks the specific failure to expand hierarchical v3 ValueSets.</p>\n<h2>Root Cause</h2>\n<p><strong>Classification</strong>: code-level defect</p>\n<p><strong>Prod</strong> resolves parent-child hierarchy from CodeSystem property definitions by matching on URI:<br>\n<a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_codesystem_service.pas#L438-L458\" target=\"_blank\"><code>library/ftx/fhir_codesystem_service.pas#L438-L458</code></a><br>\n— Iterates CodeSystem property definitions and matches any property where <code>code = &#x27;parent&#x27;</code> OR <code>uri = &#x27;http://hl7.org/fhir/concept-properties#parent&#x27;</code>. Then uses the matched property&#x27;s actual <code>code</code> (e.g. <code>subsumedBy</code>) to find concept-level property entries and build parent-child relationships.</p>\n<p><strong>Dev</strong> only matches hardcoded property code names <code>parent</code> and <code>child</code>:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/codesystem.js#L507-L523\" target=\"_blank\"><code>tx/library/codesystem.js#L507-L523</code></a><br>\n— The <code>_buildHierarchyMaps</code> method checks <code>property.code === &#x27;parent&#x27;</code> and <code>property.code === &#x27;child&#x27;</code> but never consults the CodeSystem&#x27;s property definitions to discover that <code>subsumedBy</code> maps to the standard parent URI <code>http://hl7.org/fhir/concept-properties#parent</code>.</p>\n<p>The v3 CodeSystems (e.g. <code>v3-ActReason</code>) define their parent property as <code>{code: &quot;subsumedBy&quot;, uri: &quot;http://hl7.org/fhir/concept-properties#parent&quot;}</code>. Since the dev server only checks for the literal string <code>&quot;parent&quot;</code>, it never builds the hierarchy for these code systems. When ValueSets like <code>v3-PurposeOfUse</code> use a <code>filter: [{property: &quot;concept&quot;, op: &quot;is-a&quot;, value: &quot;PurposeOfUse&quot;}]</code>, the <code>_addDescendants</code> call in <code>cs-cs.js</code> finds zero descendants because the <code>parentToChildrenMap</code> was never populated.</p>\n<p><strong>Fix</strong>: In <code>_buildHierarchyMaps</code> (or <code>buildMaps</code>), consult the CodeSystem&#x27;s top-level <code>property</code> definitions to identify which property codes map to <code>http://hl7.org/fhir/concept-properties#parent</code> (or <code>#child</code>), then use those codes when scanning concept properties — matching the prod server&#x27;s approach.</p>", "impact": 246}, {"id": "4f12dda", "title": "Dev loads older SNOMED CT and CPT editions, causing expand contains[].version to differ", "status": "open", "labels": ["config-issue", "content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:14", "date_iso": "2026-02-07T20:14:02-06:00", "body_md": "Records-Impacted: 198\nTolerance-ID: expand-contains-version-skew\nRecord-ID: 6f9cf4c7-e6f4-445c-bc86-323b2b6d7165\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fcts.nlm.nih.gov%2Ffhir%2FValueSet%2F2.16.840.1.113762.1.4.1267.23&_format=json' \\\n  -H 'Accept: application/fhir+json' | jq '.expansion.contains[:3] | map({system, code, version})'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fcts.nlm.nih.gov%2Ffhir%2FValueSet%2F2.16.840.1.113762.1.4.1267.23&_format=json' \\\n  -H 'Accept: application/fhir+json' | jq '.expansion.contains[:3] | map({system, code, version})'\n```\n\nProd returns SNOMED version `http://snomed.info/sct/731000124108/version/20250901` and CPT version `2026`, dev returns SNOMED version `http://snomed.info/sct/731000124108/version/20250301` and CPT version `2025`.\n\n## What differs\n\nIn $expand responses, prod and dev return the same set of codes (same system + code pairs) but with different `version` strings on `expansion.contains[]` entries:\n\n- **SNOMED CT US edition**: prod returns `http://snomed.info/sct/731000124108/version/20250901`, dev returns `http://snomed.info/sct/731000124108/version/20250301`\n- **CPT (AMA)**: prod returns `2026`, dev returns `2025`\n\nBoth sides return 200 with identical code membership (280 codes in the representative record), but each code's version field reflects the loaded edition.\n\nThis differs from bug 9fd2328, which covers the case where SNOMED version skew causes *different* code sets to appear. Here, the codes are the same — only the version annotations differ.\n\n## How widespread\n\n198 expand delta records exhibit this pattern. All are the same ValueSet URL (`http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1267.23`) requested with different parameters. Each contains 280 codes with both SNOMED and CPT codes, where all codes match but version strings differ.\n\nFound via:\n```python\n# For each expand delta with same code membership,\n# check if contains[].version differs for common codes\n```\n\n## What the tolerance covers\n\nTolerance `expand-contains-version-skew` matches expand records where both sides return 200, the code membership is identical, but `contains[].version` strings differ for common codes. It normalizes all `contains[].version` values to prod's values. This only triggers when code sets are the same (no extra/missing codes) — the existing `expand-snomed-version-skew-content` tolerance handles cases with code membership differences.", "body_html": "<p>Records-Impacted: 198<br>\nTolerance-ID: expand-contains-version-skew<br>\nRecord-ID: 6f9cf4c7-e6f4-445c-bc86-323b2b6d7165</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fcts.nlm.nih.gov%2Ffhir%2FValueSet%2F2.16.840.1.113762.1.4.1267.23&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; | jq &#x27;.expansion.contains[:3] | map({system, code, version})&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fcts.nlm.nih.gov%2Ffhir%2FValueSet%2F2.16.840.1.113762.1.4.1267.23&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; | jq &#x27;.expansion.contains[:3] | map({system, code, version})&#x27;</code></pre>\n<p>Prod returns SNOMED version <code>http://snomed.info/sct/731000124108/version/20250901</code> and CPT version <code>2026</code>, dev returns SNOMED version <code>http://snomed.info/sct/731000124108/version/20250301</code> and CPT version <code>2025</code>.</p>\n<h2>What differs</h2>\n<p>In $expand responses, prod and dev return the same set of codes (same system + code pairs) but with different <code>version</code> strings on <code>expansion.contains[]</code> entries:</p>\n<ul><li><strong>SNOMED CT US edition</strong>: prod returns <code>http://snomed.info/sct/731000124108/version/20250901</code>, dev returns <code>http://snomed.info/sct/731000124108/version/20250301</code></li><li><strong>CPT (AMA)</strong>: prod returns <code>2026</code>, dev returns <code>2025</code></li></ul>\n<p>Both sides return 200 with identical code membership (280 codes in the representative record), but each code&#x27;s version field reflects the loaded edition.</p>\n<p>This differs from bug 9fd2328, which covers the case where SNOMED version skew causes <em>different</em> code sets to appear. Here, the codes are the same — only the version annotations differ.</p>\n<h2>How widespread</h2>\n<p>198 expand delta records exhibit this pattern. All are the same ValueSet URL (<code>http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1267.23</code>) requested with different parameters. Each contains 280 codes with both SNOMED and CPT codes, where all codes match but version strings differ.</p>\n<p>Found via:</p>\n<pre><code class=\"lang-python\"># For each expand delta with same code membership,\n# check if contains[].version differs for common codes</code></pre>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>expand-contains-version-skew</code> matches expand records where both sides return 200, the code membership is identical, but <code>contains[].version</code> strings differ for common codes. It normalizes all <code>contains[].version</code> values to prod&#x27;s values. This only triggers when code sets are the same (no extra/missing codes) — the existing <code>expand-snomed-version-skew-content</code> tolerance handles cases with code membership differences.</p>", "impact": 198}, {"id": "167be81", "title": "Dev returns result=false for valid v3 terminology codes in ValueSet $validate-code", "status": "open", "labels": ["code-defect", "reproduced", "result-disagrees", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:35", "date_iso": "2026-02-07T20:35:16-06:00", "body_md": "Records-Impacted: 187\nTolerance-ID: v3-valueset-validate-code-result-disagrees\nRecord-ID: 92d4fd1a-70fc-4497-adb5-309a3f564716\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fconsent-category&code=INFA&_format=json&system=http:%2F%2Fterminology.hl7.org%2FCodeSystem%2Fv3-ActCode' \\\n  -H 'Accept: application/fhir+json'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fconsent-category&code=INFA&_format=json&system=http:%2F%2Fterminology.hl7.org%2FCodeSystem%2Fv3-ActCode' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns `result: true` (code is valid in the ValueSet), dev returns `result: false` with error message \"The provided code 'http://terminology.hl7.org/CodeSystem/v3-ActCode#INFA' was not found in the value set 'http://hl7.org/fhir/ValueSet/consent-category|4.0.1'\".\n\nThe bug reproduces across multiple ValueSets:\n- encounter-participant-type with code CON from v3-ParticipationType\n- v3-ActEncounterCode with code AMB from v3-ActCode\n\n## Root Cause\n\n**Classification**: code-level defect\n\nHL7 v3 CodeSystems (e.g., v3-ActCode, v3-ParticipationType, v3-RoleCode) use a **flat concept list** with a property named `subsumedBy` to define hierarchy. This property is declared with `uri: \"http://hl7.org/fhir/concept-properties#parent\"` — the standard FHIR URI for parent relationships — but with the non-standard property code `subsumedBy` instead of `parent`.\n\n**Prod** resolves hierarchy by matching on the property URI, not just the code:\n[`fhir_codesystem_service.pas#L438-L458`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_codesystem_service.pas#L438-L458)\n— In `loadCodeSystem`, iterates the CodeSystem's `property` declarations and matches any property where `prop.code = 'parent'` **or** `prop.uri = 'http://hl7.org/fhir/concept-properties#parent'`. This finds the `subsumedBy` property via its URI. Then uses `prop.code` (= `subsumedBy`) to look up concept-level properties and build parent-child relationships.\n\n**Dev** only matches on hardcoded property code names `parent` and `child`:\n[`tx/library/codesystem.js#L507-L523`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/codesystem.js#L507-L523)\n— In `_buildHierarchyMaps`, checks `property.code === 'parent'` and `property.code === 'child'` only. Never consults the CodeSystem's property declarations or their URIs. Since v3 CodeSystems use `subsumedBy` (not `parent`), no hierarchy relationships are built. `getDescendants('_ActConsentType')` returns empty, so `is-a` filter matching in `checkConceptSet` finds no descendants, and validation returns false.\n\n**Fix**: In `_buildHierarchyMaps`, look up the CodeSystem's `property` declarations to find which property code maps to `http://hl7.org/fhir/concept-properties#parent` (and `#child`), then use those codes when scanning concept properties — matching the prod server's approach.\n\n## What differs\n\nProd returns `result: true` for $validate-code of HL7 v3 terminology codes against their corresponding ValueSets. Dev returns `result: false` with message \"The provided code was not found in the value set.\"\n\nBoth servers agree on the CodeSystem version, code, and display text — dev can look up the code successfully in the CodeSystem. But dev fails to determine that the code is a member of the ValueSet.\n\nExample (this record): GET /r4/ValueSet/$validate-code with system=v3-ActCode, code=INFA, url=consent-category.\n- Prod: result=true, version=9.0.0, display=\"information access\"\n- Dev: result=false, version=9.0.0, display=\"information access\", message=\"code not found in value set consent-category|4.0.1\"\n\n## How widespread\n\n187 records across 5 ValueSets, all GET requests, all r4, all using terminology.hl7.org/CodeSystem/v3-* systems:\n\n- 103 records: v3-ActEncounterCode ValueSet (codes AMB, IMP, HH, EMER from v3-ActCode)\n- 69 records: encounter-participant-type ValueSet (codes CON, ADM, ATND from v3-ParticipationType)\n- 9 records: consent-category ValueSet (code INFA from v3-ActCode)\n- 4 records: v3-ServiceDeliveryLocationRoleType ValueSet (codes ER, CARD, SLEEP from v3-RoleCode)\n- 2 records: v3-PurposeOfUse ValueSet (code HMARKT from v3-ActReason)\n\nSearch used: grep 'result-disagrees' deltas.ndjson, filtered to terminology.hl7.org/CodeSystem/v3-* systems.\n\n## What the tolerance covers\n\nTolerance `v3-valueset-validate-code-result-disagrees` skips records where:\n- Operation is ValueSet/$validate-code\n- System is terminology.hl7.org/CodeSystem/v3-*\n- prodResult=true, devResult=false\n- Both sides report the same CodeSystem version\n\nEliminates 187 records.", "body_html": "<p>Records-Impacted: 187<br>\nTolerance-ID: v3-valueset-validate-code-result-disagrees<br>\nRecord-ID: 92d4fd1a-70fc-4497-adb5-309a3f564716</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fconsent-category&amp;code=INFA&amp;_format=json&amp;system=http:%2F%2Fterminology.hl7.org%2FCodeSystem%2Fv3-ActCode&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fconsent-category&amp;code=INFA&amp;_format=json&amp;system=http:%2F%2Fterminology.hl7.org%2FCodeSystem%2Fv3-ActCode&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns <code>result: true</code> (code is valid in the ValueSet), dev returns <code>result: false</code> with error message &quot;The provided code &#x27;<a href=\"http://terminology.hl7.org/CodeSystem/v3-ActCode#INFA&#x27;\" target=\"_blank\">http://terminology.hl7.org/CodeSystem/v3-ActCode#INFA&#x27;</a> was not found in the value set &#x27;<a href=\"http://hl7.org/fhir/ValueSet/consent-category|4.0.1&#x27;&quot;.\" target=\"_blank\">http://hl7.org/fhir/ValueSet/consent-category|4.0.1&#x27;&quot;.</a></p>\n<p>The bug reproduces across multiple ValueSets:</p>\n<ul><li>encounter-participant-type with code CON from v3-ParticipationType</li><li>v3-ActEncounterCode with code AMB from v3-ActCode</li></ul>\n<h2>Root Cause</h2>\n<p><strong>Classification</strong>: code-level defect</p>\n<p>HL7 v3 CodeSystems (e.g., v3-ActCode, v3-ParticipationType, v3-RoleCode) use a <strong>flat concept list</strong> with a property named <code>subsumedBy</code> to define hierarchy. This property is declared with <code>uri: &quot;http://hl7.org/fhir/concept-properties#parent&quot;</code> — the standard FHIR URI for parent relationships — but with the non-standard property code <code>subsumedBy</code> instead of <code>parent</code>.</p>\n<p><strong>Prod</strong> resolves hierarchy by matching on the property URI, not just the code:<br>\n<a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_codesystem_service.pas#L438-L458\" target=\"_blank\"><code>fhir_codesystem_service.pas#L438-L458</code></a><br>\n— In <code>loadCodeSystem</code>, iterates the CodeSystem&#x27;s <code>property</code> declarations and matches any property where <code>prop.code = &#x27;parent&#x27;</code> <strong>or</strong> <code>prop.uri = &#x27;http://hl7.org/fhir/concept-properties#parent&#x27;</code>. This finds the <code>subsumedBy</code> property via its URI. Then uses <code>prop.code</code> (= <code>subsumedBy</code>) to look up concept-level properties and build parent-child relationships.</p>\n<p><strong>Dev</strong> only matches on hardcoded property code names <code>parent</code> and <code>child</code>:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/codesystem.js#L507-L523\" target=\"_blank\"><code>tx/library/codesystem.js#L507-L523</code></a><br>\n— In <code>_buildHierarchyMaps</code>, checks <code>property.code === &#x27;parent&#x27;</code> and <code>property.code === &#x27;child&#x27;</code> only. Never consults the CodeSystem&#x27;s property declarations or their URIs. Since v3 CodeSystems use <code>subsumedBy</code> (not <code>parent</code>), no hierarchy relationships are built. <code>getDescendants(&#x27;_ActConsentType&#x27;)</code> returns empty, so <code>is-a</code> filter matching in <code>checkConceptSet</code> finds no descendants, and validation returns false.</p>\n<p><strong>Fix</strong>: In <code>_buildHierarchyMaps</code>, look up the CodeSystem&#x27;s <code>property</code> declarations to find which property code maps to <code>http://hl7.org/fhir/concept-properties#parent</code> (and <code>#child</code>), then use those codes when scanning concept properties — matching the prod server&#x27;s approach.</p>\n<h2>What differs</h2>\n<p>Prod returns <code>result: true</code> for $validate-code of HL7 v3 terminology codes against their corresponding ValueSets. Dev returns <code>result: false</code> with message &quot;The provided code was not found in the value set.&quot;</p>\n<p>Both servers agree on the CodeSystem version, code, and display text — dev can look up the code successfully in the CodeSystem. But dev fails to determine that the code is a member of the ValueSet.</p>\n<p>Example (this record): GET /r4/ValueSet/$validate-code with system=v3-ActCode, code=INFA, url=consent-category.</p>\n<ul><li>Prod: result=true, version=9.0.0, display=&quot;information access&quot;</li><li>Dev: result=false, version=9.0.0, display=&quot;information access&quot;, message=&quot;code not found in value set consent-category|4.0.1&quot;</li></ul>\n<h2>How widespread</h2>\n<p>187 records across 5 ValueSets, all GET requests, all r4, all using terminology.hl7.org/CodeSystem/v3-* systems:</p>\n<ul><li>103 records: v3-ActEncounterCode ValueSet (codes AMB, IMP, HH, EMER from v3-ActCode)</li><li>69 records: encounter-participant-type ValueSet (codes CON, ADM, ATND from v3-ParticipationType)</li><li>9 records: consent-category ValueSet (code INFA from v3-ActCode)</li><li>4 records: v3-ServiceDeliveryLocationRoleType ValueSet (codes ER, CARD, SLEEP from v3-RoleCode)</li><li>2 records: v3-PurposeOfUse ValueSet (code HMARKT from v3-ActReason)</li></ul>\n<p>Search used: grep &#x27;result-disagrees&#x27; deltas.ndjson, filtered to terminology.hl7.org/CodeSystem/v3-* systems.</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>v3-valueset-validate-code-result-disagrees</code> skips records where:</p>\n<ul><li>Operation is ValueSet/$validate-code</li><li>System is terminology.hl7.org/CodeSystem/v3-*</li><li>prodResult=true, devResult=false</li><li>Both sides report the same CodeSystem version</li></ul>\n<p>Eliminates 187 records.</p>", "impact": 187}, {"id": "e4e45bc", "title": "Dev returns 200 instead of 422 for validate-code with code but no system parameter", "status": "open", "labels": ["reproduced", "status-mismatch", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 19:08", "date_iso": "2026-02-07T19:08:04-06:00", "body_md": "Records-Impacted: 133\nTolerance-ID: validate-code-no-system-422\nRecord-ID: 5ea323a9-073d-4ebf-b1ae-0a374b35c26d\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code?url=http%3A%2F%2Fterminology.hl7.org%2FValueSet%2FUSPS-State&code=TX&_format=json' \\\n  -H 'Accept: application/fhir+json'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http%3A%2F%2Fterminology.hl7.org%2FValueSet%2FUSPS-State&code=TX&_format=json' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 422 with OperationOutcome: \"Unable to find code to validate (looked for coding | codeableConcept | code+system | code+inferSystem in parameters ...)\". Dev returns HTTP 200 with Parameters containing `result=true`, `system=https://www.usps.com/`, `code=TX`, `display=Texas`.\n\n\nWhen $validate-code is called with `code` but no `system` parameter (and no `context`), prod returns HTTP 422 with an OperationOutcome error: \"Unable to find code to validate (looked for coding | codeableConcept | code+system | code+inferSystem in parameters ...)\". Dev returns HTTP 200 with a successful Parameters response, inferring the system from the ValueSet.\n\nPer the FHIR spec for ValueSet/$validate-code: \"If a code is provided, a system or a context must be provided.\" Prod correctly rejects these requests; dev incorrectly accepts them by inferring the system.\n\n\n133 records across 14 distinct request URLs, all sharing the same pattern:\n- GET /r4/ValueSet/$validate-code with `url=...&code=...` but no `system` parameter\n- One POST /r4/CodeSystem/$validate-code with only `code` in the Parameters body (no system)\n\nExamples include ValueSets for USPS-State, defined-types, iso3166-1-2, mimetypes, languages, administrative-gender, encounter-status, event-status, patient-contactrelationship, and a CTS ValueSet.\n\nFound via: `grep '\"status-mismatch\"' deltas.ndjson > /tmp/sm.ndjson` then filtering for prod.status=422, dev.status=200, op=validate-code.\n\n\nTolerance ID: `validate-code-no-system-422`. Matches validate-code records where prod returns 422 and dev returns 200, and the request has `code` but no `system` parameter (checked in both URL query params and POST request body). Eliminates 133 records.\n\n\n5ea323a9-073d-4ebf-b1ae-0a374b35c26d — GET /r4/ValueSet/$validate-code?url=http:%2F%2Fterminology.hl7.org%2FValueSet%2FUSPS-State&code=TX&_format=json", "body_html": "<p>Records-Impacted: 133<br>\nTolerance-ID: validate-code-no-system-422<br>\nRecord-ID: 5ea323a9-073d-4ebf-b1ae-0a374b35c26d</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r4/ValueSet/$validate-code?url=http%3A%2F%2Fterminology.hl7.org%2FValueSet%2FUSPS-State&amp;code=TX&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http%3A%2F%2Fterminology.hl7.org%2FValueSet%2FUSPS-State&amp;code=TX&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns HTTP 422 with OperationOutcome: &quot;Unable to find code to validate (looked for coding | codeableConcept | code+system | code+inferSystem in parameters ...)&quot;. Dev returns HTTP 200 with Parameters containing <code>result=true</code>, <code>system=https://www.usps.com/</code>, <code>code=TX</code>, <code>display=Texas</code>.</p>\n<p>When $validate-code is called with <code>code</code> but no <code>system</code> parameter (and no <code>context</code>), prod returns HTTP 422 with an OperationOutcome error: &quot;Unable to find code to validate (looked for coding | codeableConcept | code+system | code+inferSystem in parameters ...)&quot;. Dev returns HTTP 200 with a successful Parameters response, inferring the system from the ValueSet.</p>\n<p>Per the FHIR spec for ValueSet/$validate-code: &quot;If a code is provided, a system or a context must be provided.&quot; Prod correctly rejects these requests; dev incorrectly accepts them by inferring the system.</p>\n<p>133 records across 14 distinct request URLs, all sharing the same pattern:</p>\n<ul><li>GET /r4/ValueSet/$validate-code with <code>url=...&amp;code=...</code> but no <code>system</code> parameter</li><li>One POST /r4/CodeSystem/$validate-code with only <code>code</code> in the Parameters body (no system)</li></ul>\n<p>Examples include ValueSets for USPS-State, defined-types, iso3166-1-2, mimetypes, languages, administrative-gender, encounter-status, event-status, patient-contactrelationship, and a CTS ValueSet.</p>\n<p>Found via: <code>grep &#x27;&quot;status-mismatch&quot;&#x27; deltas.ndjson &gt; /tmp/sm.ndjson</code> then filtering for prod.status=422, dev.status=200, op=validate-code.</p>\n<p>Tolerance ID: <code>validate-code-no-system-422</code>. Matches validate-code records where prod returns 422 and dev returns 200, and the request has <code>code</code> but no <code>system</code> parameter (checked in both URL query params and POST request body). Eliminates 133 records.</p>\n<p>5ea323a9-073d-4ebf-b1ae-0a374b35c26d — GET /r4/ValueSet/$validate-code?url=http:%2F%2Fterminology.hl7.org%2FValueSet%2FUSPS-State&amp;code=TX&amp;_format=json</p>", "impact": 133}, {"id": "9fd2328", "title": "Dev loads older SNOMED CT edition (20240201) than prod (20250201), causing  to return different code sets", "status": "open", "labels": ["config-issue", "content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:23", "date_iso": "2026-02-07T20:23:08-06:00", "body_md": "Records-Impacted: 82\nTolerance-ID: expand-snomed-version-skew-content, expand-snomed-version-skew-content-no-used-cs, snomed-version-skew-message-text\nRecord-ID: 2c7143df-3316-422a-b284-237f16fbcd6e, accdb602-a8bc-4e9c-a8fb-22a12b740f0e, 3534e5f0-39e3-4375-9b37-4dc59848cb70\n\n## What differs\n\nProd and dev load different SNOMED CT editions, causing multiple types of differences across $expand and $validate-code operations. Three variants observed:\n\n1. **$expand with `used-codesystem` parameter** (POST requests with inline ValueSets): Prod uses SNOMED International edition 20250201, dev uses 20240201. The `used-codesystem` expansion parameter confirms the version difference. Example: expanding descendants of 365636006 \"Finding of blood group\" — prod returns 208 codes, dev returns 207 (code 1351894008 \"Mixed field RhD\" only in prod).\n\n2. **$expand without `used-codesystem` parameter** (GET requests for VSAC ValueSets): Prod uses SNOMED US edition 20250901, dev uses 20250301. Version difference is only visible in `contains[].version` strings. Example: ValueSet 2.16.840.1.113762.1.4.1240.3 (\"Sex\") — dev returns 5 codes including 184115007 \"Patient sex unknown (finding)\" which is absent from prod's 4-code expansion.\n\n3. **$validate-code message/issues text version skew**: Both sides agree on result=false, but the error message text and OperationOutcome issue text contain different SNOMED edition version strings (e.g., \"version 'http://snomed.info/sct/900000000000207008/version/20250201'\" in prod vs \"version/20240201\" in dev). The message structure and content are otherwise identical — only the embedded version URI differs. All are POST /r4/ValueSet/$validate-code with SNOMED codes that are not found in the specified ValueSet.\n\n## How widespread\n\n82 records total:\n- 40 expand records with `used-codesystem` parameter (POST /r4/ValueSet/$expand with SNOMED filters)\n- 7 expand records without `used-codesystem` parameter (GET /r4/ValueSet/$expand for VSAC ValueSet 2.16.840.1.113762.1.4.1240.3)\n- 35 validate-code content-differs records where message/issues text contain SNOMED version strings that differ only due to edition version skew\n\n## What the tolerances cover\n\n- **`expand-snomed-version-skew-content`** (40 records): Matches expand records where both sides return 200, SNOMED `used-codesystem` versions differ, and code membership differs. Normalizes both sides to the intersection of codes and adjusts total.\n\n- **`expand-snomed-version-skew-content-no-used-cs`** (7 records): Matches expand records where SNOMED version skew is detectable only from `contains[].version` strings (no `used-codesystem` expansion parameter). Same normalization approach — intersects code membership, adjusts total, and normalizes version strings to prod's values.\n\n- **`snomed-version-skew-message-text`** (35 records): Matches validate-code Parameters responses where SNOMED version strings in the `message` valueString and `issues` OperationOutcome issue text differ, but the text is otherwise identical after version normalization. Replaces dev's SNOMED version URIs with prod's values in both the message parameter and issue detail text fields.", "body_html": "<p>Records-Impacted: 82<br>\nTolerance-ID: expand-snomed-version-skew-content, expand-snomed-version-skew-content-no-used-cs, snomed-version-skew-message-text<br>\nRecord-ID: 2c7143df-3316-422a-b284-237f16fbcd6e, accdb602-a8bc-4e9c-a8fb-22a12b740f0e, 3534e5f0-39e3-4375-9b37-4dc59848cb70</p>\n<h2>What differs</h2>\n<p>Prod and dev load different SNOMED CT editions, causing multiple types of differences across $expand and $validate-code operations. Three variants observed:</p>\n<ol><li>**$expand with <code>used-codesystem</code> parameter** (POST requests with inline ValueSets): Prod uses SNOMED International edition 20250201, dev uses 20240201. The <code>used-codesystem</code> expansion parameter confirms the version difference. Example: expanding descendants of 365636006 &quot;Finding of blood group&quot; — prod returns 208 codes, dev returns 207 (code 1351894008 &quot;Mixed field RhD&quot; only in prod).</li></ol>\n<ol><li>**$expand without <code>used-codesystem</code> parameter** (GET requests for VSAC ValueSets): Prod uses SNOMED US edition 20250901, dev uses 20250301. Version difference is only visible in <code>contains[].version</code> strings. Example: ValueSet 2.16.840.1.113762.1.4.1240.3 (&quot;Sex&quot;) — dev returns 5 codes including 184115007 &quot;Patient sex unknown (finding)&quot; which is absent from prod&#x27;s 4-code expansion.</li></ol>\n<ol><li><strong>$validate-code message/issues text version skew</strong>: Both sides agree on result=false, but the error message text and OperationOutcome issue text contain different SNOMED edition version strings (e.g., &quot;version &#x27;<a href=\"http://snomed.info/sct/900000000000207008/version/20250201&#x27;&quot;\" target=\"_blank\">http://snomed.info/sct/900000000000207008/version/20250201&#x27;&quot;</a> in prod vs &quot;version/20240201&quot; in dev). The message structure and content are otherwise identical — only the embedded version URI differs. All are POST /r4/ValueSet/$validate-code with SNOMED codes that are not found in the specified ValueSet.</li></ol>\n<h2>How widespread</h2>\n<p>82 records total:</p>\n<ul><li>40 expand records with <code>used-codesystem</code> parameter (POST /r4/ValueSet/$expand with SNOMED filters)</li><li>7 expand records without <code>used-codesystem</code> parameter (GET /r4/ValueSet/$expand for VSAC ValueSet 2.16.840.1.113762.1.4.1240.3)</li><li>35 validate-code content-differs records where message/issues text contain SNOMED version strings that differ only due to edition version skew</li></ul>\n<h2>What the tolerances cover</h2>\n<ul><li>**<code>expand-snomed-version-skew-content</code>** (40 records): Matches expand records where both sides return 200, SNOMED <code>used-codesystem</code> versions differ, and code membership differs. Normalizes both sides to the intersection of codes and adjusts total.</li></ul>\n<ul><li>**<code>expand-snomed-version-skew-content-no-used-cs</code>** (7 records): Matches expand records where SNOMED version skew is detectable only from <code>contains[].version</code> strings (no <code>used-codesystem</code> expansion parameter). Same normalization approach — intersects code membership, adjusts total, and normalizes version strings to prod&#x27;s values.</li></ul>\n<ul><li>**<code>snomed-version-skew-message-text</code>** (35 records): Matches validate-code Parameters responses where SNOMED version strings in the <code>message</code> valueString and <code>issues</code> OperationOutcome issue text differ, but the text is otherwise identical after version normalization. Replaces dev&#x27;s SNOMED version URIs with prod&#x27;s values in both the message parameter and issue detail text fields.</li></ul>", "impact": 82}, {"id": "e02b03e", "title": "Prod HGVS timeout: 62 records have prod=500 due to external service timeout, comparison invalid", "status": "open", "labels": ["config-issue", "reproduced", "status-mismatch", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:14", "date_iso": "2026-02-07T20:14:02-06:00", "body_md": "Records-Impacted: 62\nTolerance-ID: skip-prod-hgvs-timeout\nRecord-ID: 286d30a9-e2b8-4967-8c56-265b3f6160a6\n\n\n```bash\ncurl -s https://tx.fhir.org/r4/CodeSystem/'$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://varnomen.hgvs.org\",\"code\":\"BRCA1:c.3143delG p.(Gly1048ValfsTer14)\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"cache-id\",\"valueId\":\"7743c2e6-5b90-4b62-bcd2-6695b993e76b\"},{\"name\":\"system-version\",\"valueUri\":\"http://snomed.info/sct|http://snomed.info/sct/83821000000107\"},{\"name\":\"diagnostics\",\"valueBoolean\":true}]}'\n\ncurl -s https://tx-dev.fhir.org/r4/CodeSystem/'$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://varnomen.hgvs.org\",\"code\":\"BRCA1:c.3143delG p.(Gly1048ValfsTer14)\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"cache-id\",\"valueId\":\"7743c2e6-5b90-4b62-bcd2-6695b993e76b\"},{\"name\":\"system-version\",\"valueUri\":\"http://snomed.info/sct|http://snomed.info/sct/83821000000107\"},{\"name\":\"diagnostics\",\"valueBoolean\":true}]}'\n```\n\nProd returns HTTP 500 with OperationOutcome: \"Error parsing HGVS response: Read timed out.\" Dev returns HTTP 200 with Parameters: result=false, indicating the HGVS code is unknown.\n\n\nProd returns HTTP 500 with an OperationOutcome error: \"Error parsing HGVS response: Read timed out.\" Dev returns HTTP 200 with a proper Parameters response (result=false, code not found in http://varnomen.hgvs.org version 2.0).\n\nProd's 500 is a transient failure — the prod server timed out calling an external HGVS validation service during data collection. Dev processes the same code locally and returns a valid terminology response.\n\n\n62 records in the comparison dataset. All share:\n- System: http://varnomen.hgvs.org\n- Operation: $validate-code (POST /r4/CodeSystem/$validate-code?)\n- Status: prod=500, dev=200\n- Category: status-mismatch\n- Prod body contains \"Error parsing HGVS response: Read timed out.\"\n\nSearch: `grep -c 'Read timed out' results/deltas/deltas.ndjson` → 62\n\nThere are 124 total HGVS records in the dataset; the other 62 did not timeout and have prod=200, dev=200.\n\n\nTolerance `skip-prod-hgvs-timeout` skips any record where prod returned 500 and the prod body contains \"Read timed out\". These records have unreliable comparison data since prod failed to complete the operation. Eliminates 62 records.\n\n\n286d30a9-e2b8-4967-8c56-265b3f6160a6\n\nThis is a data collection artifact — the comparison data is tainted because prod experienced transient external service timeouts during the collection run. These records should be recollected in a future run.", "body_html": "<p>Records-Impacted: 62<br>\nTolerance-ID: skip-prod-hgvs-timeout<br>\nRecord-ID: 286d30a9-e2b8-4967-8c56-265b3f6160a6</p>\n<pre><code class=\"lang-bash\">curl -s https://tx.fhir.org/r4/CodeSystem/&#x27;$validate-code&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;coding&quot;,&quot;valueCoding&quot;:{&quot;system&quot;:&quot;http://varnomen.hgvs.org&quot;,&quot;code&quot;:&quot;BRCA1:c.3143delG p.(Gly1048ValfsTer14)&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en-GB&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;cache-id&quot;,&quot;valueId&quot;:&quot;7743c2e6-5b90-4b62-bcd2-6695b993e76b&quot;},{&quot;name&quot;:&quot;system-version&quot;,&quot;valueUri&quot;:&quot;http://snomed.info/sct|http://snomed.info/sct/83821000000107&quot;},{&quot;name&quot;:&quot;diagnostics&quot;,&quot;valueBoolean&quot;:true}]}&#x27;\n\ncurl -s https://tx-dev.fhir.org/r4/CodeSystem/&#x27;$validate-code&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;coding&quot;,&quot;valueCoding&quot;:{&quot;system&quot;:&quot;http://varnomen.hgvs.org&quot;,&quot;code&quot;:&quot;BRCA1:c.3143delG p.(Gly1048ValfsTer14)&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en-GB&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;cache-id&quot;,&quot;valueId&quot;:&quot;7743c2e6-5b90-4b62-bcd2-6695b993e76b&quot;},{&quot;name&quot;:&quot;system-version&quot;,&quot;valueUri&quot;:&quot;http://snomed.info/sct|http://snomed.info/sct/83821000000107&quot;},{&quot;name&quot;:&quot;diagnostics&quot;,&quot;valueBoolean&quot;:true}]}&#x27;</code></pre>\n<p>Prod returns HTTP 500 with OperationOutcome: &quot;Error parsing HGVS response: Read timed out.&quot; Dev returns HTTP 200 with Parameters: result=false, indicating the HGVS code is unknown.</p>\n<p>Prod returns HTTP 500 with an OperationOutcome error: &quot;Error parsing HGVS response: Read timed out.&quot; Dev returns HTTP 200 with a proper Parameters response (result=false, code not found in <a href=\"http://varnomen.hgvs.org\" target=\"_blank\">http://varnomen.hgvs.org</a> version 2.0).</p>\n<p>Prod&#x27;s 500 is a transient failure — the prod server timed out calling an external HGVS validation service during data collection. Dev processes the same code locally and returns a valid terminology response.</p>\n<p>62 records in the comparison dataset. All share:</p>\n<ul><li>System: <a href=\"http://varnomen.hgvs.org\" target=\"_blank\">http://varnomen.hgvs.org</a></li><li>Operation: $validate-code (POST /r4/CodeSystem/$validate-code?)</li><li>Status: prod=500, dev=200</li><li>Category: status-mismatch</li><li>Prod body contains &quot;Error parsing HGVS response: Read timed out.&quot;</li></ul>\n<p>Search: <code>grep -c &#x27;Read timed out&#x27; results/deltas/deltas.ndjson</code> → 62</p>\n<p>There are 124 total HGVS records in the dataset; the other 62 did not timeout and have prod=200, dev=200.</p>\n<p>Tolerance <code>skip-prod-hgvs-timeout</code> skips any record where prod returned 500 and the prod body contains &quot;Read timed out&quot;. These records have unreliable comparison data since prod failed to complete the operation. Eliminates 62 records.</p>\n<p>286d30a9-e2b8-4967-8c56-265b3f6160a6</p>\n<p>This is a data collection artifact — the comparison data is tainted because prod experienced transient external service timeouts during the collection run. These records should be recollected in a future run.</p>", "impact": 62}, {"id": "3103b01", "title": "Dev returns extra informational HGVS syntax issue in $validate-code for varnomen.hgvs.org", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:40", "date_iso": "2026-02-07T20:40:20-06:00", "body_md": "Records-Impacted: 62\nTolerance-ID: hgvs-extra-syntax-issue\nRecord-ID: cdf72565-a646-4daa-86f9-ed5ead0058d6\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/CodeSystem/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://varnomen.hgvs.org\",\"code\":\"NC_000003.11\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r4/CodeSystem/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://varnomen.hgvs.org\",\"code\":\"NC_000003.11\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n```\n\nProd returns 1 OperationOutcome issue (error-level only), dev returns 2 issues (error-level plus an additional informational-level issue with text: \"Error while processing 'NC_000003.11': Missing one of 'c', 'g', 'm', 'n', 'p', 'r' followed by '.'.\")\n\n\nFor $validate-code operations against http://varnomen.hgvs.org, both prod and dev correctly return result=false for invalid HGVS codes. Both return the same error-level OperationOutcome issue (\"Unknown code 'X' in the CodeSystem 'http://varnomen.hgvs.org' version '2.0'\").\n\nHowever, dev returns an additional informational-level OperationOutcome issue that prod does not:\n\n- severity: \"information\"\n- code: \"code-invalid\"\n- text: \"Error while processing '<code>': Missing one of 'c', 'g', 'm', 'n', 'p', 'r' followed by '.'.\"\n\nThis appears to be HGVS-specific syntax validation feedback that dev performs but prod does not.\n\n\n62 records in content-differs category show this exact pattern. All involve $validate-code POST to /r4/CodeSystem/$validate-code? with system http://varnomen.hgvs.org. All have the same extra informational issue text pattern (\"Missing one of 'c', 'g', 'm', 'n', 'p', 'r' followed by '.'\").\n\nSearch: grep -c \"Missing one of\" results/deltas/deltas.ndjson => 62\n\n\nTolerance ID: hgvs-extra-syntax-issue. Matches $validate-code records for http://varnomen.hgvs.org where dev has more OperationOutcome issues than prod, and the extra issues are informational-level. Normalizes by trimming dev's issue list to match prod's length. Eliminates 62 records.\n\n\ncdf72565-a646-4daa-86f9-ed5ead0058d6\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Dev** adds an extra informational issue from the `locate()` message when a code is not found:\n[`tx/workers/validate.js#L1506-L1508`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L1506-L1508)\n— In `checkConceptSet`, after adding the `Unknown_Code_in_Version` error, dev checks `if (loc.message && op)` and adds an informational issue with the message returned by the HGVS provider's `locate()` method.\n\n**Dev HGVS provider** passes the NLM service error message through as `loc.message`:\n[`tx/cs/cs-hgvs.js#L111-L115`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/cs/cs-hgvs.js#L111-L115)\n— When the NLM `$validate-code` returns `result=false`, the HGVS syntax error message (e.g., \"Missing one of 'c', 'g', 'm', 'n', 'p', 'r' followed by '.'\") is returned as `{ context: null, message: result.message }`.\n\n**Prod** does not add informational issues from the `locate()` message:\n[`library/ftx/fhir_valuesets.pas#L2273-L2281`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_valuesets.pas#L2273-L2281)\n— In `checkConceptSet`, when `loc = nil`, prod only adds the `Unknown_Code_in_Version` error issue. There is no code to emit the `message` var as an additional informational issue. (Additionally, the prod HGVS `locate` at [`server/tx/tx_hgvs.pas#L252-L253`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx/tx_hgvs.pas#L252-L253) reads `o.str['message']` instead of `o.str['valueString']`, so the NLM error message is never captured regardless.)\n\n**Fix**: Remove the informational issue emission in `tx/workers/validate.js` lines 1506-1508, or gate it behind a condition that matches prod behavior. The `loc.message` from `locate()` should not be surfaced as a separate OperationOutcome issue since prod does not emit it.", "body_html": "<p>Records-Impacted: 62<br>\nTolerance-ID: hgvs-extra-syntax-issue<br>\nRecord-ID: cdf72565-a646-4daa-86f9-ed5ead0058d6</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r4/CodeSystem/$validate-code&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;coding&quot;,&quot;valueCoding&quot;:{&quot;system&quot;:&quot;http://varnomen.hgvs.org&quot;,&quot;code&quot;:&quot;NC_000003.11&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en-GB&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true}]}&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r4/CodeSystem/$validate-code&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;coding&quot;,&quot;valueCoding&quot;:{&quot;system&quot;:&quot;http://varnomen.hgvs.org&quot;,&quot;code&quot;:&quot;NC_000003.11&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en-GB&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true}]}&#x27;</code></pre>\n<p>Prod returns 1 OperationOutcome issue (error-level only), dev returns 2 issues (error-level plus an additional informational-level issue with text: &quot;Error while processing &#x27;NC_000003.11&#x27;: Missing one of &#x27;c&#x27;, &#x27;g&#x27;, &#x27;m&#x27;, &#x27;n&#x27;, &#x27;p&#x27;, &#x27;r&#x27; followed by &#x27;.&#x27;.&quot;)</p>\n<p>For $validate-code operations against <a href=\"http://varnomen.hgvs.org,\" target=\"_blank\">http://varnomen.hgvs.org,</a> both prod and dev correctly return result=false for invalid HGVS codes. Both return the same error-level OperationOutcome issue (&quot;Unknown code &#x27;X&#x27; in the CodeSystem &#x27;<a href=\"http://varnomen.hgvs.org&#x27;\" target=\"_blank\">http://varnomen.hgvs.org&#x27;</a> version &#x27;2.0&#x27;&quot;).</p>\n<p>However, dev returns an additional informational-level OperationOutcome issue that prod does not:</p>\n<ul><li>severity: &quot;information&quot;</li><li>code: &quot;code-invalid&quot;</li><li>text: &quot;Error while processing &#x27;&lt;code&gt;&#x27;: Missing one of &#x27;c&#x27;, &#x27;g&#x27;, &#x27;m&#x27;, &#x27;n&#x27;, &#x27;p&#x27;, &#x27;r&#x27; followed by &#x27;.&#x27;.&quot;</li></ul>\n<p>This appears to be HGVS-specific syntax validation feedback that dev performs but prod does not.</p>\n<p>62 records in content-differs category show this exact pattern. All involve $validate-code POST to /r4/CodeSystem/$validate-code? with system <a href=\"http://varnomen.hgvs.org.\" target=\"_blank\">http://varnomen.hgvs.org.</a> All have the same extra informational issue text pattern (&quot;Missing one of &#x27;c&#x27;, &#x27;g&#x27;, &#x27;m&#x27;, &#x27;n&#x27;, &#x27;p&#x27;, &#x27;r&#x27; followed by &#x27;.&#x27;&quot;).</p>\n<p>Search: grep -c &quot;Missing one of&quot; results/deltas/deltas.ndjson =&gt; 62</p>\n<p>Tolerance ID: hgvs-extra-syntax-issue. Matches $validate-code records for <a href=\"http://varnomen.hgvs.org\" target=\"_blank\">http://varnomen.hgvs.org</a> where dev has more OperationOutcome issues than prod, and the extra issues are informational-level. Normalizes by trimming dev&#x27;s issue list to match prod&#x27;s length. Eliminates 62 records.</p>\n<p>cdf72565-a646-4daa-86f9-ed5ead0058d6</p>\n<h2>Root Cause</h2>\n<p><strong>Classification</strong>: code-level defect</p>\n<p><strong>Dev</strong> adds an extra informational issue from the <code>locate()</code> message when a code is not found:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L1506-L1508\" target=\"_blank\"><code>tx/workers/validate.js#L1506-L1508</code></a><br>\n— In <code>checkConceptSet</code>, after adding the <code>Unknown_Code_in_Version</code> error, dev checks <code>if (loc.message &amp;&amp; op)</code> and adds an informational issue with the message returned by the HGVS provider&#x27;s <code>locate()</code> method.</p>\n<p><strong>Dev HGVS provider</strong> passes the NLM service error message through as <code>loc.message</code>:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/cs/cs-hgvs.js#L111-L115\" target=\"_blank\"><code>tx/cs/cs-hgvs.js#L111-L115</code></a><br>\n— When the NLM <code>$validate-code</code> returns <code>result=false</code>, the HGVS syntax error message (e.g., &quot;Missing one of &#x27;c&#x27;, &#x27;g&#x27;, &#x27;m&#x27;, &#x27;n&#x27;, &#x27;p&#x27;, &#x27;r&#x27; followed by &#x27;.&#x27;&quot;) is returned as <code>{ context: null, message: result.message }</code>.</p>\n<p><strong>Prod</strong> does not add informational issues from the <code>locate()</code> message:<br>\n<a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_valuesets.pas#L2273-L2281\" target=\"_blank\"><code>library/ftx/fhir_valuesets.pas#L2273-L2281</code></a><br>\n— In <code>checkConceptSet</code>, when <code>loc = nil</code>, prod only adds the <code>Unknown_Code_in_Version</code> error issue. There is no code to emit the <code>message</code> var as an additional informational issue. (Additionally, the prod HGVS <code>locate</code> at <a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/server/tx/tx_hgvs.pas#L252-L253\" target=\"_blank\"><code>server/tx/tx_hgvs.pas#L252-L253</code></a> reads <code>o.str[&#x27;message&#x27;]</code> instead of <code>o.str[&#x27;valueString&#x27;]</code>, so the NLM error message is never captured regardless.)</p>\n<p><strong>Fix</strong>: Remove the informational issue emission in <code>tx/workers/validate.js</code> lines 1506-1508, or gate it behind a condition that matches prod behavior. The <code>loc.message</code> from <code>locate()</code> should not be surfaced as a separate OperationOutcome issue since prod does not emit it.</p>", "impact": 62}, {"id": "6b31694", "title": "Dev crashes (500) on GET  with filter parameter: searchText.toLowerCase is not a function", "status": "open", "labels": ["dev-crash-on-valid", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 19:50", "date_iso": "2026-02-07T19:50:55-06:00", "body_md": "Records-Impacted: 58\nTolerance-ID: expand-filter-crash\nRecord-ID: dabcdc4f-feed-4ac8-adea-8999b06187a5\n\n## Repro\n\n```bash\n# Prod (returns 200 with ValueSet expansion)\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http://hl7.org/fhir/ValueSet/participant-role&filter=referr&count=50' \\\n  -H 'Accept: application/fhir+json'\n\n# Dev (returns 500 with error)\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http://hl7.org/fhir/ValueSet/participant-role&filter=referr&count=50' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 200 with a valid ValueSet expansion. Dev returns HTTP 500 with OperationOutcome: `searchText.toLowerCase is not a function`. Reproduced with multiple filter values (`referr`, `family`, `referring`) across different ValueSets.\n\n## What differs\n\nDev returns HTTP 500 with OperationOutcome error `searchText.toLowerCase is not a function` on all GET `$expand` requests (R4 and R5) that include a `filter` parameter. Prod returns 200 with a valid ValueSet expansion.\n\nThe error is a JavaScript TypeError indicating that `searchText` is null/undefined when `.toLowerCase()` is called during filter processing.\n\n## How widespread\n\nAll 58 records matching this error in the comparison dataset. Every one is a GET `/r4/ValueSet/$expand` or `/r5/ValueSet/$expand` request with a `filter=` query parameter. They span 3 distinct ValueSets:\n- `http://hl7.org/fhir/ValueSet/participant-role` (R4 and R5)\n- `http://hl7.org/fhir/ValueSet/condition-code` (R4)\n- `http://hl7.org/fhir/ValueSet/medication-codes` (R4)\n\nSearch: `grep -c 'searchText.toLowerCase is not a function' jobs/2026-02-round-2/results/deltas/deltas.ndjson` → 58\n\n## What the tolerance covers\n\nTolerance ID: `expand-filter-crash`\nMatches: GET requests to `/r[345]/ValueSet/$expand` where `filter=` is in the URL, `prod.status=200`, `dev.status=500`, and the dev response contains `searchText.toLowerCase is not a function`.\nEliminates: 58 records.\n\n## Representative records\n\n- `dabcdc4f-feed-4ac8-adea-8999b06187a5` — `GET /r4/ValueSet/$expand?url=http://hl7.org/fhir/ValueSet/participant-role&filter=referr&count=50`", "body_html": "<p>Records-Impacted: 58<br>\nTolerance-ID: expand-filter-crash<br>\nRecord-ID: dabcdc4f-feed-4ac8-adea-8999b06187a5</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod (returns 200 with ValueSet expansion)\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand?url=http://hl7.org/fhir/ValueSet/participant-role&amp;filter=referr&amp;count=50&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\n# Dev (returns 500 with error)\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http://hl7.org/fhir/ValueSet/participant-role&amp;filter=referr&amp;count=50&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns HTTP 200 with a valid ValueSet expansion. Dev returns HTTP 500 with OperationOutcome: <code>searchText.toLowerCase is not a function</code>. Reproduced with multiple filter values (<code>referr</code>, <code>family</code>, <code>referring</code>) across different ValueSets.</p>\n<h2>What differs</h2>\n<p>Dev returns HTTP 500 with OperationOutcome error <code>searchText.toLowerCase is not a function</code> on all GET <code>$expand</code> requests (R4 and R5) that include a <code>filter</code> parameter. Prod returns 200 with a valid ValueSet expansion.</p>\n<p>The error is a JavaScript TypeError indicating that <code>searchText</code> is null/undefined when <code>.toLowerCase()</code> is called during filter processing.</p>\n<h2>How widespread</h2>\n<p>All 58 records matching this error in the comparison dataset. Every one is a GET <code>/r4/ValueSet/$expand</code> or <code>/r5/ValueSet/$expand</code> request with a <code>filter=</code> query parameter. They span 3 distinct ValueSets:</p>\n<ul><li><code>http://hl7.org/fhir/ValueSet/participant-role</code> (R4 and R5)</li><li><code>http://hl7.org/fhir/ValueSet/condition-code</code> (R4)</li><li><code>http://hl7.org/fhir/ValueSet/medication-codes</code> (R4)</li></ul>\n<p>Search: <code>grep -c &#x27;searchText.toLowerCase is not a function&#x27; jobs/2026-02-round-2/results/deltas/deltas.ndjson</code> → 58</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance ID: <code>expand-filter-crash</code><br>\nMatches: GET requests to <code>/r[345]/ValueSet/$expand</code> where <code>filter=</code> is in the URL, <code>prod.status=200</code>, <code>dev.status=500</code>, and the dev response contains <code>searchText.toLowerCase is not a function</code>.<br>\nEliminates: 58 records.</p>\n<h2>Representative records</h2>\n<ul><li><code>dabcdc4f-feed-4ac8-adea-8999b06187a5</code> — <code>GET /r4/ValueSet/$expand?url=http://hl7.org/fhir/ValueSet/participant-role&amp;filter=referr&amp;count=50</code></li></ul>", "impact": 58}, {"id": "4aebc14", "title": "Dev -code result=false for SNOMED codes valid in prod due to older SNOMED edition", "status": "open", "labels": ["config-issue", "reproduced", "result-disagrees", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:14", "date_iso": "2026-02-07T20:14:02-06:00", "body_md": "Records-Impacted: 57\nTolerance-ID: snomed-version-skew-validate-code-result-disagrees\nRecord-ID: a74520f2-677a-41d4-a489-57b323c8dfb9\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code?' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://snomed.info/sct\",\"code\":\"39154008\",\"display\":\"Clinical diagnosis\"}},{\"name\":\"valueSetMode\",\"valueString\":\"NO_MEMBERSHIP_CHECK\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"ndhm-diagnosis-use\",\"url\":\"https://nrces.in/ndhm/fhir/r4/ValueSet/ndhm-diagnosis-use\",\"version\":\"6.5.0\",\"compose\":{\"include\":[{\"system\":\"http://snomed.info/sct\",\"filter\":[{\"property\":\"concept\",\"op\":\"is-a\",\"value\":\"106229004\"}]}],\"exclude\":[{\"system\":\"http://snomed.info/sct\",\"concept\":[{\"code\":\"106229004\",\"display\":\"Qualifier for type of diagnosis\"}]}]}}},{\"name\":\"system-version\",\"valueString\":\"http://snomed.info/sct|http://snomed.info/sct/900000000000207008\"}]}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"http://snomed.info/sct\",\"code\":\"39154008\",\"display\":\"Clinical diagnosis\"}},{\"name\":\"valueSetMode\",\"valueString\":\"NO_MEMBERSHIP_CHECK\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"ndhm-diagnosis-use\",\"url\":\"https://nrces.in/ndhm/fhir/r4/ValueSet/ndhm-diagnosis-use\",\"version\":\"6.5.0\",\"compose\":{\"include\":[{\"system\":\"http://snomed.info/sct\",\"filter\":[{\"property\":\"concept\",\"op\":\"is-a\",\"value\":\"106229004\"}]}],\"exclude\":[{\"system\":\"http://snomed.info/sct\",\"concept\":[{\"code\":\"106229004\",\"display\":\"Qualifier for type of diagnosis\"}]}]}}},{\"name\":\"system-version\",\"valueString\":\"http://snomed.info/sct|http://snomed.info/sct/900000000000207008\"}]}'\n```\n\nProd returns `result: true` with SNOMED version 20250201. Dev returns `result: false` with SNOMED version 20240201 and an error message that code 39154008 was not found in the ValueSet.\n\n## What differs\n\nOn ValueSet $validate-code operations with SNOMED CT codes, prod returns result=true while dev returns result=false. The root cause is that dev loads older SNOMED CT editions than prod (e.g., International 20240201 vs 20250201, US 20240201 vs 20250901). When a ValueSet uses hierarchy-based filters (e.g., is-a or descendent-of), the code membership can differ between SNOMED versions because the hierarchical relationships change between editions.\n\nFor example, in the representative record, SNOMED code 39154008 (\"Clinical diagnosis\") is validated against ValueSet ndhm-diagnosis-use (which filters for descendants of 106229004 \"Qualifier for type of diagnosis\"). Prod (version 20250201) says the code is in the ValueSet; dev (version 20240201) says it is not.\n\n## How widespread\n\n57 records in the full comparison.ndjson have SNOMED version-skewed validate-code result disagreements. Of those, 12 still appear in deltas.ndjson (the remaining 45 are already handled by other tolerances, likely because they also have status mismatches). Found via:\n\n```python\n# Check all validate-code records for SNOMED version skew + result disagreement\n# across comparison.ndjson\n```\n\nAffected SNOMED modules: International (20240201 vs 20250201) and US (20240201/20230301 vs 20250901). Multiple codes affected: 39154008, 116154003, 309343006, 1287116005, 428041000124106, and others.\n\n## What the tolerance covers\n\nTolerance `snomed-version-skew-validate-code-result-disagrees` skips validate-code records where both prod and dev return 200, both have SNOMED version parameters that differ, and the result boolean disagrees. This is the validate-code counterpart of the existing expand-snomed-version-skew-content tolerance (bug 9fd2328). Eliminates 1 delta record (the others are already handled by existing status-mismatch tolerances).\n\n## Related\n\nSame root cause as bug 9fd2328 (Dev loads older SNOMED CT edition), which covers $expand operations.", "body_html": "<p>Records-Impacted: 57<br>\nTolerance-ID: snomed-version-skew-validate-code-result-disagrees<br>\nRecord-ID: a74520f2-677a-41d4-a489-57b323c8dfb9</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$validate-code?&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;coding&quot;,&quot;valueCoding&quot;:{&quot;system&quot;:&quot;http://snomed.info/sct&quot;,&quot;code&quot;:&quot;39154008&quot;,&quot;display&quot;:&quot;Clinical diagnosis&quot;}},{&quot;name&quot;:&quot;valueSetMode&quot;,&quot;valueString&quot;:&quot;NO_MEMBERSHIP_CHECK&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;id&quot;:&quot;ndhm-diagnosis-use&quot;,&quot;url&quot;:&quot;https://nrces.in/ndhm/fhir/r4/ValueSet/ndhm-diagnosis-use&quot;,&quot;version&quot;:&quot;6.5.0&quot;,&quot;compose&quot;:{&quot;include&quot;:[{&quot;system&quot;:&quot;http://snomed.info/sct&quot;,&quot;filter&quot;:[{&quot;property&quot;:&quot;concept&quot;,&quot;op&quot;:&quot;is-a&quot;,&quot;value&quot;:&quot;106229004&quot;}]}],&quot;exclude&quot;:[{&quot;system&quot;:&quot;http://snomed.info/sct&quot;,&quot;concept&quot;:[{&quot;code&quot;:&quot;106229004&quot;,&quot;display&quot;:&quot;Qualifier for type of diagnosis&quot;}]}]}}},{&quot;name&quot;:&quot;system-version&quot;,&quot;valueString&quot;:&quot;http://snomed.info/sct|http://snomed.info/sct/900000000000207008&quot;}]}&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$validate-code?&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;coding&quot;,&quot;valueCoding&quot;:{&quot;system&quot;:&quot;http://snomed.info/sct&quot;,&quot;code&quot;:&quot;39154008&quot;,&quot;display&quot;:&quot;Clinical diagnosis&quot;}},{&quot;name&quot;:&quot;valueSetMode&quot;,&quot;valueString&quot;:&quot;NO_MEMBERSHIP_CHECK&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;id&quot;:&quot;ndhm-diagnosis-use&quot;,&quot;url&quot;:&quot;https://nrces.in/ndhm/fhir/r4/ValueSet/ndhm-diagnosis-use&quot;,&quot;version&quot;:&quot;6.5.0&quot;,&quot;compose&quot;:{&quot;include&quot;:[{&quot;system&quot;:&quot;http://snomed.info/sct&quot;,&quot;filter&quot;:[{&quot;property&quot;:&quot;concept&quot;,&quot;op&quot;:&quot;is-a&quot;,&quot;value&quot;:&quot;106229004&quot;}]}],&quot;exclude&quot;:[{&quot;system&quot;:&quot;http://snomed.info/sct&quot;,&quot;concept&quot;:[{&quot;code&quot;:&quot;106229004&quot;,&quot;display&quot;:&quot;Qualifier for type of diagnosis&quot;}]}]}}},{&quot;name&quot;:&quot;system-version&quot;,&quot;valueString&quot;:&quot;http://snomed.info/sct|http://snomed.info/sct/900000000000207008&quot;}]}&#x27;</code></pre>\n<p>Prod returns <code>result: true</code> with SNOMED version 20250201. Dev returns <code>result: false</code> with SNOMED version 20240201 and an error message that code 39154008 was not found in the ValueSet.</p>\n<h2>What differs</h2>\n<p>On ValueSet $validate-code operations with SNOMED CT codes, prod returns result=true while dev returns result=false. The root cause is that dev loads older SNOMED CT editions than prod (e.g., International 20240201 vs 20250201, US 20240201 vs 20250901). When a ValueSet uses hierarchy-based filters (e.g., is-a or descendent-of), the code membership can differ between SNOMED versions because the hierarchical relationships change between editions.</p>\n<p>For example, in the representative record, SNOMED code 39154008 (&quot;Clinical diagnosis&quot;) is validated against ValueSet ndhm-diagnosis-use (which filters for descendants of 106229004 &quot;Qualifier for type of diagnosis&quot;). Prod (version 20250201) says the code is in the ValueSet; dev (version 20240201) says it is not.</p>\n<h2>How widespread</h2>\n<p>57 records in the full comparison.ndjson have SNOMED version-skewed validate-code result disagreements. Of those, 12 still appear in deltas.ndjson (the remaining 45 are already handled by other tolerances, likely because they also have status mismatches). Found via:</p>\n<pre><code class=\"lang-python\"># Check all validate-code records for SNOMED version skew + result disagreement\n# across comparison.ndjson</code></pre>\n<p>Affected SNOMED modules: International (20240201 vs 20250201) and US (20240201/20230301 vs 20250901). Multiple codes affected: 39154008, 116154003, 309343006, 1287116005, 428041000124106, and others.</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>snomed-version-skew-validate-code-result-disagrees</code> skips validate-code records where both prod and dev return 200, both have SNOMED version parameters that differ, and the result boolean disagrees. This is the validate-code counterpart of the existing expand-snomed-version-skew-content tolerance (bug 9fd2328). Eliminates 1 delta record (the others are already handled by existing status-mismatch tolerances).</p>\n<h2>Related</h2>\n<p>Same root cause as bug 9fd2328 (Dev loads older SNOMED CT edition), which covers $expand operations.</p>", "impact": 57}, {"id": "b36a12b", "title": "validate-code: unknown version message says 'no versions known' when valid versions exist", "status": "open", "labels": ["content-differs", "repro-inconclusive", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 17:35", "date_iso": "2026-02-07T17:35:40-06:00", "body_md": "Records-Impacted: 50\nTolerance-ID: unknown-version-no-versions-known\nRecord-ID: f8badb02-7ec3-4624-a906-eec8ec9f5656\n\n\n```bash\ncurl -s https://tx.fhir.org/r4/CodeSystem/\\$validate-code \\\n  -H \"Accept: application/fhir+json\" \\\n  -H \"Content-Type: application/fhir+json\" \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"https://fhir.nhs.uk/CodeSystem/England-GenomicTestDirectory\",\"version\":\"9\",\"code\":\"M119.5\",\"display\":\"Multi Target NGS Panel Small\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n\ncurl -s https://tx-dev.fhir.org/r4/CodeSystem/\\$validate-code \\\n  -H \"Accept: application/fhir+json\" \\\n  -H \"Content-Type: application/fhir+json\" \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"https://fhir.nhs.uk/CodeSystem/England-GenomicTestDirectory\",\"version\":\"9\",\"code\":\"M119.5\",\"display\":\"Multi Target NGS Panel Small\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n```\n\n**Repro inconclusive**: As of 2026-02-07, both servers now return \"No versions of this code system are known\". The England-GenomicTestDirectory CodeSystem appears to no longer be loaded on either server (tested versions 9, 7, and 0.1.0 all fail). The bug was real at the time of comparison (prod listed \"Valid versions: 0.1.0\" while dev said no versions known), but cannot be verified against the current live servers because the test CodeSystem is unavailable.\n\n\nWhen validating a code against a CodeSystem with a version that doesn't exist, but other versions of the CodeSystem are known:\n\n- **Prod** returns: \"A definition for CodeSystem '...' version 'X' could not be found, so the code cannot be validated. Valid versions: 0.1.0\"\n- **Dev** returns: \"A definition for CodeSystem '...' version 'X' could not be found, so the code cannot be validated. No versions of this code system are known\"\n\nAdditionally, the `x-caused-by-unknown-system` parameter differs:\n- **Prod**: includes the version suffix (e.g., `...England-GenomicTestDirectory|9`)\n- **Dev**: omits the version suffix (e.g., `...England-GenomicTestDirectory`)\n\nThe OperationOutcome message-id also differs:\n- **Prod**: `UNKNOWN_CODESYSTEM_VERSION`\n- **Dev**: `UNKNOWN_CODESYSTEM_VERSION_NONE`\n\nDev's message is factually incorrect — it claims \"No versions of this code system are known\" but it does know version 0.1.0 (proven by 40 other records for the same code system that validate successfully against version 0.1.0).\n\n\nAll 50 impacted records are $validate-code operations against `https://fhir.nhs.uk/CodeSystem/England-GenomicTestDirectory` with requested versions 7 (40 records) or 9 (10 records). Neither version exists — only 0.1.0 is valid.\n\nSearch: `grep 'No versions of this code system are known' jobs/2026-02-round-2/results/deltas/deltas.ndjson | wc -l` → 50\nAll 50 are for England-GenomicTestDirectory. All 50 also have \"Valid versions:\" in prod.\n\nThe pattern may apply more broadly to any CodeSystem where a nonexistent version is requested but other versions are loaded.\n\n\nTolerance `unknown-version-no-versions-known` normalizes the message text, OperationOutcome details, x-caused-by-unknown-system, and message-id for records matching this pattern: both result=false, prod message contains \"Valid versions:\", dev message contains \"No versions of this code system are known\". Eliminates 50 records.", "body_html": "<p>Records-Impacted: 50<br>\nTolerance-ID: unknown-version-no-versions-known<br>\nRecord-ID: f8badb02-7ec3-4624-a906-eec8ec9f5656</p>\n<pre><code class=\"lang-bash\">curl -s https://tx.fhir.org/r4/CodeSystem/\\$validate-code \\\n  -H &quot;Accept: application/fhir+json&quot; \\\n  -H &quot;Content-Type: application/fhir+json&quot; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;coding&quot;,&quot;valueCoding&quot;:{&quot;system&quot;:&quot;https://fhir.nhs.uk/CodeSystem/England-GenomicTestDirectory&quot;,&quot;version&quot;:&quot;9&quot;,&quot;code&quot;:&quot;M119.5&quot;,&quot;display&quot;:&quot;Multi Target NGS Panel Small&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en-GB&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true}]}&#x27;\n\ncurl -s https://tx-dev.fhir.org/r4/CodeSystem/\\$validate-code \\\n  -H &quot;Accept: application/fhir+json&quot; \\\n  -H &quot;Content-Type: application/fhir+json&quot; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;coding&quot;,&quot;valueCoding&quot;:{&quot;system&quot;:&quot;https://fhir.nhs.uk/CodeSystem/England-GenomicTestDirectory&quot;,&quot;version&quot;:&quot;9&quot;,&quot;code&quot;:&quot;M119.5&quot;,&quot;display&quot;:&quot;Multi Target NGS Panel Small&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en-GB&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true}]}&#x27;</code></pre>\n<p><strong>Repro inconclusive</strong>: As of 2026-02-07, both servers now return &quot;No versions of this code system are known&quot;. The England-GenomicTestDirectory CodeSystem appears to no longer be loaded on either server (tested versions 9, 7, and 0.1.0 all fail). The bug was real at the time of comparison (prod listed &quot;Valid versions: 0.1.0&quot; while dev said no versions known), but cannot be verified against the current live servers because the test CodeSystem is unavailable.</p>\n<p>When validating a code against a CodeSystem with a version that doesn&#x27;t exist, but other versions of the CodeSystem are known:</p>\n<ul><li><strong>Prod</strong> returns: &quot;A definition for CodeSystem &#x27;...&#x27; version &#x27;X&#x27; could not be found, so the code cannot be validated. Valid versions: 0.1.0&quot;</li><li><strong>Dev</strong> returns: &quot;A definition for CodeSystem &#x27;...&#x27; version &#x27;X&#x27; could not be found, so the code cannot be validated. No versions of this code system are known&quot;</li></ul>\n<p>Additionally, the <code>x-caused-by-unknown-system</code> parameter differs:</p>\n<ul><li><strong>Prod</strong>: includes the version suffix (e.g., <code>...England-GenomicTestDirectory|9</code>)</li><li><strong>Dev</strong>: omits the version suffix (e.g., <code>...England-GenomicTestDirectory</code>)</li></ul>\n<p>The OperationOutcome message-id also differs:</p>\n<ul><li><strong>Prod</strong>: <code>UNKNOWN_CODESYSTEM_VERSION</code></li><li><strong>Dev</strong>: <code>UNKNOWN_CODESYSTEM_VERSION_NONE</code></li></ul>\n<p>Dev&#x27;s message is factually incorrect — it claims &quot;No versions of this code system are known&quot; but it does know version 0.1.0 (proven by 40 other records for the same code system that validate successfully against version 0.1.0).</p>\n<p>All 50 impacted records are $validate-code operations against <code>https://fhir.nhs.uk/CodeSystem/England-GenomicTestDirectory</code> with requested versions 7 (40 records) or 9 (10 records). Neither version exists — only 0.1.0 is valid.</p>\n<p>Search: <code>grep &#x27;No versions of this code system are known&#x27; jobs/2026-02-round-2/results/deltas/deltas.ndjson | wc -l</code> → 50<br>\nAll 50 are for England-GenomicTestDirectory. All 50 also have &quot;Valid versions:&quot; in prod.</p>\n<p>The pattern may apply more broadly to any CodeSystem where a nonexistent version is requested but other versions are loaded.</p>\n<p>Tolerance <code>unknown-version-no-versions-known</code> normalizes the message text, OperationOutcome details, x-caused-by-unknown-system, and message-id for records matching this pattern: both result=false, prod message contains &quot;Valid versions:&quot;, dev message contains &quot;No versions of this code system are known&quot;. Eliminates 50 records.</p>", "impact": 50}, {"id": "2ed80bd", "title": "Dev  omits expansion.total when prod includes it", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 16:24", "date_iso": "2026-02-07T16:24:36-06:00", "body_md": "Records-Impacted: 47\nTolerance-ID: expand-dev-missing-total\nRecord-ID: a1f653a2-a199-4228-a7f7-2522abde6953\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand' -H 'Accept: application/fhir+json' -H 'Content-Type: application/fhir+json' -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"system-version\",\"valueUri\":\"http://snomed.info/sct|http://snomed.info/sct/11000315107\"},{\"name\":\"displayLanguage\",\"valueCode\":\"fr\"},{\"name\":\"includeDefinition\",\"valueBoolean\":false},{\"name\":\"excludeNested\",\"valueBoolean\":true},{\"name\":\"cache-id\",\"valueId\":\"4d94febc-fb6a-407d-a69c-29b8de3c56c3\"},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"status\":\"active\",\"compose\":{\"inactive\":true,\"include\":[{\"system\":\"urn:iso:std:iso:3166:-2\"}]}}}]}' | jq '.expansion | {total, contains_count: (.contains | length)}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand' -H 'Accept: application/fhir+json' -H 'Content-Type: application/fhir+json' -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"system-version\",\"valueUri\":\"http://snomed.info/sct|http://snomed.info/sct/11000315107\"},{\"name\":\"displayLanguage\",\"valueCode\":\"fr\"},{\"name\":\"includeDefinition\",\"valueBoolean\":false},{\"name\":\"excludeNested\",\"valueBoolean\":true},{\"name\":\"cache-id\",\"valueId\":\"4d94febc-fb6a-407d-a69c-29b8de3c56c3\"},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"status\":\"active\",\"compose\":{\"inactive\":true,\"include\":[{\"system\":\"urn:iso:std:iso:3166:-2\"}]}}}]}' | jq '.expansion | {total, contains_count: (.contains | length)}'\n```\n\nProd returns `\"total\": 5099` with 1000 contains entries. Dev returns `\"total\": null` (field missing) with 1000 contains entries.\n\n## What differs\n\nIn $expand responses (POST /r4/ValueSet/$expand), prod returns `expansion.total` (the total count of matching concepts) while dev omits it entirely. The `total` field is a 0..1 optional integer in FHIR R4's ValueSet.expansion, documented as \"Total concept count; permits server pagination.\" Without it, clients cannot determine how many pages exist in a paged expansion.\n\nExamples:\n- Prod: `\"total\": 5099` with 1000 contains (paged)\n- Dev: no `total` field, same 1000 contains\n\nBoth servers return identical `contains` arrays and `offset` values in all sampled records.\n\n## How widespread\n\n47 records in deltas.ndjson show this pattern (prod has expansion.total, dev omits it). Breakdown:\n- 33 records with total=5099 (paged SNOMED expansions with count=1000)\n- 13 records with total=0 (empty expansions)\n- 1 record with total=249 (ISO 3166 codes, also has contains count mismatch)\n\nSearch: All 47 are expand operations, all POST /r4/ValueSet/$expand, all with both statuses 200.\n\nNote: There is a separate existing tolerance (expand-unclosed-extension-and-total, bug f2b2cef) for the reverse case where prod omits total on unclosed expansions but dev includes it. That bug is about the valueset-unclosed extension. This bug is different — neither side has the unclosed extension; dev simply fails to include `total` in complete expansions.\n\n## What the tolerance covers\n\nTolerance ID: expand-dev-missing-total\nMatches: $expand responses (POST /r4/ValueSet/$expand) where both sides return 200, prod has expansion.total, and dev doesn't.\nNormalizes by removing expansion.total from prod (since dev lacks it) to prevent re-triaging.", "body_html": "<p>Records-Impacted: 47<br>\nTolerance-ID: expand-dev-missing-total<br>\nRecord-ID: a1f653a2-a199-4228-a7f7-2522abde6953</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand&#x27; -H &#x27;Accept: application/fhir+json&#x27; -H &#x27;Content-Type: application/fhir+json&#x27; -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;system-version&quot;,&quot;valueUri&quot;:&quot;http://snomed.info/sct|http://snomed.info/sct/11000315107&quot;},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueCode&quot;:&quot;fr&quot;},{&quot;name&quot;:&quot;includeDefinition&quot;,&quot;valueBoolean&quot;:false},{&quot;name&quot;:&quot;excludeNested&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;cache-id&quot;,&quot;valueId&quot;:&quot;4d94febc-fb6a-407d-a69c-29b8de3c56c3&quot;},{&quot;name&quot;:&quot;count&quot;,&quot;valueInteger&quot;:1000},{&quot;name&quot;:&quot;offset&quot;,&quot;valueInteger&quot;:0},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;status&quot;:&quot;active&quot;,&quot;compose&quot;:{&quot;inactive&quot;:true,&quot;include&quot;:[{&quot;system&quot;:&quot;urn:iso:std:iso:3166:-2&quot;}]}}}]}&#x27; | jq &#x27;.expansion | {total, contains_count: (.contains | length)}&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand&#x27; -H &#x27;Accept: application/fhir+json&#x27; -H &#x27;Content-Type: application/fhir+json&#x27; -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;system-version&quot;,&quot;valueUri&quot;:&quot;http://snomed.info/sct|http://snomed.info/sct/11000315107&quot;},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueCode&quot;:&quot;fr&quot;},{&quot;name&quot;:&quot;includeDefinition&quot;,&quot;valueBoolean&quot;:false},{&quot;name&quot;:&quot;excludeNested&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;cache-id&quot;,&quot;valueId&quot;:&quot;4d94febc-fb6a-407d-a69c-29b8de3c56c3&quot;},{&quot;name&quot;:&quot;count&quot;,&quot;valueInteger&quot;:1000},{&quot;name&quot;:&quot;offset&quot;,&quot;valueInteger&quot;:0},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;status&quot;:&quot;active&quot;,&quot;compose&quot;:{&quot;inactive&quot;:true,&quot;include&quot;:[{&quot;system&quot;:&quot;urn:iso:std:iso:3166:-2&quot;}]}}}]}&#x27; | jq &#x27;.expansion | {total, contains_count: (.contains | length)}&#x27;</code></pre>\n<p>Prod returns <code>&quot;total&quot;: 5099</code> with 1000 contains entries. Dev returns <code>&quot;total&quot;: null</code> (field missing) with 1000 contains entries.</p>\n<h2>What differs</h2>\n<p>In $expand responses (POST /r4/ValueSet/$expand), prod returns <code>expansion.total</code> (the total count of matching concepts) while dev omits it entirely. The <code>total</code> field is a 0..1 optional integer in FHIR R4&#x27;s ValueSet.expansion, documented as &quot;Total concept count; permits server pagination.&quot; Without it, clients cannot determine how many pages exist in a paged expansion.</p>\n<p>Examples:</p>\n<ul><li>Prod: <code>&quot;total&quot;: 5099</code> with 1000 contains (paged)</li><li>Dev: no <code>total</code> field, same 1000 contains</li></ul>\n<p>Both servers return identical <code>contains</code> arrays and <code>offset</code> values in all sampled records.</p>\n<h2>How widespread</h2>\n<p>47 records in deltas.ndjson show this pattern (prod has expansion.total, dev omits it). Breakdown:</p>\n<ul><li>33 records with total=5099 (paged SNOMED expansions with count=1000)</li><li>13 records with total=0 (empty expansions)</li><li>1 record with total=249 (ISO 3166 codes, also has contains count mismatch)</li></ul>\n<p>Search: All 47 are expand operations, all POST /r4/ValueSet/$expand, all with both statuses 200.</p>\n<p>Note: There is a separate existing tolerance (expand-unclosed-extension-and-total, bug f2b2cef) for the reverse case where prod omits total on unclosed expansions but dev includes it. That bug is about the valueset-unclosed extension. This bug is different — neither side has the unclosed extension; dev simply fails to include <code>total</code> in complete expansions.</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance ID: expand-dev-missing-total<br>\nMatches: $expand responses (POST /r4/ValueSet/$expand) where both sides return 200, prod has expansion.total, and dev doesn&#x27;t.<br>\nNormalizes by removing expansion.total from prod (since dev lacks it) to prevent re-triaging.</p>", "impact": 47}, {"id": "36da928", "title": "Dev returns 404 for SNOMED CT implicit ValueSet  (fhir_vs URLs)", "status": "open", "labels": ["missing-resource", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 16:48", "date_iso": "2026-02-07T16:48:14-06:00", "body_md": "Records-Impacted: 36\nTolerance-ID: snomed-implicit-valueset-expand-404\nRecord-ID: 871b3f66-9e31-4b6c-9774-adb378e935df\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http%3A%2F%2Fsnomed.info%2Fsct%3Ffhir_vs&filter=diabetes&count=5' \\\n  -H 'Accept: application/fhir+json'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http%3A%2F%2Fsnomed.info%2Fsct%3Ffhir_vs&filter=diabetes&count=5' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 200 with a valid ValueSet expansion containing 5 SNOMED CT concepts matching \"diabetes\". Dev returns HTTP 404 with OperationOutcome: `\"ValueSet not found: http://snomed.info/sct?fhir_vs\"`.\n\n## What differs\n\nWhen expanding SNOMED CT implicit ValueSets using the standard `fhir_vs` URL pattern, prod returns 200 with a valid ValueSet expansion, while dev returns 404 with OperationOutcome \"ValueSet not found: http://snomed.info/sct?fhir_vs\".\n\nThis affects all SNOMED CT implicit ValueSet URLs:\n- `http://snomed.info/sct?fhir_vs` (all of SNOMED CT)\n- `http://snomed.info/sct?fhir_vs=isa/<sctid>` (descendants of a concept)\n\nThese are FHIR-standard implicit ValueSet URLs defined in the SNOMED CT FHIR usage guide. A terminology server must recognize these URL patterns and synthesize the corresponding ValueSet rather than looking for a stored resource.\n\n## How widespread\n\n36 records in the delta file show this pattern. All are `missing-resource` category, `expand` operation. All have prod=200, dev=404.\n\n```\ngrep -c 'fhir_vs' jobs/2026-02-round-2/results/deltas/deltas.ndjson\n# → 36\n```\n\nThe pattern is predicted by the URL containing `fhir_vs` combined with the $expand operation. Both /r4/ and /r5/ FHIR version prefixes are affected. Various filter and count parameters are used across the records but all fail the same way.\n\n176 total records in comparison.ndjson contain `fhir_vs`; the other 140 are already handled (matched OK or skipped by existing tolerances).\n\n## What the tolerance covers\n\nTolerance `snomed-implicit-valueset-expand-404` matches records where:\n- The URL contains `fhir_vs`\n- Dev returns status 404\n- Prod returns status 200\n\nIt skips these records entirely since no meaningful comparison is possible (dev doesn't return FHIR content). Eliminates 36 delta records.\n\n## Representative record\n\n`871b3f66-9e31-4b6c-9774-adb378e935df` — GET /r4/ValueSet/$expand?url=http%3A%2F%2Fsnomed.info%2Fsct%3Ffhir_vs&filter=diabetes&count=5", "body_html": "<p>Records-Impacted: 36<br>\nTolerance-ID: snomed-implicit-valueset-expand-404<br>\nRecord-ID: 871b3f66-9e31-4b6c-9774-adb378e935df</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand?url=http%3A%2F%2Fsnomed.info%2Fsct%3Ffhir_vs&amp;filter=diabetes&amp;count=5&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http%3A%2F%2Fsnomed.info%2Fsct%3Ffhir_vs&amp;filter=diabetes&amp;count=5&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns HTTP 200 with a valid ValueSet expansion containing 5 SNOMED CT concepts matching &quot;diabetes&quot;. Dev returns HTTP 404 with OperationOutcome: <code>&quot;ValueSet not found: http://snomed.info/sct?fhir_vs&quot;</code>.</p>\n<h2>What differs</h2>\n<p>When expanding SNOMED CT implicit ValueSets using the standard <code>fhir_vs</code> URL pattern, prod returns 200 with a valid ValueSet expansion, while dev returns 404 with OperationOutcome &quot;ValueSet not found: <a href=\"http://snomed.info/sct?fhir_vs&quot;.\" target=\"_blank\">http://snomed.info/sct?fhir_vs&quot;.</a></p>\n<p>This affects all SNOMED CT implicit ValueSet URLs:</p>\n<ul><li><code>http://snomed.info/sct?fhir_vs</code> (all of SNOMED CT)</li><li><code>http://snomed.info/sct?fhir_vs=isa/&lt;sctid&gt;</code> (descendants of a concept)</li></ul>\n<p>These are FHIR-standard implicit ValueSet URLs defined in the SNOMED CT FHIR usage guide. A terminology server must recognize these URL patterns and synthesize the corresponding ValueSet rather than looking for a stored resource.</p>\n<h2>How widespread</h2>\n<p>36 records in the delta file show this pattern. All are <code>missing-resource</code> category, <code>expand</code> operation. All have prod=200, dev=404.</p>\n<pre><code>grep -c &#x27;fhir_vs&#x27; jobs/2026-02-round-2/results/deltas/deltas.ndjson\n# → 36</code></pre>\n<p>The pattern is predicted by the URL containing <code>fhir_vs</code> combined with the $expand operation. Both /r4/ and /r5/ FHIR version prefixes are affected. Various filter and count parameters are used across the records but all fail the same way.</p>\n<p>176 total records in comparison.ndjson contain <code>fhir_vs</code>; the other 140 are already handled (matched OK or skipped by existing tolerances).</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>snomed-implicit-valueset-expand-404</code> matches records where:</p>\n<ul><li>The URL contains <code>fhir_vs</code></li><li>Dev returns status 404</li><li>Prod returns status 200</li></ul>\n<p>It skips these records entirely since no meaningful comparison is possible (dev doesn&#x27;t return FHIR content). Eliminates 36 delta records.</p>\n<h2>Representative record</h2>\n<p><code>871b3f66-9e31-4b6c-9774-adb378e935df</code> — GET /r4/ValueSet/$expand?url=http%3A%2F%2Fsnomed.info%2Fsct%3Ffhir_vs&amp;filter=diabetes&amp;count=5</p>", "impact": 36}, {"id": "7716e08", "title": "Dev uses R5-style property instead of R4 extension for deprecated status in expand contains", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 19:22", "date_iso": "2026-02-07T19:22:46-06:00", "body_md": "Records-Impacted: 26\nTolerance-ID: expand-r4-deprecated-status-representation\nRecord-ID: 307d55c7-f148-4ddc-a360-3962e4e2fe7c, 131242e8-b7fb-4c3a-a45b-680355b8a70f\n\nIn R4 $expand responses, prod and dev represent deprecated code status differently in two ways:\n\n**1. Per-code deprecated annotations on expansion.contains entries**\n\n- **security-labels (18 records)**: Prod uses R4-compatible extension `http://hl7.org/fhir/5.0/StructureDefinition/extension-ValueSet.expansion.contains.property` to convey `status: deprecated`. Dev uses R5-native `property` elements directly (e.g., `\"property\": [{\"code\": \"status\", \"valueCode\": \"deprecated\"}]`). The R4 spec does not define `property` on `expansion.contains` — that was introduced in R5.\n\n- **patient-contactrelationship (5 records) + v3-TribalEntityUS (3 records)**: Prod annotates deprecated codes with the same R5 backport extension. Dev omits the deprecated status annotation entirely — no extension and no property.\n\n**2. Expansion-level property declaration extension**\n\nProd includes an expansion-level extension `http://hl7.org/fhir/5.0/StructureDefinition/extension-ValueSet.expansion.property` that declares the \"status\" property used in per-code annotations. Dev either omits this entirely (patient-contactrelationship) or includes it with different key ordering (TribalEntityUS). This is the R5 backport mechanism for declaring expansion properties in R4.\n\n**How widespread**\n\n26 expand records across 3 ValueSets. All are R4 $expand operations containing codes from HL7 terminology CodeSystems with deprecated entries.\n\n```bash\ngrep 'extension-ValueSet.expansion.contains.property' jobs/2026-02-round-2/results/deltas/deltas.ndjson | wc -l\ngrep 'extension-ValueSet.expansion.property' jobs/2026-02-round-2/results/deltas/deltas.ndjson | wc -l\n```\n\n**Tolerance**\n\nTolerance `expand-r4-deprecated-status-representation` normalizes by stripping both per-code annotations (R5 backport extension and R5-native property) and the expansion-level property declaration extension from both sides. This eliminates the structural difference so other content differences can still surface.", "body_html": "<p>Records-Impacted: 26<br>\nTolerance-ID: expand-r4-deprecated-status-representation<br>\nRecord-ID: 307d55c7-f148-4ddc-a360-3962e4e2fe7c, 131242e8-b7fb-4c3a-a45b-680355b8a70f</p>\n<p>In R4 $expand responses, prod and dev represent deprecated code status differently in two ways:</p>\n<p><strong>1. Per-code deprecated annotations on expansion.contains entries</strong></p>\n<ul><li><strong>security-labels (18 records)</strong>: Prod uses R4-compatible extension <code>http://hl7.org/fhir/5.0/StructureDefinition/extension-ValueSet.expansion.contains.property</code> to convey <code>status: deprecated</code>. Dev uses R5-native <code>property</code> elements directly (e.g., <code>&quot;property&quot;: [{&quot;code&quot;: &quot;status&quot;, &quot;valueCode&quot;: &quot;deprecated&quot;}]</code>). The R4 spec does not define <code>property</code> on <code>expansion.contains</code> — that was introduced in R5.</li></ul>\n<ul><li><strong>patient-contactrelationship (5 records) + v3-TribalEntityUS (3 records)</strong>: Prod annotates deprecated codes with the same R5 backport extension. Dev omits the deprecated status annotation entirely — no extension and no property.</li></ul>\n<p><strong>2. Expansion-level property declaration extension</strong></p>\n<p>Prod includes an expansion-level extension <code>http://hl7.org/fhir/5.0/StructureDefinition/extension-ValueSet.expansion.property</code> that declares the &quot;status&quot; property used in per-code annotations. Dev either omits this entirely (patient-contactrelationship) or includes it with different key ordering (TribalEntityUS). This is the R5 backport mechanism for declaring expansion properties in R4.</p>\n<p><strong>How widespread</strong></p>\n<p>26 expand records across 3 ValueSets. All are R4 $expand operations containing codes from HL7 terminology CodeSystems with deprecated entries.</p>\n<pre><code class=\"lang-bash\">grep &#x27;extension-ValueSet.expansion.contains.property&#x27; jobs/2026-02-round-2/results/deltas/deltas.ndjson | wc -l\ngrep &#x27;extension-ValueSet.expansion.property&#x27; jobs/2026-02-round-2/results/deltas/deltas.ndjson | wc -l</code></pre>\n<p><strong>Tolerance</strong></p>\n<p>Tolerance <code>expand-r4-deprecated-status-representation</code> normalizes by stripping both per-code annotations (R5 backport extension and R5-native property) and the expansion-level property declaration extension from both sides. This eliminates the structural difference so other content differences can still surface.</p>", "impact": 26}, {"id": "af1ce69", "title": "validate-code: dev renders null status as literal 'null' in inactive concept message", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 18:56", "date_iso": "2026-02-07T18:56:09-06:00", "body_md": "Records-Impacted: 24\nTolerance-ID: validate-code-null-status-in-message\nRecord-ID: 20db1af0-c1c6-4f83-9019-2aaeff9ef549\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/CodeSystem/$validate-code?url=http:%2F%2Fwww.nlm.nih.gov%2Fresearch%2Fumls%2Frxnorm&code=70618&_format=json' \\\n  -H 'Accept: application/fhir+json' | jq -r '.parameter[] | select(.name == \"message\") | .valueString'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/CodeSystem/$validate-code?url=http:%2F%2Fwww.nlm.nih.gov%2Fresearch%2Fumls%2Frxnorm&code=70618&_format=json' \\\n  -H 'Accept: application/fhir+json' | jq -r '.parameter[] | select(.name == \"message\") | .valueString'\n```\n\nProd returns `\"The concept '70618' has a status of  and its use should be reviewed\"` (empty string for status), dev returns `\"The concept '70618' has a status of null and its use should be reviewed\"` (literal word \"null\").\n\n## What differs\n\nIn $validate-code responses for inactive concepts, the message and issues text differ in how a missing status value is rendered:\n\n- Prod: `\"The concept '70618' has a status of  and its use should be reviewed\"` (empty string for status)\n- Dev: `\"The concept '70618' has a status of null and its use should be reviewed\"` (literal word \"null\")\n\nBoth servers agree on result=true, inactive=true, display, system, and version. The only difference is this string interpolation of a null/missing status value in the INACTIVE_CONCEPT_FOUND message.\n\n## How widespread\n\n24 records in the current delta file, all identical: GET /r4/CodeSystem/$validate-code for RxNorm code 70618. The same underlying pattern (empty vs \"null\" in status message) also affects 20 NDC records already covered by a separate tolerance (ndc-validate-code-extra-inactive-params, bug 7258b41).\n\nSearch: `grep 'has a status of  and' results/deltas/deltas.ndjson | wc -l` → 24\nAll 24 are validate-code operations on http://www.nlm.nih.gov/research/umls/rxnorm, code 70618.\n\n## What the tolerance covers\n\nTolerance ID: validate-code-null-status-in-message\nMatches: validate-code Parameters responses where prod message contains \"status of \" (empty) and dev message contains \"status of null\" at the same position. Normalizes both message and issues text by replacing \"status of null\" with \"status of \" (prod's rendering) in dev. Eliminates 24 delta records.", "body_html": "<p>Records-Impacted: 24<br>\nTolerance-ID: validate-code-null-status-in-message<br>\nRecord-ID: 20db1af0-c1c6-4f83-9019-2aaeff9ef549</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/CodeSystem/$validate-code?url=http:%2F%2Fwww.nlm.nih.gov%2Fresearch%2Fumls%2Frxnorm&amp;code=70618&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; | jq -r &#x27;.parameter[] | select(.name == &quot;message&quot;) | .valueString&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/CodeSystem/$validate-code?url=http:%2F%2Fwww.nlm.nih.gov%2Fresearch%2Fumls%2Frxnorm&amp;code=70618&amp;_format=json&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; | jq -r &#x27;.parameter[] | select(.name == &quot;message&quot;) | .valueString&#x27;</code></pre>\n<p>Prod returns <code>&quot;The concept &#x27;70618&#x27; has a status of  and its use should be reviewed&quot;</code> (empty string for status), dev returns <code>&quot;The concept &#x27;70618&#x27; has a status of null and its use should be reviewed&quot;</code> (literal word &quot;null&quot;).</p>\n<h2>What differs</h2>\n<p>In $validate-code responses for inactive concepts, the message and issues text differ in how a missing status value is rendered:</p>\n<ul><li>Prod: <code>&quot;The concept &#x27;70618&#x27; has a status of  and its use should be reviewed&quot;</code> (empty string for status)</li><li>Dev: <code>&quot;The concept &#x27;70618&#x27; has a status of null and its use should be reviewed&quot;</code> (literal word &quot;null&quot;)</li></ul>\n<p>Both servers agree on result=true, inactive=true, display, system, and version. The only difference is this string interpolation of a null/missing status value in the INACTIVE_CONCEPT_FOUND message.</p>\n<h2>How widespread</h2>\n<p>24 records in the current delta file, all identical: GET /r4/CodeSystem/$validate-code for RxNorm code 70618. The same underlying pattern (empty vs &quot;null&quot; in status message) also affects 20 NDC records already covered by a separate tolerance (ndc-validate-code-extra-inactive-params, bug 7258b41).</p>\n<p>Search: <code>grep &#x27;has a status of  and&#x27; results/deltas/deltas.ndjson | wc -l</code> → 24<br>\nAll 24 are validate-code operations on <a href=\"http://www.nlm.nih.gov/research/umls/rxnorm,\" target=\"_blank\">http://www.nlm.nih.gov/research/umls/rxnorm,</a> code 70618.</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance ID: validate-code-null-status-in-message<br>\nMatches: validate-code Parameters responses where prod message contains &quot;status of &quot; (empty) and dev message contains &quot;status of null&quot; at the same position. Normalizes both message and issues text by replacing &quot;status of null&quot; with &quot;status of &quot; (prod&#x27;s rendering) in dev. Eliminates 24 delta records.</p>", "impact": 24}, {"id": "bd89513", "title": "Dev returns extra message/issues for display language resolution on validate-code result=true", "status": "open", "labels": ["code-defect", "content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:34", "date_iso": "2026-02-07T20:34:09-06:00", "body_md": "Records-Impacted: 21\nTolerance-ID: dev-extra-display-lang-not-found-message\nRecord-ID: 299d1b7f-b8f7-4cee-95ab-fa83da75ea80, c9f3b468-dc3d-47f5-a305-0346bf5b4cab\n\n## What differs\n\nWhen $validate-code returns result=true and a displayLanguage parameter was specified in the request, prod and dev disagree on how to communicate \"no display found in the requested language\":\n\n**Variant 1 (19 records):** Prod omits message/issues entirely. Dev returns extra `message` (\"There are no valid display names found for the code ...\") and `issues` (OperationOutcome with informational severity, tx-issue-type=`invalid-display`).\n\n**Variant 2 (2 records):** Prod returns `issues` with tx-issue-type=`display-comment` (\"'Laboratory procedure' is the default display; the code system http://snomed.info/sct has no Display Names for the language es-AR\"). Dev returns `message` and `issues` with tx-issue-type=`invalid-display` with differently-worded text. Both are saying the same thing but using different issue type codes and message wording.\n\nIn all cases, both servers agree on result=true, and system/code/version/display parameters match.\n\n## How widespread\n\n21 records total. Variant 1 affects 19 records (mostly urn:iso:std:iso:3166 codes with displayLanguage=fr/fr-FR, POST /r4/ValueSet/$validate-code). Variant 2 affects 2 records (SNOMED code 108252007 with displayLanguage=es-AR, POST /r5/CodeSystem/$validate-code).\n\nSearch: `grep 'There are no valid display names found' jobs/2026-02-round-2/comparison.ndjson | wc -l` → 21\n\n## Tolerance\n\nTolerance `dev-extra-display-lang-not-found-message` handles both variants. It matches validate-code Parameters where result=true, prod has no message parameter, and dev has a message containing \"There are no valid display names found\". It normalizes by stripping dev's extra message/issues, and also stripping prod's display-comment issues when all issues are about display language defaults. Eliminates 21 records.\n\n## Repro\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code?' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"urn:iso:std:iso:3166\",\"code\":\"FR\",\"display\":\"France\"}]}},{\"name\":\"displayLanguage\",\"valueCode\":\"fr\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"jurisdiction\",\"url\":\"http://hl7.org/fhir/ValueSet/jurisdiction\",\"version\":\"4.0.1\",\"compose\":{\"include\":[{\"system\":\"urn:iso:std:iso:3166\"},{\"system\":\"urn:iso:std:iso:3166:-2\"},{\"system\":\"http://unstats.un.org/unsd/methods/m49/m49.htm\",\"filter\":[{\"property\":\"class\",\"op\":\"=\",\"value\":\"region\"}]}]}}}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"urn:iso:std:iso:3166\",\"code\":\"FR\",\"display\":\"France\"}]}},{\"name\":\"displayLanguage\",\"valueCode\":\"fr\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"jurisdiction\",\"url\":\"http://hl7.org/fhir/ValueSet/jurisdiction\",\"version\":\"4.0.1\",\"compose\":{\"include\":[{\"system\":\"urn:iso:std:iso:3166\"},{\"system\":\"urn:iso:std:iso:3166:-2\"},{\"system\":\"http://unstats.un.org/unsd/methods/m49/m49.htm\",\"filter\":[{\"property\":\"class\",\"op\":\"=\",\"value\":\"region\"}]}]}}}]}'\n```\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** passes `defLang` to `hasDisplay` when checking whether the provided display matches known designations, so default-language displays count as a match and the display warning block is skipped entirely:\n[`library/ftx/fhir_valuesets.pas#L1768`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_valuesets.pas#L1768)\n— `list.hasDisplay(FParams.workingLanguages, defLang, c.display, ...)` finds \"France\" via the default language fallback, so no display error is generated.\n\n**Dev** passes `null` instead of `defLang` to `hasDisplay` in the `checkDisplays` method, so default-language displays are not considered a match. This causes the code to enter the display-not-found path and emit the `NO_VALID_DISPLAY_FOUND_NONE_FOR_LANG_OK` informational message:\n[`tx/workers/validate.js#L1343`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L1343)\n— `list.hasDisplay(this.params.workingLanguages(), null, c.display, ...)` does not find \"France\" because `_langsMatch` skips the default-language shortcut when `defLang` is `null`:\n[`tx/library/designations.js#L778-L781`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/designations.js#L778-L781)\n\n**Fix**: In `checkDisplays` at `tx/workers/validate.js` line 1343, change the second argument of `list.hasDisplay(...)` from `null` to `defLang` (which is already passed as a parameter to `checkDisplays`), matching what prod does at `fhir_valuesets.pas` line 1768.", "body_html": "<p>Records-Impacted: 21<br>\nTolerance-ID: dev-extra-display-lang-not-found-message<br>\nRecord-ID: 299d1b7f-b8f7-4cee-95ab-fa83da75ea80, c9f3b468-dc3d-47f5-a305-0346bf5b4cab</p>\n<h2>What differs</h2>\n<p>When $validate-code returns result=true and a displayLanguage parameter was specified in the request, prod and dev disagree on how to communicate &quot;no display found in the requested language&quot;:</p>\n<p><strong>Variant 1 (19 records):</strong> Prod omits message/issues entirely. Dev returns extra <code>message</code> (&quot;There are no valid display names found for the code ...&quot;) and <code>issues</code> (OperationOutcome with informational severity, tx-issue-type=<code>invalid-display</code>).</p>\n<p><strong>Variant 2 (2 records):</strong> Prod returns <code>issues</code> with tx-issue-type=<code>display-comment</code> (&quot;&#x27;Laboratory procedure&#x27; is the default display; the code system <a href=\"http://snomed.info/sct\" target=\"_blank\">http://snomed.info/sct</a> has no Display Names for the language es-AR&quot;). Dev returns <code>message</code> and <code>issues</code> with tx-issue-type=<code>invalid-display</code> with differently-worded text. Both are saying the same thing but using different issue type codes and message wording.</p>\n<p>In all cases, both servers agree on result=true, and system/code/version/display parameters match.</p>\n<h2>How widespread</h2>\n<p>21 records total. Variant 1 affects 19 records (mostly urn:iso:std:iso:3166 codes with displayLanguage=fr/fr-FR, POST /r4/ValueSet/$validate-code). Variant 2 affects 2 records (SNOMED code 108252007 with displayLanguage=es-AR, POST /r5/CodeSystem/$validate-code).</p>\n<p>Search: <code>grep &#x27;There are no valid display names found&#x27; jobs/2026-02-round-2/comparison.ndjson | wc -l</code> → 21</p>\n<h2>Tolerance</h2>\n<p>Tolerance <code>dev-extra-display-lang-not-found-message</code> handles both variants. It matches validate-code Parameters where result=true, prod has no message parameter, and dev has a message containing &quot;There are no valid display names found&quot;. It normalizes by stripping dev&#x27;s extra message/issues, and also stripping prod&#x27;s display-comment issues when all issues are about display language defaults. Eliminates 21 records.</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r4/ValueSet/$validate-code?&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;codeableConcept&quot;,&quot;valueCodeableConcept&quot;:{&quot;coding&quot;:[{&quot;system&quot;:&quot;urn:iso:std:iso:3166&quot;,&quot;code&quot;:&quot;FR&quot;,&quot;display&quot;:&quot;France&quot;}]}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueCode&quot;:&quot;fr&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;id&quot;:&quot;jurisdiction&quot;,&quot;url&quot;:&quot;http://hl7.org/fhir/ValueSet/jurisdiction&quot;,&quot;version&quot;:&quot;4.0.1&quot;,&quot;compose&quot;:{&quot;include&quot;:[{&quot;system&quot;:&quot;urn:iso:std:iso:3166&quot;},{&quot;system&quot;:&quot;urn:iso:std:iso:3166:-2&quot;},{&quot;system&quot;:&quot;http://unstats.un.org/unsd/methods/m49/m49.htm&quot;,&quot;filter&quot;:[{&quot;property&quot;:&quot;class&quot;,&quot;op&quot;:&quot;=&quot;,&quot;value&quot;:&quot;region&quot;}]}]}}}]}&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$validate-code?&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;codeableConcept&quot;,&quot;valueCodeableConcept&quot;:{&quot;coding&quot;:[{&quot;system&quot;:&quot;urn:iso:std:iso:3166&quot;,&quot;code&quot;:&quot;FR&quot;,&quot;display&quot;:&quot;France&quot;}]}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueCode&quot;:&quot;fr&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;id&quot;:&quot;jurisdiction&quot;,&quot;url&quot;:&quot;http://hl7.org/fhir/ValueSet/jurisdiction&quot;,&quot;version&quot;:&quot;4.0.1&quot;,&quot;compose&quot;:{&quot;include&quot;:[{&quot;system&quot;:&quot;urn:iso:std:iso:3166&quot;},{&quot;system&quot;:&quot;urn:iso:std:iso:3166:-2&quot;},{&quot;system&quot;:&quot;http://unstats.un.org/unsd/methods/m49/m49.htm&quot;,&quot;filter&quot;:[{&quot;property&quot;:&quot;class&quot;,&quot;op&quot;:&quot;=&quot;,&quot;value&quot;:&quot;region&quot;}]}]}}}]}&#x27;</code></pre>\n<h2>Root Cause</h2>\n<p><strong>Classification</strong>: code-level defect</p>\n<p><strong>Prod</strong> passes <code>defLang</code> to <code>hasDisplay</code> when checking whether the provided display matches known designations, so default-language displays count as a match and the display warning block is skipped entirely:<br>\n<a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/ftx/fhir_valuesets.pas#L1768\" target=\"_blank\"><code>library/ftx/fhir_valuesets.pas#L1768</code></a><br>\n— <code>list.hasDisplay(FParams.workingLanguages, defLang, c.display, ...)</code> finds &quot;France&quot; via the default language fallback, so no display error is generated.</p>\n<p><strong>Dev</strong> passes <code>null</code> instead of <code>defLang</code> to <code>hasDisplay</code> in the <code>checkDisplays</code> method, so default-language displays are not considered a match. This causes the code to enter the display-not-found path and emit the <code>NO_VALID_DISPLAY_FOUND_NONE_FOR_LANG_OK</code> informational message:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/workers/validate.js#L1343\" target=\"_blank\"><code>tx/workers/validate.js#L1343</code></a><br>\n— <code>list.hasDisplay(this.params.workingLanguages(), null, c.display, ...)</code> does not find &quot;France&quot; because <code>_langsMatch</code> skips the default-language shortcut when <code>defLang</code> is <code>null</code>:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/designations.js#L778-L781\" target=\"_blank\"><code>tx/library/designations.js#L778-L781</code></a></p>\n<p><strong>Fix</strong>: In <code>checkDisplays</code> at <code>tx/workers/validate.js</code> line 1343, change the second argument of <code>list.hasDisplay(...)</code> from <code>null</code> to <code>defLang</code> (which is already passed as a parameter to <code>checkDisplays</code>), matching what prod does at <code>fhir_valuesets.pas</code> line 1768.</p>", "impact": 21}, {"id": "44d1916", "title": "Dev returns 200 expansion instead of 422 too-costly for large code systems (LOINC, MIME types)", "status": "open", "labels": ["reproduced", "status-mismatch", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 17:40", "date_iso": "2026-02-07T17:40:18-06:00", "body_md": "Records-Impacted: 17\nTolerance-ID: expand-too-costly-succeeds\nRecord-ID: d9734f68-d8b4-475d-9204-632c9b4ccbf0\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r5/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"status\":\"active\",\"compose\":{\"inactive\":true,\"include\":[{\"system\":\"http://loinc.org\"}]}}}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r5/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"status\":\"active\",\"compose\":{\"inactive\":true,\"include\":[{\"system\":\"http://loinc.org\"}]}}}]}'\n```\n\nProd returns HTTP 422 with OperationOutcome: `{\"resourceType\":\"OperationOutcome\", \"issue\":[{\"severity\":\"error\",\"code\":\"too-costly\",\"details\":{\"text\":\"The value set '' expansion has too many codes to display (>10000)\"}}]}`.\n\nDev returns HTTP 200 with a ValueSet containing 1000 LOINC codes in the expansion (respecting the `count` parameter for pagination).\n\n\nWhen expanding ValueSets that include very large code systems (all of LOINC via `http://loinc.org`, or MIME types via `http://hl7.org/fhir/ValueSet/mimetypes`), prod returns HTTP 422 with an OperationOutcome containing `issue.code: \"too-costly\"` and message \"The value set '' expansion has too many codes to display (>10000)\". Dev returns HTTP 200 with a ValueSet containing up to 1000 codes (honoring the count parameter for pagination).\n\nProd correctly enforces an expansion size guard — refusing to expand code systems with >10000 codes even when pagination parameters are present. Dev does not enforce this guard and instead returns a paginated result.\n\n\n17 records in the comparison dataset show this pattern:\n- 6 records: POST `/r5/ValueSet/$expand` expanding all of LOINC (`http://loinc.org`, with `inactive: true`)\n- 11 records: GET `/r4/ValueSet/$expand?url=http%3A%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fmimetypes` expanding MIME types\n\nSearch method: `grep 'too-costly' deltas.ndjson` finds 273 records total; filtering to `status-mismatch` category (prod=422, dev=200) yields 17. The remaining 256 are `dev-crash-on-error` (prod=422, dev=500) — same root cause but different symptom (dev crashes rather than succeeding).\n\nAdditionally, there are likely records already eliminated by the prior `expand-too-costly-succeeds` tolerance (bug e3fb3f6, which appears to have been removed from git-bug). The current tolerance was scoped too narrowly (exact URL match on `/r4/ValueSet/$expand` only, missing GET requests with query params and /r5/ requests).\n\n\nTolerance ID: `expand-too-costly-succeeds`. Matches any $expand request (any FHIR version, GET or POST) where prod returns 422 with an OperationOutcome containing `issue.code: \"too-costly\"` and dev returns 200. Skips these records entirely since the responses are fundamentally incomparable (error vs success).\n\n\n- `d9734f68-d8b4-475d-9204-632c9b4ccbf0` (LOINC, POST /r5/ValueSet/$expand)\n- `3a2672db-cb0d-4312-87f1-5d6b685fbfe0` (MIME types, GET /r4/ValueSet/$expand?url=...mimetypes)", "body_html": "<p>Records-Impacted: 17<br>\nTolerance-ID: expand-too-costly-succeeds<br>\nRecord-ID: d9734f68-d8b4-475d-9204-632c9b4ccbf0</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r5/ValueSet/$expand&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;count&quot;,&quot;valueInteger&quot;:1000},{&quot;name&quot;:&quot;offset&quot;,&quot;valueInteger&quot;:0},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;status&quot;:&quot;active&quot;,&quot;compose&quot;:{&quot;inactive&quot;:true,&quot;include&quot;:[{&quot;system&quot;:&quot;http://loinc.org&quot;}]}}}]}&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r5/ValueSet/$expand&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;count&quot;,&quot;valueInteger&quot;:1000},{&quot;name&quot;:&quot;offset&quot;,&quot;valueInteger&quot;:0},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;status&quot;:&quot;active&quot;,&quot;compose&quot;:{&quot;inactive&quot;:true,&quot;include&quot;:[{&quot;system&quot;:&quot;http://loinc.org&quot;}]}}}]}&#x27;</code></pre>\n<p>Prod returns HTTP 422 with OperationOutcome: <code>{&quot;resourceType&quot;:&quot;OperationOutcome&quot;, &quot;issue&quot;:[{&quot;severity&quot;:&quot;error&quot;,&quot;code&quot;:&quot;too-costly&quot;,&quot;details&quot;:{&quot;text&quot;:&quot;The value set &#x27;&#x27; expansion has too many codes to display (&gt;10000)&quot;}}]}</code>.</p>\n<p>Dev returns HTTP 200 with a ValueSet containing 1000 LOINC codes in the expansion (respecting the <code>count</code> parameter for pagination).</p>\n<p>When expanding ValueSets that include very large code systems (all of LOINC via <code>http://loinc.org</code>, or MIME types via <code>http://hl7.org/fhir/ValueSet/mimetypes</code>), prod returns HTTP 422 with an OperationOutcome containing <code>issue.code: &quot;too-costly&quot;</code> and message &quot;The value set &#x27;&#x27; expansion has too many codes to display (&gt;10000)&quot;. Dev returns HTTP 200 with a ValueSet containing up to 1000 codes (honoring the count parameter for pagination).</p>\n<p>Prod correctly enforces an expansion size guard — refusing to expand code systems with &gt;10000 codes even when pagination parameters are present. Dev does not enforce this guard and instead returns a paginated result.</p>\n<p>17 records in the comparison dataset show this pattern:</p>\n<ul><li>6 records: POST <code>/r5/ValueSet/$expand</code> expanding all of LOINC (<code>http://loinc.org</code>, with <code>inactive: true</code>)</li><li>11 records: GET <code>/r4/ValueSet/$expand?url=http%3A%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fmimetypes</code> expanding MIME types</li></ul>\n<p>Search method: <code>grep &#x27;too-costly&#x27; deltas.ndjson</code> finds 273 records total; filtering to <code>status-mismatch</code> category (prod=422, dev=200) yields 17. The remaining 256 are <code>dev-crash-on-error</code> (prod=422, dev=500) — same root cause but different symptom (dev crashes rather than succeeding).</p>\n<p>Additionally, there are likely records already eliminated by the prior <code>expand-too-costly-succeeds</code> tolerance (bug e3fb3f6, which appears to have been removed from git-bug). The current tolerance was scoped too narrowly (exact URL match on <code>/r4/ValueSet/$expand</code> only, missing GET requests with query params and /r5/ requests).</p>\n<p>Tolerance ID: <code>expand-too-costly-succeeds</code>. Matches any $expand request (any FHIR version, GET or POST) where prod returns 422 with an OperationOutcome containing <code>issue.code: &quot;too-costly&quot;</code> and dev returns 200. Skips these records entirely since the responses are fundamentally incomparable (error vs success).</p>\n<ul><li><code>d9734f68-d8b4-475d-9204-632c9b4ccbf0</code> (LOINC, POST /r5/ValueSet/$expand)</li><li><code>3a2672db-cb0d-4312-87f1-5d6b685fbfe0</code> (MIME types, GET /r4/ValueSet/$expand?url=...mimetypes)</li></ul>", "impact": 17}, {"id": "1932f81", "title": "Dev returns SQLITE_MISUSE error on RxNorm-related $expand requests", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 18:29", "date_iso": "2026-02-07T18:29:01-06:00", "body_md": "Records-Impacted: 16\nTolerance-ID: dev-sqlite-misuse-expand-rxnorm\nRecord-ID: e108a92a-a962-45b4-ad35-e0aa4fe4cf32\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?_limit=1000&_incomplete=true' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"x-system-cache-id\",\n      \"valueString\": \"dc8fd4bc-091a-424a-8a3b-6198ef146891\"\n    },\n    {\n      \"name\": \"includeDefinition\",\n      \"valueBoolean\": false\n    },\n    {\n      \"name\": \"excludeNested\",\n      \"valueBoolean\": false\n    },\n    {\n      \"name\": \"valueSet\",\n      \"resource\": {\n        \"resourceType\": \"ValueSet\",\n        \"status\": \"active\",\n        \"compose\": {\n          \"inactive\": true,\n          \"include\": [\n            {\n              \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\"\n            }\n          ]\n        }\n      }\n    },\n    {\n      \"name\": \"_limit\",\n      \"valueString\": \"1000\"\n    },\n    {\n      \"name\": \"_incomplete\",\n      \"valueString\": \"true\"\n    }\n  ]\n}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?_limit=1000&_incomplete=true' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"x-system-cache-id\",\n      \"valueString\": \"dc8fd4bc-091a-424a-8a3b-6198ef146891\"\n    },\n    {\n      \"name\": \"includeDefinition\",\n      \"valueBoolean\": false\n    },\n    {\n      \"name\": \"excludeNested\",\n      \"valueBoolean\": false\n    },\n    {\n      \"name\": \"valueSet\",\n      \"resource\": {\n        \"resourceType\": \"ValueSet\",\n        \"status\": \"active\",\n        \"compose\": {\n          \"inactive\": true,\n          \"include\": [\n            {\n              \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\"\n            }\n          ]\n        }\n      }\n    },\n    {\n      \"name\": \"_limit\",\n      \"valueString\": \"1000\"\n    },\n    {\n      \"name\": \"_incomplete\",\n      \"valueString\": \"true\"\n    }\n  ]\n}'\n```\n\nProd returns 500 with `\"fdb_sqlite3_objects error: no such column: cui1\"` (specific database schema error). Dev returns 500 with `\"SQLITE_MISUSE: not an error\"` (generic SQLite misuse error).\n\n## What differs\n\nDev returns 500 with error message \"SQLITE_MISUSE: not an error\" on POST /r4/ValueSet/$expand requests involving RxNorm-related code systems. This affects two sub-patterns:\n\n1. **8 records (both 500)**: Prod also returns 500 but with a different, more descriptive SQLite error: \"fdb_sqlite3_objects error: no such column: cui1\". Both servers crash, but dev's error is generic/unhelpful while prod's points to a specific database schema issue.\n\n2. **8 records (prod 422, dev 500)**: Prod returns 422 with a proper error message like \"A definition for CodeSystem 'https://hl7.org/fhir/sid/ndc' could not be found, so the value set cannot be expanded\". Dev crashes with 500 SQLITE_MISUSE instead of returning a proper error response.\n\nAll 16 records are POST requests to /r4/ValueSet/$expand?_limit=1000&_incomplete=true with request bodies that include RxNorm (http://www.nlm.nih.gov/research/umls/rxnorm) in the ValueSet compose.\n\n## How widespread\n\n16 records total in the dataset. All are expand operations on the same URL pattern. Searched with:\n  grep -c 'SQLITE_MISUSE' results/deltas/deltas.ndjson  → 16\n\nAll have the same dev error text \"SQLITE_MISUSE: not an error\". The prod responses vary between internal SQLite errors (500) and proper FHIR error responses (422).\n\n## What the tolerance covers\n\nTolerance ID: dev-sqlite-misuse-expand-rxnorm\nMatches records where the dev response is an OperationOutcome containing \"SQLITE_MISUSE\" in the error details, on $expand operations. Skips the entire record since dev's crash prevents meaningful content comparison.\nEliminates 16 records.", "body_html": "<p>Records-Impacted: 16<br>\nTolerance-ID: dev-sqlite-misuse-expand-rxnorm<br>\nRecord-ID: e108a92a-a962-45b4-ad35-e0aa4fe4cf32</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand?_limit=1000&amp;_incomplete=true&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{\n  &quot;resourceType&quot;: &quot;Parameters&quot;,\n  &quot;parameter&quot;: [\n    {\n      &quot;name&quot;: &quot;x-system-cache-id&quot;,\n      &quot;valueString&quot;: &quot;dc8fd4bc-091a-424a-8a3b-6198ef146891&quot;\n    },\n    {\n      &quot;name&quot;: &quot;includeDefinition&quot;,\n      &quot;valueBoolean&quot;: false\n    },\n    {\n      &quot;name&quot;: &quot;excludeNested&quot;,\n      &quot;valueBoolean&quot;: false\n    },\n    {\n      &quot;name&quot;: &quot;valueSet&quot;,\n      &quot;resource&quot;: {\n        &quot;resourceType&quot;: &quot;ValueSet&quot;,\n        &quot;status&quot;: &quot;active&quot;,\n        &quot;compose&quot;: {\n          &quot;inactive&quot;: true,\n          &quot;include&quot;: [\n            {\n              &quot;system&quot;: &quot;http://www.nlm.nih.gov/research/umls/rxnorm&quot;\n            }\n          ]\n        }\n      }\n    },\n    {\n      &quot;name&quot;: &quot;_limit&quot;,\n      &quot;valueString&quot;: &quot;1000&quot;\n    },\n    {\n      &quot;name&quot;: &quot;_incomplete&quot;,\n      &quot;valueString&quot;: &quot;true&quot;\n    }\n  ]\n}&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand?_limit=1000&amp;_incomplete=true&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{\n  &quot;resourceType&quot;: &quot;Parameters&quot;,\n  &quot;parameter&quot;: [\n    {\n      &quot;name&quot;: &quot;x-system-cache-id&quot;,\n      &quot;valueString&quot;: &quot;dc8fd4bc-091a-424a-8a3b-6198ef146891&quot;\n    },\n    {\n      &quot;name&quot;: &quot;includeDefinition&quot;,\n      &quot;valueBoolean&quot;: false\n    },\n    {\n      &quot;name&quot;: &quot;excludeNested&quot;,\n      &quot;valueBoolean&quot;: false\n    },\n    {\n      &quot;name&quot;: &quot;valueSet&quot;,\n      &quot;resource&quot;: {\n        &quot;resourceType&quot;: &quot;ValueSet&quot;,\n        &quot;status&quot;: &quot;active&quot;,\n        &quot;compose&quot;: {\n          &quot;inactive&quot;: true,\n          &quot;include&quot;: [\n            {\n              &quot;system&quot;: &quot;http://www.nlm.nih.gov/research/umls/rxnorm&quot;\n            }\n          ]\n        }\n      }\n    },\n    {\n      &quot;name&quot;: &quot;_limit&quot;,\n      &quot;valueString&quot;: &quot;1000&quot;\n    },\n    {\n      &quot;name&quot;: &quot;_incomplete&quot;,\n      &quot;valueString&quot;: &quot;true&quot;\n    }\n  ]\n}&#x27;</code></pre>\n<p>Prod returns 500 with <code>&quot;fdb_sqlite3_objects error: no such column: cui1&quot;</code> (specific database schema error). Dev returns 500 with <code>&quot;SQLITE_MISUSE: not an error&quot;</code> (generic SQLite misuse error).</p>\n<h2>What differs</h2>\n<p>Dev returns 500 with error message &quot;SQLITE_MISUSE: not an error&quot; on POST /r4/ValueSet/$expand requests involving RxNorm-related code systems. This affects two sub-patterns:</p>\n<ol><li><strong>8 records (both 500)</strong>: Prod also returns 500 but with a different, more descriptive SQLite error: &quot;fdb_sqlite3_objects error: no such column: cui1&quot;. Both servers crash, but dev&#x27;s error is generic/unhelpful while prod&#x27;s points to a specific database schema issue.</li></ol>\n<ol><li><strong>8 records (prod 422, dev 500)</strong>: Prod returns 422 with a proper error message like &quot;A definition for CodeSystem &#x27;<a href=\"https://hl7.org/fhir/sid/ndc&#x27;\" target=\"_blank\">https://hl7.org/fhir/sid/ndc&#x27;</a> could not be found, so the value set cannot be expanded&quot;. Dev crashes with 500 SQLITE_MISUSE instead of returning a proper error response.</li></ol>\n<p>All 16 records are POST requests to /r4/ValueSet/$expand?_limit=1000&amp;_incomplete=true with request bodies that include RxNorm (<a href=\"http://www.nlm.nih.gov/research/umls/rxnorm\" target=\"_blank\">http://www.nlm.nih.gov/research/umls/rxnorm</a>) in the ValueSet compose.</p>\n<h2>How widespread</h2>\n<p>16 records total in the dataset. All are expand operations on the same URL pattern. Searched with:<br>\ngrep -c &#x27;SQLITE_MISUSE&#x27; results/deltas/deltas.ndjson  → 16</p>\n<p>All have the same dev error text &quot;SQLITE_MISUSE: not an error&quot;. The prod responses vary between internal SQLite errors (500) and proper FHIR error responses (422).</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance ID: dev-sqlite-misuse-expand-rxnorm<br>\nMatches records where the dev response is an OperationOutcome containing &quot;SQLITE_MISUSE&quot; in the error details, on $expand operations. Skips the entire record since dev&#x27;s crash prevents meaningful content comparison.<br>\nEliminates 16 records.</p>", "impact": 16}, {"id": "c7004d3", "title": "Dev omits valueset-toocostly extension and adds spurious used-codesystem on  for grammar-based code systems", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 16:30", "date_iso": "2026-02-07T16:30:40-06:00", "body_md": "Records-Impacted: 13\nTolerance-ID: expand-toocostly-extension-and-used-codesystem\nRecord-ID: a272aa8c-96d7-4905-a75a-ea21d67b83fc\n\n\nProd:\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"_incomplete\",\"valueBoolean\":true},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"url\":\"http://hl7.org/fhir/ValueSet/mimetypes\",\"compose\":{\"include\":[{\"system\":\"urn:ietf:bcp:13\"}]}}}]}' \\\n  | jq '.expansion.extension, [.expansion.parameter[] | select(.name == \"used-codesystem\")]'\n```\n\nDev:\n```bash\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"_incomplete\",\"valueBoolean\":true},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"url\":\"http://hl7.org/fhir/ValueSet/mimetypes\",\"compose\":{\"include\":[{\"system\":\"urn:ietf:bcp:13\"}]}}}]}' \\\n  | jq '.expansion.extension, [.expansion.parameter[] | select(.name == \"used-codesystem\")]'\n```\n\nProd returns `expansion.extension` with `valueset-toocostly: true`, dev returns `null`. Dev includes `used-codesystem: urn:ietf:bcp:13` in parameters, prod does not.\n\n\nFor $expand on grammar-based code systems (primarily BCP-13 MIME types via `urn:ietf:bcp:13`, plus one Brazilian ICD-10 ValueSet), both prod and dev return 200 with an empty expansion (total=0, no `contains`). However:\n\n1. **Prod includes `expansion.extension` with `valueset-toocostly: true`; dev omits it.** This extension signals that the expansion could not be performed because the code system is grammar-based or too costly to enumerate. Prod correctly marks these expansions; dev does not.\n\n2. **Dev includes `expansion.parameter` with `used-codesystem` (e.g., `urn:ietf:bcp:13`); prod omits it.** Dev reports which code system it consulted, even though the expansion returned no results. Prod does not report a used-codesystem on these too-costly expansions.\n\nBoth differences always co-occur in the same records.\n\n\n13 records in the current comparison dataset show both patterns simultaneously. All are successful (200/200) $expand operations. 12 of 13 involve `http://hl7.org/fhir/ValueSet/mimetypes` (BCP-13 MIME types). One involves a Brazilian ValueSet that includes LOINC and a Brazilian ICD-10 code system.\n\nSearch: `grep 'valueset-toocostly' deltas.ndjson` found 25 records total; of those, 13 have both sides returning 200 (the rest have status mismatches handled by other tolerances).\n\n\nTolerance `expand-toocostly-extension-and-used-codesystem` matches $expand records where both return 200, prod has the `valueset-toocostly` extension but dev doesn't, and normalizes by:\n- Removing the `valueset-toocostly` extension from prod\n- Removing any dev-only `used-codesystem` parameters\n\nEliminates 13 records from the delta file.\n\n\na272aa8c-96d7-4905-a75a-ea21d67b83fc: POST /r4/ValueSet/$expand — BCP-13 MIME types (http://hl7.org/fhir/ValueSet/mimetypes). Prod returns empty expansion with `valueset-toocostly: true` extension and `limitedExpansion: true` parameter. Dev returns empty expansion with `limitedExpansion: true` and `used-codesystem: urn:ietf:bcp:13` but no toocostly extension.", "body_html": "<p>Records-Impacted: 13<br>\nTolerance-ID: expand-toocostly-extension-and-used-codesystem<br>\nRecord-ID: a272aa8c-96d7-4905-a75a-ea21d67b83fc</p>\n<p>Prod:</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;_incomplete&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;count&quot;,&quot;valueInteger&quot;:1000},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;url&quot;:&quot;http://hl7.org/fhir/ValueSet/mimetypes&quot;,&quot;compose&quot;:{&quot;include&quot;:[{&quot;system&quot;:&quot;urn:ietf:bcp:13&quot;}]}}}]}&#x27; \\\n  | jq &#x27;.expansion.extension, [.expansion.parameter[] | select(.name == &quot;used-codesystem&quot;)]&#x27;</code></pre>\n<p>Dev:</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;_incomplete&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;count&quot;,&quot;valueInteger&quot;:1000},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;url&quot;:&quot;http://hl7.org/fhir/ValueSet/mimetypes&quot;,&quot;compose&quot;:{&quot;include&quot;:[{&quot;system&quot;:&quot;urn:ietf:bcp:13&quot;}]}}}]}&#x27; \\\n  | jq &#x27;.expansion.extension, [.expansion.parameter[] | select(.name == &quot;used-codesystem&quot;)]&#x27;</code></pre>\n<p>Prod returns <code>expansion.extension</code> with <code>valueset-toocostly: true</code>, dev returns <code>null</code>. Dev includes <code>used-codesystem: urn:ietf:bcp:13</code> in parameters, prod does not.</p>\n<p>For $expand on grammar-based code systems (primarily BCP-13 MIME types via <code>urn:ietf:bcp:13</code>, plus one Brazilian ICD-10 ValueSet), both prod and dev return 200 with an empty expansion (total=0, no <code>contains</code>). However:</p>\n<ol><li>**Prod includes <code>expansion.extension</code> with <code>valueset-toocostly: true</code>; dev omits it.** This extension signals that the expansion could not be performed because the code system is grammar-based or too costly to enumerate. Prod correctly marks these expansions; dev does not.</li></ol>\n<ol><li>**Dev includes <code>expansion.parameter</code> with <code>used-codesystem</code> (e.g., <code>urn:ietf:bcp:13</code>); prod omits it.** Dev reports which code system it consulted, even though the expansion returned no results. Prod does not report a used-codesystem on these too-costly expansions.</li></ol>\n<p>Both differences always co-occur in the same records.</p>\n<p>13 records in the current comparison dataset show both patterns simultaneously. All are successful (200/200) $expand operations. 12 of 13 involve <code>http://hl7.org/fhir/ValueSet/mimetypes</code> (BCP-13 MIME types). One involves a Brazilian ValueSet that includes LOINC and a Brazilian ICD-10 code system.</p>\n<p>Search: <code>grep &#x27;valueset-toocostly&#x27; deltas.ndjson</code> found 25 records total; of those, 13 have both sides returning 200 (the rest have status mismatches handled by other tolerances).</p>\n<p>Tolerance <code>expand-toocostly-extension-and-used-codesystem</code> matches $expand records where both return 200, prod has the <code>valueset-toocostly</code> extension but dev doesn&#x27;t, and normalizes by:</p>\n<ul><li>Removing the <code>valueset-toocostly</code> extension from prod</li><li>Removing any dev-only <code>used-codesystem</code> parameters</li></ul>\n<p>Eliminates 13 records from the delta file.</p>\n<p>a272aa8c-96d7-4905-a75a-ea21d67b83fc: POST /r4/ValueSet/$expand — BCP-13 MIME types (<a href=\"http://hl7.org/fhir/ValueSet/mimetypes\" target=\"_blank\">http://hl7.org/fhir/ValueSet/mimetypes</a>). Prod returns empty expansion with <code>valueset-toocostly: true</code> extension and <code>limitedExpansion: true</code> parameter. Dev returns empty expansion with <code>limitedExpansion: true</code> and <code>used-codesystem: urn:ietf:bcp:13</code> but no toocostly extension.</p>", "impact": 13}, {"id": "d05a4a6", "title": "Dev omits retired status-check informational issues in validate-code OperationOutcome", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 19:14", "date_iso": "2026-02-07T19:14:32-06:00", "body_md": "Records-Impacted: 13\nTolerance-ID: missing-retired-status-check-issue\nRecord-ID: dc21c18a-fd57-429c-a51b-54bbfd23753f\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fsecurity-labels%7C4.0.1&code=code8&_format=json&system=urn:ihe:xds:scheme8' \\\n  -H 'Accept: application/fhir+json'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fsecurity-labels%7C4.0.1&code=code8&_format=json&system=urn:ihe:xds:scheme8' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns 3 OperationOutcome issues: an informational `status-check` issue (\"Reference to retired ValueSet http://terminology.hl7.org/ValueSet/v3-ActUSPrivacyLaw|3.0.0\") plus two error-level issues (UNKNOWN_CODESYSTEM and not-in-vs). Dev returns only the 2 error-level issues, omitting the retired status-check informational issue entirely.\n\n## What differs\n\nWhen validating a code against a ValueSet that includes a retired sub-ValueSet, prod returns an informational status-check issue in the OperationOutcome reporting the retired reference. Dev omits this issue entirely.\n\nSpecifically, for validate-code on `http://hl7.org/fhir/ValueSet/security-labels|4.0.1` (which composes `http://terminology.hl7.org/ValueSet/v3-ActUSPrivacyLaw|3.0.0`, a retired ValueSet), prod includes:\n\n```json\n{\n  \"severity\": \"information\",\n  \"code\": \"business-rule\",\n  \"details\": {\n    \"coding\": [{\"system\": \"http://hl7.org/fhir/tools/CodeSystem/tx-issue-type\", \"code\": \"status-check\"}],\n    \"text\": \"Reference to retired ValueSet http://terminology.hl7.org/ValueSet/v3-ActUSPrivacyLaw|3.0.0\"\n  }\n}\n```\n\nDev's OperationOutcome has no such issue. All other parameters (result, system, code, message, and the two error-level issues) match between prod and dev.\n\n## How widespread\n\n13 records in deltas.ndjson. All are GET validate-code requests on `http://hl7.org/fhir/ValueSet/security-labels|4.0.1` with system `urn:ihe:xds:scheme8`. Found via:\n```\ngrep 'status-check' results/deltas/deltas.ndjson | wc -l\n```\n\nNote: the existing `hl7-terminology-cs-version-skew` tolerance already strips *draft* status-check issues for `terminology.hl7.org/CodeSystem/*` systems (bug 6edc96c). This is a separate pattern — *retired* status-check issues for ValueSet composition references.\n\n## What the tolerance covers\n\nTolerance `missing-retired-status-check-issue` strips informational status-check issues containing \"retired\" from prod's OperationOutcome, matching any validate-code operation where prod has a retired status-check issue and dev does not. Eliminates 13 records.", "body_html": "<p>Records-Impacted: 13<br>\nTolerance-ID: missing-retired-status-check-issue<br>\nRecord-ID: dc21c18a-fd57-429c-a51b-54bbfd23753f</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fsecurity-labels%7C4.0.1&amp;code=code8&amp;_format=json&amp;system=urn:ihe:xds:scheme8&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fhl7.org%2Ffhir%2FValueSet%2Fsecurity-labels%7C4.0.1&amp;code=code8&amp;_format=json&amp;system=urn:ihe:xds:scheme8&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns 3 OperationOutcome issues: an informational <code>status-check</code> issue (&quot;Reference to retired ValueSet <a href=\"http://terminology.hl7.org/ValueSet/v3-ActUSPrivacyLaw|3.0.0&quot;\" target=\"_blank\">http://terminology.hl7.org/ValueSet/v3-ActUSPrivacyLaw|3.0.0&quot;</a>) plus two error-level issues (UNKNOWN_CODESYSTEM and not-in-vs). Dev returns only the 2 error-level issues, omitting the retired status-check informational issue entirely.</p>\n<h2>What differs</h2>\n<p>When validating a code against a ValueSet that includes a retired sub-ValueSet, prod returns an informational status-check issue in the OperationOutcome reporting the retired reference. Dev omits this issue entirely.</p>\n<p>Specifically, for validate-code on <code>http://hl7.org/fhir/ValueSet/security-labels|4.0.1</code> (which composes <code>http://terminology.hl7.org/ValueSet/v3-ActUSPrivacyLaw|3.0.0</code>, a retired ValueSet), prod includes:</p>\n<pre><code class=\"lang-json\">{\n  &quot;severity&quot;: &quot;information&quot;,\n  &quot;code&quot;: &quot;business-rule&quot;,\n  &quot;details&quot;: {\n    &quot;coding&quot;: [{&quot;system&quot;: &quot;http://hl7.org/fhir/tools/CodeSystem/tx-issue-type&quot;, &quot;code&quot;: &quot;status-check&quot;}],\n    &quot;text&quot;: &quot;Reference to retired ValueSet http://terminology.hl7.org/ValueSet/v3-ActUSPrivacyLaw|3.0.0&quot;\n  }\n}</code></pre>\n<p>Dev&#x27;s OperationOutcome has no such issue. All other parameters (result, system, code, message, and the two error-level issues) match between prod and dev.</p>\n<h2>How widespread</h2>\n<p>13 records in deltas.ndjson. All are GET validate-code requests on <code>http://hl7.org/fhir/ValueSet/security-labels|4.0.1</code> with system <code>urn:ihe:xds:scheme8</code>. Found via:</p>\n<pre><code>grep &#x27;status-check&#x27; results/deltas/deltas.ndjson | wc -l</code></pre>\n<p>Note: the existing <code>hl7-terminology-cs-version-skew</code> tolerance already strips <em>draft</em> status-check issues for <code>terminology.hl7.org/CodeSystem/*</code> systems (bug 6edc96c). This is a separate pattern — <em>retired</em> status-check issues for ValueSet composition references.</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>missing-retired-status-check-issue</code> strips informational status-check issues containing &quot;retired&quot; from prod&#x27;s OperationOutcome, matching any validate-code operation where prod has a retired status-check issue and dev does not. Eliminates 13 records.</p>", "impact": 13}, {"id": "f33161f", "title": "Dev returns 400 error instead of 200 toocostly expansion for grammar-based code systems", "status": "open", "labels": ["reproduced", "status-mismatch", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 17:35", "date_iso": "2026-02-07T17:35:55-06:00", "body_md": "Records-Impacted: 12\nTolerance-ID: expand-toocostly-grammar-400\nRecord-ID: 4a993d89-3f8b-444d-9a63-e95c6944c4a7\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"x-system-cache-id\",\"valueString\":\"dc8fd4bc-091a-424a-8a3b-6198ef146891\"},{\"name\":\"defaultDisplayLanguage\",\"valueCode\":\"en-US\"},{\"name\":\"_limit\",\"valueInteger\":10000},{\"name\":\"_incomplete\",\"valueBoolean\":true},{\"name\":\"displayLanguage\",\"valueCode\":\"en\"},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"excludeNested\",\"valueBoolean\":false},{\"name\":\"cache-id\",\"valueId\":\"26888bd4-58f1-4cae-b379-f6f52937a918\"},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"all-languages\",\"status\":\"active\",\"compose\":{\"include\":[{\"system\":\"urn:ietf:bcp:47\"}]}}}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"x-system-cache-id\",\"valueString\":\"dc8fd4bc-091a-424a-8a3b-6198ef146891\"},{\"name\":\"defaultDisplayLanguage\",\"valueCode\":\"en-US\"},{\"name\":\"_limit\",\"valueInteger\":10000},{\"name\":\"_incomplete\",\"valueBoolean\":true},{\"name\":\"displayLanguage\",\"valueCode\":\"en\"},{\"name\":\"count\",\"valueInteger\":1000},{\"name\":\"offset\",\"valueInteger\":0},{\"name\":\"excludeNested\",\"valueBoolean\":false},{\"name\":\"cache-id\",\"valueId\":\"26888bd4-58f1-4cae-b379-f6f52937a918\"},{\"name\":\"valueSet\",\"resource\":{\"resourceType\":\"ValueSet\",\"id\":\"all-languages\",\"status\":\"active\",\"compose\":{\"include\":[{\"system\":\"urn:ietf:bcp:47\"}]}}}]}'\n```\n\nProd returns HTTP 200 with a ValueSet containing the `valueset-toocostly` extension (`valueBoolean: true`) and `limitedExpansion` parameter. Dev returns HTTP 400 with an OperationOutcome: `code: \"too-costly\"`, message: `\"The code System \\\"urn:ietf:bcp:47\\\" has a grammar, and cannot be enumerated directly\"`.\n\n\nWhen expanding a ValueSet that includes a grammar-based code system (BCP-47 `urn:ietf:bcp:47` or SNOMED CT `http://snomed.info/sct`) without any filter constraints, prod returns HTTP 200 with a ValueSet containing the `valueset-toocostly` extension and `limitedExpansion` parameter (indicating the expansion is too large to enumerate). Dev instead returns HTTP 400 with an OperationOutcome error (`code: \"too-costly\"`, message: \"The code System ... has a grammar, and cannot be enumerated directly\").\n\nProd's approach (returning a ValueSet with the toocostly extension) is the expected FHIR behavior for expansions that are too costly to compute — it signals the condition without failing the request.\n\n\n12 records in the comparison dataset show this pattern:\n- 8 records involve BCP-47 (`urn:ietf:bcp:47`), including the `all-languages` ValueSet\n- 4 records involve SNOMED CT (`http://snomed.info/sct`)\n- Affects both /r4/ and /r5/ endpoints\n- All are POST /r{4,5}/ValueSet/$expand requests\n\nSearch: `grep 'has a grammar' deltas.ndjson` finds 223 matches across all records (most already handled by existing tolerances), but filtering to status-mismatch expand records with prod=200/dev=400 and dev issue code \"too-costly\" yields exactly 12.\n\n\nTolerance ID: `expand-toocostly-grammar-400`. Matches $expand requests where prod returns 200 with the `valueset-toocostly` extension and dev returns 400 with an OperationOutcome containing issue code \"too-costly\". Skips these records entirely since the status codes and response formats are incomparable.\n\n\n- `4a993d89-3f8b-444d-9a63-e95c6944c4a7` (BCP-47, /r4/)\n- `b96706f9-c555-40e7-bdd2-f682fe2d5d88` (SNOMED, /r4/)\n- `d61127b2-3ed1-4deb-b11b-b8ccc77185ed` (BCP-47, /r5/)", "body_html": "<p>Records-Impacted: 12<br>\nTolerance-ID: expand-toocostly-grammar-400<br>\nRecord-ID: 4a993d89-3f8b-444d-9a63-e95c6944c4a7</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;x-system-cache-id&quot;,&quot;valueString&quot;:&quot;dc8fd4bc-091a-424a-8a3b-6198ef146891&quot;},{&quot;name&quot;:&quot;defaultDisplayLanguage&quot;,&quot;valueCode&quot;:&quot;en-US&quot;},{&quot;name&quot;:&quot;_limit&quot;,&quot;valueInteger&quot;:10000},{&quot;name&quot;:&quot;_incomplete&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueCode&quot;:&quot;en&quot;},{&quot;name&quot;:&quot;count&quot;,&quot;valueInteger&quot;:1000},{&quot;name&quot;:&quot;offset&quot;,&quot;valueInteger&quot;:0},{&quot;name&quot;:&quot;excludeNested&quot;,&quot;valueBoolean&quot;:false},{&quot;name&quot;:&quot;cache-id&quot;,&quot;valueId&quot;:&quot;26888bd4-58f1-4cae-b379-f6f52937a918&quot;},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;id&quot;:&quot;all-languages&quot;,&quot;status&quot;:&quot;active&quot;,&quot;compose&quot;:{&quot;include&quot;:[{&quot;system&quot;:&quot;urn:ietf:bcp:47&quot;}]}}}]}&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;x-system-cache-id&quot;,&quot;valueString&quot;:&quot;dc8fd4bc-091a-424a-8a3b-6198ef146891&quot;},{&quot;name&quot;:&quot;defaultDisplayLanguage&quot;,&quot;valueCode&quot;:&quot;en-US&quot;},{&quot;name&quot;:&quot;_limit&quot;,&quot;valueInteger&quot;:10000},{&quot;name&quot;:&quot;_incomplete&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueCode&quot;:&quot;en&quot;},{&quot;name&quot;:&quot;count&quot;,&quot;valueInteger&quot;:1000},{&quot;name&quot;:&quot;offset&quot;,&quot;valueInteger&quot;:0},{&quot;name&quot;:&quot;excludeNested&quot;,&quot;valueBoolean&quot;:false},{&quot;name&quot;:&quot;cache-id&quot;,&quot;valueId&quot;:&quot;26888bd4-58f1-4cae-b379-f6f52937a918&quot;},{&quot;name&quot;:&quot;valueSet&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;ValueSet&quot;,&quot;id&quot;:&quot;all-languages&quot;,&quot;status&quot;:&quot;active&quot;,&quot;compose&quot;:{&quot;include&quot;:[{&quot;system&quot;:&quot;urn:ietf:bcp:47&quot;}]}}}]}&#x27;</code></pre>\n<p>Prod returns HTTP 200 with a ValueSet containing the <code>valueset-toocostly</code> extension (<code>valueBoolean: true</code>) and <code>limitedExpansion</code> parameter. Dev returns HTTP 400 with an OperationOutcome: <code>code: &quot;too-costly&quot;</code>, message: <code>&quot;The code System \\&quot;urn:ietf:bcp:47\\&quot; has a grammar, and cannot be enumerated directly&quot;</code>.</p>\n<p>When expanding a ValueSet that includes a grammar-based code system (BCP-47 <code>urn:ietf:bcp:47</code> or SNOMED CT <code>http://snomed.info/sct</code>) without any filter constraints, prod returns HTTP 200 with a ValueSet containing the <code>valueset-toocostly</code> extension and <code>limitedExpansion</code> parameter (indicating the expansion is too large to enumerate). Dev instead returns HTTP 400 with an OperationOutcome error (<code>code: &quot;too-costly&quot;</code>, message: &quot;The code System ... has a grammar, and cannot be enumerated directly&quot;).</p>\n<p>Prod&#x27;s approach (returning a ValueSet with the toocostly extension) is the expected FHIR behavior for expansions that are too costly to compute — it signals the condition without failing the request.</p>\n<p>12 records in the comparison dataset show this pattern:</p>\n<ul><li>8 records involve BCP-47 (<code>urn:ietf:bcp:47</code>), including the <code>all-languages</code> ValueSet</li><li>4 records involve SNOMED CT (<code>http://snomed.info/sct</code>)</li><li>Affects both /r4/ and /r5/ endpoints</li><li>All are POST /r{4,5}/ValueSet/$expand requests</li></ul>\n<p>Search: <code>grep &#x27;has a grammar&#x27; deltas.ndjson</code> finds 223 matches across all records (most already handled by existing tolerances), but filtering to status-mismatch expand records with prod=200/dev=400 and dev issue code &quot;too-costly&quot; yields exactly 12.</p>\n<p>Tolerance ID: <code>expand-toocostly-grammar-400</code>. Matches $expand requests where prod returns 200 with the <code>valueset-toocostly</code> extension and dev returns 400 with an OperationOutcome containing issue code &quot;too-costly&quot;. Skips these records entirely since the status codes and response formats are incomparable.</p>\n<ul><li><code>4a993d89-3f8b-444d-9a63-e95c6944c4a7</code> (BCP-47, /r4/)</li><li><code>b96706f9-c555-40e7-bdd2-f682fe2d5d88</code> (SNOMED, /r4/)</li><li><code>d61127b2-3ed1-4deb-b11b-b8ccc77185ed</code> (BCP-47, /r5/)</li></ul>", "impact": 12}, {"id": "80ce6b2", "title": "Dev message parameter omits issue texts when validating CodeableConcept with multiple coding errors", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 17:36", "date_iso": "2026-02-07T17:36:04-06:00", "body_md": "Records-Impacted: 10\nTolerance-ID: message-concat-selective-issues\nRecord-ID: c350392e-d535-45e3-83cf-924b05e26a14\n\n## Repro\n\n```bash\n# Prod\ncat > /tmp/repro-request.json << 'EOF'\n{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication\",\"code\":\"R210\",\"display\":\"Inherited MMR deficiency (Lynch syndrome)\"},{\"system\":\"http://snomed.info/sct\",\"code\":\"1365861003\",\"display\":\"Lynch syndrome gene mutation detected\"}],\"text\":\"Inherited MMR deficiency (Lynch syndrome)\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en-GB\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true},{\"name\":\"tx-resource\",\"resource\":{\"resourceType\":\"CodeSystem\",\"id\":\"GenomicClinicalIndication\",\"url\":\"https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication\",\"version\":\"0.1.0\",\"name\":\"GenomicClinicalIndication\",\"title\":\"NHS England Genomic Clinical Indication Code\",\"status\":\"draft\",\"experimental\":false,\"date\":\"2025-05-08\",\"publisher\":\"NHS North West Genomics\",\"contact\":[{\"telecom\":[{\"system\":\"url\",\"value\":\"https://www.nwgenomics.nhs.uk/contact-us\"}]}],\"description\":\"1st level Genomic Test Directory Codes\",\"jurisdiction\":[{\"coding\":[{\"system\":\"urn:iso:std:iso:3166\",\"code\":\"GB\",\"display\":\"United Kingdom of Great Britain and Northern Ireland\"}]}],\"caseSensitive\":true,\"content\":\"fragment\",\"concept\":[{\"code\":\"R240\",\"display\":\"Diagnostic testing for known mutation(s)\"},{\"code\":\"R361\",\"display\":\"Childhood onset hereditary spastic paraplegia\"},{\"code\":\"R362\",\"display\":\"Not present in 8.0\"},{\"code\":\"R372\",\"display\":\"Newborn screening for sickle cell disease in a transfused baby\"},{\"code\":\"R93\",\"display\":\"Sickle cell, thalassaemia and other haemoglobinopathies\"},{\"code\":\"R94\",\"display\":\"Not present in 8.0\"},{\"code\":\"R413\",\"display\":\"Autoinflammatory Disorders\"},{\"code\":\"R67\",\"display\":\"Monogenic hearing loss\"},{\"code\":\"R141\",\"display\":\"Monogenic diabetes\"},{\"code\":\"R142\",\"display\":\"Glucokinase-related fasting hyperglycaemia\"},{\"code\":\"R201\",\"display\":\"Atypical haemolytic uraemic syndrome\"},{\"code\":\"M9\",\"display\":\"Thyroid Papillary Carcinoma - Adult\"},{\"code\":\"M215\",\"display\":\"Endometrial Cancer\"}]}},{\"name\":\"cache-id\",\"valueId\":\"7743c2e6-5b90-4b62-bcd2-6695b993e76b\"},{\"name\":\"system-version\",\"valueUri\":\"http://snomed.info/sct|http://snomed.info/sct/83821000000107\"},{\"name\":\"diagnostics\",\"valueBoolean\":true}]}\nEOF\n\ncat /tmp/repro-request.json | curl -s https://tx.fhir.org/r4/CodeSystem/\\$validate-code \\\n  -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' \\\n  --data-binary @- | jq -r '.parameter[] | select(.name == \"message\") | .valueString'\n\n# Dev\ncat /tmp/repro-request.json | curl -s https://tx-dev.fhir.org/r4/CodeSystem/\\$validate-code \\\n  -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' \\\n  --data-binary @- | jq -r '.parameter[] | select(.name == \"message\") | .valueString'\n```\n\nProd returns: `Unknown code '1365861003' in the CodeSystem 'http://snomed.info/sct' version 'http://snomed.info/sct/83821000000107/version/20230412' (UK Edition); Unknown Code 'R210' in the CodeSystem 'https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication' version '0.1.0' - note that the code system is labeled as a fragment, so the code may be valid in some other fragment`\n\nDev returns: `Unknown code '1365861003' in the CodeSystem 'http://snomed.info/sct' version 'http://snomed.info/sct/83821000000107/version/20230412' (UK Edition)`\n\nDev omits the second error message about the GenomicClinicalIndication code R210.\n\n## What differs\n\nWhen $validate-code is called on a CodeableConcept containing multiple codings that each fail validation, the `message` output parameter should concatenate all error/warning issue texts with \"; \". Prod does this correctly. Dev only includes one of the error texts in the message, omitting the others.\n\nFor example, with a CodeableConcept containing two codings (GenomicClinicalIndication#R210 and SNOMED#1365861003), both invalid:\n- **Prod message**: \"Unknown code '1365861003' in the CodeSystem 'http://snomed.info/sct'...; Unknown Code 'R210' in the CodeSystem 'https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication'...\"\n- **Dev message**: \"Unknown code '1365861003' in the CodeSystem 'http://snomed.info/sct'...\"\n\nDev omits the second error about the GenomicClinicalIndication code. The structured OperationOutcome `issues` resource is identical between prod and dev (both have all 3 issues). Only the `message` parameter text is incomplete.\n\n## How widespread\n\n10 delta records, all POST /r4/CodeSystem/$validate-code, all validating the same GenomicClinicalIndication CodeableConcept with SNOMED coding. Identified by searching for records where the only diff is `message` value-differs and prod's message contains more semicolon-separated segments than dev's.\n\nThis is a variant of the same underlying bug as tolerance `message-concat-missing-issues` (which handles a different set of 8 records where prod message = all issue texts joined, dev message = first issue text only). The root cause is the same: dev doesn't properly concatenate all relevant issue texts into the message parameter.\n\n## What the tolerance covers\n\nTolerance `message-concat-selective-issues` matches validate-code records where:\n- Both sides have identical OperationOutcome issues\n- Messages differ\n- Dev's message is a proper substring of prod's message (prod includes more issue texts)\n\nCanonicalizes dev's message to prod's value. Eliminates 10 records.", "body_html": "<p>Records-Impacted: 10<br>\nTolerance-ID: message-concat-selective-issues<br>\nRecord-ID: c350392e-d535-45e3-83cf-924b05e26a14</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncat &gt; /tmp/repro-request.json &lt;&lt; &#x27;EOF&#x27;\n{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;codeableConcept&quot;,&quot;valueCodeableConcept&quot;:{&quot;coding&quot;:[{&quot;system&quot;:&quot;https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication&quot;,&quot;code&quot;:&quot;R210&quot;,&quot;display&quot;:&quot;Inherited MMR deficiency (Lynch syndrome)&quot;},{&quot;system&quot;:&quot;http://snomed.info/sct&quot;,&quot;code&quot;:&quot;1365861003&quot;,&quot;display&quot;:&quot;Lynch syndrome gene mutation detected&quot;}],&quot;text&quot;:&quot;Inherited MMR deficiency (Lynch syndrome)&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en-GB&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true},{&quot;name&quot;:&quot;tx-resource&quot;,&quot;resource&quot;:{&quot;resourceType&quot;:&quot;CodeSystem&quot;,&quot;id&quot;:&quot;GenomicClinicalIndication&quot;,&quot;url&quot;:&quot;https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication&quot;,&quot;version&quot;:&quot;0.1.0&quot;,&quot;name&quot;:&quot;GenomicClinicalIndication&quot;,&quot;title&quot;:&quot;NHS England Genomic Clinical Indication Code&quot;,&quot;status&quot;:&quot;draft&quot;,&quot;experimental&quot;:false,&quot;date&quot;:&quot;2025-05-08&quot;,&quot;publisher&quot;:&quot;NHS North West Genomics&quot;,&quot;contact&quot;:[{&quot;telecom&quot;:[{&quot;system&quot;:&quot;url&quot;,&quot;value&quot;:&quot;https://www.nwgenomics.nhs.uk/contact-us&quot;}]}],&quot;description&quot;:&quot;1st level Genomic Test Directory Codes&quot;,&quot;jurisdiction&quot;:[{&quot;coding&quot;:[{&quot;system&quot;:&quot;urn:iso:std:iso:3166&quot;,&quot;code&quot;:&quot;GB&quot;,&quot;display&quot;:&quot;United Kingdom of Great Britain and Northern Ireland&quot;}]}],&quot;caseSensitive&quot;:true,&quot;content&quot;:&quot;fragment&quot;,&quot;concept&quot;:[{&quot;code&quot;:&quot;R240&quot;,&quot;display&quot;:&quot;Diagnostic testing for known mutation(s)&quot;},{&quot;code&quot;:&quot;R361&quot;,&quot;display&quot;:&quot;Childhood onset hereditary spastic paraplegia&quot;},{&quot;code&quot;:&quot;R362&quot;,&quot;display&quot;:&quot;Not present in 8.0&quot;},{&quot;code&quot;:&quot;R372&quot;,&quot;display&quot;:&quot;Newborn screening for sickle cell disease in a transfused baby&quot;},{&quot;code&quot;:&quot;R93&quot;,&quot;display&quot;:&quot;Sickle cell, thalassaemia and other haemoglobinopathies&quot;},{&quot;code&quot;:&quot;R94&quot;,&quot;display&quot;:&quot;Not present in 8.0&quot;},{&quot;code&quot;:&quot;R413&quot;,&quot;display&quot;:&quot;Autoinflammatory Disorders&quot;},{&quot;code&quot;:&quot;R67&quot;,&quot;display&quot;:&quot;Monogenic hearing loss&quot;},{&quot;code&quot;:&quot;R141&quot;,&quot;display&quot;:&quot;Monogenic diabetes&quot;},{&quot;code&quot;:&quot;R142&quot;,&quot;display&quot;:&quot;Glucokinase-related fasting hyperglycaemia&quot;},{&quot;code&quot;:&quot;R201&quot;,&quot;display&quot;:&quot;Atypical haemolytic uraemic syndrome&quot;},{&quot;code&quot;:&quot;M9&quot;,&quot;display&quot;:&quot;Thyroid Papillary Carcinoma - Adult&quot;},{&quot;code&quot;:&quot;M215&quot;,&quot;display&quot;:&quot;Endometrial Cancer&quot;}]}},{&quot;name&quot;:&quot;cache-id&quot;,&quot;valueId&quot;:&quot;7743c2e6-5b90-4b62-bcd2-6695b993e76b&quot;},{&quot;name&quot;:&quot;system-version&quot;,&quot;valueUri&quot;:&quot;http://snomed.info/sct|http://snomed.info/sct/83821000000107&quot;},{&quot;name&quot;:&quot;diagnostics&quot;,&quot;valueBoolean&quot;:true}]}\nEOF\n\ncat /tmp/repro-request.json | curl -s https://tx.fhir.org/r4/CodeSystem/\\$validate-code \\\n  -X POST --header &#x27;Content-Type: application/json&#x27; --header &#x27;Accept: application/json&#x27; \\\n  --data-binary @- | jq -r &#x27;.parameter[] | select(.name == &quot;message&quot;) | .valueString&#x27;\n\n# Dev\ncat /tmp/repro-request.json | curl -s https://tx-dev.fhir.org/r4/CodeSystem/\\$validate-code \\\n  -X POST --header &#x27;Content-Type: application/json&#x27; --header &#x27;Accept: application/json&#x27; \\\n  --data-binary @- | jq -r &#x27;.parameter[] | select(.name == &quot;message&quot;) | .valueString&#x27;</code></pre>\n<p>Prod returns: <code>Unknown code &#x27;1365861003&#x27; in the CodeSystem &#x27;http://snomed.info/sct&#x27; version &#x27;http://snomed.info/sct/83821000000107/version/20230412&#x27; (UK Edition); Unknown Code &#x27;R210&#x27; in the CodeSystem &#x27;https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication&#x27; version &#x27;0.1.0&#x27; - note that the code system is labeled as a fragment, so the code may be valid in some other fragment</code></p>\n<p>Dev returns: <code>Unknown code &#x27;1365861003&#x27; in the CodeSystem &#x27;http://snomed.info/sct&#x27; version &#x27;http://snomed.info/sct/83821000000107/version/20230412&#x27; (UK Edition)</code></p>\n<p>Dev omits the second error message about the GenomicClinicalIndication code R210.</p>\n<h2>What differs</h2>\n<p>When $validate-code is called on a CodeableConcept containing multiple codings that each fail validation, the <code>message</code> output parameter should concatenate all error/warning issue texts with &quot;; &quot;. Prod does this correctly. Dev only includes one of the error texts in the message, omitting the others.</p>\n<p>For example, with a CodeableConcept containing two codings (GenomicClinicalIndication#R210 and SNOMED#1365861003), both invalid:</p>\n<ul><li><strong>Prod message</strong>: &quot;Unknown code &#x27;1365861003&#x27; in the CodeSystem &#x27;<a href=\"http://snomed.info/sct&#x27;...;\" target=\"_blank\">http://snomed.info/sct&#x27;...;</a> Unknown Code &#x27;R210&#x27; in the CodeSystem &#x27;<a href=\"https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication&#x27;...&quot;\" target=\"_blank\">https://fhir.nwgenomics.nhs.uk/CodeSystem/GenomicClinicalIndication&#x27;...&quot;</a></li><li><strong>Dev message</strong>: &quot;Unknown code &#x27;1365861003&#x27; in the CodeSystem &#x27;<a href=\"http://snomed.info/sct&#x27;...&quot;\" target=\"_blank\">http://snomed.info/sct&#x27;...&quot;</a></li></ul>\n<p>Dev omits the second error about the GenomicClinicalIndication code. The structured OperationOutcome <code>issues</code> resource is identical between prod and dev (both have all 3 issues). Only the <code>message</code> parameter text is incomplete.</p>\n<h2>How widespread</h2>\n<p>10 delta records, all POST /r4/CodeSystem/$validate-code, all validating the same GenomicClinicalIndication CodeableConcept with SNOMED coding. Identified by searching for records where the only diff is <code>message</code> value-differs and prod&#x27;s message contains more semicolon-separated segments than dev&#x27;s.</p>\n<p>This is a variant of the same underlying bug as tolerance <code>message-concat-missing-issues</code> (which handles a different set of 8 records where prod message = all issue texts joined, dev message = first issue text only). The root cause is the same: dev doesn&#x27;t properly concatenate all relevant issue texts into the message parameter.</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>message-concat-selective-issues</code> matches validate-code records where:</p>\n<ul><li>Both sides have identical OperationOutcome issues</li><li>Messages differ</li><li>Dev&#x27;s message is a proper substring of prod&#x27;s message (prod includes more issue texts)</li></ul>\n<p>Canonicalizes dev&#x27;s message to prod&#x27;s value. Eliminates 10 records.</p>", "impact": 10}, {"id": "1433eb6", "title": "Dev returns 400 ValueSet-not-found for validate-code requests that prod handles successfully (10 records)", "status": "open", "labels": ["reproduced", "status-mismatch", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 19:14", "date_iso": "2026-02-07T19:14:44-06:00", "body_md": "Records-Impacted: 10\nTolerance-ID: validate-code-valueset-not-found-dev-400\nRecord-ID: 064711fa-e287-430e-a6f4-7ff723952ff1\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"url\",\"valueUri\":\"http://hl7.org/fhir/ValueSet/@all\"},{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"http://snomed.info/sct\",\"code\":\"48546005\",\"display\":\"Diazepam-containing product\"}]}},{\"name\":\"displayLanguage\",\"valueCode\":\"en-US\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"url\",\"valueUri\":\"http://hl7.org/fhir/ValueSet/@all\"},{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"http://snomed.info/sct\",\"code\":\"48546005\",\"display\":\"Diazepam-containing product\"}]}},{\"name\":\"displayLanguage\",\"valueCode\":\"en-US\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n```\n\nProd returns HTTP 200 with `{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"result\",\"valueBoolean\":true},...]}` indicating successful validation. Dev returns HTTP 400 with `{\"resourceType\":\"OperationOutcome\",\"issue\":[{\"severity\":\"error\",\"code\":\"not-found\",\"details\":{\"text\":\"A definition for the value Set 'http://hl7.org/fhir/ValueSet/@all' could not be found\"}}]}`.\n\nFor $validate-code requests against certain ValueSets, prod returns HTTP 200 with a valid Parameters response (result=true or result=false), while dev returns HTTP 400 with an OperationOutcome saying \"A definition for the value Set '...' could not be found.\"\n\nProd successfully resolves these ValueSets and performs code validation. Dev fails at the ValueSet resolution step and returns an error instead of a validation result.\n\n\n10 records show this pattern (prod=200, dev=400 with \"could not be found\"):\n\n- 3 records: `nrces.in/ndhm/fhir/r4/ValueSet/ndhm-diagnosis-use*` (Indian NDHM ValueSets)\n- 5 records: `ontariohealth.ca/fhir/ValueSet/*` (Ontario Health ValueSets)\n- 2 records: `hl7.org/fhir/ValueSet/@all` (special @all ValueSet)\n\nSearch: `grep 'could not be found' results/deltas/deltas.ndjson` filtered to prod=200 dev=400\n\nAll are POST /r4/ValueSet/$validate-code requests. The ValueSets come from different IG packages (NDHM India, Ontario Health, and core FHIR @all), so the root cause may be that dev is missing certain IG-provided ValueSet definitions or doesn't support the @all pseudo-ValueSet.\n\n\nTolerance `validate-code-valueset-not-found-dev-400` matches: POST validate-code, prod=200, dev=400, where dev body contains OperationOutcome with \"could not be found\" text. Eliminates all 10 records.\n\n\n- 064711fa-e287-430e-a6f4-7ff723952ff1 (nrces.in ndhm-diagnosis-use--0)\n- 5beceead-a754-4f88-8dec-1a7a931166b9 (ontariohealth.ca symptoms-of-clinical-concern)\n- 38f6e665-4c34-4589-8d29-77c522b97845 (hl7.org/fhir/ValueSet/@all)", "body_html": "<p>Records-Impacted: 10<br>\nTolerance-ID: validate-code-valueset-not-found-dev-400<br>\nRecord-ID: 064711fa-e287-430e-a6f4-7ff723952ff1</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$validate-code&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;url&quot;,&quot;valueUri&quot;:&quot;http://hl7.org/fhir/ValueSet/@all&quot;},{&quot;name&quot;:&quot;codeableConcept&quot;,&quot;valueCodeableConcept&quot;:{&quot;coding&quot;:[{&quot;system&quot;:&quot;http://snomed.info/sct&quot;,&quot;code&quot;:&quot;48546005&quot;,&quot;display&quot;:&quot;Diazepam-containing product&quot;}]}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueCode&quot;:&quot;en-US&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true}]}&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$validate-code&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;url&quot;,&quot;valueUri&quot;:&quot;http://hl7.org/fhir/ValueSet/@all&quot;},{&quot;name&quot;:&quot;codeableConcept&quot;,&quot;valueCodeableConcept&quot;:{&quot;coding&quot;:[{&quot;system&quot;:&quot;http://snomed.info/sct&quot;,&quot;code&quot;:&quot;48546005&quot;,&quot;display&quot;:&quot;Diazepam-containing product&quot;}]}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueCode&quot;:&quot;en-US&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true}]}&#x27;</code></pre>\n<p>Prod returns HTTP 200 with <code>{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;result&quot;,&quot;valueBoolean&quot;:true},...]}</code> indicating successful validation. Dev returns HTTP 400 with <code>{&quot;resourceType&quot;:&quot;OperationOutcome&quot;,&quot;issue&quot;:[{&quot;severity&quot;:&quot;error&quot;,&quot;code&quot;:&quot;not-found&quot;,&quot;details&quot;:{&quot;text&quot;:&quot;A definition for the value Set &#x27;http://hl7.org/fhir/ValueSet/@all&#x27; could not be found&quot;}}]}</code>.</p>\n<p>For $validate-code requests against certain ValueSets, prod returns HTTP 200 with a valid Parameters response (result=true or result=false), while dev returns HTTP 400 with an OperationOutcome saying &quot;A definition for the value Set &#x27;...&#x27; could not be found.&quot;</p>\n<p>Prod successfully resolves these ValueSets and performs code validation. Dev fails at the ValueSet resolution step and returns an error instead of a validation result.</p>\n<p>10 records show this pattern (prod=200, dev=400 with &quot;could not be found&quot;):</p>\n<ul><li>3 records: <code>nrces.in/ndhm/fhir/r4/ValueSet/ndhm-diagnosis-use*</code> (Indian NDHM ValueSets)</li><li>5 records: <code>ontariohealth.ca/fhir/ValueSet/*</code> (Ontario Health ValueSets)</li><li>2 records: <code>hl7.org/fhir/ValueSet/@all</code> (special @all ValueSet)</li></ul>\n<p>Search: <code>grep &#x27;could not be found&#x27; results/deltas/deltas.ndjson</code> filtered to prod=200 dev=400</p>\n<p>All are POST /r4/ValueSet/$validate-code requests. The ValueSets come from different IG packages (NDHM India, Ontario Health, and core FHIR @all), so the root cause may be that dev is missing certain IG-provided ValueSet definitions or doesn&#x27;t support the @all pseudo-ValueSet.</p>\n<p>Tolerance <code>validate-code-valueset-not-found-dev-400</code> matches: POST validate-code, prod=200, dev=400, where dev body contains OperationOutcome with &quot;could not be found&quot; text. Eliminates all 10 records.</p>\n<ul><li>064711fa-e287-430e-a6f4-7ff723952ff1 (nrces.in ndhm-diagnosis-use--0)</li><li>5beceead-a754-4f88-8dec-1a7a931166b9 (ontariohealth.ca symptoms-of-clinical-concern)</li><li>38f6e665-4c34-4589-8d29-77c522b97845 (hl7.org/fhir/ValueSet/@all)</li></ul>", "impact": 10}, {"id": "801aef1", "title": "Dev adds expression field on informational OperationOutcome issues where prod omits it", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 16:03", "date_iso": "2026-02-07T16:03:42-06:00", "body_md": "Records-Impacted: 6\nTolerance-ID: oo-extra-expression-on-info-issues\nRecord-ID: 9160e659-1af6-4bc6-9c89-e0a8b4df55cf\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/CodeSystem/$validate-code?system=http%3A%2F%2Funitsofmeasure.org&code=TEST' \\\n  -H 'Accept: application/fhir+json' | \\\n  jq '.parameter[] | select(.name == \"issues\") | .resource.issue[] | select(.severity == \"information\") | {severity, code, expression}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/CodeSystem/$validate-code?system=http%3A%2F%2Funitsofmeasure.org&code=TEST' \\\n  -H 'Accept: application/fhir+json' | \\\n  jq '.parameter[] | select(.name == \"issues\") | .resource.issue[] | select(.severity == \"information\") | {severity, code, expression}'\n```\n\nProd returns `\"expression\": null` (field absent) on the informational issue, dev returns `\"expression\": [\"code\"]`.\n\n## What differs\n\nIn $validate-code responses, both prod and dev return OperationOutcome issues. On error-severity issues, both include `expression: [\"code\"]`. On information-severity issues, prod omits the `expression` field entirely while dev includes `expression: [\"code\"]`.\n\nFor example, on `GET /r4/CodeSystem/$validate-code?system=http%3A%2F%2Funitsofmeasure.org&code=TEST`:\n- Prod: informational issue has no `expression` field\n- Dev: informational issue has `\"expression\": [\"code\"]`\n\nThe `expression` value is semantically correct (the issue relates to the `code` parameter), so dev is providing more complete information, but the difference in field presence is a real behavioral divergence.\n\n## How widespread\n\n6 records across the dataset exhibit this pattern:\n- 4 SNOMED CT records (all `code=K29` variants on different FHIR version paths)\n- 1 UCUM record (`code=TEST`)\n- 1 SNOMED CT POST record (`code=freetext`)\n\nAll are `$validate-code` or `$batch-validate-code` operations where the code is invalid and the informational issue provides supplementary error context (e.g., UCUM parse error, SNOMED expression parse error).\n\nSearch: node script checking all 3948 delta records for issues where dev has `expression` and prod lacks it on the same positional issue.\n\n## What the tolerance covers\n\nTolerance `oo-extra-expression-on-info-issues` matches validate-code Parameters responses where any OperationOutcome information-severity issue in dev has `expression` that prod lacks. Normalizes by removing the extra `expression` from dev to match prod. Eliminates 6 records.", "body_html": "<p>Records-Impacted: 6<br>\nTolerance-ID: oo-extra-expression-on-info-issues<br>\nRecord-ID: 9160e659-1af6-4bc6-9c89-e0a8b4df55cf</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/CodeSystem/$validate-code?system=http%3A%2F%2Funitsofmeasure.org&amp;code=TEST&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; | \\\n  jq &#x27;.parameter[] | select(.name == &quot;issues&quot;) | .resource.issue[] | select(.severity == &quot;information&quot;) | {severity, code, expression}&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/CodeSystem/$validate-code?system=http%3A%2F%2Funitsofmeasure.org&amp;code=TEST&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; | \\\n  jq &#x27;.parameter[] | select(.name == &quot;issues&quot;) | .resource.issue[] | select(.severity == &quot;information&quot;) | {severity, code, expression}&#x27;</code></pre>\n<p>Prod returns <code>&quot;expression&quot;: null</code> (field absent) on the informational issue, dev returns <code>&quot;expression&quot;: [&quot;code&quot;]</code>.</p>\n<h2>What differs</h2>\n<p>In $validate-code responses, both prod and dev return OperationOutcome issues. On error-severity issues, both include <code>expression: [&quot;code&quot;]</code>. On information-severity issues, prod omits the <code>expression</code> field entirely while dev includes <code>expression: [&quot;code&quot;]</code>.</p>\n<p>For example, on <code>GET /r4/CodeSystem/$validate-code?system=http%3A%2F%2Funitsofmeasure.org&amp;code=TEST</code>:</p>\n<ul><li>Prod: informational issue has no <code>expression</code> field</li><li>Dev: informational issue has <code>&quot;expression&quot;: [&quot;code&quot;]</code></li></ul>\n<p>The <code>expression</code> value is semantically correct (the issue relates to the <code>code</code> parameter), so dev is providing more complete information, but the difference in field presence is a real behavioral divergence.</p>\n<h2>How widespread</h2>\n<p>6 records across the dataset exhibit this pattern:</p>\n<ul><li>4 SNOMED CT records (all <code>code=K29</code> variants on different FHIR version paths)</li><li>1 UCUM record (<code>code=TEST</code>)</li><li>1 SNOMED CT POST record (<code>code=freetext</code>)</li></ul>\n<p>All are <code>$validate-code</code> or <code>$batch-validate-code</code> operations where the code is invalid and the informational issue provides supplementary error context (e.g., UCUM parse error, SNOMED expression parse error).</p>\n<p>Search: node script checking all 3948 delta records for issues where dev has <code>expression</code> and prod lacks it on the same positional issue.</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>oo-extra-expression-on-info-issues</code> matches validate-code Parameters responses where any OperationOutcome information-severity issue in dev has <code>expression</code> that prod lacks. Normalizes by removing the extra <code>expression</code> from dev to match prod. Eliminates 6 records.</p>", "impact": 6}, {"id": "b6d19d8", "title": "Dev omits system/code/version/display params on CodeSystem/$validate-code with codeableConcept containing unknown system", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 16:16", "date_iso": "2026-02-07T16:16:28-06:00", "body_md": "Records-Impacted: 5\nTolerance-ID: cc-validate-code-missing-known-coding-params\nRecord-ID: 84b0cee7-5f7e-4fbc-af8a-aed5ad7a91d4\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r5/CodeSystem/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"https://fhir.smartypower.app/CodeSystem/smartypower-cognitive-tests\",\"code\":\"SP-QUICKSTOP\",\"display\":\"QuickStop Response Inhibition Test\"},{\"system\":\"http://loinc.org\",\"code\":\"72106-8\",\"display\":\"Cognitive functioning [Interpretation]\"}],\"text\":\"Go/No-Go task measuring response inhibition and impulse control\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r5/CodeSystem/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"codeableConcept\",\"valueCodeableConcept\":{\"coding\":[{\"system\":\"https://fhir.smartypower.app/CodeSystem/smartypower-cognitive-tests\",\"code\":\"SP-QUICKSTOP\",\"display\":\"QuickStop Response Inhibition Test\"},{\"system\":\"http://loinc.org\",\"code\":\"72106-8\",\"display\":\"Cognitive functioning [Interpretation]\"}],\"text\":\"Go/No-Go task measuring response inhibition and impulse control\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n```\n\nProd returns `system=http://loinc.org`, `code=72106-8`, `display=Total score [MMSE]`, plus 2 OperationOutcome issues (UNKNOWN_CODESYSTEM + Display_Name_for__should_be_one_of__instead_of). Dev returns no system/code/display params and only 1 issue (UNKNOWN_CODESYSTEM).\n\n\nWhen CodeSystem/$validate-code is called with a codeableConcept containing multiple codings — one from an unknown CodeSystem and one from a known CodeSystem — and result=false:\n\n- **Prod** validates the known coding and returns `system`, `code`, `version`, `display` parameters for it. When the known coding also has issues (e.g. invalid-display), prod includes those as additional OperationOutcome issues.\n- **Dev** only reports the unknown system error and omits the `system`, `code`, `version`, `display` parameters entirely. Dev also omits any additional OperationOutcome issues related to the known coding.\n\nFor example, with a codeableConcept containing a LOINC coding (known) and a smartypower coding (unknown):\n- Prod returns: system=http://loinc.org, code=72106-8, version=2.81, display=\"Total score [MMSE]\", plus 2 issues (UNKNOWN_CODESYSTEM + invalid-display)\n- Dev returns: no system/code/version/display params, only 1 issue (UNKNOWN_CODESYSTEM)\n\n\n5 records in deltas. All are CodeSystem/$validate-code (both /r4 and /r5) with codeableConcept containing one unknown and one known coding. Both sides agree result=false.\n\nSearch: `grep '\"missing-in-dev\",\"param\":\"system\"' results/deltas/deltas.ndjson | wc -l` → 5\n\nThe 5 records involve 2 unknown systems:\n- https://fhir.smartypower.app/CodeSystem/smartypower-cognitive-tests (2 records, LOINC known coding)\n- http://fhir.essilorluxottica.com/fhir/CodeSystem/el-observation-code-cs (3 records, SNOMED known coding)\n\n\nTolerance ID: cc-validate-code-missing-known-coding-params\nMatches: validate-code with codeableConcept, result=false on both sides, x-caused-by-unknown-system present, where prod has system/code params that dev lacks.\nNormalizes by adding prod's system/code/version/display params to dev and canonicalizing issues to prod's set.\nEliminates: 5 records.\n\n\n- 84b0cee7-5f7e-4fbc-af8a-aed5ad7a91d4 (LOINC + smartypower, /r5)\n- 6f70f14a-81e1-427e-9eed-1b2c53801296 (SNOMED + essilorluxottica, /r4)", "body_html": "<p>Records-Impacted: 5<br>\nTolerance-ID: cc-validate-code-missing-known-coding-params<br>\nRecord-ID: 84b0cee7-5f7e-4fbc-af8a-aed5ad7a91d4</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r5/CodeSystem/$validate-code&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;codeableConcept&quot;,&quot;valueCodeableConcept&quot;:{&quot;coding&quot;:[{&quot;system&quot;:&quot;https://fhir.smartypower.app/CodeSystem/smartypower-cognitive-tests&quot;,&quot;code&quot;:&quot;SP-QUICKSTOP&quot;,&quot;display&quot;:&quot;QuickStop Response Inhibition Test&quot;},{&quot;system&quot;:&quot;http://loinc.org&quot;,&quot;code&quot;:&quot;72106-8&quot;,&quot;display&quot;:&quot;Cognitive functioning [Interpretation]&quot;}],&quot;text&quot;:&quot;Go/No-Go task measuring response inhibition and impulse control&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true}]}&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r5/CodeSystem/$validate-code&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;codeableConcept&quot;,&quot;valueCodeableConcept&quot;:{&quot;coding&quot;:[{&quot;system&quot;:&quot;https://fhir.smartypower.app/CodeSystem/smartypower-cognitive-tests&quot;,&quot;code&quot;:&quot;SP-QUICKSTOP&quot;,&quot;display&quot;:&quot;QuickStop Response Inhibition Test&quot;},{&quot;system&quot;:&quot;http://loinc.org&quot;,&quot;code&quot;:&quot;72106-8&quot;,&quot;display&quot;:&quot;Cognitive functioning [Interpretation]&quot;}],&quot;text&quot;:&quot;Go/No-Go task measuring response inhibition and impulse control&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true}]}&#x27;</code></pre>\n<p>Prod returns <code>system=http://loinc.org</code>, <code>code=72106-8</code>, <code>display=Total score [MMSE]</code>, plus 2 OperationOutcome issues (UNKNOWN_CODESYSTEM + Display_Name_for<strong>should_be_one_of</strong>instead_of). Dev returns no system/code/display params and only 1 issue (UNKNOWN_CODESYSTEM).</p>\n<p>When CodeSystem/$validate-code is called with a codeableConcept containing multiple codings — one from an unknown CodeSystem and one from a known CodeSystem — and result=false:</p>\n<ul><li><strong>Prod</strong> validates the known coding and returns <code>system</code>, <code>code</code>, <code>version</code>, <code>display</code> parameters for it. When the known coding also has issues (e.g. invalid-display), prod includes those as additional OperationOutcome issues.</li><li><strong>Dev</strong> only reports the unknown system error and omits the <code>system</code>, <code>code</code>, <code>version</code>, <code>display</code> parameters entirely. Dev also omits any additional OperationOutcome issues related to the known coding.</li></ul>\n<p>For example, with a codeableConcept containing a LOINC coding (known) and a smartypower coding (unknown):</p>\n<ul><li>Prod returns: system=<a href=\"http://loinc.org,\" target=\"_blank\">http://loinc.org,</a> code=72106-8, version=2.81, display=&quot;Total score [MMSE]&quot;, plus 2 issues (UNKNOWN_CODESYSTEM + invalid-display)</li><li>Dev returns: no system/code/version/display params, only 1 issue (UNKNOWN_CODESYSTEM)</li></ul>\n<p>5 records in deltas. All are CodeSystem/$validate-code (both /r4 and /r5) with codeableConcept containing one unknown and one known coding. Both sides agree result=false.</p>\n<p>Search: <code>grep &#x27;&quot;missing-in-dev&quot;,&quot;param&quot;:&quot;system&quot;&#x27; results/deltas/deltas.ndjson | wc -l</code> → 5</p>\n<p>The 5 records involve 2 unknown systems:</p>\n<ul><li><a href=\"https://fhir.smartypower.app/CodeSystem/smartypower-cognitive-tests\" target=\"_blank\">https://fhir.smartypower.app/CodeSystem/smartypower-cognitive-tests</a> (2 records, LOINC known coding)</li><li><a href=\"http://fhir.essilorluxottica.com/fhir/CodeSystem/el-observation-code-cs\" target=\"_blank\">http://fhir.essilorluxottica.com/fhir/CodeSystem/el-observation-code-cs</a> (3 records, SNOMED known coding)</li></ul>\n<p>Tolerance ID: cc-validate-code-missing-known-coding-params<br>\nMatches: validate-code with codeableConcept, result=false on both sides, x-caused-by-unknown-system present, where prod has system/code params that dev lacks.<br>\nNormalizes by adding prod&#x27;s system/code/version/display params to dev and canonicalizing issues to prod&#x27;s set.<br>\nEliminates: 5 records.</p>\n<ul><li>84b0cee7-5f7e-4fbc-af8a-aed5ad7a91d4 (LOINC + smartypower, /r5)</li><li>6f70f14a-81e1-427e-9eed-1b2c53801296 (SNOMED + essilorluxottica, /r4)</li></ul>", "impact": 5}, {"id": "7b445b0", "title": "SNOMED $lookup: dev returns Synonym designation use type where prod returns Inactive", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 19:46", "date_iso": "2026-02-07T19:46:16-06:00", "body_md": "Records-Impacted: 4\nTolerance-ID: snomed-lookup-inactive-designation-use\nRecord-ID: eebd3d87-2015-48c3-84ac-c46d76ac23e1\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/CodeSystem/$lookup?system=http://snomed.info/sct&code=303071001' \\\n  -H 'Accept: application/fhir+json'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/CodeSystem/$lookup?system=http://snomed.info/sct&code=303071001' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns designation \"People in the family\" with `use.code: \"73425007\"` (display: \"Inactive\"), dev returns the same designation with `use.code: \"900000000000013009\"` (display: \"Synonym (core metadata concept)\"). Also reproducible with code 116101001 where prod marks 7 of 9 designations as Inactive while dev marks none.\n\n## What differs\n\nFor SNOMED CT CodeSystem/$lookup responses containing inactive descriptions, prod marks those designations with `use.code: \"73425007\"` (display: \"Inactive\") while dev marks the same designations with `use.code: \"900000000000013009\"` (display: \"Synonym (core metadata concept)\").\n\nIn SNOMED CT, concept 73425007 identifies a description that is inactive (no longer preferred). Using Synonym (900000000000013009) instead loses the information that the description is inactive.\n\nExample for code 303071001 (Family member):\n- Prod: designation \"People in the family\" has `use.code: \"73425007\"` (Inactive)\n- Dev: same designation has `use.code: \"900000000000013009\"` (Synonym)\n\nFor code 116101001, prod marks 7 of 9 designations with Inactive use type; dev marks none as Inactive, using Synonym or FSN instead.\n\n## How widespread\n\n4 records in the delta set match this pattern. All are SNOMED $lookup operations on R4:\n- 1 record for code 303071001 (Family member)\n- 3 records for code 116101001 (Gonadotropin releasing hormone) — same code, different comparison record IDs\n\nSearch: `python3` script checking for `73425007` in prodBody across all SNOMED lookup deltas found exactly 4 matches. Broader search across all 2187 SNOMED lookups in comparison.ndjson also found only 4 records.\n\n## What the tolerance covers\n\nTolerance `snomed-lookup-inactive-designation-use` normalizes the designation use type difference by:\n- Matching SNOMED $lookup records where prod has designation use code 73425007 and dev has 900000000000013009 for the same designation value\n- Normalizing dev designations to match prod's use type when the designation text matches\n\nEliminates 4 records.\n\n## Representative records\n\n- eebd3d87-2015-48c3-84ac-c46d76ac23e1 — GET /r4/CodeSystem/$lookup?system=http://snomed.info/sct&code=303071001\n- fcb6b89e-a38f-444f-8bcb-41eefd5509b0 — GET /r4/CodeSystem/$lookup?system=http://snomed.info/sct&code=116101001", "body_html": "<p>Records-Impacted: 4<br>\nTolerance-ID: snomed-lookup-inactive-designation-use<br>\nRecord-ID: eebd3d87-2015-48c3-84ac-c46d76ac23e1</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/CodeSystem/$lookup?system=http://snomed.info/sct&amp;code=303071001&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/CodeSystem/$lookup?system=http://snomed.info/sct&amp;code=303071001&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns designation &quot;People in the family&quot; with <code>use.code: &quot;73425007&quot;</code> (display: &quot;Inactive&quot;), dev returns the same designation with <code>use.code: &quot;900000000000013009&quot;</code> (display: &quot;Synonym (core metadata concept)&quot;). Also reproducible with code 116101001 where prod marks 7 of 9 designations as Inactive while dev marks none.</p>\n<h2>What differs</h2>\n<p>For SNOMED CT CodeSystem/$lookup responses containing inactive descriptions, prod marks those designations with <code>use.code: &quot;73425007&quot;</code> (display: &quot;Inactive&quot;) while dev marks the same designations with <code>use.code: &quot;900000000000013009&quot;</code> (display: &quot;Synonym (core metadata concept)&quot;).</p>\n<p>In SNOMED CT, concept 73425007 identifies a description that is inactive (no longer preferred). Using Synonym (900000000000013009) instead loses the information that the description is inactive.</p>\n<p>Example for code 303071001 (Family member):</p>\n<ul><li>Prod: designation &quot;People in the family&quot; has <code>use.code: &quot;73425007&quot;</code> (Inactive)</li><li>Dev: same designation has <code>use.code: &quot;900000000000013009&quot;</code> (Synonym)</li></ul>\n<p>For code 116101001, prod marks 7 of 9 designations with Inactive use type; dev marks none as Inactive, using Synonym or FSN instead.</p>\n<h2>How widespread</h2>\n<p>4 records in the delta set match this pattern. All are SNOMED $lookup operations on R4:</p>\n<ul><li>1 record for code 303071001 (Family member)</li><li>3 records for code 116101001 (Gonadotropin releasing hormone) — same code, different comparison record IDs</li></ul>\n<p>Search: <code>python3</code> script checking for <code>73425007</code> in prodBody across all SNOMED lookup deltas found exactly 4 matches. Broader search across all 2187 SNOMED lookups in comparison.ndjson also found only 4 records.</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>snomed-lookup-inactive-designation-use</code> normalizes the designation use type difference by:</p>\n<ul><li>Matching SNOMED $lookup records where prod has designation use code 73425007 and dev has 900000000000013009 for the same designation value</li><li>Normalizing dev designations to match prod&#x27;s use type when the designation text matches</li></ul>\n<p>Eliminates 4 records.</p>\n<h2>Representative records</h2>\n<ul><li>eebd3d87-2015-48c3-84ac-c46d76ac23e1 — GET /r4/CodeSystem/$lookup?system=<a href=\"http://snomed.info/sct&amp;code=303071001\" target=\"_blank\">http://snomed.info/sct&amp;code=303071001</a></li><li>fcb6b89e-a38f-444f-8bcb-41eefd5509b0 — GET /r4/CodeSystem/$lookup?system=<a href=\"http://snomed.info/sct&amp;code=116101001\" target=\"_blank\">http://snomed.info/sct&amp;code=116101001</a></li></ul>", "impact": 4}, {"id": "15f5ce0", "title": "GET /r5/CodeSystem/$subsumes returns 400 despite valid system parameter", "status": "open", "labels": ["reproduced", "status-mismatch", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:15", "date_iso": "2026-02-07T20:15:10-06:00", "body_md": "Records-Impacted: 2\nTolerance-ID: r5-get-subsumes-status-mismatch\nRecord-ID: 065c2fa7-d80e-416a-b50d-ed4f78a48fd7\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r5/CodeSystem/$subsumes?system=http://snomed.info/sct&codeA=40127002&codeB=159033005' \\\n  -H 'Accept: application/fhir+json'\n\ncurl -s 'https://tx-dev.fhir.org/r5/CodeSystem/$subsumes?system=http://snomed.info/sct&codeA=40127002&codeB=159033005' \\\n  -H 'Accept: application/fhir+json'\n```\n\nProd returns HTTP 400 with OperationOutcome: \"No CodeSystem Identified (need a system parameter, or execute the operation on a CodeSystem resource)\". Dev returns HTTP 200 with Parameters containing `{\"name\":\"outcome\",\"valueCode\":\"subsumed-by\"}`.\n\n\nGET requests to `/r5/CodeSystem/$subsumes` with `system`, `codeA`, and `codeB` query parameters return HTTP 400 from prod with an OperationOutcome error: \"No CodeSystem Identified (need a system parameter, or execute the operation on a CodeSystem resource)\". Dev returns HTTP 200 with a valid Parameters response containing the subsumption outcome.\n\nThe `system` parameter is clearly present in the URL (e.g., `system=http://snomed.info/sct`), so prod appears to fail to recognize it. POST requests to the same R5 $subsumes endpoint succeed on both prod and dev.\n\n\n2 records in the current comparison dataset, both GET requests to `/r5/CodeSystem/$subsumes` with SNOMED system:\n\n- `065c2fa7-d80e-416a-b50d-ed4f78a48fd7`: codeA=40127002, codeB=159033005 (dev: subsumed-by)\n- `d48aa838-d4f2-492a-aedb-5562103b1ae3`: codeA=159033005, codeB=309414002\n\nFound via: `grep '/r5/CodeSystem/\\$subsumes' comparison.ndjson` — 3 total records, of which 2 are GET (both failing) and 1 is POST (succeeding).\n\nNo R4 $subsumes records exist in the dataset for comparison.\n\n\nTolerance ID `r5-get-subsumes-status-mismatch` skips GET requests to `/r5/CodeSystem/$subsumes` where prod=400 and dev=200. Eliminates 2 records.", "body_html": "<p>Records-Impacted: 2<br>\nTolerance-ID: r5-get-subsumes-status-mismatch<br>\nRecord-ID: 065c2fa7-d80e-416a-b50d-ed4f78a48fd7</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r5/CodeSystem/$subsumes?system=http://snomed.info/sct&amp;codeA=40127002&amp;codeB=159033005&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r5/CodeSystem/$subsumes?system=http://snomed.info/sct&amp;codeA=40127002&amp;codeB=159033005&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27;</code></pre>\n<p>Prod returns HTTP 400 with OperationOutcome: &quot;No CodeSystem Identified (need a system parameter, or execute the operation on a CodeSystem resource)&quot;. Dev returns HTTP 200 with Parameters containing <code>{&quot;name&quot;:&quot;outcome&quot;,&quot;valueCode&quot;:&quot;subsumed-by&quot;}</code>.</p>\n<p>GET requests to <code>/r5/CodeSystem/$subsumes</code> with <code>system</code>, <code>codeA</code>, and <code>codeB</code> query parameters return HTTP 400 from prod with an OperationOutcome error: &quot;No CodeSystem Identified (need a system parameter, or execute the operation on a CodeSystem resource)&quot;. Dev returns HTTP 200 with a valid Parameters response containing the subsumption outcome.</p>\n<p>The <code>system</code> parameter is clearly present in the URL (e.g., <code>system=http://snomed.info/sct</code>), so prod appears to fail to recognize it. POST requests to the same R5 $subsumes endpoint succeed on both prod and dev.</p>\n<p>2 records in the current comparison dataset, both GET requests to <code>/r5/CodeSystem/$subsumes</code> with SNOMED system:</p>\n<ul><li><code>065c2fa7-d80e-416a-b50d-ed4f78a48fd7</code>: codeA=40127002, codeB=159033005 (dev: subsumed-by)</li><li><code>d48aa838-d4f2-492a-aedb-5562103b1ae3</code>: codeA=159033005, codeB=309414002</li></ul>\n<p>Found via: <code>grep &#x27;/r5/CodeSystem/\\$subsumes&#x27; comparison.ndjson</code> — 3 total records, of which 2 are GET (both failing) and 1 is POST (succeeding).</p>\n<p>No R4 $subsumes records exist in the dataset for comparison.</p>\n<p>Tolerance ID <code>r5-get-subsumes-status-mismatch</code> skips GET requests to <code>/r5/CodeSystem/$subsumes</code> where prod=400 and dev=200. Eliminates 2 records.</p>", "impact": 2}, {"id": "44136eb", "title": "Dev returns expansion codes when prod marks expansion as too-costly (both HTTP 200)", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 19:58", "date_iso": "2026-02-07T19:58:02-06:00", "body_md": "Records-Impacted: 1\nTolerance-ID: expand-toocostly-dev-returns-codes\nRecord-ID: 227d1960-bfbd-4ca4-9c10-c5614d0e62d5\n\n## Repro\n\n```bash\n# Save the request body from the record (1.2MB, includes inline CodeSystem resources)\n# Extract from: jobs/2026-02-round-2/issues/227d1960-bfbd-4ca4-9c10-c5614d0e62d5/record.json\n# python3 -c \"import json; r=json.load(open('record.json')); open('/tmp/body.json','w').write(r['requestBody'])\"\n\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d @/tmp/body.json | python3 -c \"import sys,json; d=json.load(sys.stdin); e=d.get('expansion',{}); print('total:', e.get('total'), 'contains:', len(e.get('contains',[])), 'toocostly:', any(x.get('url','').endswith('valueset-toocostly') for x in e.get('extension',[])))\"\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d @/tmp/body.json | python3 -c \"import sys,json; d=json.load(sys.stdin); e=d.get('expansion',{}); print('total:', e.get('total'), 'contains:', len(e.get('contains',[])), 'toocostly:', any(x.get('url','').endswith('valueset-toocostly') for x in e.get('extension',[])))\"\n```\n\nProd returns `total: 0, contains: 0, toocostly: True`. Dev returns `total: None, contains: 1000, toocostly: False`.\n\n## What differs\n\nFor $expand of ValueSets that include large code systems, prod returns HTTP 200 with an empty expansion (0 codes in `contains`) and marks it with `valueset-toocostly: true` extension and `limitedExpansion: true` parameter. Dev returns HTTP 200 with 1000 codes in `expansion.contains` — it proceeds with the expansion that prod considers too costly.\n\nAfter existing normalizations strip the toocostly extension difference (tolerance `expand-toocostly-extension-and-used-codesystem`), the remaining difference is: prod has no `expansion.contains` array while dev has 1000 codes.\n\nThe observed record involves a Brazilian ValueSet (`cid10-ciap2`, URL `https://fhir.saude.go.gov.br/r4/core/ValueSet/cid10-ciap2`) that includes codes from `BRCID10` and `BRCIAP2` code systems.\n\n## How widespread\n\n1 record in the current delta file shows this exact pattern (both 200, prod empty+toocostly, dev has codes). Related but distinct from bug 44d1916 (where prod returns 422 instead of 200).\n\nSearch: checked all 56 records where prod has 0 codes and dev has >0 codes in comparison.ndjson; 55 of those have prod with no expansion metadata at all (handled by other tolerances), and only this 1 record has prod explicitly marking the expansion as too-costly with the toocostly extension.\n\n## Tolerance\n\nTolerance `expand-toocostly-dev-returns-codes` matches $expand records where both return 200, prod has the `valueset-toocostly` extension, and dev has codes in `expansion.contains` while prod does not. Skips these records since the responses are fundamentally different in content (empty vs populated expansion) and this is a known behavioral difference in expansion size enforcement.", "body_html": "<p>Records-Impacted: 1<br>\nTolerance-ID: expand-toocostly-dev-returns-codes<br>\nRecord-ID: 227d1960-bfbd-4ca4-9c10-c5614d0e62d5</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Save the request body from the record (1.2MB, includes inline CodeSystem resources)\n# Extract from: jobs/2026-02-round-2/issues/227d1960-bfbd-4ca4-9c10-c5614d0e62d5/record.json\n# python3 -c &quot;import json; r=json.load(open(&#x27;record.json&#x27;)); open(&#x27;/tmp/body.json&#x27;,&#x27;w&#x27;).write(r[&#x27;requestBody&#x27;])&quot;\n\n# Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d @/tmp/body.json | python3 -c &quot;import sys,json; d=json.load(sys.stdin); e=d.get(&#x27;expansion&#x27;,{}); print(&#x27;total:&#x27;, e.get(&#x27;total&#x27;), &#x27;contains:&#x27;, len(e.get(&#x27;contains&#x27;,[])), &#x27;toocostly:&#x27;, any(x.get(&#x27;url&#x27;,&#x27;&#x27;).endswith(&#x27;valueset-toocostly&#x27;) for x in e.get(&#x27;extension&#x27;,[])))&quot;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d @/tmp/body.json | python3 -c &quot;import sys,json; d=json.load(sys.stdin); e=d.get(&#x27;expansion&#x27;,{}); print(&#x27;total:&#x27;, e.get(&#x27;total&#x27;), &#x27;contains:&#x27;, len(e.get(&#x27;contains&#x27;,[])), &#x27;toocostly:&#x27;, any(x.get(&#x27;url&#x27;,&#x27;&#x27;).endswith(&#x27;valueset-toocostly&#x27;) for x in e.get(&#x27;extension&#x27;,[])))&quot;</code></pre>\n<p>Prod returns <code>total: 0, contains: 0, toocostly: True</code>. Dev returns <code>total: None, contains: 1000, toocostly: False</code>.</p>\n<h2>What differs</h2>\n<p>For $expand of ValueSets that include large code systems, prod returns HTTP 200 with an empty expansion (0 codes in <code>contains</code>) and marks it with <code>valueset-toocostly: true</code> extension and <code>limitedExpansion: true</code> parameter. Dev returns HTTP 200 with 1000 codes in <code>expansion.contains</code> — it proceeds with the expansion that prod considers too costly.</p>\n<p>After existing normalizations strip the toocostly extension difference (tolerance <code>expand-toocostly-extension-and-used-codesystem</code>), the remaining difference is: prod has no <code>expansion.contains</code> array while dev has 1000 codes.</p>\n<p>The observed record involves a Brazilian ValueSet (<code>cid10-ciap2</code>, URL <code>https://fhir.saude.go.gov.br/r4/core/ValueSet/cid10-ciap2</code>) that includes codes from <code>BRCID10</code> and <code>BRCIAP2</code> code systems.</p>\n<h2>How widespread</h2>\n<p>1 record in the current delta file shows this exact pattern (both 200, prod empty+toocostly, dev has codes). Related but distinct from bug 44d1916 (where prod returns 422 instead of 200).</p>\n<p>Search: checked all 56 records where prod has 0 codes and dev has &gt;0 codes in comparison.ndjson; 55 of those have prod with no expansion metadata at all (handled by other tolerances), and only this 1 record has prod explicitly marking the expansion as too-costly with the toocostly extension.</p>\n<h2>Tolerance</h2>\n<p>Tolerance <code>expand-toocostly-dev-returns-codes</code> matches $expand records where both return 200, prod has the <code>valueset-toocostly</code> extension, and dev has codes in <code>expansion.contains</code> while prod does not. Skips these records since the responses are fundamentally different in content (empty vs populated expansion) and this is a known behavioral difference in expansion size enforcement.</p>", "impact": 1}, {"id": "f9f6206", "title": "validate-code: dev renders JavaScript undefined/null as literal strings when code/version absent", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:21", "date_iso": "2026-02-07T20:21:48-06:00", "body_md": "Records-Impacted: 1\nTolerance-ID: validate-code-undefined-null-in-unknown-code-message\nRecord-ID: 7f0c6cf8-a250-4935-8ab6-32f499d65302\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r5/CodeSystem/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"urn:ietf:bcp:47\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r5/CodeSystem/$validate-code' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"coding\",\"valueCoding\":{\"system\":\"urn:ietf:bcp:47\"}},{\"name\":\"displayLanguage\",\"valueString\":\"en\"},{\"name\":\"default-to-latest-version\",\"valueBoolean\":true}]}'\n```\n\nProd returns message `\"Unknown code '' in the CodeSystem 'urn:ietf:bcp:47' version ''\"` (empty strings for missing code/version), dev returns `\"Unknown code 'undefined' in the CodeSystem 'urn:ietf:bcp:47' version 'null'\"` (JavaScript undefined/null as literal strings). Dev also includes an extra informational issue `\"Empty code\"` that prod does not return.\n\n\nIn a POST /r5/CodeSystem/$validate-code request for system `urn:ietf:bcp:47` with a coding that has no `code` or `version`, the message and issues text differ:\n\n- Prod: `\"Unknown code '' in the CodeSystem 'urn:ietf:bcp:47' version ''\"`\n- Dev: `\"Unknown code 'undefined' in the CodeSystem 'urn:ietf:bcp:47' version 'null'\"`\n\nDev renders JavaScript's `undefined` and `null` as literal strings instead of empty strings when code and version are absent from the request.\n\nAdditionally, dev includes an extra informational OperationOutcome issue (`\"Empty code\"`, severity=information) that prod does not return.\n\nBoth servers agree on result=false and system=urn:ietf:bcp:47.\n\n\n1 record in the current delta file. Searched for broader patterns:\n- `grep \"'undefined'\" deltas.ndjson` → 37 hits total, but only 2 have 'undefined' in non-diagnostics params (this record and 06cfc4c9 which has \"and undefined\" in a version list — a different pattern)\n- `grep \"version 'null'\" deltas.ndjson` → 1 hit (this record only)\n- `grep \"Empty code\" deltas.ndjson` → 1 hit (this record only)\n\n\nTolerance ID: validate-code-undefined-null-in-unknown-code-message\nMatches: validate-code Parameters responses where dev message contains `'undefined'` or `version 'null'` and prod has the same message but with empty strings. Normalizes the message and issues text to prod's rendering, and removes the extra \"Empty code\" informational issue from dev. Eliminates 1 delta record.\n\n\n`grep -n '7f0c6cf8-a250-4935-8ab6-32f499d65302' comparison.ndjson`", "body_html": "<p>Records-Impacted: 1<br>\nTolerance-ID: validate-code-undefined-null-in-unknown-code-message<br>\nRecord-ID: 7f0c6cf8-a250-4935-8ab6-32f499d65302</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r5/CodeSystem/$validate-code&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;coding&quot;,&quot;valueCoding&quot;:{&quot;system&quot;:&quot;urn:ietf:bcp:47&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true}]}&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r5/CodeSystem/$validate-code&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;coding&quot;,&quot;valueCoding&quot;:{&quot;system&quot;:&quot;urn:ietf:bcp:47&quot;}},{&quot;name&quot;:&quot;displayLanguage&quot;,&quot;valueString&quot;:&quot;en&quot;},{&quot;name&quot;:&quot;default-to-latest-version&quot;,&quot;valueBoolean&quot;:true}]}&#x27;</code></pre>\n<p>Prod returns message <code>&quot;Unknown code &#x27;&#x27; in the CodeSystem &#x27;urn:ietf:bcp:47&#x27; version &#x27;&#x27;&quot;</code> (empty strings for missing code/version), dev returns <code>&quot;Unknown code &#x27;undefined&#x27; in the CodeSystem &#x27;urn:ietf:bcp:47&#x27; version &#x27;null&#x27;&quot;</code> (JavaScript undefined/null as literal strings). Dev also includes an extra informational issue <code>&quot;Empty code&quot;</code> that prod does not return.</p>\n<p>In a POST /r5/CodeSystem/$validate-code request for system <code>urn:ietf:bcp:47</code> with a coding that has no <code>code</code> or <code>version</code>, the message and issues text differ:</p>\n<ul><li>Prod: <code>&quot;Unknown code &#x27;&#x27; in the CodeSystem &#x27;urn:ietf:bcp:47&#x27; version &#x27;&#x27;&quot;</code></li><li>Dev: <code>&quot;Unknown code &#x27;undefined&#x27; in the CodeSystem &#x27;urn:ietf:bcp:47&#x27; version &#x27;null&#x27;&quot;</code></li></ul>\n<p>Dev renders JavaScript&#x27;s <code>undefined</code> and <code>null</code> as literal strings instead of empty strings when code and version are absent from the request.</p>\n<p>Additionally, dev includes an extra informational OperationOutcome issue (<code>&quot;Empty code&quot;</code>, severity=information) that prod does not return.</p>\n<p>Both servers agree on result=false and system=urn:ietf:bcp:47.</p>\n<p>1 record in the current delta file. Searched for broader patterns:</p>\n<ul><li><code>grep &quot;&#x27;undefined&#x27;&quot; deltas.ndjson</code> → 37 hits total, but only 2 have &#x27;undefined&#x27; in non-diagnostics params (this record and 06cfc4c9 which has &quot;and undefined&quot; in a version list — a different pattern)</li><li><code>grep &quot;version &#x27;null&#x27;&quot; deltas.ndjson</code> → 1 hit (this record only)</li><li><code>grep &quot;Empty code&quot; deltas.ndjson</code> → 1 hit (this record only)</li></ul>\n<p>Tolerance ID: validate-code-undefined-null-in-unknown-code-message<br>\nMatches: validate-code Parameters responses where dev message contains <code>&#x27;undefined&#x27;</code> or <code>version &#x27;null&#x27;</code> and prod has the same message but with empty strings. Normalizes the message and issues text to prod&#x27;s rendering, and removes the extra &quot;Empty code&quot; informational issue from dev. Eliminates 1 delta record.</p>\n<p><code>grep -n &#x27;7f0c6cf8-a250-4935-8ab6-32f499d65302&#x27; comparison.ndjson</code></p>", "impact": 1}, {"id": "5f3b796", "title": "LOINC $lookup: dev returns extra designations, RELATEDNAMES2 properties, and different CLASSTYPE format", "status": "open", "labels": ["content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:37", "date_iso": "2026-02-07T20:37:05-06:00", "body_md": "Records-Impacted: 1\nTolerance-ID: loinc-lookup-extra-designations-properties\nRecord-ID: e5ceaa8d-ae90-42ed-a02d-1dc612d44d30\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/CodeSystem/$lookup' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"system\",\"valueUri\":\"http://loinc.org\"},{\"name\":\"code\",\"valueCode\":\"4548-4\"}]}'\n\ncurl -s 'https://tx-dev.fhir.org/r4/CodeSystem/$lookup' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"system\",\"valueUri\":\"http://loinc.org\"},{\"name\":\"code\",\"valueCode\":\"4548-4\"}]}'\n```\n\nProd returns CLASSTYPE with `value: \"Laboratory class\"` and 0 RELATEDNAMES2 properties. Dev returns CLASSTYPE with `value: \"1\"` plus `description: \"Laboratory class\"`, an extra `preferredForLanguage` designation, and 14 RELATEDNAMES2 properties with language-specific related names.\n\n\nOn POST /r4/CodeSystem/$lookup for LOINC code 4548-4, dev returns three categories of differences compared to prod:\n\n1. **Extra `preferredForLanguage` designation**: Dev includes a designation with `use.system: \"http://terminology.hl7.org/CodeSystem/hl7TermMaintInfra\"` and `use.code: \"preferredForLanguage\"` that prod omits entirely. (Prod instead has a duplicate LONG_COMMON_NAME designation with identical content.)\n\n2. **Different CLASSTYPE property format**: Prod returns `CLASSTYPE` with `value: \"Laboratory class\"` (a single valueString). Dev returns `CLASSTYPE` with `value: \"1\"` (the numeric code) plus a separate `description: \"Laboratory class\"` part. These represent different data modeling choices for the same property.\n\n3. **Extra RELATEDNAMES2 properties**: Dev returns 14 `RELATEDNAMES2` property parameters with language-specific related names (en-US, ar-JO, de-AT, de-DE, el-GR, es-ES, et-EE, fr-BE, it-IT, pl-PL, pt-BR, ru-RU, uk-UA, zh-CN). Prod returns none of these RELATEDNAMES2 properties.\n\n\nOnly 1 LOINC $lookup record exists in this comparison dataset. All LOINC $lookup requests would likely be affected since these differences stem from how LOINC properties and designations are served.\n\ngrep 'lookup' deltas.ndjson | grep 'loinc' → 1 record\n\n\nTolerance `loinc-lookup-extra-designations-properties` normalizes all three differences:\n- Strips the `preferredForLanguage` designation from dev\n- Strips duplicate LONG_COMMON_NAME designations from prod\n- Normalizes CLASSTYPE to use prod's format (value only, no description)\n- Strips all RELATEDNAMES2 properties from dev\n\nThis eliminates 1 record from deltas.", "body_html": "<p>Records-Impacted: 1<br>\nTolerance-ID: loinc-lookup-extra-designations-properties<br>\nRecord-ID: e5ceaa8d-ae90-42ed-a02d-1dc612d44d30</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r4/CodeSystem/$lookup&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;system&quot;,&quot;valueUri&quot;:&quot;http://loinc.org&quot;},{&quot;name&quot;:&quot;code&quot;,&quot;valueCode&quot;:&quot;4548-4&quot;}]}&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r4/CodeSystem/$lookup&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;system&quot;,&quot;valueUri&quot;:&quot;http://loinc.org&quot;},{&quot;name&quot;:&quot;code&quot;,&quot;valueCode&quot;:&quot;4548-4&quot;}]}&#x27;</code></pre>\n<p>Prod returns CLASSTYPE with <code>value: &quot;Laboratory class&quot;</code> and 0 RELATEDNAMES2 properties. Dev returns CLASSTYPE with <code>value: &quot;1&quot;</code> plus <code>description: &quot;Laboratory class&quot;</code>, an extra <code>preferredForLanguage</code> designation, and 14 RELATEDNAMES2 properties with language-specific related names.</p>\n<p>On POST /r4/CodeSystem/$lookup for LOINC code 4548-4, dev returns three categories of differences compared to prod:</p>\n<ol><li>**Extra <code>preferredForLanguage</code> designation**: Dev includes a designation with <code>use.system: &quot;http://terminology.hl7.org/CodeSystem/hl7TermMaintInfra&quot;</code> and <code>use.code: &quot;preferredForLanguage&quot;</code> that prod omits entirely. (Prod instead has a duplicate LONG_COMMON_NAME designation with identical content.)</li></ol>\n<ol><li><strong>Different CLASSTYPE property format</strong>: Prod returns <code>CLASSTYPE</code> with <code>value: &quot;Laboratory class&quot;</code> (a single valueString). Dev returns <code>CLASSTYPE</code> with <code>value: &quot;1&quot;</code> (the numeric code) plus a separate <code>description: &quot;Laboratory class&quot;</code> part. These represent different data modeling choices for the same property.</li></ol>\n<ol><li><strong>Extra RELATEDNAMES2 properties</strong>: Dev returns 14 <code>RELATEDNAMES2</code> property parameters with language-specific related names (en-US, ar-JO, de-AT, de-DE, el-GR, es-ES, et-EE, fr-BE, it-IT, pl-PL, pt-BR, ru-RU, uk-UA, zh-CN). Prod returns none of these RELATEDNAMES2 properties.</li></ol>\n<p>Only 1 LOINC $lookup record exists in this comparison dataset. All LOINC $lookup requests would likely be affected since these differences stem from how LOINC properties and designations are served.</p>\n<p>grep &#x27;lookup&#x27; deltas.ndjson | grep &#x27;loinc&#x27; → 1 record</p>\n<p>Tolerance <code>loinc-lookup-extra-designations-properties</code> normalizes all three differences:</p>\n<ul><li>Strips the <code>preferredForLanguage</code> designation from dev</li><li>Strips duplicate LONG_COMMON_NAME designations from prod</li><li>Normalizes CLASSTYPE to use prod&#x27;s format (value only, no description)</li><li>Strips all RELATEDNAMES2 properties from dev</li></ul>\n<p>This eliminates 1 record from deltas.</p>", "impact": 1}, {"id": "f33ebd3", "title": "validate-code: prod reports UNKNOWN_CODESYSTEM, dev reports UNKNOWN_CODESYSTEM_VERSION when system-version pins unavailable SNOMED edition", "status": "open", "labels": ["content-differs", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:38", "date_iso": "2026-02-07T20:38:40-06:00", "body_md": "Records-Impacted: 1\nTolerance-ID: unknown-system-vs-unknown-version\nRecord-ID: 06cfc4c9-c3c4-42a6-abb8-3068cd06190f\n\n## What differs\n\nWhen `$validate-code` on `CodeSystem` is called with `system-version` pinning an unavailable SNOMED CT edition (Canadian edition `http://snomed.info/sct/20611000087101`), prod and dev disagree on the error classification:\n\n- **Prod**: Treats the entire CodeSystem as unknown — message-id `UNKNOWN_CODESYSTEM`, message \"A definition for CodeSystem 'http://snomed.info/sct' could not be found\", `x-caused-by-unknown-system: http://snomed.info/sct` (no version), no `display` parameter\n- **Dev**: Recognizes SNOMED is loaded but the specific edition is not — message-id `UNKNOWN_CODESYSTEM_VERSION`, message \"A definition for CodeSystem 'http://snomed.info/sct' version 'http://snomed.info/sct/20611000087101' could not be found ... Valid versions: ...\" listing all available editions, `x-caused-by-unknown-system: http://snomed.info/sct|http://snomed.info/sct/20611000087101` (with version), and includes `display: \"Chest pain\"` parameter\n\nBoth return `result: false` but for different reasons: prod says the system is entirely unknown, dev says the specific version is unknown and helpfully lists available versions.\n\nThe request includes `system-version` parameter `http://snomed.info/sct|http://snomed.info/sct/20611000087101` (Canadian SNOMED edition), `default-to-latest-version: true`, and code `29857009` (Chest pain).\n\n## How widespread\n\nOnly 1 record in the deltas matches this exact pattern (prod=UNKNOWN_CODESYSTEM, dev=UNKNOWN_CODESYSTEM_VERSION). In the full comparison data, also only 1 record has this specific disagreement — the remaining SNOMED records with system-version for this edition are handled by existing tolerances.\n\nSearch: `grep 'UNKNOWN_CODESYSTEM' deltas.ndjson` → 2 hits, but only 1 has this prod-vs-dev message-id disagreement (the other is a missing-resource for $expand).\n\n## What the tolerance covers\n\nTolerance `unknown-system-vs-unknown-version` matches validate-code records where prod has message-id `UNKNOWN_CODESYSTEM` and dev has `UNKNOWN_CODESYSTEM_VERSION`. Normalizes dev's messages, issues, x-caused-by-unknown-system, and display to match prod's values. Eliminates 1 record.", "body_html": "<p>Records-Impacted: 1<br>\nTolerance-ID: unknown-system-vs-unknown-version<br>\nRecord-ID: 06cfc4c9-c3c4-42a6-abb8-3068cd06190f</p>\n<h2>What differs</h2>\n<p>When <code>$validate-code</code> on <code>CodeSystem</code> is called with <code>system-version</code> pinning an unavailable SNOMED CT edition (Canadian edition <code>http://snomed.info/sct/20611000087101</code>), prod and dev disagree on the error classification:</p>\n<ul><li><strong>Prod</strong>: Treats the entire CodeSystem as unknown — message-id <code>UNKNOWN_CODESYSTEM</code>, message &quot;A definition for CodeSystem &#x27;<a href=\"http://snomed.info/sct&#x27;\" target=\"_blank\">http://snomed.info/sct&#x27;</a> could not be found&quot;, <code>x-caused-by-unknown-system: http://snomed.info/sct</code> (no version), no <code>display</code> parameter</li><li><strong>Dev</strong>: Recognizes SNOMED is loaded but the specific edition is not — message-id <code>UNKNOWN_CODESYSTEM_VERSION</code>, message &quot;A definition for CodeSystem &#x27;<a href=\"http://snomed.info/sct&#x27;\" target=\"_blank\">http://snomed.info/sct&#x27;</a> version &#x27;<a href=\"http://snomed.info/sct/20611000087101&#x27;\" target=\"_blank\">http://snomed.info/sct/20611000087101&#x27;</a> could not be found ... Valid versions: ...&quot; listing all available editions, <code>x-caused-by-unknown-system: http://snomed.info/sct|http://snomed.info/sct/20611000087101</code> (with version), and includes <code>display: &quot;Chest pain&quot;</code> parameter</li></ul>\n<p>Both return <code>result: false</code> but for different reasons: prod says the system is entirely unknown, dev says the specific version is unknown and helpfully lists available versions.</p>\n<p>The request includes <code>system-version</code> parameter <code>http://snomed.info/sct|http://snomed.info/sct/20611000087101</code> (Canadian SNOMED edition), <code>default-to-latest-version: true</code>, and code <code>29857009</code> (Chest pain).</p>\n<h2>How widespread</h2>\n<p>Only 1 record in the deltas matches this exact pattern (prod=UNKNOWN_CODESYSTEM, dev=UNKNOWN_CODESYSTEM_VERSION). In the full comparison data, also only 1 record has this specific disagreement — the remaining SNOMED records with system-version for this edition are handled by existing tolerances.</p>\n<p>Search: <code>grep &#x27;UNKNOWN_CODESYSTEM&#x27; deltas.ndjson</code> → 2 hits, but only 1 has this prod-vs-dev message-id disagreement (the other is a missing-resource for $expand).</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>unknown-system-vs-unknown-version</code> matches validate-code records where prod has message-id <code>UNKNOWN_CODESYSTEM</code> and dev has <code>UNKNOWN_CODESYSTEM_VERSION</code>. Normalizes dev&#x27;s messages, issues, x-caused-by-unknown-system, and display to match prod&#x27;s values. Eliminates 1 record.</p>", "impact": 1}, {"id": "a9cf20c", "title": "Dev omits deprecated location field on OperationOutcome issues", "status": "open", "labels": ["code-defect", "content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:24", "date_iso": "2026-02-07T20:24:41-06:00", "body_md": "Records-Impacted: ~3316\nRecord-ID: 59eff7c6-9fd2-45b2-8f27-c790368bcc54, 1697b0cd-971b-475c-8075-f249215b1205, 199de988-2772-45c3-83cb-5ff1de1f01ce\nTolerance-ID: oo-missing-location-field, oo-missing-location-post-version-skew\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fcts.nlm.nih.gov%2Ffhir%2FValueSet%2F2.16.840.1.114222.4.11.1066&code=1223P0106X&_format=json&system=http:%2F%2Fnucc.org%2Fprovider-taxonomy' \\\n  -H 'Accept: application/fhir+json' | jq '.parameter[] | select(.name == \"issues\") | .resource.issue[0] | {severity, code, location, expression}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fcts.nlm.nih.gov%2Ffhir%2FValueSet%2F2.16.840.1.114222.4.11.1066&code=1223P0106X&_format=json&system=http:%2F%2Fnucc.org%2Fprovider-taxonomy' \\\n  -H 'Accept: application/fhir+json' | jq '.parameter[] | select(.name == \"issues\") | .resource.issue[0] | {severity, code, location, expression}'\n```\n\nProd returns `\"location\": [\"system\"]`, dev returns `\"location\": null` (field is omitted).\n\n## Root Cause\n\n**Classification**: code-level defect\n\n**Prod** populates both `location` and `expression` with the same path value on every OperationOutcome issue:\n[`library/fhir4/fhir4_common.pas#L1480-L1492`](https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/fhir4/fhir4_common.pas#L1480-L1492)\n— The `addIssue` method (line 1487-1488) adds the path to both `iss.locationList` and `iss.expressionList`. The same pattern appears in `addIssueNoId` at lines 1457-1458.\n\n**Dev** only sets `expression`, never sets `location`:\n[`tx/library/operation-outcome.js#L25-L46`](https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/operation-outcome.js#L25-L46)\n— The `asIssue()` method (line 33-35) sets `res.expression = [this.path]` but has no corresponding `res.location = [this.path]` line.\n\n**Fix**: In `tx/library/operation-outcome.js`, add `res.location = [this.path]` alongside the existing `res.expression = [this.path]` in the `asIssue()` method (after line 34).\n\n## Tolerances\n\n### 1. `oo-missing-location-field` (~3069 records)\n\n**What it handles**: Strips `location` from prod's OperationOutcome issues when dev lacks it and `location` equals `expression`. Handles both flat `$validate-code` responses (top-level issues parameter) and nested `$batch-validate-code` responses (issues inside `validation` parameter entries).\n\n**Representative records**:\n- `59eff7c6-9fd2-45b2-8f27-c790368bcc54` (flat validate-code, NUCC provider-taxonomy)\n- `1697b0cd-971b-475c-8075-f249215b1205` (batch-validate-code, nested validation structure)\n\n**Details**: Of the ~3069 affected records, ~2555 are fully eliminated from deltas (location was the only remaining difference). The remaining ~514 still have other differences but the location diff is normalized away. The batch-validate-code subset accounts for ~38 records where the nested response structure required additional handling.\n\n### 2. `oo-missing-location-post-version-skew` (~247 records)\n\n**What it handles**: Same root cause, but catches records where `oo-missing-location-field` misses the difference due to pipeline ordering. Specifically, when HL7 terminology version-skew tolerances (`hl7-terminology-cs-version-skew`) strip extra `status-check` informational issues from prod, the OperationOutcome issue arrays only become aligned after those normalizations run. Since `oo-missing-location-field` runs earlier in the pipeline, the misaligned arrays prevent index-based comparison from detecting the location difference. This tolerance runs later to catch those remaining records.\n\n**Representative record**: `199de988-2772-45c3-83cb-5ff1de1f01ce` (validate-code against `condition-category` CodeSystem, prod has extra status-check issue stripped by version-skew tolerance)\n\n## Total impact\n\n~3316 records across both tolerances (~34% of all deltas). All are `$validate-code` or `$batch-validate-code` operations.", "body_html": "<p>Records-Impacted: ~3316<br>\nRecord-ID: 59eff7c6-9fd2-45b2-8f27-c790368bcc54, 1697b0cd-971b-475c-8075-f249215b1205, 199de988-2772-45c3-83cb-5ff1de1f01ce<br>\nTolerance-ID: oo-missing-location-field, oo-missing-location-post-version-skew</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fcts.nlm.nih.gov%2Ffhir%2FValueSet%2F2.16.840.1.114222.4.11.1066&amp;code=1223P0106X&amp;_format=json&amp;system=http:%2F%2Fnucc.org%2Fprovider-taxonomy&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; | jq &#x27;.parameter[] | select(.name == &quot;issues&quot;) | .resource.issue[0] | {severity, code, location, expression}&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$validate-code?url=http:%2F%2Fcts.nlm.nih.gov%2Ffhir%2FValueSet%2F2.16.840.1.114222.4.11.1066&amp;code=1223P0106X&amp;_format=json&amp;system=http:%2F%2Fnucc.org%2Fprovider-taxonomy&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; | jq &#x27;.parameter[] | select(.name == &quot;issues&quot;) | .resource.issue[0] | {severity, code, location, expression}&#x27;</code></pre>\n<p>Prod returns <code>&quot;location&quot;: [&quot;system&quot;]</code>, dev returns <code>&quot;location&quot;: null</code> (field is omitted).</p>\n<h2>Root Cause</h2>\n<p><strong>Classification</strong>: code-level defect</p>\n<p><strong>Prod</strong> populates both <code>location</code> and <code>expression</code> with the same path value on every OperationOutcome issue:<br>\n<a href=\"https://github.com/HealthIntersections/fhirserver/blob/ec46dff3fe631ddeeaa000a3ca9530e0dd8c9eac/library/fhir4/fhir4_common.pas#L1480-L1492\" target=\"_blank\"><code>library/fhir4/fhir4_common.pas#L1480-L1492</code></a><br>\n— The <code>addIssue</code> method (line 1487-1488) adds the path to both <code>iss.locationList</code> and <code>iss.expressionList</code>. The same pattern appears in <code>addIssueNoId</code> at lines 1457-1458.</p>\n<p><strong>Dev</strong> only sets <code>expression</code>, never sets <code>location</code>:<br>\n<a href=\"https://github.com/HealthIntersections/FHIRsmith/blob/6440990b4d0f5ca87b48093bad6ac2868067a49e/tx/library/operation-outcome.js#L25-L46\" target=\"_blank\"><code>tx/library/operation-outcome.js#L25-L46</code></a><br>\n— The <code>asIssue()</code> method (line 33-35) sets <code>res.expression = [this.path]</code> but has no corresponding <code>res.location = [this.path]</code> line.</p>\n<p><strong>Fix</strong>: In <code>tx/library/operation-outcome.js</code>, add <code>res.location = [this.path]</code> alongside the existing <code>res.expression = [this.path]</code> in the <code>asIssue()</code> method (after line 34).</p>\n<h2>Tolerances</h2>\n<h3>1. <code>oo-missing-location-field</code> (~3069 records)</h3>\n<p><strong>What it handles</strong>: Strips <code>location</code> from prod&#x27;s OperationOutcome issues when dev lacks it and <code>location</code> equals <code>expression</code>. Handles both flat <code>$validate-code</code> responses (top-level issues parameter) and nested <code>$batch-validate-code</code> responses (issues inside <code>validation</code> parameter entries).</p>\n<p><strong>Representative records</strong>:</p>\n<ul><li><code>59eff7c6-9fd2-45b2-8f27-c790368bcc54</code> (flat validate-code, NUCC provider-taxonomy)</li><li><code>1697b0cd-971b-475c-8075-f249215b1205</code> (batch-validate-code, nested validation structure)</li></ul>\n<p><strong>Details</strong>: Of the ~3069 affected records, ~2555 are fully eliminated from deltas (location was the only remaining difference). The remaining ~514 still have other differences but the location diff is normalized away. The batch-validate-code subset accounts for ~38 records where the nested response structure required additional handling.</p>\n<h3>2. <code>oo-missing-location-post-version-skew</code> (~247 records)</h3>\n<p><strong>What it handles</strong>: Same root cause, but catches records where <code>oo-missing-location-field</code> misses the difference due to pipeline ordering. Specifically, when HL7 terminology version-skew tolerances (<code>hl7-terminology-cs-version-skew</code>) strip extra <code>status-check</code> informational issues from prod, the OperationOutcome issue arrays only become aligned after those normalizations run. Since <code>oo-missing-location-field</code> runs earlier in the pipeline, the misaligned arrays prevent index-based comparison from detecting the location difference. This tolerance runs later to catch those remaining records.</p>\n<p><strong>Representative record</strong>: <code>199de988-2772-45c3-83cb-5ff1de1f01ce</code> (validate-code against <code>condition-category</code> CodeSystem, prod has extra status-check issue stripped by version-skew tolerance)</p>\n<h2>Total impact</h2>\n<p>~3316 records across both tolerances (~34% of all deltas). All are <code>$validate-code</code> or <code>$batch-validate-code</code> operations.</p>", "impact": null}, {"id": "6edc96c", "title": "Dev loads different versions of HL7 terminology CodeSystems (terminology.hl7.org) than prod", "status": "open", "labels": ["config-issue", "content-differs", "reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 20:28", "date_iso": "2026-02-07T20:28:29-06:00", "body_md": "Records-Impacted: ~465\nRecord-ID: 04364a8a-acce-491a-8018-9ac010d47d21, ef77e7ca-9afa-4325-a1f3-a939a62a490f, 7813f9ee-79ee-445b-8064-603a98e876bf, 83509e51-1a8b-4d77-8f4e-7b0037009c4a, 2d18564d-4e72-425d-aca0-358240df2c57, 118efc0f-ad5c-4db9-b9e6-2120a5824b92\nTolerance-ID: hl7-terminology-cs-version-skew, expand-hl7-terminology-version-skew-params, expand-hl7-terminology-version-skew-content, validate-code-hl7-terminology-vs-version-skew, expand-hl7-terminology-version-skew-vs-metadata, hl7-terminology-lookup-definition-designation-skew\n\n## Summary\n\nDev loads older/different versions of HL7 terminology CodeSystems and ValueSets (`http://terminology.hl7.org/CodeSystem/*`, `http://terminology.hl7.org/ValueSet/*`) than prod. For example, prod loads `consentcategorycodes` at version `4.0.1` while dev loads `1.0.1`; prod loads `observation-category` at `4.0.1` while dev loads `2.0.0`. Dev also loads different ValueSet versions (e.g., `v3-TribalEntityUS|4.0.0` vs dev's `|2018-08-12`, `v3-ActEncounterCode|3.0.0` vs dev's `|2014-03-26`). This version skew is the single root cause behind six distinct manifestations affecting `$validate-code`, `$expand`, and `$lookup` operations.\n\nKnown affected CodeSystems and their version mismatches:\n- `consentcategorycodes`: prod=4.0.1, dev=1.0.1\n- `goal-achievement`: prod=4.0.1, dev=1.0.1\n- `observation-category`: prod=4.0.1, dev=2.0.0\n- `consentpolicycodes`: prod=4.0.1, dev=3.0.1\n- `condition-category`: prod=4.0.1, dev=2.0.0\n- `condition-clinical`: prod=4.0.1, dev=3.0.0\n- `v2-0116`: prod=2.9, dev=3.0.0\n\nKnown affected ValueSets:\n- `v3-ActEncounterCode`: prod=3.0.0, dev=2014-03-26\n- `v3-TribalEntityUS`: prod=4.0.0, dev=2018-08-12\n\n## Tolerances\n\n### 1. `hl7-terminology-cs-version-skew` (~58 records)\n\n**What it handles**: `$validate-code` responses where the only differences are CodeSystem version strings in the `version` parameter, `message` text, and `issues` OperationOutcome `details.text`. Also strips draft `status-check` informational issues that prod includes but dev omits (because dev loads a version that lacks the draft status metadata). Both servers agree on validation results for all affected codes.\n\n**Normalizes**: Dev's version parameter and version strings in message/issues text to prod's values; strips prod's draft status-check issues.\n\n**Representative record**: `04364a8a-acce-491a-8018-9ac010d47d21` — validate-code for `consentcategorycodes` where prod says \"version '4.0.1'\", dev says \"version '1.0.1'\".\n\n### 2. `expand-hl7-terminology-version-skew-params` (~236 records)\n\n**What it handles**: `$expand` responses where the `expansion.parameter` entries differ due to version skew. The `used-codesystem` version strings differ (e.g., `observation-category|4.0.1` vs `|2.0.0`) and prod includes `warning-draft` parameters that dev omits.\n\n**Normalizes**: `used-codesystem` versions for `terminology.hl7.org` systems to prod's values; strips `warning-draft` parameters from both sides.\n\n**Representative record**: `ef77e7ca-9afa-4325-a1f3-a939a62a490f` — expand of `us-core-simple-observation-category` where used-codesystem version and warning-draft differ.\n\n### 3. `expand-hl7-terminology-version-skew-content` (~163 records)\n\n**What it handles**: `$expand` responses where prod and dev return slightly different sets of codes (1-5 extra/missing) because different CodeSystem versions include different codes. For example, dev's older `consentpolicycodes` includes `ch-epr` (removed in 4.0.1), and dev's older `observation-category` includes an extra `symptom` code. The common codes between prod and dev are identical.\n\n**Normalizes**: Both sides to the intersection of codes present in both responses; adjusts the total count accordingly.\n\n**Representative record**: `7813f9ee-79ee-445b-8064-603a98e876bf` — expand of `consent-policy` where dev returns 27 codes vs prod's 26 (extra `ch-epr`).\n\n### 4. `validate-code-hl7-terminology-vs-version-skew` (4 records)\n\n**What it handles**: `$validate-code` responses where the only difference is the ValueSet version string in message text and issues details text. Both servers agree on `result=false` and all other parameters. The difference appears in \"not found in the value set 'url|version'\" messages where prod references the newer ValueSet version (e.g., `v3-ActEncounterCode|3.0.0`) and dev references the older version (e.g., `|2014-03-26`).\n\n**Normalizes**: ValueSet pipe-delimited version strings in message and issues text to prod's values.\n\n**Representative record**: `83509e51-1a8b-4d77-8f4e-7b0037009c4a` — validate-code for PLB in v3-ActEncounterCode where prod says `|3.0.0`, dev says `|2014-03-26`.\n\n### 5. `expand-hl7-terminology-version-skew-vs-metadata` (3 records)\n\n**What it handles**: `$expand` responses where the ValueSet-level metadata fields (date, name, title, version, identifier, language, immutable, meta) differ because prod and dev loaded different editions of the same HL7 terminology ValueSet. The expansion contents are handled by other tolerances (e.g., code intersection), but the wrapper metadata still reflects the different loaded ValueSet versions. For example, TribalEntityUS: prod returns version=4.0.0/name=TribalEntityUS/date=2014-03-26, dev returns version=2018-08-12/name=v3.TribalEntityUS/date=2018-08-12.\n\n**Normalizes**: Dev's metadata fields (date, name, title, version, identifier, language, immutable, meta) to prod's values.\n\n**Representative record**: `2d18564d-4e72-425d-aca0-358240df2c57` — expand of v3-TribalEntityUS where all ValueSet metadata differs between versions.\n\n### 6. `hl7-terminology-lookup-definition-designation-skew` (1 record)\n\n**What it handles**: `$lookup` responses for HL7 terminology CodeSystems where dev returns extra top-level `definition` and `designation` parameters that prod doesn't return. Dev has `definition` as a top-level parameter (with version-dependent text), while prod returns `definition` only as a property entry. Dev also includes a `designation` parameter with `preferredForLanguage` use that prod omits entirely. Both are consequences of dev loading a newer CodeSystem version with richer content.\n\n**Normalizes**: Strips `definition` and `designation` top-level parameters and `definition` property entries from both sides.\n\n**Representative record**: `118efc0f-ad5c-4db9-b9e6-2120a5824b92` — lookup of `active` in `condition-clinical` where dev (version 3.0.0) returns extra definition and designation, prod (version 4.0.1) returns definition only as a property.\n\n## Repro\n\n```bash\n# Prod\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fterminology.hl7.org%2FValueSet%2Fv3-TribalEntityUS&incomplete-ok=true&_format=json' -H 'Accept: application/fhir+json' | jq '{version, name, title, date}'\n\n# Dev\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fterminology.hl7.org%2FValueSet%2Fv3-TribalEntityUS&incomplete-ok=true&_format=json' -H 'Accept: application/fhir+json' | jq '{version, name, title, date}'\n```\n\nProd returns `version=4.0.0, name=TribalEntityUS`, dev returns `version=2018-08-12, name=v3.TribalEntityUS`.", "body_html": "<p>Records-Impacted: ~465<br>\nRecord-ID: 04364a8a-acce-491a-8018-9ac010d47d21, ef77e7ca-9afa-4325-a1f3-a939a62a490f, 7813f9ee-79ee-445b-8064-603a98e876bf, 83509e51-1a8b-4d77-8f4e-7b0037009c4a, 2d18564d-4e72-425d-aca0-358240df2c57, 118efc0f-ad5c-4db9-b9e6-2120a5824b92<br>\nTolerance-ID: hl7-terminology-cs-version-skew, expand-hl7-terminology-version-skew-params, expand-hl7-terminology-version-skew-content, validate-code-hl7-terminology-vs-version-skew, expand-hl7-terminology-version-skew-vs-metadata, hl7-terminology-lookup-definition-designation-skew</p>\n<h2>Summary</h2>\n<p>Dev loads older/different versions of HL7 terminology CodeSystems and ValueSets (<code>http://terminology.hl7.org/CodeSystem/*</code>, <code>http://terminology.hl7.org/ValueSet/*</code>) than prod. For example, prod loads <code>consentcategorycodes</code> at version <code>4.0.1</code> while dev loads <code>1.0.1</code>; prod loads <code>observation-category</code> at <code>4.0.1</code> while dev loads <code>2.0.0</code>. Dev also loads different ValueSet versions (e.g., <code>v3-TribalEntityUS|4.0.0</code> vs dev&#x27;s <code>|2018-08-12</code>, <code>v3-ActEncounterCode|3.0.0</code> vs dev&#x27;s <code>|2014-03-26</code>). This version skew is the single root cause behind six distinct manifestations affecting <code>$validate-code</code>, <code>$expand</code>, and <code>$lookup</code> operations.</p>\n<p>Known affected CodeSystems and their version mismatches:</p>\n<ul><li><code>consentcategorycodes</code>: prod=4.0.1, dev=1.0.1</li><li><code>goal-achievement</code>: prod=4.0.1, dev=1.0.1</li><li><code>observation-category</code>: prod=4.0.1, dev=2.0.0</li><li><code>consentpolicycodes</code>: prod=4.0.1, dev=3.0.1</li><li><code>condition-category</code>: prod=4.0.1, dev=2.0.0</li><li><code>condition-clinical</code>: prod=4.0.1, dev=3.0.0</li><li><code>v2-0116</code>: prod=2.9, dev=3.0.0</li></ul>\n<p>Known affected ValueSets:</p>\n<ul><li><code>v3-ActEncounterCode</code>: prod=3.0.0, dev=2014-03-26</li><li><code>v3-TribalEntityUS</code>: prod=4.0.0, dev=2018-08-12</li></ul>\n<h2>Tolerances</h2>\n<h3>1. <code>hl7-terminology-cs-version-skew</code> (~58 records)</h3>\n<p><strong>What it handles</strong>: <code>$validate-code</code> responses where the only differences are CodeSystem version strings in the <code>version</code> parameter, <code>message</code> text, and <code>issues</code> OperationOutcome <code>details.text</code>. Also strips draft <code>status-check</code> informational issues that prod includes but dev omits (because dev loads a version that lacks the draft status metadata). Both servers agree on validation results for all affected codes.</p>\n<p><strong>Normalizes</strong>: Dev&#x27;s version parameter and version strings in message/issues text to prod&#x27;s values; strips prod&#x27;s draft status-check issues.</p>\n<p><strong>Representative record</strong>: <code>04364a8a-acce-491a-8018-9ac010d47d21</code> — validate-code for <code>consentcategorycodes</code> where prod says &quot;version &#x27;4.0.1&#x27;&quot;, dev says &quot;version &#x27;1.0.1&#x27;&quot;.</p>\n<h3>2. <code>expand-hl7-terminology-version-skew-params</code> (~236 records)</h3>\n<p><strong>What it handles</strong>: <code>$expand</code> responses where the <code>expansion.parameter</code> entries differ due to version skew. The <code>used-codesystem</code> version strings differ (e.g., <code>observation-category|4.0.1</code> vs <code>|2.0.0</code>) and prod includes <code>warning-draft</code> parameters that dev omits.</p>\n<p><strong>Normalizes</strong>: <code>used-codesystem</code> versions for <code>terminology.hl7.org</code> systems to prod&#x27;s values; strips <code>warning-draft</code> parameters from both sides.</p>\n<p><strong>Representative record</strong>: <code>ef77e7ca-9afa-4325-a1f3-a939a62a490f</code> — expand of <code>us-core-simple-observation-category</code> where used-codesystem version and warning-draft differ.</p>\n<h3>3. <code>expand-hl7-terminology-version-skew-content</code> (~163 records)</h3>\n<p><strong>What it handles</strong>: <code>$expand</code> responses where prod and dev return slightly different sets of codes (1-5 extra/missing) because different CodeSystem versions include different codes. For example, dev&#x27;s older <code>consentpolicycodes</code> includes <code>ch-epr</code> (removed in 4.0.1), and dev&#x27;s older <code>observation-category</code> includes an extra <code>symptom</code> code. The common codes between prod and dev are identical.</p>\n<p><strong>Normalizes</strong>: Both sides to the intersection of codes present in both responses; adjusts the total count accordingly.</p>\n<p><strong>Representative record</strong>: <code>7813f9ee-79ee-445b-8064-603a98e876bf</code> — expand of <code>consent-policy</code> where dev returns 27 codes vs prod&#x27;s 26 (extra <code>ch-epr</code>).</p>\n<h3>4. <code>validate-code-hl7-terminology-vs-version-skew</code> (4 records)</h3>\n<p><strong>What it handles</strong>: <code>$validate-code</code> responses where the only difference is the ValueSet version string in message text and issues details text. Both servers agree on <code>result=false</code> and all other parameters. The difference appears in &quot;not found in the value set &#x27;url|version&#x27;&quot; messages where prod references the newer ValueSet version (e.g., <code>v3-ActEncounterCode|3.0.0</code>) and dev references the older version (e.g., <code>|2014-03-26</code>).</p>\n<p><strong>Normalizes</strong>: ValueSet pipe-delimited version strings in message and issues text to prod&#x27;s values.</p>\n<p><strong>Representative record</strong>: <code>83509e51-1a8b-4d77-8f4e-7b0037009c4a</code> — validate-code for PLB in v3-ActEncounterCode where prod says <code>|3.0.0</code>, dev says <code>|2014-03-26</code>.</p>\n<h3>5. <code>expand-hl7-terminology-version-skew-vs-metadata</code> (3 records)</h3>\n<p><strong>What it handles</strong>: <code>$expand</code> responses where the ValueSet-level metadata fields (date, name, title, version, identifier, language, immutable, meta) differ because prod and dev loaded different editions of the same HL7 terminology ValueSet. The expansion contents are handled by other tolerances (e.g., code intersection), but the wrapper metadata still reflects the different loaded ValueSet versions. For example, TribalEntityUS: prod returns version=4.0.0/name=TribalEntityUS/date=2014-03-26, dev returns version=2018-08-12/name=v3.TribalEntityUS/date=2018-08-12.</p>\n<p><strong>Normalizes</strong>: Dev&#x27;s metadata fields (date, name, title, version, identifier, language, immutable, meta) to prod&#x27;s values.</p>\n<p><strong>Representative record</strong>: <code>2d18564d-4e72-425d-aca0-358240df2c57</code> — expand of v3-TribalEntityUS where all ValueSet metadata differs between versions.</p>\n<h3>6. <code>hl7-terminology-lookup-definition-designation-skew</code> (1 record)</h3>\n<p><strong>What it handles</strong>: <code>$lookup</code> responses for HL7 terminology CodeSystems where dev returns extra top-level <code>definition</code> and <code>designation</code> parameters that prod doesn&#x27;t return. Dev has <code>definition</code> as a top-level parameter (with version-dependent text), while prod returns <code>definition</code> only as a property entry. Dev also includes a <code>designation</code> parameter with <code>preferredForLanguage</code> use that prod omits entirely. Both are consequences of dev loading a newer CodeSystem version with richer content.</p>\n<p><strong>Normalizes</strong>: Strips <code>definition</code> and <code>designation</code> top-level parameters and <code>definition</code> property entries from both sides.</p>\n<p><strong>Representative record</strong>: <code>118efc0f-ad5c-4db9-b9e6-2120a5824b92</code> — lookup of <code>active</code> in <code>condition-clinical</code> where dev (version 3.0.0) returns extra definition and designation, prod (version 4.0.1) returns definition only as a property.</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Prod\ncurl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fterminology.hl7.org%2FValueSet%2Fv3-TribalEntityUS&amp;incomplete-ok=true&amp;_format=json&#x27; -H &#x27;Accept: application/fhir+json&#x27; | jq &#x27;{version, name, title, date}&#x27;\n\n# Dev\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand?url=http:%2F%2Fterminology.hl7.org%2FValueSet%2Fv3-TribalEntityUS&amp;incomplete-ok=true&amp;_format=json&#x27; -H &#x27;Accept: application/fhir+json&#x27; | jq &#x27;{version, name, title, date}&#x27;</code></pre>\n<p>Prod returns <code>version=4.0.0, name=TribalEntityUS</code>, dev returns <code>version=2018-08-12, name=v3.TribalEntityUS</code>.</p>", "impact": null}, {"id": "1bc5e64", "title": "Dev returns x-caused-by-unknown-system for CodeSystem versions that prod resolves (RxNorm 04072025, SNOMED US 20220301)", "status": "closed", "labels": ["content-differs", "not-reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 17:50", "date_iso": "2026-02-07T17:50:21-06:00", "body_md": "Records-Impacted: 7\nTolerance-ID: validate-code-x-unknown-system-extra\nRecord-ID: f7e61c56-3c3c-4925-8822-f0f4e4406e3f\n\n## Repro\n\n```bash\n# Test RxNorm version 04072025\ncurl -s https://tx.fhir.org/r4/ValueSet/\\$validate-code \\\n  -H \"Accept: application/fhir+json\" \\\n  -H \"Content-Type: application/fhir+json\" \\\n  -d '{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"url\",\n      \"valueUri\": \"http://hl7.org/fhir/ValueSet/substance-code\"\n    },\n    {\n      \"name\": \"coding\",\n      \"valueCoding\": {\n        \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\",\n        \"version\": \"04072025\",\n        \"code\": \"1049221\"\n      }\n    }\n  ]\n}' | jq '.parameter[] | select(.name==\"x-unknown-system\" or .name==\"x-caused-by-unknown-system\")'\n\n# Dev (same request)\ncurl -s https://tx-dev.fhir.org/r4/ValueSet/\\$validate-code \\\n  -H \"Accept: application/fhir+json\" \\\n  -H \"Content-Type: application/fhir+json\" \\\n  -d '{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"url\",\n      \"valueUri\": \"http://hl7.org/fhir/ValueSet/substance-code\"\n    },\n    {\n      \"name\": \"coding\",\n      \"valueCoding\": {\n        \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\",\n        \"version\": \"04072025\",\n        \"code\": \"1049221\"\n      }\n    }\n  ]\n}' | jq '.parameter[] | select(.name==\"x-unknown-system\" or .name==\"x-caused-by-unknown-system\")'\n```\n\n**Result**: Both servers now return identical responses with `x-unknown-system` parameter. The bug describes a scenario where prod did NOT return this parameter but dev did. The servers have converged — both now handle the unknown version the same way.\n\n## What differs\n\nWhen validating a code against a ValueSet that includes codes from RxNorm or SNOMED CT, and the request pins a specific CodeSystem version, dev fails to resolve certain versions that prod resolves:\n\n- **RxNorm version `04072025`**: Dev returns \"A definition for CodeSystem 'http://www.nlm.nih.gov/research/umls/rxnorm' version '04072025' could not be found\". Prod resolves it (falls back to known version `??`) and performs actual validation, returning \"code not found in valueset\".\n- **SNOMED US edition version `20220301`** (`http://snomed.info/sct/731000124108/version/20220301`): Same pattern — dev can't find this version, prod resolves it.\n\nDev returns `x-caused-by-unknown-system` parameter (e.g., `http://www.nlm.nih.gov/research/umls/rxnorm|04072025`) and a single OperationOutcome issue with code `not-found`. Prod omits `x-caused-by-unknown-system` and returns the actual validation result with issues like `this-code-not-in-vs` and `not-in-vs`.\n\nBoth return `result=false`, but for completely different reasons: prod says \"code not in valueset\", dev says \"can't validate because CodeSystem version not found.\"\n\n## How widespread\n\n7 records in the deltas match this pattern (dev has `x-caused-by-unknown-system`, prod does not):\n- 4 records: RxNorm version 04072025\n- 3 records: SNOMED US edition version 20220301\n\nAll are POST /r4/ValueSet/$validate-code operations.\n\nSearch: `grep 'x-caused-by-unknown-system' deltas.ndjson` → 8 hits total, 7 where only dev has the parameter.\n\n## What the tolerance covers\n\nTolerance `validate-code-x-unknown-system-extra` matches validate-code records where dev has `x-caused-by-unknown-system` but prod does not. It normalizes dev's issues, message, and x-caused-by-unknown-system to match prod's values. Eliminates 7 records.\n\nNote: This tolerance previously existed but had a bug — it matched on parameter name `x-unknown-system` instead of the correct `x-caused-by-unknown-system`, so it matched 0 records. The fix corrects the parameter name.", "body_html": "<p>Records-Impacted: 7<br>\nTolerance-ID: validate-code-x-unknown-system-extra<br>\nRecord-ID: f7e61c56-3c3c-4925-8822-f0f4e4406e3f</p>\n<h2>Repro</h2>\n<pre><code class=\"lang-bash\"># Test RxNorm version 04072025\ncurl -s https://tx.fhir.org/r4/ValueSet/\\$validate-code \\\n  -H &quot;Accept: application/fhir+json&quot; \\\n  -H &quot;Content-Type: application/fhir+json&quot; \\\n  -d &#x27;{\n  &quot;resourceType&quot;: &quot;Parameters&quot;,\n  &quot;parameter&quot;: [\n    {\n      &quot;name&quot;: &quot;url&quot;,\n      &quot;valueUri&quot;: &quot;http://hl7.org/fhir/ValueSet/substance-code&quot;\n    },\n    {\n      &quot;name&quot;: &quot;coding&quot;,\n      &quot;valueCoding&quot;: {\n        &quot;system&quot;: &quot;http://www.nlm.nih.gov/research/umls/rxnorm&quot;,\n        &quot;version&quot;: &quot;04072025&quot;,\n        &quot;code&quot;: &quot;1049221&quot;\n      }\n    }\n  ]\n}&#x27; | jq &#x27;.parameter[] | select(.name==&quot;x-unknown-system&quot; or .name==&quot;x-caused-by-unknown-system&quot;)&#x27;\n\n# Dev (same request)\ncurl -s https://tx-dev.fhir.org/r4/ValueSet/\\$validate-code \\\n  -H &quot;Accept: application/fhir+json&quot; \\\n  -H &quot;Content-Type: application/fhir+json&quot; \\\n  -d &#x27;{\n  &quot;resourceType&quot;: &quot;Parameters&quot;,\n  &quot;parameter&quot;: [\n    {\n      &quot;name&quot;: &quot;url&quot;,\n      &quot;valueUri&quot;: &quot;http://hl7.org/fhir/ValueSet/substance-code&quot;\n    },\n    {\n      &quot;name&quot;: &quot;coding&quot;,\n      &quot;valueCoding&quot;: {\n        &quot;system&quot;: &quot;http://www.nlm.nih.gov/research/umls/rxnorm&quot;,\n        &quot;version&quot;: &quot;04072025&quot;,\n        &quot;code&quot;: &quot;1049221&quot;\n      }\n    }\n  ]\n}&#x27; | jq &#x27;.parameter[] | select(.name==&quot;x-unknown-system&quot; or .name==&quot;x-caused-by-unknown-system&quot;)&#x27;</code></pre>\n<p><strong>Result</strong>: Both servers now return identical responses with <code>x-unknown-system</code> parameter. The bug describes a scenario where prod did NOT return this parameter but dev did. The servers have converged — both now handle the unknown version the same way.</p>\n<h2>What differs</h2>\n<p>When validating a code against a ValueSet that includes codes from RxNorm or SNOMED CT, and the request pins a specific CodeSystem version, dev fails to resolve certain versions that prod resolves:</p>\n<ul><li>**RxNorm version <code>04072025</code>**: Dev returns &quot;A definition for CodeSystem &#x27;<a href=\"http://www.nlm.nih.gov/research/umls/rxnorm&#x27;\" target=\"_blank\">http://www.nlm.nih.gov/research/umls/rxnorm&#x27;</a> version &#x27;04072025&#x27; could not be found&quot;. Prod resolves it (falls back to known version <code>??</code>) and performs actual validation, returning &quot;code not found in valueset&quot;.</li><li>**SNOMED US edition version <code>20220301</code>** (<code>http://snomed.info/sct/731000124108/version/20220301</code>): Same pattern — dev can&#x27;t find this version, prod resolves it.</li></ul>\n<p>Dev returns <code>x-caused-by-unknown-system</code> parameter (e.g., <code>http://www.nlm.nih.gov/research/umls/rxnorm|04072025</code>) and a single OperationOutcome issue with code <code>not-found</code>. Prod omits <code>x-caused-by-unknown-system</code> and returns the actual validation result with issues like <code>this-code-not-in-vs</code> and <code>not-in-vs</code>.</p>\n<p>Both return <code>result=false</code>, but for completely different reasons: prod says &quot;code not in valueset&quot;, dev says &quot;can&#x27;t validate because CodeSystem version not found.&quot;</p>\n<h2>How widespread</h2>\n<p>7 records in the deltas match this pattern (dev has <code>x-caused-by-unknown-system</code>, prod does not):</p>\n<ul><li>4 records: RxNorm version 04072025</li><li>3 records: SNOMED US edition version 20220301</li></ul>\n<p>All are POST /r4/ValueSet/$validate-code operations.</p>\n<p>Search: <code>grep &#x27;x-caused-by-unknown-system&#x27; deltas.ndjson</code> → 8 hits total, 7 where only dev has the parameter.</p>\n<h2>What the tolerance covers</h2>\n<p>Tolerance <code>validate-code-x-unknown-system-extra</code> matches validate-code records where dev has <code>x-caused-by-unknown-system</code> but prod does not. It normalizes dev&#x27;s issues, message, and x-caused-by-unknown-system to match prod&#x27;s values. Eliminates 7 records.</p>\n<p>Note: This tolerance previously existed but had a bug — it matched on parameter name <code>x-unknown-system</code> instead of the correct <code>x-caused-by-unknown-system</code>, so it matched 0 records. The fix corrects the parameter name.</p>", "impact": 7}, {"id": "e18fdef", "title": "Dev returns 404 for LOINC answer list ValueSet $expand (appends |4.0.1 to canonical URL)", "status": "closed", "labels": ["missing-resource", "not-reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 15:22", "date_iso": "2026-02-07T15:22:09-06:00", "body_md": "Records-Impacted: 2\nTolerance-ID: loinc-answer-list-expand-404\nRecord-ID: 7cf61657-1a32-4b8f-a4c6-f626df7381e0\n\n\n```bash\ncurl -s https://tx.fhir.org/r4/ValueSet/\\$expand \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"url\",\"valueUri\":\"http://loinc.org/vs/LL379-9\"}]}'\n\ncurl -s https://tx-dev.fhir.org/r4/ValueSet/\\$expand \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\"resourceType\":\"Parameters\",\"parameter\":[{\"name\":\"url\",\"valueUri\":\"http://loinc.org/vs/LL379-9\"}]}'\n```\n\n**Result:** Both servers now return 200 with identical ValueSet expansions containing 7 codes. The bug is no longer reproduced - the dev server previously returned 404 with \"ValueSet not found: http://loinc.org/vs/LL379-9|4.0.1\" but now correctly expands the LOINC answer list.\n\n\nWhen expanding the LOINC answer list ValueSet `http://loinc.org/vs/LL379-9` via `POST /r4/ValueSet/$expand`, prod returns 200 with a successful expansion (7 codes), while dev **previously** returned 404 with:\n\n    ValueSet not found: http://loinc.org/vs/LL379-9|4.0.1\n\nDev was appending `|4.0.1` (the FHIR R4 version) to the ValueSet canonical URL when resolving it, causing the lookup to fail.\n\n\n2 records in the comparison dataset showed this exact pattern — both are `POST /r4/ValueSet/$expand` for the same LOINC answer list LL379-9, both with prod=200/dev=404, and both with the same `|4.0.1` suffix in the dev error message.\n\nSearch:\n- `grep 'LL379-9' deltas.ndjson` → 2 records\n- `grep 'missing-resource' deltas.ndjson` → 3 total (1 is a separate CodeSystem/SOP issue)\n- All 2 matching records had identical error diagnostic\n\nThe full comparison.ndjson had 64 records referencing LL379-9, but the other 62 are `GET /r4/ValueSet?_elements=url,version` (search/list operations, not expand) and succeeded on both servers.\n\n\nTolerance ID: `loinc-answer-list-expand-404`\nMatched: `missing-resource` category, `POST /r4/ValueSet/$expand`, dev 404 with diagnostics containing `|4.0.1`\nEliminated: 2 records", "body_html": "<p>Records-Impacted: 2<br>\nTolerance-ID: loinc-answer-list-expand-404<br>\nRecord-ID: 7cf61657-1a32-4b8f-a4c6-f626df7381e0</p>\n<pre><code class=\"lang-bash\">curl -s https://tx.fhir.org/r4/ValueSet/\\$expand \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;url&quot;,&quot;valueUri&quot;:&quot;http://loinc.org/vs/LL379-9&quot;}]}&#x27;\n\ncurl -s https://tx-dev.fhir.org/r4/ValueSet/\\$expand \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{&quot;resourceType&quot;:&quot;Parameters&quot;,&quot;parameter&quot;:[{&quot;name&quot;:&quot;url&quot;,&quot;valueUri&quot;:&quot;http://loinc.org/vs/LL379-9&quot;}]}&#x27;</code></pre>\n<p><strong>Result:</strong> Both servers now return 200 with identical ValueSet expansions containing 7 codes. The bug is no longer reproduced - the dev server previously returned 404 with &quot;ValueSet not found: <a href=\"http://loinc.org/vs/LL379-9|4.0.1&quot;\" target=\"_blank\">http://loinc.org/vs/LL379-9|4.0.1&quot;</a> but now correctly expands the LOINC answer list.</p>\n<p>When expanding the LOINC answer list ValueSet <code>http://loinc.org/vs/LL379-9</code> via <code>POST /r4/ValueSet/$expand</code>, prod returns 200 with a successful expansion (7 codes), while dev <strong>previously</strong> returned 404 with:</p>\n<p>ValueSet not found: <a href=\"http://loinc.org/vs/LL379-9|4.0.1\" target=\"_blank\">http://loinc.org/vs/LL379-9|4.0.1</a></p>\n<p>Dev was appending <code>|4.0.1</code> (the FHIR R4 version) to the ValueSet canonical URL when resolving it, causing the lookup to fail.</p>\n<p>2 records in the comparison dataset showed this exact pattern — both are <code>POST /r4/ValueSet/$expand</code> for the same LOINC answer list LL379-9, both with prod=200/dev=404, and both with the same <code>|4.0.1</code> suffix in the dev error message.</p>\n<p>Search:</p>\n<ul><li><code>grep &#x27;LL379-9&#x27; deltas.ndjson</code> → 2 records</li><li><code>grep &#x27;missing-resource&#x27; deltas.ndjson</code> → 3 total (1 is a separate CodeSystem/SOP issue)</li><li>All 2 matching records had identical error diagnostic</li></ul>\n<p>The full comparison.ndjson had 64 records referencing LL379-9, but the other 62 are <code>GET /r4/ValueSet?_elements=url,version</code> (search/list operations, not expand) and succeeded on both servers.</p>\n<p>Tolerance ID: <code>loinc-answer-list-expand-404</code><br>\nMatched: <code>missing-resource</code> category, <code>POST /r4/ValueSet/$expand</code>, dev 404 with diagnostics containing <code>|4.0.1</code><br>\nEliminated: 2 records</p>", "impact": 2}, {"id": "44d6f07", "title": "Dev truncates BCP-47 language tag region in expand displayLanguage parameter", "status": "closed", "labels": ["content-differs", "not-reproduced", "tx-compare"], "author": "Claude (AI Assistant)", "date": "2026-02-07 17:53", "date_iso": "2026-02-07T17:53:39-06:00", "body_md": "Records-Impacted: 2\nTolerance-ID: expand-displayLanguage-region-truncated\nRecord-ID: 4bd05003-c9ae-4886-9009-3f794f2690a1\n\n\n```bash\ncurl -s 'https://tx.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\n    \"resourceType\": \"Parameters\",\n    \"parameter\": [\n      {\"name\": \"displayLanguage\", \"valueCode\": \"fr-FR\"},\n      {\"name\": \"excludeNested\", \"valueBoolean\": true},\n      {\"name\": \"count\", \"valueInteger\": 10},\n      {\"name\": \"valueSet\", \"resource\": {\n        \"resourceType\": \"ValueSet\",\n        \"status\": \"active\",\n        \"compose\": {\n          \"include\": [{\"system\": \"http://loinc.org\", \"concept\": [{\"code\": \"11369-6\"}]}]\n        }\n      }}\n    ]\n  }' | jq '.expansion.parameter[] | select(.name == \"displayLanguage\")'\n\ncurl -s 'https://tx-dev.fhir.org/r4/ValueSet/$expand' \\\n  -H 'Accept: application/fhir+json' \\\n  -H 'Content-Type: application/fhir+json' \\\n  -d '{\n    \"resourceType\": \"Parameters\",\n    \"parameter\": [\n      {\"name\": \"displayLanguage\", \"valueCode\": \"fr-FR\"},\n      {\"name\": \"excludeNested\", \"valueBoolean\": true},\n      {\"name\": \"count\", \"valueInteger\": 10},\n      {\"name\": \"valueSet\", \"resource\": {\n        \"resourceType\": \"ValueSet\",\n        \"status\": \"active\",\n        \"compose\": {\n          \"include\": [{\"system\": \"http://loinc.org\", \"concept\": [{\"code\": \"11369-6\"}]}]\n        }\n      }}\n    ]\n  }' | jq '.expansion.parameter[] | select(.name == \"displayLanguage\")'\n```\n\n**Result**: Both servers now return `{\"name\": \"displayLanguage\", \"valueCode\": \"fr-FR\"}`. The bug has been fixed - dev no longer truncates the region subtag.\n\n\nIn $expand responses, the `displayLanguage` expansion parameter echoed back by dev truncates the BCP-47 language tag to just the language code, dropping the region subtag. When the request specifies `displayLanguage=fr-FR`, prod echoes back `fr-FR` in the expansion parameters, but dev echoes back `fr`.\n\nThe actual expansion content (codes, display text) is identical between prod and dev — the difference is only in the echoed `displayLanguage` parameter value.\n\n\n2 records in the current comparison show this pattern. Both are POST /r4/ValueSet/$expand requests with `displayLanguage=fr-FR` in the request body.\n\nSearch: grep for records where both prod and dev have a `displayLanguage` expansion parameter but with different values — found only these 2 records (IDs: 4bd05003-c9ae-4886-9009-3f794f2690a1, 57537a3f-f65b-4f96-b9d7-3354772c3973).\n\nThere are an additional 62 records with a different displayLanguage mismatch pattern (prod has displayLanguage=en or en-US but dev omits it entirely), which is a separate issue.\n\n\nTolerance `expand-displayLanguage-region-truncated` normalizes the displayLanguage expansion parameter to the prod value when both sides have a displayLanguage parameter but the values differ only by region subtag truncation (e.g., fr-FR vs fr). This eliminates 2 records.\n\n\n`grep -n '4bd05003-c9ae-4886-9009-3f794f2690a1' jobs/2026-02-round-2/comparison.ndjson`", "body_html": "<p>Records-Impacted: 2<br>\nTolerance-ID: expand-displayLanguage-region-truncated<br>\nRecord-ID: 4bd05003-c9ae-4886-9009-3f794f2690a1</p>\n<pre><code class=\"lang-bash\">curl -s &#x27;https://tx.fhir.org/r4/ValueSet/$expand&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{\n    &quot;resourceType&quot;: &quot;Parameters&quot;,\n    &quot;parameter&quot;: [\n      {&quot;name&quot;: &quot;displayLanguage&quot;, &quot;valueCode&quot;: &quot;fr-FR&quot;},\n      {&quot;name&quot;: &quot;excludeNested&quot;, &quot;valueBoolean&quot;: true},\n      {&quot;name&quot;: &quot;count&quot;, &quot;valueInteger&quot;: 10},\n      {&quot;name&quot;: &quot;valueSet&quot;, &quot;resource&quot;: {\n        &quot;resourceType&quot;: &quot;ValueSet&quot;,\n        &quot;status&quot;: &quot;active&quot;,\n        &quot;compose&quot;: {\n          &quot;include&quot;: [{&quot;system&quot;: &quot;http://loinc.org&quot;, &quot;concept&quot;: [{&quot;code&quot;: &quot;11369-6&quot;}]}]\n        }\n      }}\n    ]\n  }&#x27; | jq &#x27;.expansion.parameter[] | select(.name == &quot;displayLanguage&quot;)&#x27;\n\ncurl -s &#x27;https://tx-dev.fhir.org/r4/ValueSet/$expand&#x27; \\\n  -H &#x27;Accept: application/fhir+json&#x27; \\\n  -H &#x27;Content-Type: application/fhir+json&#x27; \\\n  -d &#x27;{\n    &quot;resourceType&quot;: &quot;Parameters&quot;,\n    &quot;parameter&quot;: [\n      {&quot;name&quot;: &quot;displayLanguage&quot;, &quot;valueCode&quot;: &quot;fr-FR&quot;},\n      {&quot;name&quot;: &quot;excludeNested&quot;, &quot;valueBoolean&quot;: true},\n      {&quot;name&quot;: &quot;count&quot;, &quot;valueInteger&quot;: 10},\n      {&quot;name&quot;: &quot;valueSet&quot;, &quot;resource&quot;: {\n        &quot;resourceType&quot;: &quot;ValueSet&quot;,\n        &quot;status&quot;: &quot;active&quot;,\n        &quot;compose&quot;: {\n          &quot;include&quot;: [{&quot;system&quot;: &quot;http://loinc.org&quot;, &quot;concept&quot;: [{&quot;code&quot;: &quot;11369-6&quot;}]}]\n        }\n      }}\n    ]\n  }&#x27; | jq &#x27;.expansion.parameter[] | select(.name == &quot;displayLanguage&quot;)&#x27;</code></pre>\n<p><strong>Result</strong>: Both servers now return <code>{&quot;name&quot;: &quot;displayLanguage&quot;, &quot;valueCode&quot;: &quot;fr-FR&quot;}</code>. The bug has been fixed - dev no longer truncates the region subtag.</p>\n<p>In $expand responses, the <code>displayLanguage</code> expansion parameter echoed back by dev truncates the BCP-47 language tag to just the language code, dropping the region subtag. When the request specifies <code>displayLanguage=fr-FR</code>, prod echoes back <code>fr-FR</code> in the expansion parameters, but dev echoes back <code>fr</code>.</p>\n<p>The actual expansion content (codes, display text) is identical between prod and dev — the difference is only in the echoed <code>displayLanguage</code> parameter value.</p>\n<p>2 records in the current comparison show this pattern. Both are POST /r4/ValueSet/$expand requests with <code>displayLanguage=fr-FR</code> in the request body.</p>\n<p>Search: grep for records where both prod and dev have a <code>displayLanguage</code> expansion parameter but with different values — found only these 2 records (IDs: 4bd05003-c9ae-4886-9009-3f794f2690a1, 57537a3f-f65b-4f96-b9d7-3354772c3973).</p>\n<p>There are an additional 62 records with a different displayLanguage mismatch pattern (prod has displayLanguage=en or en-US but dev omits it entirely), which is a separate issue.</p>\n<p>Tolerance <code>expand-displayLanguage-region-truncated</code> normalizes the displayLanguage expansion parameter to the prod value when both sides have a displayLanguage parameter but the values differ only by region subtag truncation (e.g., fr-FR vs fr). This eliminates 2 records.</p>\n<p><code>grep -n &#x27;4bd05003-c9ae-4886-9009-3f794f2690a1&#x27; jobs/2026-02-round-2/comparison.ndjson</code></p>", "impact": 2}];
const STATS = {"total": 40, "open": 37, "closed": 3, "labels": {"content-differs": 26, "reproduced": 35, "tx-compare": 40, "code-defect": 7, "status-mismatch": 8, "dev-crash-on-error": 1, "config-issue": 5, "result-disagrees": 2, "dev-crash-on-valid": 1, "repro-inconclusive": 1, "missing-resource": 2, "not-reproduced": 3}, "sortedLabels": ["tx-compare", "reproduced", "content-differs", "status-mismatch", "code-defect", "config-issue", "not-reproduced", "result-disagrees", "missing-resource", "dev-crash-on-error", "dev-crash-on-valid", "repro-inconclusive"], "job": {"total": 32233, "matchedPerfectly": 0, "matchedEquiv": 10492, "knownIssues": 21735, "untriaged": 6}};

document.getElementById("gen-time").textContent = new Date().toLocaleString();

// Pipeline overview bar
(function() {
  const job = STATS.job;
  if (!job) return;
  const bar = document.getElementById("pipeline-bar");
  const segs = [
    { value: job.matchedPerfectly, label: "matched perfectly", cls: "seg-perfect" },
    { value: job.matchedEquiv, label: "considered equivalent by Claude", cls: "seg-equiv" },
    { value: job.knownIssues, label: "considered mismatches by Claude; bugs listed below", cls: "seg-known" },
    { value: job.untriaged, label: "untriaged", cls: "seg-untriaged" },
  ];
  const total = job.total;
  let html = "";
  for (const s of segs) {
    if (s.value === 0) continue;
    const pct = (s.value / total * 100);
    html += `<div class="pipeline-seg ${s.cls}" style="flex:${s.value}">
      <span class="seg-value">${s.value.toLocaleString()}</span>
      <span class="seg-label">${s.label}</span>
    </div>`;
  }
  bar.innerHTML = html;
})();

// Stats bar
(function() {
  const bar = document.getElementById("stats-bar");
  let html = `<div class="stat"><span class="stat-value">${STATS.total}</span> bugs total</div>`;
  html += `<div class="stat-divider"></div>`;
  html += `<div class="stat"><span class="stat-value" style="color:var(--status-open-fg)">${STATS.open}</span> open</div>`;
  html += `<div class="stat"><span class="stat-value">${STATS.closed}</span> closed</div>`;
  bar.innerHTML = html;
})();

// Label filter pills
(function() {
  const container = document.getElementById("label-filters");
  let html = "";
  for (const label of STATS.sortedLabels) {
    const c = STATS.labels[label] || 0;
    html += `<span class="filter-pill" data-label="${label}">${label} <span class="count">${c}</span></span>`;
  }
  container.innerHTML = html;
})();

// State
let activeLabels = new Set();
let activeStatus = "all";
let searchQuery = "";
let currentSort = "impact";

function renderBugList() {
  const list = document.getElementById("bug-list");
  // Sort bugs
  const sorted = [...BUGS];
  if (currentSort === "impact") {
    sorted.sort((a, b) => (b.impact || 0) - (a.impact || 0) || a.title.localeCompare(b.title));
  } else if (currentSort === "date") {
    sorted.sort((a, b) => (b.date_iso || "").localeCompare(a.date_iso || ""));
  } else if (currentSort === "title") {
    sorted.sort((a, b) => a.title.localeCompare(b.title));
  }

  let html = "";
  for (const bug of sorted) {
    const statusClass = bug.status === "open" ? "pill-status-open" : "pill-status-closed";
    const labels = bug.labels.map(l => `<span class="pill pill-label" data-label="${l}">${l}</span>`).join("");
    const impactPill = bug.impact ? `<span class="pill pill-impact">${bug.impact.toLocaleString()} records</span>` : "";

    html += `<div class="bug-card" data-status="${bug.status}" data-id="${bug.id}" data-labels="${bug.labels.join(",")}" data-impact="${bug.impact || 0}">
      <div class="bug-header" onclick="toggleBug(this)">
        <svg class="bug-expand-icon" viewBox="0 0 16 16" fill="currentColor">
          <path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"/>
        </svg>
        <div class="bug-info">
          <div class="bug-title">${bug.title}</div>
          <div class="bug-meta">
            <span class="pill ${statusClass}">${bug.status}</span>
            ${labels}
            ${impactPill}
            <span class="bug-id">${bug.id}</span>
            <span class="bug-date">updated ${bug.date}</span>
          </div>
        </div>
      </div>
      <div class="bug-body">${bug.body_html}</div>
    </div>`;
  }

  list.innerHTML = html;
  applyFilters();
}

function toggleBug(header) {
  header.parentElement.classList.toggle("expanded");
}

let allExpanded = false;
function toggleExpandAll() {
  allExpanded = !allExpanded;
  const cards = document.querySelectorAll(".bug-card:not(.hidden)");
  cards.forEach(c => c.classList.toggle("expanded", allExpanded));
  document.getElementById("expand-all-btn").textContent = allExpanded ? "Collapse all" : "Expand all";
}

function applyFilters() {
  const cards = document.querySelectorAll(".bug-card");
  const query = searchQuery.toLowerCase();
  let visibleCount = 0;

  cards.forEach(card => {
    const status = card.dataset.status;
    const cardLabels = card.dataset.labels ? card.dataset.labels.split(",") : [];
    const bugId = card.dataset.id;
    const bug = BUGS.find(b => b.id === bugId);

    let show = true;

    // Label filter: card must have at least one of the active labels
    if (activeLabels.size > 0) {
      if (!cardLabels.some(l => activeLabels.has(l))) {
        show = false;
      }
    }

    if (activeStatus !== "all" && status !== activeStatus) {
      show = false;
    }

    if (query && show && bug) {
      const searchable = (bug.title + " " + bug.body_md + " " + bug.labels.join(" ")).toLowerCase();
      if (!searchable.includes(query)) {
        show = false;
      }
    }

    card.classList.toggle("hidden", !show);
    if (show) visibleCount++;
  });

  document.getElementById("no-results").classList.toggle("hidden", visibleCount > 0);
}

// Search
document.getElementById("search").addEventListener("input", function() {
  searchQuery = this.value;
  applyFilters();
});

// Label filter pills — derive all visuals from activeLabels set
function updatePillVisuals() {
  document.querySelectorAll(".filter-pill[data-label]").forEach(pill => {
    const label = pill.dataset.label;
    if (activeLabels.size === 0) {
      pill.classList.remove("dimmed", "active");
    } else if (activeLabels.has(label)) {
      pill.classList.remove("dimmed");
      pill.classList.add("active");
    } else {
      pill.classList.add("dimmed");
      pill.classList.remove("active");
    }
  });
}

document.querySelectorAll(".filter-pill[data-label]").forEach(pill => {
  pill.addEventListener("click", function() {
    const label = this.dataset.label;
    if (activeLabels.has(label)) {
      activeLabels.delete(label);
    } else {
      activeLabels.add(label);
    }
    updatePillVisuals();
    applyFilters();
  });
});

// Status filter buttons
document.querySelectorAll(".ctrl-btn[data-status]").forEach(btn => {
  btn.addEventListener("click", function() {
    document.querySelectorAll(".ctrl-btn[data-status]").forEach(b => b.classList.remove("active"));
    this.classList.add("active");
    activeStatus = this.dataset.status;
    applyFilters();
  });
});

// Sort buttons
document.querySelectorAll(".sort-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    document.querySelectorAll(".sort-btn").forEach(b => b.classList.remove("active"));
    this.classList.add("active");
    currentSort = this.dataset.sort;
    renderBugList();
  });
});

// Initial render
renderBugList();
</script>
</body>
</html>